<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Complete Workflow - Sistema Ministerial</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            max-width: 1200px; 
            margin: 2rem auto; 
            padding: 1rem; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container { 
            background: white; 
            padding: 2rem; 
            border-radius: 12px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .test-section { 
            background: #f8f9fa; 
            padding: 1.5rem; 
            border-radius: 8px; 
            border-left: 4px solid #007bff;
            margin: 1.5rem 0;
        }
        .test-result { 
            background: #f1f3f4; 
            padding: 1rem; 
            border-radius: 4px; 
            border-left: 4px solid #6c757d;
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        button { 
            background: linear-gradient(45deg, #007bff, #0056b3); 
            color: white; 
            border: none; 
            padding: 0.75rem 1.5rem; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 1rem;
            margin: 0.5rem 0.5rem 0.5rem 0;
            transition: all 0.3s ease;
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }
        button:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .info { border-left-color: #17a2b8; background: #d1ecf1; }
        pre { 
            background: #2d3748; 
            color: #e2e8f0;
            padding: 1rem; 
            border-radius: 4px; 
            overflow-x: auto; 
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        h1 { 
            color: #2d3748;
            text-align: center;
            margin-bottom: 2rem;
        }
        h2 { 
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }
        .workflow-step {
            display: flex;
            align-items: center;
            margin: 1rem 0;
            padding: 1rem;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .step-number {
            background: #007bff;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-weight: bold;
        }
        .step-content {
            flex: 1;
        }
        .step-status {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-left: 1rem;
        }
        .status-pending { background: #6c757d; }
        .status-running { background: #ffc107; }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Sistema Ministerial - Teste Completo do Workflow</h1>
        <p style="text-align: center; color: #6c757d; margin-bottom: 2rem;">
            Teste automatizado completo do fluxo: Estudantes ‚Üí Programas ‚Üí Designa√ß√µes ‚Üí Relat√≥rios
        </p>

        <div class="test-section">
            <h2>üéØ Workflow Principal</h2>
            <div id="workflow-steps">
                <div class="workflow-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <strong>Carregar Estudantes</strong>
                        <div>Verificar se h√° estudantes cadastrados e ativos</div>
                    </div>
                    <div class="step-status status-pending" id="step1-status"></div>
                </div>
                <div class="workflow-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <strong>Carregar Programas</strong>
                        <div>Testar Edge Function list-programs-json</div>
                    </div>
                    <div class="step-status status-pending" id="step2-status"></div>
                </div>
                <div class="workflow-step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <strong>Gerar Designa√ß√µes</strong>
                        <div>Testar Edge Function generate-assignments</div>
                    </div>
                    <div class="step-status status-pending" id="step3-status"></div>
                </div>
                <div class="workflow-step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <strong>Validar Resultados</strong>
                        <div>Verificar se as designa√ß√µes seguem regras S-38</div>
                    </div>
                    <div class="step-status status-pending" id="step4-status"></div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>üß™ Controles de Teste</h2>
            <button onclick="runCompleteWorkflowTest()">üöÄ Executar Teste Completo</button>
            <button onclick="testStep(1)">üë• Testar Estudantes</button>
            <button onclick="testStep(2)">üìÖ Testar Programas</button>
            <button onclick="testStep(3)">üìã Testar Designa√ß√µes</button>
            <button onclick="resetTest()">üîÑ Resetar Teste</button>
        </div>

        <div class="test-section">
            <h2>‚öôÔ∏è Configura√ß√£o</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <label><strong>Supabase URL:</strong></label>
                    <input type="text" id="supabaseUrl" value="https://dlvojolvdsqrfczjjjuw.supabase.co" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div>
                    <label><strong>Anon Key:</strong></label>
                    <input type="password" id="anonKey" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsdm9qb2x2ZHNxcmZjempqanV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE0MDcyNzMsImV4cCI6MjA0Njk4MzI3M30.nUrN2bCd-pX6bJOV1fTxhI8CamBW1yZpFQLX6qTLzsk" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; border: 1px solid #ddd; border-radius: 4px;">
                </div>
            </div>
        </div>

        <div id="results" class="test-section" style="display: none;">
            <h2>üìä Resultados dos Testes</h2>
            <div id="test-results"></div>
        </div>
    </div>

    <script>
        let testResults = {};
        
        function updateStepStatus(step, status) {
            const statusEl = document.getElementById(`step${step}-status`);
            statusEl.className = `step-status status-${status}`;
        }

        function addResult(title, content, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = `
                <strong>${title}</strong>
                <pre>${JSON.stringify(content, null, 2)}</pre>
            `;
            resultsDiv.appendChild(resultDiv);
            document.getElementById('results').style.display = 'block';
        }

        async function testStep(stepNumber) {
            const supabaseUrl = document.getElementById('supabaseUrl').value;
            const anonKey = document.getElementById('anonKey').value;

            updateStepStatus(stepNumber, 'running');

            try {
                switch(stepNumber) {
                    case 1:
                        await testStudents(supabaseUrl, anonKey);
                        break;
                    case 2:
                        await testPrograms(supabaseUrl, anonKey);
                        break;
                    case 3:
                        await testAssignments(supabaseUrl, anonKey);
                        break;
                    case 4:
                        await validateResults();
                        break;
                }
                updateStepStatus(stepNumber, 'success');
            } catch (error) {
                updateStepStatus(stepNumber, 'error');
                addResult(`‚ùå Erro no Passo ${stepNumber}`, error.message, 'error');
            }
        }

        async function testStudents(supabaseUrl, anonKey) {
            addResult('üîç Testando conex√£o com estudantes...', 'Iniciando teste', 'info');
            
            // Test direct Supabase connection
            const response = await fetch(`${supabaseUrl}/rest/v1/vw_estudantes_grid?select=*&limit=5`, {
                headers: {
                    'Authorization': `Bearer ${anonKey}`,
                    'apikey': anonKey
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const students = await response.json();
            testResults.students = students;
            
            addResult('‚úÖ Estudantes carregados', {
                count: students.length,
                sample: students.slice(0, 2).map(s => ({ nome: s.nome, genero: s.genero, ativo: s.ativo }))
            }, 'success');
        }

        async function testPrograms(supabaseUrl, anonKey) {
            addResult('üîç Testando Edge Function list-programs-json...', 'Iniciando teste', 'info');
            
            const response = await fetch(`${supabaseUrl}/functions/v1/list-programs-json`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${anonKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ limit: 10 })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
            }

            const data = await response.json();
            testResults.programs = data;
            
            addResult('‚úÖ Programas carregados via Edge Function', {
                success: data.success || false,
                programsCount: data.programas?.length || 0,
                sample: data.programas?.slice(0, 1) || []
            }, 'success');
        }

        async function testAssignments(supabaseUrl, anonKey) {
            addResult('üîç Testando Edge Function generate-assignments...', 'Iniciando teste', 'info');
            
            const response = await fetch(`${supabaseUrl}/functions/v1/generate-assignments`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${anonKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    semana: '2024-12-09',
                    data_reuniao: '2024-12-09',
                    partes_customizadas: [
                        {
                            id: '1',
                            tipo: 'opening_comments',
                            titulo: 'Coment√°rios Iniciais',
                            minutos: 3
                        },
                        {
                            id: '2',
                            tipo: 'bible_reading',
                            titulo: 'Leitura da B√≠blia',
                            minutos: 4
                        }
                    ]
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
            }

            const data = await response.json();
            testResults.assignments = data;
            
            addResult('‚úÖ Designa√ß√µes geradas via Edge Function', {
                success: data.success || false,
                assignmentsCount: data.data?.designacoes?.length || 0,
                statistics: data.data?.estatisticas || {},
                sample: data.data?.designacoes?.slice(0, 2) || []
            }, 'success');
        }

        async function validateResults() {
            addResult('üîç Validando resultados conforme regras S-38...', 'Iniciando valida√ß√£o', 'info');
            
            const validations = [];
            
            // Validate students exist
            if (testResults.students && testResults.students.length > 0) {
                validations.push('‚úÖ Estudantes dispon√≠veis para designa√ß√£o');
            } else {
                validations.push('‚ùå Nenhum estudante encontrado');
            }
            
            // Validate programs loaded
            if (testResults.programs && testResults.programs.programas && testResults.programs.programas.length > 0) {
                validations.push('‚úÖ Programas carregados com sucesso');
            } else {
                validations.push('‚ùå Nenhum programa carregado');
            }
            
            // Validate assignments generated
            if (testResults.assignments && testResults.assignments.success) {
                validations.push('‚úÖ Designa√ß√µes geradas com algoritmo S-38');
                
                const assignments = testResults.assignments.data?.designacoes || [];
                const stats = testResults.assignments.data?.estatisticas || {};
                
                if (assignments.length > 0) {
                    validations.push(`‚úÖ ${assignments.length} designa√ß√µes criadas`);
                }
                
                if (stats.conflitos_encontrados && stats.conflitos_encontrados.length === 0) {
                    validations.push('‚úÖ Nenhum conflito encontrado');
                } else if (stats.conflitos_encontrados) {
                    validations.push(`‚ö†Ô∏è ${stats.conflitos_encontrados.length} conflito(s) encontrado(s)`);
                }
            } else {
                validations.push('‚ùå Falha na gera√ß√£o de designa√ß√µes');
            }
            
            addResult('üìã Valida√ß√£o Completa', validations, 'success');
        }

        async function runCompleteWorkflowTest() {
            resetTest();
            addResult('üöÄ Iniciando teste completo do workflow...', 'Executando todos os passos', 'info');
            
            for (let step = 1; step <= 4; step++) {
                await new Promise(resolve => setTimeout(resolve, 1000)); // Small delay between steps
                await testStep(step);
            }
            
            addResult('üéâ Teste completo finalizado!', 'Verifique os resultados acima', 'success');
        }

        function resetTest() {
            testResults = {};
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('results').style.display = 'none';
            
            for (let i = 1; i <= 4; i++) {
                updateStepStatus(i, 'pending');
            }
        }

        // Auto-run basic connectivity test on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                addResult('üåê Sistema de Teste Carregado', 'Pronto para executar testes do workflow completo', 'info');
            }, 500);
        });
    </script>
</body>
</html>