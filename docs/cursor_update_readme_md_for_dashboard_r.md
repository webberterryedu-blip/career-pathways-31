# Update readme.md for dashboard roles
_Exported on 9/8/2025 at 13:44:36 GMT+1 from Cursor (1.5.3)_

---

**User**

reescreva o readme.md C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\README.md  # Sua-Parte — Papéis dos Dashboards

Este documento descreve, de forma objetiva, o papel de cada dashboard no sistema.

---

## Dashboard do Administrador

O Administrador é responsável pela gestão global da plataforma. Seu painel permite:

- Importar o conteúdo oficial das reuniões (temas, leituras etc.) a partir de arquivos como PDFs.
- Gerenciar todas as congregações e seus instrutores.
- Monitorar o status geral e a saúde da plataforma.

---

## Dashboard do Instrutor

O Instrutor é o usuário final na congregação. Seu painel permite:

- Visualizar a programação das reuniões inserida pelo administrador.
- Cadastrar e gerenciar os estudantes da congregação.
- Fazer as designações das partes da reunião para os estudantes.
- Trabalhar offline, com sincronização dos dados quando a internet estiver disponível.
  Skip to content
Navigation Menu
RobertoAraujoSilva
sua-parte

Type / to search
Code
Issues
Pull requests
Actions
Projects
Security
Insights
Settings
sua-parte
Public template
RobertoAraujoSilva/sua-parte
Go to file
t
Name		
lovable-dev[bot]
lovable-dev[bot]
Fix: Resolve TypeScript errors
4358eb5
 · 
48 minutes ago
.github/workflows
fix(auth): resolve critical Supabase authentication and connection is…
last month
.kilocode
drop
last month
.kiro
feat: add sistema-ministerial verification system
3 weeks ago
audit
debugr
last month
backend
feat: add sistema-ministerial verification system
3 weeks ago
cypress
Atualização completa do sistema: README.md atualizado, novos testes …
3 weeks ago
docs
warp
13 hours ago
integration-test-reports
feat: add sistema-ministerial verification system
3 weeks ago
public
Fix build error and optimize service worker
4 hours ago
scripts
from laptop Qodo
3 weeks ago
src
Fix: Resolve TypeScript errors
48 minutes ago
supabase
feat: adicionar campos de metadados ao banco de dados (MCP-05.1)
3 weeks ago
test-autofix-reports
feat: add sistema-ministerial verification system
3 weeks ago
test-verification-reports
feat: add sistema-ministerial verification system
3 weeks ago
.env
Fix build error and optimize service worker
4 hours ago
.env.cypress
fix(auth): resolve critical Supabase authentication and connection is…
last month
.env.example
feat: adicionar campos de metadados ao banco de dados (MCP-05.1)
3 weeks ago
.gitignore
Implementação completa do Admin Dashboard com Backend integrado
3 weeks ago
.npmrc
Fix local development environment and dependency issues
last month
.nvmrc
fix: Resolve Rollup build issues for Render deployment
last month
ADMIN_DASHBOARD_INTEGRATION.md
Implementação completa do Admin Dashboard com Backend integrado
3 weeks ago
APPLY_THIS_SQL.sql
primeiro estudante
last month
AUTH_TROUBLESHOOTING.md
debug
last month
DEBUG_ADMIN_DASHBOARD.md
Implementação completa do Admin Dashboard com Backend integrado
3 weeks ago
DEPLOYMENT_AUTHORIZATION_FIX.md
from laptop Qodo
3 weeks ago
DOCUMENTACAO_COMPLETA.md
retrato
last month
GUIA_USUARIO.md
retrato
last month
PROGRAMAS_SETUP.md
debug
last month
QUICK_DEPLOYMENT_FIX.md
from laptop Qodo
3 weeks ago
REACT_HOOKS_ISSUE_FIX.md
qodo
3 weeks ago
README.md
Update README.md
4 hours ago
README_ESTUDANTES.md
Implementação completa do Admin Dashboard com Backend integrado
3 weeks ago
TASK_14_COMPLETION_SUMMARY.md
qodo
3 weeks ago
VERIFICATION_SYSTEM_GUIDE.md
qodo
3 weeks ago
VERIFICATION_SYSTEM_IMPLEMENTATION_COMPLETE.md
qodo
3 weeks ago
WARP.md
warp
13 hours ago
check_translations.js
feat: translate all pages to english
3 weeks ago
cleanup_estudantes.sql
Atualização completa do sistema: README.md atualizado, novos testes …
3 weeks ago
components.json
Use tech stack vite_react_shadcn_ts_20250728_minor
last month
convert_excel_to_json.py
Atualização completa do sistema: README.md atualizado, novos testes …
3 weeks ago
cypress.config.mjs
cypress
3 weeks ago
cypress.env.json
cypress
3 weeks ago
database_review.sql
tablet
last month
debug_congregation_query.sql
retrato
last month
eslint.config.js
Use tech stack vite_react_shadcn_ts_20250728_minor
last month
index.html
Updaten
last month
index_proposed-1755115111581.css
tablet
last month
migrate.js
tablet
last month
migrate.mjs
tablet
last month
package-lock.json
Update project template
4 hours ago
package.json
Update project template
4 hours ago
postcss.config.js
Use tech stack vite_react_shadcn_ts_20250728_minor
last month
process_estudantes.sql
Atualização completa do sistema: README.md atualizado, novos testes …
3 weeks ago
requirements.txt
Atualização completa do sistema: README.md atualizado, novos testes …
3 weeks ago
tailwind.config.ts
Updaten
last month
test-app-syntax.tsx
f5
last month
test-assignment-generation.js
🚀 CRÍTICO: Corrigido botão 'Pular e Ir para Dashboard' + Sistema comp…
last month
test-jw-parser.js
🚀 CRÍTICO: Corrigido botão 'Pular e Ir para Dashboard' + Sistema comp…
last month
tsconfig.app.json
debug
last month
tsconfig.app.tsbuildinfo
feat: add sistema-ministerial verification system
3 weeks ago
tsconfig.json
Use tech stack vite_react_shadcn_ts_20250728_minor
last month
tsconfig.node.json
debug
last month
tsconfig.node.tsbuildinfo
feat: add sistema-ministerial verification system
3 weeks ago
vite-env.d.ts
debug
last month
vite.config.ts
Update project template
4 hours ago
Repository files navigation
README
📚 Sistema Ministerial
🚀 Status: SISTEMA COMPLETO IMPLEMENTADO E FUNCIONANDO!
O Sistema Ministerial é uma plataforma completa para gerenciamento de materiais, programas e congregações, com Admin Dashboard integrado e Backend Node.js funcionando em tempo real.

✨ Funcionalidades Implementadas
🎯 Admin Dashboard (100% Funcional)
Interface administrativa completa com abas organizadas
Download automático de materiais da JW.org (PDF, JWPub, RTF, DAISY)
Gerenciamento de materiais e publicação para congregações
Monitoramento do sistema em tempo real
Sistema de debug para desenvolvimento
🔧 Backend Node.js (Porta 3001)
Servidor Express com APIs REST completas
Serviço JWDownloader para scraping e download da JW.org
Sistema de cron para downloads automáticos
Integração com Supabase para banco de dados
Health checks e monitoramento do sistema
🌐 Frontend React (Porta 8081)
Interface responsiva com TailwindCSS e Shadcn/ui
Sistema de autenticação integrado com Supabase
Controle de acesso por roles (admin, instrutor, estudante)
Dashboard unificado para todos os usuários
🧪 Testes Automatizados
Testes Cypress para validação completa do sistema
Cobertura de funcionalidades principais
Testes de integração frontend-backend
🚀 Como Usar o Sistema
🎯 Opção 1 - Iniciar Tudo de Uma Vez (RECOMENDADO)
npm run dev:all
Resultado: Inicia ambos os servidores simultaneamente

Backend: Porta 3000
Frontend: Porta 8080
🔧 Opção 2 - Iniciar Separadamente
# Terminal 1 - Backend
npm run dev:backend-only

# Terminal 2 - Frontend  
npm run dev:frontend-only
📱 Acessar o Admin Dashboard
URL: http://localhost:8080/admin
Login: amazonwebber007@gmail.com / admin123
🏗️ Arquitetura do Sistema
sua-parte/
├── 📁 src/                          # Frontend React
│   ├── pages/AdminDashboard.tsx     # ✅ Dashboard Admin
│   ├── pages/Auth.tsx               # ✅ Sistema de Login
│   ├── pages/Programas.tsx          # ✅ Gerenciamento de Programas
│   └── contexts/AuthContext.tsx     # ✅ Contexto de Autenticação
├── 📁 backend/                      # ✅ Backend Node.js
│   ├── server.js                    # ✅ Servidor Principal
│   ├── services/jwDownloader.js     # ✅ Download JW.org
│   ├── routes/admin.js              # ✅ APIs Admin
│   └── config/mwbSources.json      # ✅ URLs JW.org
├── 📁 cypress/                      # ✅ Testes Automatizados
│   └── e2e/admin-dashboard-integration.cy.ts
├── 📁 supabase/                     # ✅ Migrações e Banco
│   └── migrations/
└── 📁 docs/Oficial/                 # ✅ Materiais Baixados
🔍 Funcionalidades Detalhadas
🎯 Scripts Unificados (NOVO!)
npm run dev:all - Inicia backend e frontend simultaneamente
npm run dev:backend-only - Apenas o backend (porta 3000)
npm run dev:frontend-only - Apenas o frontend (porta 8080)
Desenvolvimento simplificado com um único comando
✅ Admin Dashboard
Visão Geral: Estatísticas do sistema e ações rápidas
Downloads: Configuração e verificação de atualizações da JW.org
Materiais: Lista de materiais baixados e seus status
Publicação: Sistema de publicação para congregações
🎯 Explicação Completa dos Dashboards
🏠 1. Dashboard Principal (Dashboard Geral)
📍 URL: /dashboard ou /
👥 Usuários: Instrutores (não-admin)
🎯 Finalidade: Visão geral da congregação, gerenciamento de estudantes, visualização de programas publicados, controle de designações e partes, estatísticas básicas de participação
🔧 Funcionalidades: Lista de estudantes sob responsabilidade, programas ministeriais disponíveis, calendário de reuniões, designações pendentes e realizadas, relatórios de participação
👑 2. Admin Dashboard (Dashboard Administrativo)
📍 URL: /admin
👥 Usuários: Administradores do sistema
🎯 Finalidade: Controle total do sistema, gerenciamento de materiais da JW.org, administração de congregações, configuração de usuários e permissões, monitoramento do sistema
🔧 Funcionalidades Detalhadas:
📊 Visão Geral: Estatísticas do sistema, status dos serviços, ações rápidas
📥 Downloads: Verificar Novas Versões (scraping automático da JW.org), download de materiais (PDF, EPUB, JWPub, RTF, DAISY), configuração de URLs e idiomas, logs de download
📚 Materiais: Lista de materiais baixados, status de processamento, organização por idioma e período, metadados dos arquivos
📢 Publicação: Publicar materiais para congregações, controle de acesso por região, agendamento de publicações, histórico de publicações
🏥 Monitoramento: Status do backend, conexão com banco de dados, logs do sistema, health checks
👨‍🎓 3. Dashboard do Estudante
📍 URL: /estudante/{id}
👥 Usuários: Estudantes individuais
🎯 Finalidade: Acesso limitado aos materiais publicados, visualização de programas ministeriais, histórico pessoal de participação, materiais de estudo disponíveis
🔧 Funcionalidades: Materiais publicados para sua congregação, programas ministeriais disponíveis, histórico de designações, perfil pessoal básico, acesso somente leitura
👨‍👩‍👧‍👦 4. Portal Familiar
📍 URL: /portal-familiar
👥 Usuários: Membros de família
🎯 Finalidade: Acesso familiar aos materiais, suporte para estudo em casa, materiais complementares de estudo
🔧 Funcionalidades: Materiais de estudo em família, recursos complementares, acesso limitado e controlado
🔐 5. Sistema de Autenticação
📍 URL: /auth
👥 Usuários: Todos os usuários
🎯 Finalidade: Login e registro de usuários, controle de acesso baseado em roles, gerenciamento de sessões
🔧 Funcionalidades: Login com email/senha, registro de novos usuários, recuperação de senha, controle de sessão
🔄 Fluxo de Funcionamento
1. Administrador:
Login → Admin Dashboard → Downloads → Materiais → Publicação
2. Instrutor:
Login → Dashboard Principal → Gerenciar Estudantes → Ver Programas
3. Estudante:
Login → Dashboard Estudante → Ver Materiais Publicados
🎨 Características Visuais
Admin Dashboard:
Interface administrativa com abas organizadas
Cores azuis para transmitir confiança
Loading states elegantes (implementados recentemente)
Debug info para desenvolvimento
Dashboard Principal:
Interface limpa e focada em tarefas
Cores neutras para uso prolongado
Componentes reutilizáveis para consistência
Dashboard Estudante:
Interface simples e intuitiva
Acesso limitado e controlado
Foco em conteúdo e não em funcionalidades
🚀 Integração com Backend
Admin Dashboard:
APIs completas para todas as funcionalidades
Download automático da JW.org
Gerenciamento de arquivos e metadados
Sistema de cron para tarefas automáticas
Dashboard Principal:
APIs de consulta para dados da congregação
Integração com Supabase para dados em tempo real
Sistema de notificações para atualizações
Dashboard Estudante:
APIs de leitura para materiais publicados
Controle de acesso baseado em RLS
Cache inteligente para performance
🎯 Arquitetura dos Dashboards
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Admin         │    │   Instrutor     │    │   Estudante     │
│   Dashboard     │    │   Dashboard     │    │   Dashboard     │
│                 │    │                 │    │                 │
│ • Downloads     │    │ • Estudantes    │    │ • Materiais     │
│ • Materiais     │    │ • Programas     │    │ • Programas     │
│ • Publicação    │    │ • Designações   │    │ • Histórico     │
│ • Monitoramento │    │ • Relatórios    │    │ • Perfil        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Backend Node.js                              │
│              • APIs REST                                        │
│              • JWDownloader                                     │
│              • Supabase Integration                             │
│              • File Management                                  │
└─────────────────────────────────────────────────────────────────┘
🌟 Benefícios do Sistema
Para Administradores:
Controle total sobre materiais e usuários Mostra a Programacao completa
Automação de downloads da JW.org
Monitoramento em tempo real
Para Instrutores:
Gerenciamento eficiente de estudantes puxa do Dashboard do Admin a programacao disponivel para designar os estudantes localmenete.
Acesso rápido a materiais atualizados
Controle de designações e programas
Para Estudantes:
Acesso organizado aos materiais
Interface simples e intuitiva
Materiais sempre atualizados
Monitoramento: Status do sistema e logs
✅ Sistema de Downloads
URLs configuradas para JW.org (PT-BR e EN-US)
Download automático de múltiplos formatos
Organização por idioma e período
Verificação de atualizações em tempo real
✅ Controle de Acesso
Admin: Acesso completo ao sistema
Instrutor: Gerenciamento de programas e materiais
Estudante: Visualização de materiais publicados
🧪 Executar Testes
Testes Cypress
# Executar todos os testes
npm run cypress:run

# Teste específico do Admin Dashboard
npm run cypress:run --spec "cypress/e2e/admin-dashboard-integration.cy.ts"
Testes Disponíveis
✅ Carregamento do Dashboard
✅ Conexão com Backend
✅ Verificação de Atualizações
✅ Listagem de Materiais
✅ Teste de Perfil + Backend
✅ Monitoramento do Sistema
✅ Debug Info
✅ Funcionalidade Completa de Download
🔧 Configuração e Desenvolvimento
📋 Scripts Disponíveis
# 🎯 Comandos Principais
npm run dev:all              # Inicia backend + frontend simultaneamente
npm run dev:backend-only     # Apenas o backend (porta 3000)
npm run dev:frontend-only    # Apenas o frontend (porta 8080)

# 🔧 Comandos Originais
npm run dev                  # Frontend apenas (como antes)
npm run build                # Build de produção
npm run cypress:run          # Testes automatizados
Variáveis de Ambiente
# Backend (.env)
PORT=3000
NODE_ENV=development
DOCS_PATH=../docs/Oficial
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_supabase_key

# Frontend
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_ANON_KEY=your_supabase_key
Dependências Principais
// Backend
{
  "express": "^4.18.2",
  "node-cron": "^3.0.3",
  "node-fetch": "^3.3.2",
  "cheerio": "^1.0.0-rc.12",
  "fs-extra": "^11.1.1",
  "@supabase/supabase-js": "^2.38.4"
}

// Frontend
{
  "react": "^18.2.0",
  "typescript": "^5.0.2",
  "tailwindcss": "^3.3.0",
  "@supabase/supabase-js": "^2.38.4"
}
📊 Status das Funcionalidades
Funcionalidade	Status	Descrição
🎯 Admin Dashboard	✅ 100%	Interface completa e funcional
🔧 Backend Node.js	✅ 100%	Servidor rodando e APIs ativas
📥 Download JW.org	✅ 100%	Sistema automático funcionando
🔐 Autenticação	✅ 100%	Login e controle de acesso
🧪 Testes Cypress	✅ 100%	Validação automatizada
📱 Interface	✅ 100%	Responsiva e moderna
🗄️ Banco de Dados	✅ 100%	Supabase configurado
🚨 Troubleshooting
🎯 Problemas com o Sistema Unificado
# Se o comando unificado não funcionar
npm run dev:all

# Alternativa: iniciar separadamente
npm run dev:backend-only    # Terminal 1
npm run dev:frontend-only   # Terminal 2
Backend não inicia
# Opção 1: Usar o script unificado
npm run dev:backend-only

# Opção 2: Comando tradicional
cd backend
npm install
npm run dev
Frontend não conecta ao backend
# Verificar se backend está rodando
curl http://localhost:3000/api/status
Problemas de autenticação
Verificar credenciais no Supabase
Confirmar role do usuário no banco
Verificar console do navegador para logs
📚 Documentação Adicional
ADMIN_DASHBOARD_INTEGRATION.md - Guia completo do Admin Dashboard
DEBUG_ADMIN_DASHBOARD.md - Debug e troubleshooting
README_ESTUDANTES.md - Sistema de estudantes
docs/SISTEMA-UNIFICADO.md - Arquitetura unificada
🎯 Próximos Passos
✅ Concluído
 Backend Node.js implementado
 Admin Dashboard funcional
 Sistema de downloads automático
 Testes automatizados
 Documentação completa
 Scripts unificados para desenvolvimento
🚀 Em Desenvolvimento
 Interface mais polida
 Relatórios avançados
 Notificações em tempo real
 Sistema de backup automático
🏆 Resultado Final
🎉 O Sistema Ministerial está 100% funcional!

✅ Admin Dashboard integrado e funcionando
✅ Backend rodando e processando downloads
✅ Download automático da JW.org implementado
✅ Testes automatizados funcionando
✅ Documentação completa criada
✅ Código versionado e sincronizado no GitHub
✅ Scripts unificados para desenvolvimento simplificado
🚀 Sistema pronto para uso em produção com desenvolvimento otimizado!

👥 Contribuição
Desenvolvedor Principal
Roberto Araujo da Silva - Arquitetura e implementação completa
Como Contribuir
Fork o repositório
Crie uma branch para sua feature
Commit suas mudanças
Push para a branch
Abra um Pull Request
📞 Suporte
Issues: GitHub Issues
Documentação: Arquivos markdown no repositório
Debug: Painel amarelo no Admin Dashboard (modo desenvolvimento)
📄 Licença
Este projeto está sob a licença MIT. Veja o arquivo LICENSE para mais detalhes.

🌟 Sistema Ministerial - Transformando a gestão de materiais e programas!

About
sua-parte.lovable.app/
Resources
 Readme
 Activity
Stars
 0 stars
Watchers
 0 watching
Forks
 0 forks
Releases
No releases published
Create a new release
Packages
No packages published
Publish your first package
Contributors
5
@RobertoAraujoSilva
@Webber-Lubenham
@lovable-dev[bot]
@google-labs-jules[bot]
@franklinmarceloferrer-cmd
Languages
TypeScript
74.1%
 
JavaScript
14.9%
 
HTML
5.5%
 
PLpgSQL
3.2%
 
CSS
1.0%
 
Batchfile
0.6%
 
Other
0.7%
Footer
© 2025 GitHub, Inc.
Footer navigation
Terms
Privacy
Security
Status
GitHub Community
Docs
Contact
Manage cookies
Do not share my personal information


---

**Cursor**

I'll open the current `README.md` to understand its content and then replace it with a cleaner, security-conscious version focused on the roles of each dashboard, plus concise setup/use sections.

I'll check the project scripts and ports to ensure the README reflects the actual commands and defaults, then I'll replace the README with a comprehensive, security-conscious version that covers roles, setup, scripts, env vars, and references.

I'll quickly confirm the dev server port and any custom settings in `vite.config.ts` to ensure the README's URLs and ports are correct, then I'll update `README.md` accordingly.

I’m going to replace the current README with a comprehensive, security-conscious version including roles of each dashboard, setup, scripts, env vars, ports, and links.

```markdown
# Sua-Parte — Sistema Ministerial

O Sua-Parte é uma plataforma para gestão de materiais, programas e congregações, com Frontend React (Vite) e Backend Node.js (Express). Este documento descreve os papéis dos dashboards, além de trazer instruções objetivas de instalação e uso.

## Papéis dos Dashboards

### Admin Dashboard (Administradores)
- Importar e organizar materiais oficiais (PDF, JWPub, etc.).
- Gerenciar congregações, instrutores e permissões.
- Monitorar saúde do sistema e serviços do backend.

### Dashboard do Instrutor (Congregações)
- Visualizar a programação publicada pelo admin.
- Cadastrar e gerenciar estudantes da congregação.
- Designar partes da reunião aos estudantes.
- Operar offline com sincronização quando voltar a ficar online.

### Dashboard do Estudante (Leitura/Acompanhamento)
- Acessar materiais publicados para sua congregação.
- Consultar designações, histórico e programas disponibilizados.
- Acesso com perfil restrito (somente leitura das publicações).

## Tecnologias
- Frontend: React + TypeScript, Vite, TailwindCSS, shadcn/ui
- Backend: Node.js + Express, cron, integração com Supabase
- Testes: Cypress E2E

## Instalação
1. Clonar o repositório
```bash
git clone https://github.com/RobertoAraujoSilva/sua-parte.git
cd sua-parte
```

2. Instalar dependências (raiz)
```bash
npm install
```

3. Variáveis de ambiente
- Crie um arquivo `.env` na raiz (frontend) e outro em `backend/.env` se necessário.
- Exemplo (ajuste para seu ambiente — não compartilhe chaves reais):

Frontend (.env)
```env
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
```

Backend (backend/.env)
```env
PORT=3001
NODE_ENV=development
DOCS_PATH=../docs/Oficial
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_supabase_service_or_anon_key
```

## Execução
- Iniciar frontend e backend juntos (recomendado)
```bash
npm run dev:all
```

- Iniciar apenas o backend (porta padrão 3001)
```bash
npm run dev:backend-only
```

- Iniciar apenas o frontend (porta padrão 8080)
```bash
npm run dev:frontend-only
```

Portas padrão
- Frontend (Vite): http://localhost:8080
- Backend (Express): http://localhost:3001

## Acesso rápido
- Admin Dashboard: `http://localhost:8080/admin`
- Dashboard do Instrutor: `http://localhost:8080/` ou `http://localhost:8080/dashboard`
- Estudante: acesso controlado conforme publicação/perfil

## Testes (Cypress)
- Executar todos os testes
```bash
npm run cypress:run
```

- Exemplos de testes específicos
```bash
npm run test:audit
npm run test:auth
npm run test:programs
```

## Segurança e Boas Práticas
- Não exponha chaves ou credenciais no frontend; use variáveis de ambiente.
- Garanta RLS (Row Level Security) no Supabase e privilégios mínimos por papel.
- Trate erros em todas as chamadas de API e aplique early return/guard clauses.
- Mantenha componentes enxutos, reutilizáveis e consistentes com Tailwind/shadcn.

## Documentação adicional
- `ADMIN_DASHBOARD_INTEGRATION.md` — Integração e fluxo do Admin Dashboard
- `DEBUG_ADMIN_DASHBOARD.md` — Dicas de debug
- `README_ESTUDANTES.md` — Guia do módulo de estudantes
- Pasta `docs/` — Materiais e documentação complementar

## Licença
Projeto sob licença MIT. Consulte `LICENSE` para mais detalhes.

```

I opened the current README, verified scripts/ports in the root and backend configs, and replaced the README with a concise, security-conscious document covering dashboard roles, setup, scripts, env vars, ports, and references.

### Novo README aplicado
- Foco nos papéis dos dashboards (Admin, Instrutor, Estudante).
- Instruções objetivas de instalação e execução:
  - `npm run dev:all`, `npm run dev:backend-only`, `npm run dev:frontend-only`.
  - Portas: Frontend 8080 (Vite), Backend 3001 (Express).
- Variáveis de ambiente separadas por frontend e backend, sem expor credenciais.
- Seção de testes Cypress com comandos comuns.
- Boas práticas de segurança e arquitetura (RLS no Supabase, guard clauses, Tailwind/shadcn).
- Links para documentação adicional em arquivos existentes.

- Acesse `README.md` para ver o conteúdo atualizado.

---

**User**

esta correto? vai funcionar com "C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\WhatsApp Image 2025-08-14 at 19.44.07 (1).jpeg"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\WhatsApp Image 2025-08-14 at 19.44.07.jpeg"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\estudantes_ficticios.xlsx"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\estudantes_rows.sql"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_E_202507.pdf"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_E_202509.pdf"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_E_202511.pdf"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_T_202507.daisy.zip"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_T_202509.daisy.zip"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_T_202509.jwpub"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_T_202511.jwpub"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\S-38_E.rtf"

---

**Cursor**

Sim — com sua estrutura atual, o backend serve tudo que estiver em `docs/Oficial` via rota `/materials`. Esses arquivos estarão acessíveis se os nomes forem usados corretamente (com encoding para espaços e parênteses).

Exemplos de URL (backend na porta 3001):
- JPEG com espaços/parênteses:
  - `http://localhost:3001/materials/WhatsApp%20Image%202025-08-14%20at%2019.44.07%20(1).jpeg`
  - `http://localhost:3001/materials/WhatsApp%20Image%202025-08-14%20at%2019.44.07.jpeg`
- Excel:
  - `http://localhost:3001/materials/estudantes_ficticios.xlsx`
- SQL:
  - `http://localhost:3001/materials/estudantes_rows.sql`
- PDFs:
  - `http://localhost:3001/materials/mwb_E_202507.pdf`
  - `http://localhost:3001/materials/mwb_E_202509.pdf`
  - `http://localhost:3001/materials/mwb_E_202511.pdf`
- DAISY/JWPUB:
  - `http://localhost:3001/materials/mwb_T_202507.daisy.zip`
  - `http://localhost:3001/materials/mwb_T_202509.daisy.zip`
  - `http://localhost:3001/materials/mwb_T_202509.jwpub`
  - `http://localhost:3001/materials/mwb_T_202511.jwpub`
- RTF:
  - `http://localhost:3001/materials/S-38_E.rtf`

Observações rápidas:
- Use `%20` para espaços e mantenha parênteses como `(` e `)` (normalmente funcionam, mas se preferir, evite-os renomeando os arquivos).
- Atualmente, o backend usa o caminho fixo `../docs/Oficial` (já compatível). A variável `DOCS_PATH` mencionada no README não está sendo lida pelo `server.js` neste momento.
- CORS está habilitado, então o frontend pode buscar esses arquivos sem bloqueio.

---

**User**

tem certeza?

---

**Cursor**

Sim. Confirmado no backend:

- Porta: 3001
- Rota estática: `/materials` servindo `../docs/Oficial` a partir de `backend`:
```12:31:backend/server.js
app.use('/materials', express.static(path.join(__dirname, '../docs/Oficial')));
```

Logo, os exemplos funcionam nessas URLs:
- `http://localhost:3001/materials/WhatsApp%20Image%202025-08-14%20at%2019.44.07%20(1).jpeg`
- `http://localhost:3001/materials/WhatsApp%20Image%202025-08-14%20at%2019.44.07.jpeg`
- `http://localhost:3001/materials/estudantes_ficticios.xlsx`
- `http://localhost:3001/materials/estudantes_rows.sql`
- `http://localhost:3001/materials/mwb_E_202507.pdf`
- `http://localhost:3001/materials/mwb_E_202509.pdf`
- `http://localhost:3001/materials/mwb_E_202511.pdf`
- `http://localhost:3001/materials/mwb_T_202507.daisy.zip`
- `http://localhost:3001/materials/mwb_T_202509.daisy.zip`
- `http://localhost:3001/materials/mwb_T_202509.jwpub`
- `http://localhost:3001/materials/mwb_T_202511.jwpub`
- `http://localhost:3001/materials/S-38_E.rtf`

Dicas rápidas:
- Use `%20` para espaços. Parênteses em geral funcionam; se preferir, renomeie para evitar.
- A env `DOCS_PATH` não é lida no `server.js` atual; o caminho está fixo e já aponta para `docs/Oficial`.

Se quiser validar agora: abra uma dessas URLs no navegador com o backend rodando (`npm run dev:backend-only` ou `npm run dev:all`).

```javascript
app.use('/materials', express.static(path.join(__dirname, '../docs/Oficial')));
```

---

**User**

Para que eu possa planejar os próximos passos de desenvolvimento com precisão, preciso entender melhor como cada painel (dashboard) irá funcionar na prática. Com base no que você me disse, tenho algumas perguntas:

---

### Dashboard do Administrador

* Como você visualiza a interface do administrador para a importação do conteúdo? Será um simples botão de upload de PDF, ou ele terá a opção de visualizar o conteúdo importado e fazer pequenas edições antes de salvá-lo no banco de dados?
* O conteúdo importado será universal para todas as congregações, ou o administrador terá que selecionar para qual congregação o programa se destina?

---

### Dashboard do Instrutor

* Como a programação da reunião (importada pelo administrador) será apresentada ao instrutor? Ele verá uma lista de semanas, um calendário ou outro formato?
* Você mencionou que o sistema do instrutor funcionará offline. Isso significa que ele poderá fazer todas as designações e gerenciar os estudantes mesmo sem internet? As alterações serão salvas localmente e sincronizadas quando ele se conectar novamente?

---

### Portal do Estudante

* Após o instrutor fazer a designação, como o estudante será notificado sobre sua parte? Você prefere uma notificação no próprio painel, um e-mail ou uma notificação via WhatsApp?
* O que mais o estudante poderá fazer em seu painel além de ver a sua designação? Ele terá acesso aos materiais de estudo ou a um histórico de partes que já fez?

Qual é a sua visão sobre esses pontos?

---

**Cursor**

### Dashboard do Administrador
- Importação de conteúdo
  - **Upload + pré-visualização**: botão para importar (PDF/JWPub/RTF). Após parse, exibe um preview estruturado (semanas, partes S-38, textos) antes de salvar.
  - **Edição leve**: permitir ajustes pontuais (títulos, leitura, tempos, observações) e correção de parsing, com controle de versão.
  - **Validação**: checagens (semana duplicada, campos obrigatórios, idioma/período).
- Escopo de publicação
  - **Padrão: universal** (todas as congregações).
  - **Opcional: segmentação** por congregação/idioma/região e agendamento de publicação (data/hora).
  - Histórico de publicações e rollback.

### Dashboard do Instrutor
- Apresentação da programação
  - **Lista de semanas** (padrão) com filtro por mês/idioma e status.
  - Alternativa: **calendário** (toggle) para visão rápida por data.
  - Acesso aos detalhes de cada parte S-38, com status de designação por estudante.
- Offline-first e sincronização
  - **Sim**: cadastrar/editar estudantes, criar/alterar designações, registrar observações, tudo offline.
  - Armazenamento local: **IndexedDB** + Service Worker; fila de operações para sync quando online.
  - Resolução de conflitos: “last-write-wins” por padrão + avisos quando houver divergência remota.
  - Indicadores: status de sincronização, contador de pendências e botão “Sincronizar agora”.

### Portal do Estudante
- Notificações
  - **In-app**: badges e toasts com centro de notificações.
  - Opcional: **e-mail** (configurável) e **WhatsApp** (se autorizado e com integração posterior).
  - Confirmação de leitura/recebimento (ack).
- Funcionalidades
  - **Minhas designações**: próximas/atuais, instruções, horário, local, materiais anexos.
  - **Materiais de estudo**: link seguro para PDFs/JWPub/RTF publicados pelo admin.
  - **Histórico**: partes realizadas, datas e feedback (se o instrutor registrar).
  - Perfil básico (sem edição de permissões) e política de acesso somente-leitura a programas.

### Observações de arquitetura/segurança
- RLS no Supabase com papéis: admin, instrutor, estudante; acesso sempre por congregação.
- Auditoria de mudanças de designações e publicações.
- Erros: mensagens amigáveis + fail-fast; sincronização resiliente.
- UI consistente: Tailwind + shadcn/ui; componentes reutilizáveis; arquivos curtos.

Se quiser, eu detalho modelos de dados (programa, partes, designações), fluxo de sincronização e telas com wireframes rápidos.

---

**User**

isso esta de acordo com sua resposta? 

---

**Cursor**

Sim, está alinhado ao que respondi — cobre papéis dos dashboards, instalação, execução, portas, testes e práticas de segurança.

Pequenas diferenças que vale ajustar quando avançarmos:
- Importação com pré-visualização/edição leve (Admin): não está descrita no README; está na resposta de visão. Podemos adicionar uma subseção “Fluxo de importação” depois.
- Offline-first (Instrutor): o README cita offline de forma breve; na visão detalhei IndexedDB/Service Worker e fila de sincronização. Podemos incluir uma subseção “Modo offline e sincronização”.
- Notificações do Estudante: o README não entra em e-mail/WhatsApp/ack; podemos acrescentar em “Portal do Estudante”.
- DOCS_PATH: o README lista `DOCS_PATH`, mas o `backend/server.js` usa caminho fixo `../docs/Oficial`. Se quiser usar env, precisamos ler `process.env.DOCS_PATH` ali. Quer que eu faça esse ajuste?

---

**User**

Excelente estrutura de README 👌. O documento já está claro e organizado. Vou sugerir alguns **aprimoramentos** para deixá-lo ainda mais completo e fácil de usar no dia a dia do projeto:

---

### 🔧 Sugestões de melhoria

1. **Papéis de usuários mais detalhados**

   * No *Dashboard do Estudante*, incluir que ele também pode receber **notificações automáticas** (e-mail/WhatsApp) e acessar **instruções práticas** da parte.
   * No *Dashboard do Instrutor*, reforçar que pode **exportar relatórios em PDF/Excel** com designações.

2. **Fluxo de dados**
   Adicionar um diagrama simples (texto ASCII ou link para imagem) mostrando:

   ```
   Admin importa programas → Instrutor designa estudantes → Estudante acessa sua parte
   ```

3. **Offline-first**
   No trecho do *Instrutor*, detalhar:

   > "As alterações feitas offline são armazenadas localmente e sincronizadas automaticamente quando a internet voltar, evitando perda de dados."

4. **Banco de dados (Supabase)**
   Criar seção curta listando as principais tabelas e entidades:

   * `estudantes`
   * `designacoes`
   * `congregacoes`
   * `programas`

5. **Seção de Deploy**
   Adicionar instruções básicas para publicação:

   * Frontend em **Vercel ou Netlify**
   * Backend em **Railway, Render ou Supabase Edge Functions**

6. **Seção "Doações / Apoio"** (já falamos disso)
   Como o projeto não cobra taxa fixa, pode-se adicionar no final:

   > "Este sistema é oferecido gratuitamente. Caso queira apoiar o desenvolvimento, utilize o QR Code de doação Pix disponível no portal do estudante."

---

👉 Pergunta: você quer que eu **aplique já essas melhorias no README.md** (reescrevendo e expandindo), ou prefere que eu crie um **novo arquivo `README_EXTENDIDO.md`** para servir como documentação avançada?


---

**Cursor**

Recomendo manter o README atual enxuto e criar um `README_EXTENDIDO.md` com os detalhes (papéis avançados, fluxo de dados, offline-first, modelo de dados, deploy e doações). Assim preservamos a clareza do README principal.

Quer que eu crie agora o `README_EXTENDIDO.md` com as melhorias sugeridas?

---

**User**

sim

---

**Cursor**

I'll create a new `README_EXTENDIDO.md` with the advanced documentation you requested: detailed user roles, data flow diagram, offline-first behavior, database entities, deployment options, and donations.

```markdown
*** Begin Patch
*** Add File: README_EXTENDIDO.md
+# Sua-Parte — Documentação Estendida

Este documento complementa o `README.md` com detalhes operacionais para planejamento e evolução do sistema.

## Papéis e Capacidades por Dashboard

### Admin Dashboard
- Importar materiais oficiais (PDF, JWPub, RTF) com pré-visualização estruturada por semana/parte.
- Edição leve após importação: títulos, tempos, observações e correções de parsing.
- Publicação universal (todas as congregações) ou segmentada por congregação/idioma/região, com agendamento.
- Histórico e rollback de publicações; monitoramento de serviços do backend.

### Dashboard do Instrutor
- Visualização da programação: lista de semanas (padrão) ou calendário (toggle), filtros por mês/idioma.
- Gestão de estudantes e designações por parte (S-38), com notas e status.
- Exportação de relatórios de designações em PDF/Excel.
- Offline-first: trabalho completo offline; sincronização automática quando reconectar.

### Portal do Estudante
- Notificações de designação: in-app (toasts/central) e opcional por e-mail/WhatsApp (mediante consentimento e configuração).
- Acesso a instruções práticas da parte e materiais de estudo disponibilizados pelo admin.
- Histórico de partes realizadas e confirmação de leitura/recebimento (ack) opcional.

## Fluxo de Dados (alto nível)
```
Admin importa programas  ->  Publica (todas/segmentado)  ->  Instrutor recebe semanas
Instrutor designa estudantes  ->  Publica designações  ->  Estudante é notificado e acessa
```

## Offline-first e Sincronização (Instrutor)
- Armazenamento local: IndexedDB + Service Worker para dados e fila de operações.
- Alterações offline (estudantes/designações/notas) são persistidas localmente e sincronizadas assim que houver conexão.
- Estratégia de conflitos: last-write-wins por padrão, com aviso quando houver divergências.
- Indicadores: status de sincronização, fila pendente e ação manual “Sincronizar agora”.

## Modelo de Dados (Supabase)
- Tabelas principais (nomes ilustrativos; alinhar com migrações existentes):
  - `congregacoes`: congregação e metadados (região/idioma).
  - `profiles`: usuários com `role` (admin/instrutor/estudante) e congregação.
  - `programas`: semanas/partes publicadas (fonte oficial importada), idioma/período.
  - `estudantes`: cadastro local por congregação, status, observações.
  - `designacoes`: vínculo estudante-parte-semana, status e notas.
- Segurança: RLS por congregação e papel; privilégios mínimos; auditoria de mudanças sensíveis.

## Materiais Estáticos (Backend)
- O backend serve `docs/Oficial` via `/materials` (porta padrão 3001).
- Exemplos: `http://localhost:3001/materials/mwb_E_202507.pdf`.
- Recomendações: evitar espaços/parênteses em nomes; quando necessário, usar encoding na URL (`%20`).

## Deploy (Visão Geral)
- Frontend (Vite/React):
  - Vercel ou Netlify (build `npm run build`, diretório `dist/`).
  - Configurar `VITE_SUPABASE_URL` e `VITE_SUPABASE_ANON_KEY` em variáveis de ambiente.
- Backend (Express):
  - Railway ou Render. Definir `PORT`, `SUPABASE_URL`, `SUPABASE_ANON_KEY` e apontar `DOCS_PATH` se parametrizado.
  - Alternativa: converter rotas para Supabase Edge Functions quando aplicável (leitura/publicação).
- Banco (Supabase):
  - Aplicar migrações, habilitar RLS, revisar políticas por papel, e criar chaves de serviço com escopo mínimo.

## Relatórios e Exportações (Instrutor)
- Exportar designações por semana/mês em PDF/Excel.
- Padrão visual consistente (cabeçalho com congregação, período e legenda de status).
- Opção de incluir observações e tempos estimados.

## Notificações (Estudante)
- In-app: centro de notificações, toasts e contadores.
- E-mail: templates simples (assíncrono; opt-in).
- WhatsApp: integração opcional futura (requer consentimento e provedor API conforme LGPD).

## Boas Práticas e Segurança
- Não expor segredos no frontend; usar env vars. Rotas sensíveis protegidas por RLS.
- Guard clauses e fail-fast em APIs; logs com correlação de requisições.
- Componentes e hooks curtos, reutilizáveis; Tailwind + shadcn/ui para consistência.

## Roadmap Sugerido
- [ ] Parametrizar `DOCS_PATH` no backend via `process.env.DOCS_PATH`.
- [ ] Implementar preview e edição leve na importação do Admin.
- [ ] Tabela/roteiro de sincronização offline (fila, replays, conflitos).
- [ ] Exportações PDF/Excel no Instrutor.
- [ ] Notificações e-mail (primeira etapa) e in-app com ack.
- [ ] Guia de deploy com exemplos práticos (Railway/Render + Vercel/Netlify).

## Doações / Apoio
> Este sistema é oferecido gratuitamente. Caso queira apoiar o desenvolvimento, utilize o QR Code de doação Pix disponível no portal do estudante.

---
Para dúvidas técnicas específicas, consulte também: `ADMIN_DASHBOARD_INTEGRATION.md`, `DEBUG_ADMIN_DASHBOARD.md` e `README_ESTUDANTES.md`.
*** End Patch
```

Creating `README_EXTENDIDO.md` with advanced documentation (roles, data flow, offline, DB entities, deploy, donations).

```markdown
*** Begin Patch
*** Add File: README_EXTENDIDO.md
+# Sua-Parte — Documentação Estendida

Este documento complementa o README.md com detalhes operacionais para planejamento e evolução do sistema.

## Papéis e Capacidades por Dashboard

### Admin Dashboard
- Importar materiais oficiais (PDF, JWPub, RTF) com pré-visualização por semana/parte.
- Edição leve após importação: títulos, tempos, observações e correções de parsing.
- Publicação universal (todas as congregações) ou segmentada por congregação/idioma/região, com agendamento.
- Histórico e rollback de publicações; monitoramento de serviços do backend.

### Dashboard do Instrutor
- Visualização da programação: lista de semanas (padrão) ou calendário (toggle), filtros por mês/idioma.
- Gestão de estudantes e designações por parte (S-38), com notas e status.
- Exportação de relatórios de designações em PDF/Excel.
- Offline-first: trabalho completo offline; sincronização automática quando reconectar.

### Portal do Estudante
- Notificações de designação: in-app (toasts/central) e opcional por e-mail/WhatsApp (mediante consentimento e configuração).
- Acesso a instruções práticas da parte e materiais de estudo disponibilizados pelo admin.
- Histórico de partes realizadas e confirmação de leitura/recebimento (ack) opcional.

## Fluxo de Dados (alto nível)
```
Admin importa programas  ->  Publica (todas/segmentado)  ->  Instrutor recebe semanas
Instrutor designa estudantes  ->  Publica designações  ->  Estudante é notificado e acessa
```

## Offline-first e Sincronização (Instrutor)
- Armazenamento local: IndexedDB + Service Worker para dados e fila de operações.
- Alterações offline (estudantes/designações/notas) são persistidas localmente e sincronizadas assim que houver conexão.
- Estratégia de conflitos: last-write-wins por padrão, com aviso quando houver divergências.
- Indicadores: status de sincronização, fila pendente e ação manual "Sincronizar agora".

## Modelo de Dados (Supabase)
- Tabelas principais (nomes ilustrativos; alinhar com migrações existentes):
  - `congregacoes`: congregação e metadados (região/idioma).
  - `profiles`: usuários com `role` (admin/instrutor/estudante) e congregação.
  - `programas`: semanas/partes publicadas (fonte oficial importada), idioma/período.
  - `estudantes`: cadastro local por congregação, status, observações.
  - `designacoes`: vínculo estudante-parte-semana, status e notas.
- Segurança: RLS por congregação e papel; privilégios mínimos; auditoria de mudanças sensíveis.

## Materiais Estáticos (Backend)
- O backend serve `docs/Oficial` via `/materials` (porta padrão 3001).
- Exemplos: `http://localhost:3001/materials/mwb_E_202507.pdf`.
- Recomendações: evitar espaços/parênteses em nomes; quando necessário, usar encoding na URL (`%20`).

## Deploy (Visão Geral)
- Frontend (Vite/React):
  - Vercel ou Netlify (build `npm run build`, diretório `dist/`).
  - Configurar `VITE_SUPABASE_URL` e `VITE_SUPABASE_ANON_KEY` em variáveis de ambiente.
- Backend (Express):
  - Railway ou Render. Definir `PORT`, `SUPABASE_URL`, `SUPABASE_ANON_KEY` e apontar `DOCS_PATH` se parametrizado.
  - Alternativa: converter rotas para Supabase Edge Functions quando aplicável (leitura/publicação).
- Banco (Supabase):
  - Aplicar migrações, habilitar RLS, revisar políticas por papel e criar chaves de serviço com escopo mínimo.

## Relatórios e Exportações (Instrutor)
- Exportar designações por semana/mês em PDF/Excel.
- Padrão visual consistente (cabeçalho com congregação, período e legenda de status).
- Opção de incluir observações e tempos estimados.

## Notificações (Estudante)
- In-app: centro de notificações, toasts e contadores.
- E-mail: templates simples (assíncrono; opt-in).
- WhatsApp: integração opcional futura (requer consentimento e provedor API conforme LGPD).

## Boas Práticas e Segurança
- Não expor segredos no frontend; usar env vars. Rotas sensíveis protegidas por RLS.
- Guard clauses e fail-fast em APIs; logs com correlação de requisições.
- Componentes e hooks curtos, reutilizáveis; Tailwind + shadcn/ui para consistência.

## Roadmap Sugerido
- [ ] Parametrizar `DOCS_PATH` no backend via `process.env.DOCS_PATH`.
- [ ] Implementar preview e edição leve na importação do Admin.
- [ ] Tabela/roteiro de sincronização offline (fila, replays, conflitos).
- [ ] Exportações PDF/Excel no Instrutor.
- [ ] Notificações e-mail (primeira etapa) e in-app com ack.
- [ ] Guia de deploy com exemplos práticos (Railway/Render + Vercel/Netlify).

## Doações / Apoio
> Este sistema é oferecido gratuitamente. Caso queira apoiar o desenvolvimento, utilize o QR Code de doação Pix disponível no portal do estudante.

---
Para dúvidas técnicas específicas, consulte também: `ADMIN_DASHBOARD_INTEGRATION.md`, `DEBUG_ADMIN_DASHBOARD.md` e `README_ESTUDANTES.md`.
*** End Patch
```

Criando o arquivo `README_EXTENDIDO.md` com a documentação avançada solicitada (papéis detalhados, fluxo de dados, offline-first, entidades do banco, deploy e doações).

```markdown
# Sua-Parte — Documentação Estendida

Este documento complementa o README.md com detalhes operacionais para planejamento e evolução do sistema.

## Papéis e Capacidades por Dashboard

### Admin Dashboard
- Importar materiais oficiais (PDF, JWPub, RTF) com pré-visualização por semana/parte.
- Edição leve após importação: títulos, tempos, observações e correções de parsing.
- Publicação universal (todas as congregações) ou segmentada por congregação/idioma/região, com agendamento.
- Histórico e rollback de publicações; monitoramento de serviços do backend.

### Dashboard do Instrutor
- Visualização da programação: lista de semanas (padrão) ou calendário (toggle), filtros por mês/idioma.
- Gestão de estudantes e designações por parte (S-38), com notas e status.
- Exportação de relatórios de designações em PDF/Excel.
- Offline-first: trabalho completo offline; sincronização automática quando reconectar.

### Portal do Estudante
- Notificações de designação: in-app (toasts/central) e opcional por e-mail/WhatsApp (mediante consentimento e configuração).
- Acesso a instruções práticas da parte e materiais de estudo disponibilizados pelo admin.
- Histórico de partes realizadas e confirmação de leitura/recebimento (ack) opcional.

## Fluxo de Dados (alto nível)
```
Admin importa programas  ->  Publica (todas/segmentado)  ->  Instrutor recebe semanas
Instrutor designa estudantes  ->  Publica designações  ->  Estudante é notificado e acessa
```

## Offline-first e Sincronização (Instrutor)
- Armazenamento local: IndexedDB + Service Worker para dados e fila de operações.
- Alterações offline (estudantes/designações/notas) são persistidas localmente e sincronizadas assim que houver conexão.
- Estratégia de conflitos: last-write-wins por padrão, com aviso quando houver divergências.
- Indicadores: status de sincronização, fila pendente e ação manual "Sincronizar agora".

## Modelo de Dados (Supabase)
- Tabelas principais (nomes ilustrativos; alinhar com migrações existentes):
  - `congregacoes`: congregação e metadados (região/idioma).
  - `profiles`: usuários com `role` (admin/instrutor/estudante) e congregação.
  - `programas`: semanas/partes publicadas (fonte oficial importada), idioma/período.
  - `estudantes`: cadastro local por congregação, status, observações.
  - `designacoes`: vínculo estudante-parte-semana, status e notas.
- Segurança: RLS por congregação e papel; privilégios mínimos; auditoria de mudanças sensíveis.

## Materiais Estáticos (Backend)
- O backend serve `docs/Oficial` via `/materials` (porta padrão 3001).
- Exemplos: `http://localhost:3001/materials/mwb_E_202507.pdf`.
- Recomendações: evitar espaços/parênteses em nomes; quando necessário, usar encoding na URL (`%20`).

## Deploy (Visão Geral)
- Frontend (Vite/React):
  - Vercel ou Netlify (build `npm run build`, diretório `dist/`).
  - Configurar `VITE_SUPABASE_URL` e `VITE_SUPABASE_ANON_KEY` em variáveis de ambiente.
- Backend (Express):
  - Railway ou Render. Definir `PORT`, `SUPABASE_URL`, `SUPABASE_ANON_KEY` e apontar `DOCS_PATH` se parametrizado.
  - Alternativa: converter rotas para Supabase Edge Functions quando aplicável (leitura/publicação).
- Banco (Supabase):
  - Aplicar migrações, habilitar RLS, revisar políticas por papel e criar chaves de serviço com escopo mínimo.

## Relatórios e Exportações (Instrutor)
- Exportar designações por semana/mês em PDF/Excel.
- Padrão visual consistente (cabeçalho com congregação, período e legenda de status).
- Opção de incluir observações e tempos estimados.

## Notificações (Estudante)
- In-app: centro de notificações, toasts e contadores.
- E-mail: templates simples (assíncrono; opt-in).
- WhatsApp: integração opcional futura (requer consentimento e provedor API conforme LGPD).

## Boas Práticas e Segurança
- Não expor segredos no frontend; usar env vars. Rotas sensíveis protegidas por RLS.
- Guard clauses e fail-fast em APIs; logs com correlação de requisições.
- Componentes e hooks curtos, reutilizáveis; Tailwind + shadcn/ui para consistência.

## Roadmap Sugerido
- [ ] Parametrizar `DOCS_PATH` no backend via `process.env.DOCS_PATH`.
- [ ] Implementar preview e edição leve na importação do Admin.
- [ ] Tabela/roteiro de sincronização offline (fila, replays, conflitos).
- [ ] Exportações PDF/Excel no Instrutor.
- [ ] Notificações e-mail (primeira etapa) e in-app com ack.
- [ ] Guia de deploy com exemplos práticos (Railway/Render + Vercel/Netlify).

## Doações / Apoio
> Este sistema é oferecido gratuitamente. Caso queira apoiar o desenvolvimento, utilize o QR Code de doação Pix disponível no portal do estudante.

---
Para dúvidas técnicas específicas, consulte também: `ADMIN_DASHBOARD_INTEGRATION.md`, `DEBUG_ADMIN_DASHBOARD.md` e `README_ESTUDANTES.md`.
```

Criei o `README_EXTENDIDO.md` com:
- Papéis avançados por dashboard
- Fluxo de dados (ASCII)
- Offline-first e sincronização
- Entidades principais no Supabase
- Diretrizes de deploy (frontend/backend/banco)
- Exportações de relatórios
- Notificações
- Boas práticas e roadmap
- Seção de doações/apoio

Você quer que eu adicione um link para esse arquivo no `README.md` (ex.: “Documentação Estendida”)?

---

**User**

Entendido. Com a nova documentação, o projeto está bem mais claro. Agora, com base nas informações que você forneceu, tenho mais algumas perguntas para detalhar o funcionamento e garantir que a implementação atenda a todas as suas expectativas.

---

### Perguntas sobre o Fluxo de Trabalho e Sincronização

* Você mencionou que o instrutor pode operar offline. Qual é o escopo dessa operação? Por exemplo, ele pode criar um novo estudante, editar um estudante existente ou apenas fazer designações enquanto estiver offline?
* Quando o instrutor voltar a ter conexão, como o sistema vai gerenciar possíveis conflitos de dados? Por exemplo, se um instrutor fizer designações offline, mas o administrador atualizar o programa da reunião, qual versão deve prevalecer?
* O instrutor precisará de um botão de "sincronizar" manual ou a sincronização deve acontecer de forma automática e silenciosa em segundo plano?

---

### Perguntas sobre a Experiência do Usuário (UI/UX)

* No dashboard do instrutor, a lista de programas parece ser estática (`programas_em_andamento`). Como a interface vai se atualizar para mostrar os novos programas importados pelo administrador? Haverá uma visualização de calendário?
* O painel do estudante tem acesso restrito. O estudante verá apenas as suas próprias designações ou também poderá ver quem está escalado para outras partes da reunião (como o discurso e as joias espirituais)?
* Há planos de permitir que o instrutor envie convites para os estudantes diretamente do painel, ou o cadastro inicial será sempre manual ou por planilha?

---

### Perguntas sobre a Segurança e o Desempenho

* Você planeja que o instrutor e o administrador façam login com a mesma conta do Supabase, mas com diferentes permissões (`roles`), ou eles terão contas separadas e com diferentes níveis de acesso?
* O backend em Node.js está definido para ser o único ponto de contato com o Supabase. Você gostaria que a lógica de "sincronização offline" do instrutor também passe por esse backend, ou ela será tratada diretamente pelo frontend, comunicando-se com o banco de dados?

Acredito que essas perguntas nos ajudarão a definir as funcionalidades em mais detalhes antes de avançarmos com a implementação.

---

**Cursor**

### Fluxo de Trabalho e Sincronização
- Escopo offline (Instrutor)
  - Criar/editar estudantes: sim (CRUD básico). Exclusão definitiva opcionalmente bloqueada offline (usa “soft-delete” e confirma ao sincronizar).
  - Designações: sim (criar/editar/excluir), com fila local.
  - Observações/anotações: sim.
  - Uploads pesados (ex.: anexos): adiar ou enfileirar com aviso (requer conexão).
- Conflitos ao reconectar
  - Controle por versionamento (`updated_at`/`version`).
  - Regras:
    - Alterações “estruturais” do Admin (ex.: programa/partes removidas/alteradas) prevalecem. Designações que colidem viram “em conflito” e pedem revisão do instrutor.
    - Alterações “locais” do instrutor (notas, vínculo estudante-parte) usam last-write-wins quando não há mudança estrutural; caso contrário, marcam conflito.
  - UI mostra lista de conflitos com ação “resolver”.
- Sincronização: automática + manual
  - Automática e silenciosa em segundo plano (background sync).
  - Botão “Sincronizar agora”, indicador de fila e último sync (para controle/diagnóstico).

### Experiência do Usuário (UI/UX)
- Atualização de programas no instrutor
  - Fonte dinâmica (Supabase + subscrições/revalidações) ou polling leve; badge “Novo”.
  - Visualização: lista de semanas (padrão) + toggle para calendário.
- Visibilidade do estudante
  - Padrão: vê apenas as próprias designações e materiais associados.
  - Opcional (configurável por congregação): “quadro de designações” somente leitura (sem dados sensíveis).
- Convites para estudantes
  - Suportado: convites por e-mail (link mágico), QR code em reunião, importação por planilha (bulk). Cadastro manual continua disponível.

### Segurança e Desempenho
- Contas e permissões
  - Contas separadas; roles no `profiles` (admin/instrutor/estudante), RLS por congregação.
  - JWT do Supabase com políticas por papel; auditoria de ações sensíveis.
- Caminho da sincronização offline
  - CRUD de dados do app: direto no Supabase (menos latência; aproveita RLS e row-replication).
  - Backend Node: para serviços (download JW.org, cron, processamento pesado, servir `materials/`). Pode expor endpoints auxiliares (ex.: export PDFs) sem ficar no caminho do CRUD comum.
  - Se preferir auditoria centralizada, podemos roteá-la pelo backend (webhooks/repasse) sem bloquear o fluxo direto ao Supabase.

Quer que eu adicione essas decisões no `README_EXTENDIDO.md` (seções “Conflitos e Regras” e “Convites/Importação”)?

---

**User**

sim, mas ao so escreva me diga como implementar conforme Instructions for Our Christian Life and Ministry Meeting
Table of Contents
Opening Comments. Paragraph 2
Treasures From God’s Word Paragraphs 3-5
Talk Paragraph 3
Spiritual Gems Paragraph 4
Bible Reading Paragraph 5
Apply Yourself to the Field Ministry Paragraphs 6-14
Starting a Conversation Paragraph 7
Following Up Paragraph 8
Making Disciples Paragraph 9
Explaining Your Beliefs Paragraph 10
Talk 1 Paragraph 1
Content Paragraph 12
Settings Paragraph 13
Use of Videos and Literature Paragraph 14
Living as Christians Paragraphs 15-16
Congregation Bible Study Paragraph 16
Concluding Comments Paragraph 17
Commendation and Counsel Paragraph 18
Timing Paragraph 19
Visit of Circuit Overseer Paragraph 20
Week of an Assembly or a Convention Paragraph 21
Week of the Memorial Paragraph 22
Life and Ministry Meeting Overseer Paragraph 23
Life and Ministry Meeting Chairman Paragraph 24
Auxiliary Counselor Paragraph 25
Auxiliary Classes Paragraph 26
Videos Paragraph 27

1. The instructions in this document will assist all who have a part on the Our Christian Life and Ministry meeting. Such ones should review the instructions for their part as outlined in the Life and Ministry Meeting Workbook and in this document before preparing their part. All publishers should be invited to make themselves available to present student assignments. Others who are actively associating with the congregation may participate if they agree with the teachings of the Bible and their life is in harmony with Christian principles. The Life and Ministry Meeting overseer should discuss the requirements for enrollment with anyone who is not a publisher and expresses a desire to enroll and then let the person know if he qualifies. This should be done in the presence of the one who is conducting a Bible study with him (or in the presence of a believing parent). The requirements are the same as those for a person to become an unbaptized publisher.—od chapter 8 paragraph 8.
Opening Comments
2. One minute. Each week, after the opening song and prayer, the Life and Ministry Meeting chairman will generate anticipation for the program to follow. The chairman should focus on points that will benefit the congregation the most.
Treasures From God’s Word
3. Talk: Ten minutes. The theme and an outline of two or three main points are provided in the Life and Ministry Meeting Workbook. This talk is to be assigned to an elder or a qualified ministerial servant. When a new Bible book is scheduled in the weekly Bible reading, a video will be played to introduce it. The speaker may draw parallels between the video and the theme. However, he should be sure to cover the points outlined in the workbook. Also, as time allows, he should make good use of the artwork, which is designed to complement the material to be covered. He may include other reference material as long as it contributes to the development of the points in the outline.
4. Spiritual Gems: Ten minutes. This is a question-and-answer part without an introduction or a conclusion. It is to be handled by an elder or a qualified ministerial servant. The speaker should ask the audience both questions. Also, he may determine whether or not the cited verses need to be read. Those called on should offer comments of 30 seconds or less.
5. Bible Reading: Four minutes. This student assignment is to be handled by a male student. The student should read the assigned material without giving an introduction or a conclusion. The meeting chairman will be especially interested in helping students to read with accuracy, understanding, fluency, proper sense stress, modulation, appropriate pausing, and naturalness. Because some Bible reading assignments are shorter and others are longer, the Life and Ministry Meeting overseer should take into account the abilities of the students when making these assignments.
Apply Yourself to the Field Ministry
6. Fifteen minutes. This section of the meeting is designed to give all the opportunity to practice for the ministry and to improve in their conversation skills and ability to preach and teach. As necessary, elders may receive student assignments. Each student should work on the study point from either the Teaching or Love People brochure that appears in parentheses next to the assignment in the Life and Ministry Meeting Workbook. At times, a part designated as a discussion will be scheduled. Such a part is to be handled by an elder or a qualified ministerial servant.—See paragraph 15 regarding how to handle discussion parts.
7. Starting a Conversation: This student assignment may be handled by a male or a female student. The assistant should be of the same gender or should be a family member. The student and the assistant may sit or stand.—For more information on the content and setting for this assignment, see paragraphs 12 and 13.
8. Following Up: This student assignment may be handled by a male or a female student. The assistant should be of the same gender. (km 5/97 page 2) The student and the assistant may sit or stand. The student should demonstrate what to say when following up on a previous conversation.—For more information on the content and setting for this assignment, see paragraphs 12 and 13.
9. Making Disciples: This student assignment may be handled by a male or a female student. The assistant should be of the same gender. (km 5/97 page 2) The student and the assistant may sit or stand. This part should demonstrate a segment of a Bible study already in progress. There is no need for an introduction or a conclusion unless the student is specifically working on one of these study points. It is not necessary to have all of the assigned material read aloud, although this may be done.
10. Explaining Your Beliefs: When designated as a talk, this student assignment should be handled by a male student. When designated as a demonstration, it may be handled by a male or a female student. The assistant should be of the same gender or should be a family member. The student should provide a clear and tactful answer to the theme question using the information in the reference provided. The student may decide whether or not to refer to the referenced publication during his part.
11. Talk: This student assignment is to be handled by a male student and given as a talk to the congregation. When the talk is based on a point from appendix A of the Love People brochure, the student should highlight how the verse(s) can be used in the ministry. For example, he may explain when a verse may be used, the meaning of the verse, and how to reason on it with a person. When the talk is based on a point from one of the lessons in the Love People brochure, the student should focus on how to apply the point in the ministry. He may highlight the example featured in point 1 of the lesson or highlight any of the supplementary verses included in the lesson, if helpful.
12. Content: The material in this paragraph and the following one applies to the “Starting a Conversation” and “Following Up” assignments. Unless otherwise noted, the student’s goal is to share a simple Bible truth that is relevant to the person he is speaking with and to lay the groundwork for a future conversation. The student should select a topic that is timely and effective locally. He may decide whether or not to introduce a publication or video from our Teaching Toolbox. Rather than demonstrate a memorized presentation, students should practice conversation skills, such as showing personal interest and displaying naturalness.
13. Settings: The student should apply the assigned general setting to local circumstances. For example:
(1) House to House: This setting includes preaching from door to door—whether in person, by phone, or by letter—and following up on a previous conversation with a person contacted in the house-to-house ministry.
(2) Informal Witnessing: This setting describes taking advantage of opportunities to turn an ordinary conversation into a witness. It may include sharing a Scriptural thought with those you meet at work, in school, in your neighborhood, on public transportation, or elsewhere while going about your daily activities.
(3) Public Witnessing: This setting may include cart witnessing, calling on people at places of business, street witnessing, or witnessing in parks, parking lots, or wherever people can be found.
14. Use of Videos and Literature: Depending on the circumstances, a student may decide to feature a video or literature. If a student assignment includes a video or if a student chooses to feature one, he should introduce and discuss the video but not play it.
Living as Christians
15. After a song, the next 15 minutes of this section will consist of one or two parts designed to help the audience apply God’s Word. Unless otherwise indicated, these parts may be assigned to elders or qualified ministerial servants, with the exception of a local needs part, which is to be handled by an elder. When a part is designated as a discussion, the speaker may ask questions throughout the part in addition to the ones provided. He should keep his introduction brief to allow for sufficient time to cover the main points and for audience participation. If an interview is called for, it is preferable for the one being interviewed to give his comments from the stage rather than from his seat, if possible.
16. Congregation Bible Study: Thirty minutes. This part is to be assigned to a qualified elder. (Where the number of elders is limited, qualified ministerial servants may be assigned, as needed.) The body of elders should determine who is qualified to conduct the Congregation Bible Study. Those approved should be able to preside in a meaningful way so as to keep the study on time, emphasize the key scriptures, and assist everyone to appreciate the practical value of the points covered. Those approved will benefit by reviewing published direction regarding how to conduct question-and-answer parts. (w23.04 page 24, box) After the assigned material for the week has been thoroughly covered, there is no need to prolong the study. Where possible, different conductors and readers should be used each week. If the Life and Ministry Meeting chairman directs that the study be abbreviated, then the conductor will have to decide how to abbreviate the study. He may choose to have the reading of some paragraphs omitted.
Concluding Comments
17. Three minutes. The Life and Ministry Meeting chairman will review particularly helpful points from the meeting. He should also preview the material for the next week. He may announce the names of the students who are assigned to give parts the next week, provided there is time for this. Unless otherwise indicated, any necessary announcements should be made and any necessary letters should be read to the congregation by the chairman during his concluding comments. Routine information, such as normal field service arrangements and cleaning schedules, should not be announced from the platform but should be posted on the information board. If any announcements cannot be made or any letters cannot be read in the time allotted for the concluding comments, the chairman should ask the brothers handling parts on the Living as Christians section of the meeting to abbreviate their parts as necessary. (See paragraphs 16 and 19.) The meeting will conclude with song and prayer.
Commendation and Counsel
18. Following each of the student assignments, the Life and Ministry Meeting chairman has approximately one minute to provide commendation and counsel based on the assigned study point. When the chairman introduces a student’s assignment, he will not announce the study point. However, when the student’s assignment is finished and after some appropriate words of commendation, the chairman may announce the study point and state why the student did well on that point or kindly explain why and how the student should give that particular point further attention. The chairman may also comment on other aspects of the demonstration if he feels that this would benefit the student or the audience. Additional constructive counsel based on the Love People brochure, the Teaching brochure, or the Ministry School book may be given privately after the meeting or at another time, either on the assigned study point or on another study point.—For more information regarding the role of the Life and Ministry Meeting chairman and the role of the auxiliary counselor, see paragraphs 19, 24, and 25.
Timing
19. No part should go overtime, nor should the remarks of the Life and Ministry Meeting chairman. Although the Life and Ministry Meeting Workbook specifies the timing for each part, if the material is adequately covered, there is no need to add information simply to use all of the allotted time. If parts go overtime, private counsel should be given by the Life and Ministry Meeting chairman or the auxiliary counselor. (See paragraphs 24 and 25.) The entire meeting, including songs and prayers, should last 1 hour and 45 minutes.
Visit of Circuit Overseer
20. When the congregation has the visit of the circuit overseer, the program should proceed as described in the Life and Ministry Meeting Workbook with the following exceptions: The Congregation Bible Study portion of the Living as Christians section will be replaced with a 30-minute service talk given by the circuit overseer. Prior to the service talk, the Life and Ministry Meeting chairman will review the program just held, preview the next week’s program, make any necessary announcements, read any necessary letters, and then introduce the circuit overseer. After the service talk, the circuit overseer will conclude the meeting with a song of his choice. He may invite another brother to conclude with prayer. No auxiliary classes in the language of the congregation should be held during the visit of the circuit overseer. A group may hold its meetings even when the circuit overseer is visiting the host congregation. However, the group should rejoin the host congregation for the circuit overseer’s service talk.
Week of an Assembly or a Convention
21. During the week of an assembly or a convention, no congregation meetings are held. The congregation should be reminded that the material scheduled for meetings during such weeks should be considered individually or as a family.
Week of the Memorial
22. When the Memorial falls on a weekday, no Life and Ministry Meeting will be scheduled.
Life and Ministry Meeting Overseer
23. An elder selected by the body of elders will serve as the Life and Ministry Meeting overseer. He is responsible for ensuring that this meeting is well organized and handled according to these instructions. He should maintain good communication with the auxiliary counselor. As soon as the Life and Ministry Meeting Workbook becomes available, the Life and Ministry Meeting overseer will assign all the midweek-meeting parts for the two-month period. This includes the nonstudent assignments and the midweek-meeting chairmen from among those approved by the body of elders, as well as the student assignments. (See paragraphs 3-16 and 24.) When making student assignments, he should take into consideration the student’s age, experience, and freeness of speech on the matter being discussed. He should use similar judgment when assigning the other parts of the meeting. Each of the assignments should be distributed at least three weeks prior to the date of the assignment. The Our Christian Life and Ministry Meeting Assignment (S-89) form should be used for the student assignments. The Life and Ministry Meeting overseer should ensure that a copy of the assignment schedule for the entire meeting is posted on the information board. The body of elders may assign another elder or a ministerial servant to assist him. However, only elders should be used to assign nonstudent parts.
Life and Ministry Meeting Chairman
24. Each week, one elder will serve as the chairman for the duration of the Life and Ministry Meeting. (Where the number of elders is limited, qualified ministerial servants may be assigned as needed.) He is responsible for preparing the introductory and concluding comments. He also introduces all the parts, and depending on the size of the body of elders, he may be responsible for handling other parts on the meeting, especially parts that simply call for a video to be shown without additional discussion. Comments between parts should be very brief. The body of elders will determine which elders are qualified to fill this role. The qualified elders are assigned as chairmen periodically. Depending on local circumstances, the Life and Ministry Meeting overseer may be used as chairman more frequently than the other qualified elders. If an elder is qualified to conduct the Congregation Bible Study, likely he is qualified to serve as the meeting chairman. Please keep in mind, however, that the elder who serves as chairman is required to offer loving and helpful commendation and, as needed, counsel to those who have student assignments. The chairman is also responsible for ensuring that the meeting concludes on time. (See paragraphs 17 and 19.) If the chairman wishes and if there is adequate space, a standing microphone may be positioned on the platform so that he can introduce each ensuing part while the brother giving the part is taking his position at the speaker stand. Likewise, the chairman may wish to sit at a table on stage during the student Bible reading assignment and the Apply Yourself to the Field Ministry section of the meeting. This may conserve time.
Auxiliary Counselor
25. Whenever possible, it is good to use an elder who is an experienced speaker to fill this role. The auxiliary counselor’s responsibility is to give private counsel, if needed, to elders and ministerial servants regarding any speaking assignments they may handle, including parts on the Life and Ministry Meeting, public talks, and conducting or reading at the Watchtower Study or Congregation Bible Study. (See paragraph 19.) If there are a number of elders in the congregation who are capable speakers and teachers, then a different qualified elder may serve as the auxiliary counselor each year. It is not necessary for the auxiliary counselor to offer counsel after each assignment.
Auxiliary Classes
26. Depending on the number of students, congregations may hold auxiliary classes for the student assignments. Each auxiliary class should have a qualified counselor, preferably an elder. Where necessary, a well-qualified ministerial servant may be assigned. The body of elders should decide who may serve in this capacity and whether the assignment should rotate. The counselor should follow the procedure described in paragraph 18. If an auxiliary class is held, students should be asked to go to the auxiliary classroom following the Spiritual Gems portion of the Treasures From God’s Word section of the meeting. They should rejoin the rest of the congregation following the last student assignment on the meeting.
Videos
27. Selected videos will be used in connection with this meeting. The videos for the midweek meeting will be available via the JW Library® app and accessible using a variety of devices.

© 2023 Watch Tower Bible and Tract Society of Pennsylvania
S-38-E 11/23


---

**Cursor**

Seguem instruções objetivas de implementação alinhadas ao S‑38 (Our Christian Life and Ministry Meeting), por módulo.

### Modelo de dados (mínimo viável)
- Tabelas
  - congregacoes(id, nome, idioma)
  - profiles(id, role: admin|instrutor|estudante, congregacao_id)
  - programas(id, congregacao_scope: all|subset, idioma, semana_iso, data_inicio, data_fim, status: rascunho|publicado, versao, created_at, updated_at)
  - partes(id, programa_id, secao: treasures|apply|living|cbs|opening|closing, subsecao, titulo, referencia, paragrafos_ref, tempo_min, elegibilidade: elder|ms|irmão|irmã, tipo: talk|qna|reading|demo|discussion|video|study, ordem, observacoes)
  - designacoes(id, parte_id, estudante_id, assistente_id?, status: pendente|confirmada|rejeitada|concluida, notas, updated_at, versao)
  - estudantes(id, congregacao_id, nome, genero, pode_ler? boolean, pode_falar? boolean, ativo, historico_resumo)
  - configuracoes(id, congregacao_id, mostrar_quadro_publico boolean, notificacao_email boolean, notificacao_whatsapp boolean)
  - feriados_especiais(semana_iso, tipo: memorial|assembly|convention|visit_overseer)
- Observação: use RLS por `congregacao_id`; `programas` com `congregacao_scope=all` são legíveis por todas.

### Importação/Admin (S‑38 fiel)
- Mapear “Table of Contents” do S‑38 para `secao/subsecao/tipo/elegibilidade/tempo_min`:
  - Opening Comments: secao=openning, tipo=talk, tempo=1
  - Treasures: Talk(10), Spiritual Gems(Q&A 10), Bible Reading(leitura 4; estudante masculino)
  - Apply Yourself: total 15; subpartes Starting, Following Up, Making Disciples, Explaining Beliefs, Talk 1; cada uma como `tipo` talk|demo com `elegibilidade` por gênero conforme S‑38; anexar “Content/Settings/Use of Videos” como diretrizes em `observacoes`
  - Living as Christians: até 15 (1–2 partes + possíveis discussion), depois Congregation Bible Study 30 (elder qualificado)
  - Concluding Comments: 3
  - Timing total: 1h45
- Validações na publicação:
  - Respeitar tempos por parte; somatório por seção e total
  - Restrições de elegibilidade (ex.: Bible Reading: masculino; Explaining Beliefs: talk → masculino; demo → ambos)
  - “Use of Videos”: marcar como “não reproduzir” (somente citar)
  - Semanas especiais: se memorial/assembly/convention → ocultar/ajustar seções conforme parágrafos 21–22; visita do superintendente (20): substituir CBS por service talk
- Publicação:
  - Universal (todas) por padrão; permitir segmentação por congregações/idiomas
  - Versão imutável por programa publicado; atualizações geram nova `versao` + diff

### Dashboard do Instrutor
- UI lista/calendário de semanas (badge “novo” quando `versao` muda)
- Tela da semana: lista de `partes` com regras S‑38 evidentes:
  - Mostre `tempo_min`, `tipo`, `elegibilidade`, `observacoes` (Content/Settings)
  - Bloqueie designar papel incompatível (ex.: leitura bíblica → masculino; assistente mesmo gênero)
- Fluxo de designação:
  - Criar/editar/remover designações dentro das regras
  - Exportar PDF/Excel (sem nomes ao publicar globalmente, opcional quadro público por cong)
- Offline-first:
  - Permitir CRUD de estudantes e designações offline (soft-delete)
  - Fila com marcação de dependências por `versao` do `programa`
  - Sincronização: automática em background + botão “Sincronizar agora”
- Conflitos:
  - Se `programa.versao` local < remota: marcar designações afetadas como “em conflito”; pedir remapeamento se a parte foi alterada/removida
  - Para campos locais (notas/ordem locais) sem mudança estrutural: last-write-wins
  - Resolver em modal com diffs (parte/estudante/tempo)

### Portal do Estudante
- Acessos:
  - Ver apenas suas designações e materiais do admin
  - Opcional: quadro público (somente leitura, sem dados sensíveis) se `configuracoes.mostrar_quadro_publico`
- Notificações:
  - In-app sempre; e-mail/WhatsApp se habilitado (opt-in)
  - Confirmação de leitura (ack) gravada em `designacoes.status`/`logs` (opcional)

### Regras específicas S‑38 em tempo de designação
- Gênero/assistente:
  - Starting/Following/Making: aluno e assistente de mesmo gênero; familiar permitido
  - Explaining Your Beliefs: se “talk” → masculino; se “demo” → ambos; assistente mesmo gênero/familiar
  - Bible Reading: masculino; sem intro/conclusão
  - Spiritual Gems: Q&A sem intro/conclusão; respostas ≤30s
- Settings (aplicação do cenário):
  - House-to-House / Informal / Public: registrar cenário escolhido na designação
- Timing:
  - Nenhuma parte pode exceder o tempo em `tempo_min`; somatório por seção respeitado
  - Mostrar cronômetro/indicador ao instrutor (opcional)
- Vídeos:
  - “Não reproduzir” nas designações; apenas citar/introduzir

### Semanas especiais (automação)
- memorial/assembly/convention: ocultar reunião (ou marcar sem designações)
- visit_overseer: substituir CBS por service talk (30) e ajustar comentários finais conforme (20)

### Segurança/acesso
- Supabase: roles admin/instrutor/estudante, RLS por `congregacao_id`
- Auditoria: registrar alterações em designações/publicações; quem/quando
- Backend Node: continua para downloads JW.org, cron e estáticos; CRUD de dados via Supabase direto (aproveita RLS)

### Passos práticos de implementação
- Schema/migrações: criar/ajustar tabelas acima e políticas RLS
- Importação Admin:
  - Parser que gere `programas` + `partes` preenchendo `secao/subsecao/tipo/elegibilidade/tempo_min/observacoes`
  - Tela de pré‑visualização com validações (tempos, elegibilidade, semanas especiais)
- UI Instrutor:
  - Lista/calendário, tela de partes com regras de seleção (filtros por gênero/capacidade)
  - Export PDF/Excel
  - IndexedDB + SW para fila offline; sync automático + botão manual
  - Resolução de conflitos baseada em `versao` e mapeamentos
- UI Estudante:
  - Minhas designações, materiais, histórico; ack de leitura
  - Notificações in‑app; e-mail/WhatsApp se habilitado
- Semanas especiais:
  - Job diário marca feriados especiais e ajusta visibilidade
- Testes:
  - Casos para regras S‑38 (gênero/assistente, timing, vídeos, semanas especiais)
  - E2E de sincronização e conflitos

Se quiser, eu adiciono estas seções no `README_EXTENDIDO.md` sob “Conflitos e Regras” e “Semanas especiais/Timing/Settings” para documentação permanente.

---

**User**

sim

---

**Cursor**

Vou adicionar as seções “Conflitos e Regras (S‑38)” e “Semanas Especiais, Timing e Settings (S‑38)” no `README_EXTENDIDO.md`, com instruções objetivas de implementação.

```markdown
# Sua-Parte — Documentação Estendida

Este documento complementa o README.md com detalhes operacionais para planejamento e evolução do sistema.

## Papéis e Capacidades por Dashboard

### Admin Dashboard
- Importar materiais oficiais (PDF, JWPub, RTF) com pré-visualização por semana/parte.
- Edição leve após importação: títulos, tempos, observações e correções de parsing.
- Publicação universal (todas as congregações) ou segmentada por congregação/idioma/região, com agendamento.
- Histórico e rollback de publicações; monitoramento de serviços do backend.

### Dashboard do Instrutor
- Visualização da programação: lista de semanas (padrão) ou calendário (toggle), filtros por mês/idioma.
- Gestão de estudantes e designações por parte (S-38), com notas e status.
- Exportação de relatórios de designações em PDF/Excel.
- Offline-first: trabalho completo offline; sincronização automática quando reconectar.

### Portal do Estudante
- Notificações de designação: in-app (toasts/central) e opcional por e-mail/WhatsApp (mediante consentimento e configuração).
- Acesso a instruções práticas da parte e materiais de estudo disponibilizados pelo admin.
- Histórico de partes realizadas e confirmação de leitura/recebimento (ack) opcional.

## Fluxo de Dados (alto nível)
```
Admin importa programas  ->  Publica (todas/segmentado)  ->  Instrutor recebe semanas
Instrutor designa estudantes  ->  Publica designações  ->  Estudante é notificado e acessa
```

## Offline-first e Sincronização (Instrutor)
- Armazenamento local: IndexedDB + Service Worker para dados e fila de operações.
- Alterações offline (estudantes/designações/notas) são persistidas localmente e sincronizadas assim que houver conexão.
- Estratégia de conflitos: last-write-wins por padrão, com aviso quando houver divergências.
- Indicadores: status de sincronização, fila pendente e ação manual "Sincronizar agora".

## Modelo de Dados (Supabase)
- Tabelas principais (nomes ilustrativos; alinhar com migrações existentes):
  - `congregacoes`: congregação e metadados (região/idioma).
  - `profiles`: usuários com `role` (admin/instrutor/estudante) e congregação.
  - `programas`: semanas/partes publicadas (fonte oficial importada), idioma/período.
  - `estudantes`: cadastro local por congregação, status, observações.
  - `designacoes`: vínculo estudante-parte-semana, status e notas.
- Segurança: RLS por congregação e papel; privilégios mínimos; auditoria de mudanças sensíveis.

## Materiais Estáticos (Backend)
- O backend serve `docs/Oficial` via `/materials` (porta padrão 3001).
- Exemplos: `http://localhost:3001/materials/mwb_E_202507.pdf`.
- Recomendações: evitar espaços/parênteses em nomes; quando necessário, usar encoding na URL (`%20`).

## Deploy (Visão Geral)
- Frontend (Vite/React):
  - Vercel ou Netlify (build `npm run build`, diretório `dist/`).
  - Configurar `VITE_SUPABASE_URL` e `VITE_SUPABASE_ANON_KEY` em variáveis de ambiente.
- Backend (Express):
  - Railway ou Render. Definir `PORT`, `SUPABASE_URL`, `SUPABASE_ANON_KEY` e apontar `DOCS_PATH` se parametrizado.
  - Alternativa: converter rotas para Supabase Edge Functions quando aplicável (leitura/publicação).
- Banco (Supabase):
  - Aplicar migrações, habilitar RLS, revisar políticas por papel e criar chaves de serviço com escopo mínimo.

## Relatórios e Exportações (Instrutor)
- Exportar designações por semana/mês em PDF/Excel.
- Padrão visual consistente (cabeçalho com congregação, período e legenda de status).
- Opção de incluir observações e tempos estimados.

## Notificações (Estudante)
- In-app: centro de notificações, toasts e contadores.
- E-mail: templates simples (assíncrono; opt-in).
- WhatsApp: integração opcional futura (requer consentimento e provedor API conforme LGPD).

## Boas Práticas e Segurança
- Não expor segredos no frontend; usar env vars. Rotas sensíveis protegidas por RLS.
- Guard clauses e fail-fast em APIs; logs com correlação de requisições.
- Componentes e hooks curtos, reutilizáveis; Tailwind + shadcn/ui para consistência.

## Roadmap Sugerido
- [ ] Parametrizar `DOCS_PATH` no backend via `process.env.DOCS_PATH`.
- [ ] Implementar preview e edição leve na importação do Admin.
- [ ] Tabela/roteiro de sincronização offline (fila, replays, conflitos).
- [ ] Exportações PDF/Excel no Instrutor.
- [ ] Notificações e-mail (primeira etapa) e in-app com ack.
- [ ] Guia de deploy com exemplos práticos (Railway/Render + Vercel/Netlify).

## Doações / Apoio
> Este sistema é oferecido gratuitamente. Caso queira apoiar o desenvolvimento, utilize o QR Code de doação Pix disponível no portal do estudante.

---
Para dúvidas técnicas específicas, consulte também: `ADMIN_DASHBOARD_INTEGRATION.md`, `DEBUG_ADMIN_DASHBOARD.md` e `README_ESTUDANTES.md`.

## Conflitos e Regras (S‑38)
- Versionamento e detecção de conflitos
  - Campos: `programas.versao`, `designacoes.versao`, `updated_at`.
  - Ao sincronizar: se `programa.versao_local < programa.versao_remota`, marcar designações ligadas a partes alteradas/removidas como "em conflito".
  - Last-write-wins apenas quando não houve alteração estrutural da parte (título/tipo/elegibilidade/tempo/ordem).
- Regras de elegibilidade e gênero
  - Bible Reading: estudante masculino; sem intro/conclusão.
  - Explaining Your Beliefs: talk → masculino; demo → ambos; assistente mesmo gênero ou familiar.
  - Starting/Following/Making: aluno e assistente mesmo gênero; familiar permitido.
  - Spiritual Gems: Q&A, respostas ≤30s; sem leitura obrigatória.
- Aplicação técnica
  - Validador no frontend ao criar/editar designação (bloqueia opções inválidas).
  - Constraint lógica no backend/Supabase via policies/checks suaves (preferir validação na aplicação + auditoria).
  - Campo `settings` por designação para registrar cenário: `house_to_house|informal|public`.

## Semanas Especiais, Timing e Settings (S‑38)
- Semanas especiais
  - `feriados_especiais(tipo)`: memorial/assembly/convention → ocultar reunião (ou marcar sem designações).
  - `visit_overseer`: substituir CBS (30 min) por service talk; ajustar comentários finais.
  - Job diário atualiza tabela e seta flags nas semanas futuras.
- Timing
  - `partes.tempo_min` por item; somatório por seção e total (1h45).
  - UI mostra barra/contador por seção e alerta de estouro.
  - Bloqueie salvar se exceder limites configurados.
- Settings (cenários)
  - Campos sugeridos em `designacoes.settings`:
    - `general`: `house_to_house|informal|public`.
    - `mode`: `door|phone|letter|cart|street|park|work|school|transit|other`.
  - UI com presets e descrição, persistidos por designação.

## Fluxo de Sincronização (Instrutor)
- Offline-first
  - IndexedDB: tabelas espelho de `estudantes`, `designacoes`, `programas` (somente leitura) e fila `operations`.
  - Service Worker: background sync quando a rede voltar.
- Fila e replay
  - `operations`: {id, entity, action, payload, baseVersion, createdAt}.
  - Ao reenviar: verificar `baseVersion` vs remoto; se divergente, marcar conflito.
- UI/Resolução
  - Indicadores: status online/offline, itens na fila, último sync.
  - Modal de conflitos mostrando diff (parte/estudante/campos alterados) com escolha de resolução.

```

Adicionei as seções no `README_EXTENDIDO.md` com:
- Conflitos e Regras (S‑38): versionamento, elegibilidade por gênero, validações, e aplicação técnica.
- Semanas Especiais, Timing e Settings: regras para memorial/assembleias/visita do superintendente, limites de tempo e cenários (house-to-house, informal, public).
- Fluxo de Sincronização: IndexedDB, Service Worker, fila de operações, detecção de conflitos e UI de resolução.

Se quiser, incluo um link “Documentação Estendida” no `README.md`.

---

**User**

vamos cria na raiz do projeto um arquivo chamado AGENTS.md que vai funcionar como um orquestrador de outros agents.md Specialized personas that tailor Roo's behavior. Ctrl + . for
next mode, Ctrl + Shift + . for previous mode

F Architect
Plan and design before implementation

Code
Write, modify, and refactor code

? Ask
Get answers and explanations

Debug
Diagnose and fix software issues

Orchestrator
Coordinate tasks across multiple modes

---

**Cursor**

I'll add a new root-level file named `AGENTS.md` describing the Orchestrator and specialized personas (Architect, Code, Ask, Debug), including how to switch modes and suggested usage patterns.

```markdown
# AGENTS.md — Orquestrador de Personas

Este arquivo define o orquestrador e as personas especializadas para guiar o fluxo de trabalho no projeto. Use-o como referência para alternar modos e coordenar tarefas.

## Modos Disponíveis

- F Architect (Planejar)
  - Foco: planejar arquitetura, fluxos, modelos de dados e regras (S‑38), antes de codar.
  - Saídas: diagramas, especificações, critérios de aceite, riscos.

- Code (Implementar)
  - Foco: escrever, modificar e refatorar código seguindo SOLID/DRY e UI consistente (Tailwind + shadcn/ui).
  - Saídas: commits pequenos, testes adicionados/ajustados, docs breves.

- ? Ask (Descobrir)
  - Foco: esclarecer dúvidas e justificar decisões, explicar trade-offs.
  - Saídas: respostas objetivas, comparativos, referências internas.

- Debug (Diagnosticar)
  - Foco: reproduzir, isolar e corrigir defeitos; adicionar testes de regressão.
  - Saídas: RCA, fix verificado, métricas (antes/depois) quando aplicável.

- Orchestrator (Orquestrar)
  - Foco: coordenar tarefas entre modos, dividir trabalho em etapas, garantir handoffs limpos.
  - Saídas: plano de execução, checklist, ordem de operações e critérios de conclusão.

## Atalhos de Modo

- Ctrl + .  → próximo modo
- Ctrl + Shift + .  → modo anterior

## Diretrizes do Orquestrador

1) Começar no modo F Architect para planejar:
   - Definir objetivo, requisitos, riscos, critérios de aceite.
   - Mapear entidades/tabelas, políticas RLS e regras S‑38 relevantes.

2) Delegar para Code com escopo claro:
   - Descrever arquivos a alterar/criar e pontos de integração.
   - Exigir testes (Cypress/E2E, unitários quando couber) e verificação de lint.

3) Usar ? Ask quando houver ambiguidades:
   - Formular perguntas fechadas e decisões com prós/cons.

4) Invocar Debug após implementação:
   - Reproduzir, criar testes de regressão, verificar métricas/perf.

5) Encerrar ciclo com documentação mínima:
   - Atualizar README/README_EXTENDIDO, CHANGELOG e anotações de decisões.

## Padrões de Qualidade (todos os modos)

- Segurança: não expor segredos, RLS ativo, mínimo privilégio.
- Código: funções curtas, nomes claros, early return/guard clauses.
- UI/UX: responsivo, consistente, sem inline styles desnecessários.
- Performance: evitar refetches, usar memoização e paginação.
- Documentação: sucinta, com exemplos e instruções de uso.

## Fluxo de Trabalho Sugerido

1. Orchestrator: alinhamento e criação de checklist.
2. F Architect: modelo de dados/fluxo (inclui S‑38 quando pertinente).
3. Code: implementação incremental (commits pequenos) + testes.
4. Debug: validações e correções.
5. Orchestrator: revisão final, merge e atualização de docs.

## Exemplo de Handoff

- Orchestrator → F Architect: "Definir esquema de `designacoes` com regras S‑38 e conflito de versão".
- F Architect → Code: "Criar migração, políticas RLS e validações de elegibilidade no frontend".
- Code → Debug: "Adicionar testes E2E para conflitos e exportação PDF".
- Debug → Orchestrator: "RCA e fix confirmados; pronto para merge".
```

Criei `AGENTS.md` na raiz com:
- Personas: Architect, Code, Ask, Debug e Orchestrator.
- Atalhos de modo (Ctrl + . / Ctrl + Shift + .).
- Diretrizes do orquestrador, padrões de qualidade e fluxo de trabalho.
- Exemplo de handoff entre modos.

Quer que eu referencie esse arquivo no `README.md` (ex.: seção “Agentes e Fluxo de Trabalho”)?

---

**User**

sim e programa para ele se auto escrever toda vez que um dos seus agentes funcionario fizer um tarefa que ele vai mandar executar

---

**Cursor**

Vou adicionar um link para `AGENTS.md` no `README.md` e criar uma automação: um script `scripts/agents-log.js` que registra atividades dos agentes em `agents.log.json` e atualiza a seção de registro em `AGENTS.md`. Também vou adicionar um comando npm `agents:log` no `package.json` e inserir uma seção de registro automático em `AGENTS.md`.

```markdown
# AGENTS.md — Orquestrador de Personas

Este arquivo define o orquestrador e as personas especializadas para guiar o fluxo de trabalho no projeto. Use-o como referência para alternar modos e coordenar tarefas.

## Modos Disponíveis

- F Architect (Planejar)
  - Foco: planejar arquitetura, fluxos, modelos de dados e regras (S‑38), antes de codar.
  - Saídas: diagramas, especificações, critérios de aceite, riscos.

- Code (Implementar)
  - Foco: escrever, modificar e refatorar código seguindo SOLID/DRY e UI consistente (Tailwind + shadcn/ui).
  - Saídas: commits pequenos, testes adicionados/ajustados, docs breves.

- ? Ask (Descobrir)
  - Foco: esclarecer dúvidas e justificar decisões, explicar trade-offs.
  - Saídas: respostas objetivas, comparativos, referências internas.

- Debug (Diagnosticar)
  - Foco: reproduzir, isolar e corrigir defeitos; adicionar testes de regressão.
  - Saídas: RCA, fix verificado, métricas (antes/depois) quando aplicável.

- Orchestrator (Orquestrar)
  - Foco: coordenar tarefas entre modos, dividir trabalho em etapas, garantir handoffs limpos.
  - Saídas: plano de execução, checklist, ordem de operações e critérios de conclusão.

## Atalhos de Modo

- Ctrl + .  → próximo modo
- Ctrl + Shift + .  → modo anterior

## Diretrizes do Orquestrador

1) Começar no modo F Architect para planejar:
   - Definir objetivo, requisitos, riscos, critérios de aceite.
   - Mapear entidades/tabelas, políticas RLS e regras S‑38 relevantes.

2) Delegar para Code com escopo claro:
   - Descrever arquivos a alterar/criar e pontos de integração.
   - Exigir testes (Cypress/E2E, unitários quando couber) e verificação de lint.

3) Usar ? Ask quando houver ambiguidades:
   - Formular perguntas fechadas e decisões com prós/cons.

4) Invocar Debug após implementação:
   - Reproduzir, criar testes de regressão, verificar métricas/perf.

5) Encerrar ciclo com documentação mínima:
   - Atualizar README/README_EXTENDIDO, CHANGELOG e anotações de decisões.

## Padrões de Qualidade (todos os modos)

- Segurança: não expor segredos, RLS ativo, mínimo privilégio.
- Código: funções curtas, nomes claros, early return/guard clauses.
- UI/UX: responsivo, consistente, sem inline styles desnecessários.
- Performance: evitar refetches, usar memoização e paginação.
- Documentação: sucinta, com exemplos e instruções de uso.

## Fluxo de Trabalho Sugerido

1. Orchestrator: alinhamento e criação de checklist.
2. F Architect: modelo de dados/fluxo (inclui S‑38 quando pertinente).
3. Code: implementação incremental (commits pequenos) + testes.
4. Debug: validações e correções.
5. Orchestrator: revisão final, merge e atualização de docs.

## Exemplo de Handoff

- Orchestrator → F Architect: "Definir esquema de `designacoes` com regras S‑38 e conflito de versão".
- F Architect → Code: "Criar migração, políticas RLS e validações de elegibilidade no frontend".
- Code → Debug: "Adicionar testes E2E para conflitos e exportação PDF".
- Debug → Orchestrator: "RCA e fix confirmados; pronto para merge".

## Registro de Atividades (automático)

Este arquivo mantém um registro automático das atividades dos agentes.

Use o comando:

```bash
npm run agents:log -- --agent="Code" --action="Implement feature X" --status="completed" --details="arquivos Y/Z atualizados"
```

As entradas serão salvas em `agents.log.json` e refletidas abaixo.

<!-- AGENTS_LOG_START -->
<!-- Entradas serão inseridas automaticamente aqui. Não editar manualmente abaixo desta linha. -->
<!-- AGENTS_LOG_END -->

```

I’ll add a link to AGENTS.md in README.md, create the scripts/agents-log.js automation to log agent activities and update AGENTS.md, and wire an npm script agents:log in package.json.

```markdown
# Sua-Parte — Sistema Ministerial

O Sua-Parte é uma plataforma para gestão de materiais, programas e congregações, com Frontend React (Vite) e Backend Node.js (Express). Este documento descreve os papéis dos dashboards, além de trazer instruções objetivas de instalação e uso.

## Papéis dos Dashboards

### Admin Dashboard (Administradores)
- Importar e organizar materiais oficiais (PDF, JWPub, etc.).
- Gerenciar congregações, instrutores e permissões.
- Monitorar saúde do sistema e serviços do backend.

### Dashboard do Instrutor (Congregações)
- Visualizar a programação publicada pelo admin.
- Cadastrar e gerenciar estudantes da congregação.
- Designar partes da reunião aos estudantes.
- Operar offline com sincronização quando voltar a ficar online.

### Dashboard do Estudante (Leitura/Acompanhamento)
- Acessar materiais publicados para sua congregação.
- Consultar designações, histórico e programas disponibilizados.
- Acesso com perfil restrito (somente leitura das publicações).

## Tecnologias
- Frontend: React + TypeScript, Vite, TailwindCSS, shadcn/ui
- Backend: Node.js + Express, cron, integração com Supabase
- Testes: Cypress E2E

## Instalação
1. Clonar o repositório
```bash
git clone https://github.com/RobertoAraujoSilva/sua-parte.git
cd sua-parte
```

2. Instalar dependências (raiz)
```bash
npm install
```

3. Variáveis de ambiente
- Crie um arquivo `.env` na raiz (frontend) e outro em `backend/.env` se necessário.
- Exemplo (ajuste para seu ambiente — não compartilhe chaves reais):

Frontend (.env)
```env
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
```

Backend (backend/.env)
```env
PORT=3001
NODE_ENV=development
DOCS_PATH=../docs/Oficial
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_supabase_service_or_anon_key
```

## Execução
- Iniciar frontend e backend juntos (recomendado)
```bash
npm run dev:all
```

- Iniciar apenas o backend (porta padrão 3001)
```bash
npm run dev:backend-only
```

- Iniciar apenas o frontend (porta padrão 8080)
```bash
npm run dev:frontend-only
```

Portas padrão
- Frontend (Vite): http://localhost:8080
- Backend (Express): http://localhost:3001

## Acesso rápido
- Admin Dashboard: `http://localhost:8080/admin`
- Dashboard do Instrutor: `http://localhost:8080/` ou `http://localhost:8080/dashboard`
- Estudante: acesso controlado conforme publicação/perfil

## Testes (Cypress)
- Executar todos os testes
```bash
npm run cypress:run
```

- Exemplos de testes específicos
```bash
npm run test:audit
npm run test:auth
npm run test:programs
```

## Segurança e Boas Práticas
- Não exponha chaves ou credenciais no frontend; use variáveis de ambiente.
- Garanta RLS (Row Level Security) no Supabase e privilégios mínimos por papel.
- Trate erros em todas as chamadas de API e aplique early return/guard clauses.
- Mantenha componentes enxutos, reutilizáveis e consistentes com Tailwind/shadcn.

## Documentação adicional
- `ADMIN_DASHBOARD_INTEGRATION.md` — Integração e fluxo do Admin Dashboard
- `DEBUG_ADMIN_DASHBOARD.md` — Dicas de debug
- `README_ESTUDANTES.md` — Guia do módulo de estudantes
- Pasta `docs/` — Materiais e documentação complementar
- `AGENTS.md` — Orquestrador de personas e fluxo de trabalho (com registro automático de atividades)

## Licença
Projeto sob licença MIT. Consulte `LICENSE` para mais detalhes.

```

```json
{
  "name": "vite_react_shadcn_ts",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "dev:all": "concurrently \"npm run dev:backend\" \"npm run dev:frontend\"",
    "dev:backend": "cd backend && npm run dev",
    "dev:frontend": "vite",
    "dev:backend-only": "cd backend && npm run dev",
    "dev:frontend-only": "vite",
    "build": "vite build",
    "build:prod": "vite build --config vite.config.prod.ts",
    "build:analyze": "vite build --config vite.config.prod.ts && npm run analyze",
    "analyze": "npx vite-bundle-analyzer dist",
    "build:dev": "vite build --mode development",
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0",
    "typecheck": "tsc -p tsconfig.json",
    "preview": "vite preview",
    "start": "serve -s dist -l $PORT",
    "cypress:open": "cypress open",
    "cypress:run": "cypress run",
    "cypress:install": "cypress install",
    "cypress:verify": "cypress verify",
    "test:e2e": "cypress run --spec \"cypress/e2e/**/*.cy.ts\"",
    "test:e2e:open": "cypress open",
    "test:e2e:record": "cypress run --record",
    "test:franklin": "cypress run --spec \"cypress/e2e/franklin-login.cy.ts\"",
    "test:franklin:record": "cypress run --spec \"cypress/e2e/franklin-login.cy.ts\" --record",
    "test:sarah": "cypress run --spec \"cypress/e2e/sarah-student-registration.cy.ts\"",
    "test:sarah:record": "cypress run --spec \"cypress/e2e/sarah-student-registration.cy.ts\" --record",
    "test:birth-date": "cypress run --spec \"cypress/e2e/sarah-student-registration.cy.ts\"",
    "test:sarah:open": "cypress open --e2e --browser chrome",
    "test:audit": "cypress run --spec \"cypress/e2e/auditoria_sistema_ministerial.cy.ts\"",
    "test:audit:record": "cypress run --spec \"cypress/e2e/auditoria_sistema_ministerial.cy.ts\" --record",
    "test:auth": "cypress run --spec \"cypress/e2e/authentication-roles.cy.ts\"",
    "test:auth:record": "cypress run --spec \"cypress/e2e/authentication-roles.cy.ts\" --record",
    "test:pdf-upload": "cypress run --spec \"cypress/e2e/pdf-upload-functionality.cy.ts\"",
    "test:pdf-upload:record": "cypress run --spec \"cypress/e2e/pdf-upload-functionality.cy.ts\" --record",
    "env:validate": "node scripts/validate-env.js",
    "env:check": "node scripts/validate-env.js",
    "env:show": "node -e \"console.log('Environment Variables:'); Object.keys(process.env).filter(k => k.startsWith('VITE_') || ['NODE_ENV', 'DATABASE_URL'].includes(k)).forEach(k => console.log(k + '=' + (k.includes('SECRET') || k.includes('TOKEN') || k.includes('KEY') ? '[HIDDEN]' : process.env[k])))\"",
    "test:programs": "cypress run --spec \"cypress/e2e/programs-page-functionality.cy.ts\"",
    "test:programs:record": "cypress run --spec \"cypress/e2e/programs-page-functionality.cy.ts\" --record",
    "test:sistema-completo": "cypress run --spec \"cypress/e2e/sistema-ministerial-e2e.cy.ts\"",
    "test:sistema-completo:record": "cypress run --spec \"cypress/e2e/sistema-ministerial-e2e.cy.ts\" --record",
    "test:enhanced-parsing": "cypress run --spec \"cypress/e2e/enhanced-pdf-parsing.cy.ts\"",
    "test:enhanced-parsing:record": "cypress run --spec \"cypress/e2e/enhanced-pdf-parsing.cy.ts\" --record",
    "test:assignment-generation": "cypress run --spec \"cypress/e2e/assignment-generation.cy.ts\"",
    "test:assignment-generation:record": "cypress run --spec \"cypress/e2e/assignment-generation.cy.ts\" --record",
    "test:all-new": "cypress run --spec \"cypress/e2e/{pdf-upload-functionality,programs-page-functionality,sistema-ministerial-e2e,enhanced-pdf-parsing,assignment-generation}.cy.ts\"",
    "test:complete-workflow": "cypress run --spec \"cypress/e2e/{enhanced-pdf-parsing,assignment-generation}.cy.ts\"",
    "test:integration": "node src/verification/integration-test-cli.js",
    "test:integration:performance": "node -e \"import('./src/verification/tests/integration-test-runner.js').then(m => m.runIntegrationTestSuite())\"",
    "test:integration:services": "node -e \"console.log('🔗 Running service integration tests...'); import('./src/verification/tests/integration-test-runner.js').then(m => m.runIntegrationTestSuite())\"",
    "verify:integration": "node src/verification/test-integration-simple.js",
    "test:setup": "cypress install && cypress verify",
    "test:verification": "node src/verification/tests/test-runner.cjs",
    "test:verification:simple": "node src/verification/tests/test-runner.cjs --simple",
    "test:verification:basic": "node src/verification/tests/test-runner.cjs --basic",
    "audit:plan": "node ./scripts/audit-implementation.mjs",
    "verify:system": "node src/verification/cli.js --full",
    "verify:frontend": "node src/verification/cli.js --module=frontend",
    "verify:backend": "node src/verification/cli.js --module=backend",
    "verify:infrastructure": "node src/verification/cli.js --module=infrastructure",
    "verify:reports": "node src/verification/cli.js reports",
    "verify:reports:list": "node src/verification/cli.js reports list",
    "verify:reports:dashboard": "node src/verification/cli.js reports dashboard",
    "verify:reports:trends": "node src/verification/cli.js reports trends",
    "verify:reports:cleanup": "node src/verification/cli.js reports cleanup",
    "verify:reports:init": "node src/verification/cli.js reports init",
    "test:report-storage": "node src/verification/test-report-storage.js",
    "test:frontend-verifier": "node src/verification/test-frontend-verifier.js",
    "test": "cypress run",
    "test:open": "cypress open",
    "test:component": "cypress run --component",
    "test:performance": "lighthouse http://localhost:8080/admin --output html --output-path ./lighthouse-report.html",
    "optimize": "npm run build:prod && npm run analyze"
    "agents:log": "node scripts/agents-log.js"
  },
  "dependencies": {
    "@hello-pangea/dnd": "^18.0.1",
    "@hookform/resolvers": "^3.10.0",
    "@radix-ui/react-accordion": "^1.2.11",
    "@radix-ui/react-alert-dialog": "^1.1.14",
    "@radix-ui/react-aspect-ratio": "^1.1.7",
    "@radix-ui/react-avatar": "^1.1.10",
    "@radix-ui/react-checkbox": "^1.3.2",
    "@radix-ui/react-collapsible": "^1.1.11",
    "@radix-ui/react-context-menu": "^2.2.15",
    "@radix-ui/react-dialog": "^1.1.14",
    "@radix-ui/react-dropdown-menu": "^2.1.15",
    "@radix-ui/react-hover-card": "^1.1.14",
    "@radix-ui/react-label": "^2.1.7",
    "@radix-ui/react-menubar": "^1.1.15",
    "@radix-ui/react-navigation-menu": "^1.2.13",
    "@radix-ui/react-popover": "^1.1.14",
    "@radix-ui/react-progress": "^1.1.7",
    "@radix-ui/react-radio-group": "^1.3.7",
    "@radix-ui/react-scroll-area": "^1.2.9",
    "@radix-ui/react-select": "^2.2.5",
    "@radix-ui/react-separator": "^1.1.7",
    "@radix-ui/react-slider": "^1.3.5",
    "@radix-ui/react-slot": "^1.2.3",
    "@radix-ui/react-switch": "^1.2.5",
    "@radix-ui/react-tabs": "^1.1.12",
    "@radix-ui/react-toast": "^1.2.14",
    "@radix-ui/react-toggle": "^1.1.9",
    "@radix-ui/react-toggle-group": "^1.1.10",
    "@radix-ui/react-tooltip": "^1.2.7",
    "@supabase/mcp-server-supabase": "^0.4.5",
    "@supabase/supabase-js": "^2.54.0",
    "@tanstack/react-query": "^5.83.0",
    "ag-grid-community": "^34.1.1",
    "ag-grid-react": "^34.1.1",
    "cheerio": "^1.1.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cmdk": "^1.1.1",
    "date-fns": "^3.6.0",
    "dotenv": "^17.2.1",
    "embla-carousel-react": "^8.6.0",
    "fs-extra": "^11.3.1",
    "i18next": "^25.3.6",
    "i18next-browser-languagedetector": "^8.2.0",
    "input-otp": "^1.4.2",
    "jspdf": "^3.0.1",
    "lucide-react": "^0.462.0",
    "next-themes": "^0.3.0",
    "node-fetch": "^3.3.2",
    "pdf-parse": "^1.1.1",
    "qrcode.react": "^4.2.0",
    "react": "^18.3.1",
    "react-day-picker": "^8.10.1",
    "react-dom": "^18.3.1",
    "react-error-boundary": "^6.0.0",
    "react-hook-form": "^7.61.1",
    "react-i18next": "^15.6.1",
    "react-resizable-panels": "^2.1.9",
    "react-router-dom": "^6.30.1",
    "recharts": "^2.15.4",
    "serve": "^14.2.3",
    "sonner": "^1.7.4",
    "tailwind-merge": "^2.6.0",
    "tailwindcss-animate": "^1.0.7",
    "vaul": "^0.9.9",
    "xlsx": "^0.18.5",
    "zod": "^3.25.76"
  },
  "overrides": {
    "rollup": "^4.0.0"
  },
  "devDependencies": {
    "@eslint/js": "^9.32.0",
    "@tailwindcss/typography": "^0.5.16",
    "@types/babel__core": "^7.20.5",
    "@types/babel__generator": "^7.27.0",
    "@types/babel__template": "^7.4.4",
    "@types/node": "^22.17.1",
    "@types/react": "^18.3.23",
    "@types/react-dom": "^18.3.7",
    "@vitejs/plugin-react": "^4.3.1",
    "autoprefixer": "^10.4.21",
    "concurrently": "^9.2.0",
    "cssnano": "^7.1.0",
    "cypress": "^13.17.0",
    "eslint": "^9.32.0",
    "eslint-plugin-react-hooks": "^5.2.0",
    "eslint-plugin-react-refresh": "^0.4.20",
    "fast-glob": "^3.3.3",
    "globals": "^15.15.0",
    "lovable-tagger": "^1.1.9",
    "postcss": "^8.5.6",
    "rollup-plugin-visualizer": "^6.0.3",
    "tailwindcss": "^3.4.17",
    "terser": "^5.43.1",
    "typescript": "^5.8.3",
    "typescript-eslint": "^8.38.0",
    "vite": "^5.0.0",
    "vite-plugin-pwa": "^1.0.3"
  }
}

```

```javascript
#!/usr/bin/env node
const fs = require('fs');
const path = require('path');

function parseArgs() {
  const args = process.argv.slice(2);
  const result = {};
  for (const arg of args) {
    if (arg.startsWith('--')) {
      const [key, ...rest] = arg.replace(/^--/, '').split('=');
      result[key] = rest.join('=');
    }
  }
  return result;
}

function loadJSON(file) {
  try {
    return JSON.parse(fs.readFileSync(file, 'utf8'));
  } catch (_) {
    return [];
  }
}

function saveJSON(file, data) {
  fs.writeFileSync(file, JSON.stringify(data, null, 2) + '\n', 'utf8');
}

function updateAgentsMd(logEntries) {
  const agentsMdPath = path.resolve(process.cwd(), 'AGENTS.md');
  if (!fs.existsSync(agentsMdPath)) return;
  const md = fs.readFileSync(agentsMdPath, 'utf8');
  const start = '<!-- AGENTS_LOG_START -->';
  const end = '<!-- AGENTS_LOG_END -->';
  const startIdx = md.indexOf(start);
  const endIdx = md.indexOf(end);
  if (startIdx === -1 || endIdx === -1 || endIdx < startIdx) return;

  const sliceBefore = md.slice(0, startIdx + start.length);
  const sliceAfter = md.slice(endIdx);

  const lines = logEntries.slice(-50).map(e => {
    const ts = new Date(e.timestamp).toISOString();
    return `\n- [${ts}] **${e.agent}**: ${e.action} (${e.status})${e.details ? ` — ${e.details}` : ''}`;
  }).join('');

  const next = sliceBefore + '\n' + lines + '\n' + sliceAfter;
  fs.writeFileSync(agentsMdPath, next, 'utf8');
}

function main() {
  const args = parseArgs();
  const { agent = 'Orchestrator', action = 'unspecified', status = 'pending', details = '' } = args;

  const logPath = path.resolve(process.cwd(), 'agents.log.json');
  const entries = loadJSON(logPath);
  const entry = {
    timestamp: Date.now(),
    agent,
    action,
    status,
    details
  };
  entries.push(entry);
  saveJSON(logPath, entries);
  updateAgentsMd(entries);
  console.log('Logged:', entry);
}

main();


```

Adicionei:
- Link para `AGENTS.md` no `README.md`.
- Automação de registro:
  - `scripts/agents-log.js` que grava em `agents.log.json` e atualiza a seção de log em `AGENTS.md`.
  - Script npm: `npm run agents:log -- --agent="Code" --action="Implementar X" --status="completed" --details="..."`.

Quer que eu registre uma primeira entrada de exemplo agora?

---

**User**

coloque nele um indice "C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_E_202509.pdf"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_E_202511.pdf"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_T_202507.daisy.zip"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_T_202509.daisy.zip"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_T_202509.jwpub"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_T_202511.jwpub"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\S-38_E.rtf"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\WhatsApp Image 2025-08-14 at 19.44.07 (1).jpeg"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\WhatsApp Image 2025-08-14 at 19.44.07.jpeg"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\estudantes_ficticios.xlsx"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\estudantes_rows.sql"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_E_202507.pdf" "C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\CONSOLE_LOG_FIXES.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\CORRECAO_ERRO_DATA_DESIGNACOES.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\CORRECAO_QRCODE_BUILD.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\CORREÇÕES_AUDITORIA_PWA.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\CORRECOES_TIPOS_MAPEAMENTOS.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\CORRECTED_DEVELOPER_REGISTRATION_GUIDE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\CREDENCIAIS_TESTE_SISTEMA_COMPLETO.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\CRITICAL_ASSIGNMENT_FIXES_SUMMARY.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\CRITICAL_DATABASE_MIGRATION_APPLIED.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\CRITICAL_OPTIMIZATIONS_COMPLETE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\CYPRESS_CICD_IMPLEMENTATION_SUMMARY.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\CYPRESS_CLOUD_CICD_SETUP.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\CYPRESS_CLOUD_SETUP.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\CYPRESS_CLOUD_TROUBLESHOOTING.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\CYPRESS_TESTING_SETUP.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\CYPRESS_TROUBLESHOOTING.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\DASHBOARD_LOGOUT_FIX.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\DEBUG_ADMIN_DASHBOARD.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\DEPLOYMENT_AUTHORIZATION_FIX.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\DEVELOPER_PANEL_IMPLEMENTATION_COMPLETE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\DEVELOPER_REGISTRATION_VALIDATION_REPORT.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\DOCUMENTACAO_COMPLETA.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\DOCUMENTACAO_TECNICA_CONVITES_FAMILIARES.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\EMAIL_CONFIRMATION_FIX.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\ENHANCED_PDF_PARSING.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\ENVIRONMENT_CONFIGURATION_COMPLETE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\ENVIRONMENT_SETUP_GUIDE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\EXCEL_IMPORT_GUIDE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\EXECUTION_TASKS_TRACKER.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\FAMILY_INVITATIONS_BUG_FIX.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\FAMILY_INVITATIONS_FEATURE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\FAMILY_INVITATIONS_IMPLEMENTATION.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\FAMILY_MANAGEMENT_BUG_FIX.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\FAMILY_MANAGEMENT_TESTING_GUIDE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\FAMILY_MEMBER_INSERT_BUG_FIX.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\FAQ_DELIVERABLES_SUMMARY.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\FAQ_SECTION_IMPLEMENTATION.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\GITHUB_ACTIONS_SETUP.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\GITHUB_REPOSITORY_SETUP.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\GUIA_ADMINISTRADOR_SISTEMA_MINISTERIAL.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\GUIA_TESTES_CYPRESS.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\GUIA_TRADUCAO_COMPLETA.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\GUIA_USUARIO.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\guia-desenvolvedor-logout.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\HEADER_AUTHENTICATION_FIX.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\historico-problemas-logout.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\IMPLEMENTACAO_COMPLETA_FINAL.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\IMPLEMENTACAO_COMPLETA_SISTEMA_MINISTERIAL.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\IMPLEMENTACAO_REGRA_S38_OFICIAL.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\IMPLEMENTATION_PLAN.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\INFINITE_LOADING_FIX.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\INTEGRACAO_DASHBOARDS_UNIFICADA.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\INTERNATIONAL_PHONE_SUPPORT.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\MEETINGS_DATABASE_IMPLEMENTATION_COMPLETE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\MELHORIAS_IMPORTACAO_PLANILHA.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\PACKAGE_MANAGER_LOCKFILE_RESOLUTION.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\PAGE_REFRESH_FIX.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\PAGE_REFRESH_LOADING_FIX.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\PAINEL_INSTRUTOR_INTERATIVO.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\PERFORMANCE_OPTIMIZATIONS_IMPLEMENTED.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\PLANO.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\PLANO_IMPLEMENTACAO_HISTORICO_FILA_JUSTA.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\PRD.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\problemas-logout-sistema-ministerial.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\PRODUCTION_DEPLOYMENT_FIX.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\PRODUCTION_URL_UPDATE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\PROFILE_FETCH_FIX.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\PROFILE_FETCH_TIMEOUT_FIXES.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\PROGRAM_PREVIEW_SYSTEM_COMPLETE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\PROGRAMA_HARMONIZACAO_AMANHA.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\PROGRAMAS_SETUP.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\PROXIMAS_TAREFAS.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\PULL_REQUEST_DESCRIPTION.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\QUESTIONARIO_PROJETO_SISTEMA_MINISTERIAL.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\QUICK_DEPLOYMENT_FIX.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\REACT_HOOKS_ISSUE_FIX.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\REACT_USEEFFECT_FIX.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\README.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\README_ESTUDANTES.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\RECORD_KEY_GENERATION_GUIDE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\REGIONAL_CONNECTIVITY_FIXES.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\RESPOSTAS_QUESTIONARIO.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\ROUTE_AUDIT_AND_UX_REVISION.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\ROUTE_AUDIT_IMPLEMENTATION_COMPLETE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\ROUTING_FIX_SUMMARY.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\SARAH_CYPRESS_TEST.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\SCHEMA_FIX_APPLICATION_GUIDE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\SECURITY_FIX_REPORT.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\SIGNUP_ERROR_FIX.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\SISTEMA_BILINGUE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\SISTEMA_DESIGNACOES_S38T.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\SISTEMA_TUTORIAIS_INTERATIVOS.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\SISTEMA-UNIFICADO.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\SOLUCAO_WEBSOCKET.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\STUDENT_LOGIN_DEBUG_GUIDE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\STUDENT_LOGOUT_IMPLEMENTATION.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\STUDENT_PORTAL_IMPLEMENTATION.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\SUPABASE_AUTHENTICATION_FIXES_SUMMARY.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\SUPABASE_CLIENT_TIMEOUT_FIX.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\SUPABASE_EMAIL_TEMPLATE_CONFIG.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\SUPABASE_URL_CONFIG_COMPLETE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\SUPABASE_URL_CONFIGURATION.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\SYSTEM_FLOW.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\SYSTEM_FLOW_DIAGRAM.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\SYSTEM_LOGIC_DOCUMENTATION.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\TABLET_RESPONSIVENESS_FIXES.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\TAILWIND_CONFIGURATION_UPDATE_SUMMARY.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\TASK_14_COMPLETION_SUMMARY.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\TESTE_SISTEMA_BILINGUE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\TUTORIAL_IMPORT_ERROR_FIX_COMPLETE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\UNIFICACAO_SCRIPTS.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\UNIFIED_DASHBOARD_INTEGRATION_SUMMARY.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\VERIFICACAO_CYPRESS_BUILD.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\VERIFICATION_SYSTEM_GUIDE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\VERIFICATION_SYSTEM_IMPLEMENTATION_COMPLETE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\ZOOM_RESPONSIVENESS_TESTING_GUIDE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\ZOOM_RESPONSIVENESS_TESTING_IMPLEMENTATION_SUMMARY.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\ADMIN_DASHBOARD_INTEGRATION.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\ANALISE_COMPLETA_SISTEMA_MINISTERIAL.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\ANALISE_DASHBOARDS_INTEGRACAO.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\ANALISE_RESPOSTAS_QUESTIONARIO.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\APPLICATION_READINESS_ASSESSMENT.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\APPLY_DATABASE_MIGRATION_NOW.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\ASSIGNMENT_GENERATION_SYSTEM.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\ASSIGNMENT_SYSTEM_IMPLEMENTATION_COMPLETE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\ASSIGNMENT_SYSTEM_REPAIR_GUIDE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\ASSIGNMENT_WORKFLOW_GUIDE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\AUDITORIA_E_IMPLANTACAO.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\AUTH_TIMEOUT_FIXES_COMPREHENSIVE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\AUTH_TROUBLESHOOTING.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\AUTHENTICATION_STATUS_REPORT.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\BIRTH_DATE_FEATURE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\BUILD_ERRORS_FIXED.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\CACHE_ASIDE_PATTERN_GUIDE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\CHECKLIST_IMPLEMENTACAO.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\CI_CD_COMPLETION_GUIDE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\CI_CD_INTEGRATION_SUMMARY.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\COMPREHENSIVE_TUTORIAL_SYSTEM_COMPLETE.md"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\COMPREHENSIVE_VALIDATION_ASSESSMENT_REPORT.md"  Skip to main content
Roo Code Logo
Search
ctrl
K
19.4k
Install ·
826.9k

Welcome
Getting Started
Installing Roo Code
Connecting To AI Provider
Your First Task
The Chat Interface
Typing Your Requests
How Tools Work
Context Mentions
Using Modes
Tips & Tricks
Tutorial Videos
Roo Code Cloud
Features
API Configuration Profiles
Auto-Approving Actions
Boomerang Tasks
Browser Use
Checkpoints
Code Actions
Codebase Indexing
Custom Instructions
Diagnostics Integration
Customizing Modes
Diff/Fast Edits
Enhance Prompt
Import/Export/Reset Settings
Intelligent Context Condensing
Keyboard Navigation
Roo Code Marketplace
Message Queueing
Model Temperature
Multi-File Reads
.rooignore
Slash Commands
Suggested Responses
Task Todo List
Terminal Shell Integration
MCP
Experimental
Additional Features
Advanced Usage
Model Providers
FAQ
Contributing (GitHub)
Roocabulary (GitHub)
Update Notes
FeaturesBoomerang Tasks

Copy Page
Boomerang Tasks: Orchestrate Complex Workflows
Boomerang Tasks (also known as subtasks or task orchestration) allow you to break down complex projects into smaller, manageable pieces using the built-in 🪃 Orchestrator Mode (aka Boomerang Mode). Think of it like delegating parts of your work to specialized assistants. Each subtask runs in its own context, often using a different Roo Code mode tailored for that specific job (like 💻 Code, 🏗️ Architect, or 🪲 Debug). The Orchestrator mode manages this process.



Orchestrator Mode is Built-In
The 🪃 Orchestrator mode (previously achieved via a custom "Boomerang Mode") is now a built-in mode specifically designed to orchestrate workflows by breaking down tasks and delegating them to other modes. You no longer need to create a custom mode for this functionality.

Learn more about Built-in Modes.

Why Use Boomerang Tasks?
Tackle Complexity: Break large, multi-step projects (e.g., building a full feature) into focused subtasks (e.g., design, implementation, documentation).
Use Specialized Modes: Automatically delegate subtasks to the mode best suited for that specific piece of work, leveraging specialized capabilities for optimal results.
Maintain Focus & Efficiency: Each subtask operates in its own isolated context with a separate conversation history. This prevents the parent (orchestrator) task from becoming cluttered with the detailed execution steps (like code diffs or file analysis results), allowing it to focus efficiently on the high-level workflow and manage the overall process based on concise summaries from completed subtasks.
Streamline Workflows: Results from one subtask can be automatically passed to the next, creating a smooth flow (e.g., architectural decisions feeding into the coding task).
How It Works
When in the 🪃 Orchestrator mode (aka Boomerang Mode), Roo analyzes a complex task and suggests breaking it down into a subtask1.

The parent task (in Orchestrator mode) pauses, and the new subtask begins in a different, specialized mode2.

When the subtask's goal is achieved, Roo signals completion.

The parent task resumes with only the summary3 of the subtask. The parent uses this summary to continue the main workflow.

Key Considerations
Approval Required: By default, you must approve the creation and completion of each subtask. This can be automated via the Auto-Approving Actions settings if desired.
Context Isolation and Transfer: Each subtask operates in complete isolation with its own conversation history. It does not automatically inherit the parent's context. Information must be explicitly passed:
Down: Via the initial instructions provided when the subtask is created.
Up: Via the final summary provided when the subtask finishes. Be mindful that only this summary returns to the parent.
Navigation: Roo's interface helps you see the hierarchy of tasks (which task is the parent, which are children). You can typically navigate between active and paused tasks.
Boomerang Tasks provide a powerful way to manage complex development workflows directly within Roo Code, leveraging specialized modes for maximum efficiency.

Keep Tasks Focused
Use subtasks (delegated via Orchestrator mode) to maintain clarity. If a request significantly shifts focus or requires a different expertise (mode), consider creating a subtask rather than overloading the current one.

Frequently Asked Questions
Why can't Orchestrator mode read files, write files, call MCPs, or run commands?
The Orchestrator mode is intentionally limited to focus on high-level workflow management. Giving it the ability to read files by default causes the context to become filled with file reads, hampering its ability to remain focused on orchestration. The design philosophy is that subtasks should handle the detailed work and return only the necessary information (via their completion summaries) for the orchestrator to delegate further tasks effectively.

This limitation helps prevent context poisoning, where irrelevant or excessive information contaminates the model's active context, leading to degraded performance and task deviation.

How can I override Orchestrator mode's limitations?
You can customize the Orchestrator mode to add capabilities like file reading by following the configuration precedence system:

Open the Command Palette and select "Edit Global Modes"
Copy and paste this configuration:
{
  "customModes": [
    {
      "slug": "orchestrator",
      "name": "🪃 Orchestrator",
      "roleDefinition": "You are Roo, a strategic workflow orchestrator who coordinates complex tasks by delegating them to appropriate specialized modes. You have a comprehensive understanding of each mode's capabilities and limitations, allowing you to effectively break down complex problems into discrete tasks that can be solved by different specialists.",
      "customInstructions": "Your role is to coordinate complex workflows by delegating tasks to specialized modes. As an orchestrator, you should:\n\n1. When given a complex task, break it down into logical subtasks that can be delegated to appropriate specialized modes.\n\n2. For each subtask, use the `new_task` tool to delegate. Choose the most appropriate mode for the subtask's specific goal and provide comprehensive instructions in the `message` parameter. These instructions must include:\n    *   All necessary context from the parent task or previous subtasks required to complete the work.\n    *   A clearly defined scope, specifying exactly what the subtask should accomplish.\n    *   An explicit statement that the subtask should *only* perform the work outlined in these instructions and not deviate.\n    *   An instruction for the subtask to signal completion by using the `attempt_completion` tool, providing a concise yet thorough summary of the outcome in the `result` parameter, keeping in mind that this summary will be the source of truth used to keep track of what was completed on this project. \n    *   A statement that these specific instructions supersede any conflicting general instructions the subtask's mode might have.\n\n3. Track and manage the progress of all subtasks. When a subtask is completed, analyze its results and determine the next steps.\n\n4. Help the user understand how the different subtasks fit together in the overall workflow. Provide clear reasoning about why you're delegating specific tasks to specific modes.\n\n5. When all subtasks are completed, synthesize the results and provide a comprehensive overview of what was accomplished.\n\n6. Ask clarifying questions when necessary to better understand how to break down complex tasks effectively.\n\n7. Suggest improvements to the workflow based on the results of completed subtasks.\n\nUse subtasks to maintain clarity. If a request significantly shifts focus or requires a different expertise (mode), consider creating a subtask rather than overloading the current one.",
      "groups": [
        "read"
      ],
      "source": "global"
    }
  ]
}

Save the file. Your global Orchestrator mode will now have read capabilities.
warning
Adding capabilities to the Orchestrator mode should be done thoughtfully. The limited default capabilities help maintain focus on orchestration rather than implementation details.

Footnotes
This context is passed via the message parameter of the new_task tool when the Orchestrator mode delegates the task. ↩

The mode for the subtask is specified via the mode parameter of the new_task tool during initiation by the Orchestrator mode. ↩

This summary is passed via the result parameter of the attempt_completion tool when the subtask finishes. ↩

Edit this page
Last updated on Aug 29, 2025
Previous
Auto-Approving Actions
Next
Browser Use
Why Use Boomerang Tasks?
How It Works
Key Considerations
Frequently Asked Questions
Why can't Orchestrator mode read files, write files, call MCPs, or run commands?
How can I override Orchestrator mode's limitations?
Roo Code Logo
Empowering developers to build better software faster with AI-powered tools and insights.
GitHub
Issues
Feature Requests
Download
VS Code Marketplace
Open VSX Registry
Company
Contact
Careers
Website Privacy Policy
Extension Privacy Policy

---

**Cursor**

```markdown
# AGENTS.md — Orquestrador de Personas

Este arquivo define o orquestrador e as personas especializadas para guiar o fluxo de trabalho no projeto. Use-o como referência para alternar modos e coordenar tarefas.

## Modos Disponíveis

- F Architect (Planejar)
  - Foco: planejar arquitetura, fluxos, modelos de dados e regras (S‑38), antes de codar.
  - Saídas: diagramas, especificações, critérios de aceite, riscos.

- Code (Implementar)
  - Foco: escrever, modificar e refatorar código seguindo SOLID/DRY e UI consistente (Tailwind + shadcn/ui).
  - Saídas: commits pequenos, testes adicionados/ajustados, docs breves.

- ? Ask (Descobrir)
  - Foco: esclarecer dúvidas e justificar decisões, explicar trade-offs.
  - Saídas: respostas objetivas, comparativos, referências internas.

- Debug (Diagnosticar)
  - Foco: reproduzir, isolar e corrigir defeitos; adicionar testes de regressão.
  - Saídas: RCA, fix verificado, métricas (antes/depois) quando aplicável.

- Orchestrator (Orquestrar)
  - Foco: coordenar tarefas entre modos, dividir trabalho em etapas, garantir handoffs limpos.
  - Saídas: plano de execução, checklist, ordem de operações e critérios de conclusão.

## Atalhos de Modo

- Ctrl + .  → próximo modo
- Ctrl + Shift + .  → modo anterior

## Diretrizes do Orquestrador

1) Começar no modo F Architect para planejar:
   - Definir objetivo, requisitos, riscos, critérios de aceite.
   - Mapear entidades/tabelas, políticas RLS e regras S‑38 relevantes.

2) Delegar para Code com escopo claro:
   - Descrever arquivos a alterar/criar e pontos de integração.
   - Exigir testes (Cypress/E2E, unitários quando couber) e verificação de lint.

3) Usar ? Ask quando houver ambiguidades:
   - Formular perguntas fechadas e decisões com prós/cons.

4) Invocar Debug após implementação:
   - Reproduzir, criar testes de regressão, verificar métricas/perf.

5) Encerrar ciclo com documentação mínima:
   - Atualizar README/README_EXTENDIDO, CHANGELOG e anotações de decisões.

## Padrões de Qualidade (todos os modos)

- Segurança: não expor segredos, RLS ativo, mínimo privilégio.
- Código: funções curtas, nomes claros, early return/guard clauses.
- UI/UX: responsivo, consistente, sem inline styles desnecessários.
- Performance: evitar refetches, usar memoização e paginação.
- Documentação: sucinta, com exemplos e instruções de uso.

## Fluxo de Trabalho Sugerido

1. Orchestrator: alinhamento e criação de checklist.
2. F Architect: modelo de dados/fluxo (inclui S‑38 quando pertinente).
3. Code: implementação incremental (commits pequenos) + testes.
4. Debug: validações e correções.
5. Orchestrator: revisão final, merge e atualização de docs.

## Exemplo de Handoff

- Orchestrator → F Architect: "Definir esquema de `designacoes` com regras S‑38 e conflito de versão".
- F Architect → Code: "Criar migração, políticas RLS e validações de elegibilidade no frontend".
- Code → Debug: "Adicionar testes E2E para conflitos e exportação PDF".
- Debug → Orchestrator: "RCA e fix confirmados; pronto para merge".

## Registro de Atividades (automático)

Este arquivo mantém um registro automático das atividades dos agentes.

Use o comando:

```bash
npm run agents:log -- --agent="Code" --action="Implement feature X" --status="completed" --details="arquivos Y/Z atualizados"
```

As entradas serão salvas em `agents.log.json` e refletidas abaixo.

<!-- AGENTS_LOG_START -->
<!-- Entradas serão inseridas automaticamente aqui. Não editar manualmente abaixo desta linha. -->
<!-- AGENTS_LOG_END -->

## Índice de Materiais e Documentos

### Materiais Oficiais (servidos pelo backend)
- mwb_E_202507.pdf — `http://localhost:3001/materials/mwb_E_202507.pdf`
- mwb_E_202509.pdf — `http://localhost:3001/materials/mwb_E_202509.pdf`
- mwb_E_202511.pdf — `http://localhost:3001/materials/mwb_E_202511.pdf`
- mwb_T_202507.daisy.zip — `http://localhost:3001/materials/mwb_T_202507.daisy.zip`
- mwb_T_202509.daisy.zip — `http://localhost:3001/materials/mwb_T_202509.daisy.zip`
- mwb_T_202509.jwpub — `http://localhost:3001/materials/mwb_T_202509.jwpub`
- mwb_T_202511.jwpub — `http://localhost:3001/materials/mwb_T_202511.jwpub`
- S-38_E.rtf — `http://localhost:3001/materials/S-38_E.rtf`
- WhatsApp Image 2025-08-14 at 19.44.07 (1).jpeg — `http://localhost:3001/materials/WhatsApp%20Image%202025-08-14%20at%2019.44.07%20%281%29.jpeg`
- WhatsApp Image 2025-08-14 at 19.44.07.jpeg — `http://localhost:3001/materials/WhatsApp%20Image%202025-08-14%20at%2019.44.07.jpeg`
- estudantes_ficticios.xlsx — `http://localhost:3001/materials/estudantes_ficticios.xlsx`
- estudantes_rows.sql — `http://localhost:3001/materials/estudantes_rows.sql`

### Documentação (links no repositório)
- docs/CONSOLE_LOG_FIXES.md
- docs/CORRECAO_ERRO_DATA_DESIGNACOES.md
- docs/CORRECAO_QRCODE_BUILD.md
- docs/CORREÇÕES_AUDITORIA_PWA.md
- docs/CORRECOES_TIPOS_MAPEAMENTOS.md
- docs/CORRECTED_DEVELOPER_REGISTRATION_GUIDE.md
- docs/CREDENCIAIS_TESTE_SISTEMA_COMPLETO.md
- docs/CRITICAL_ASSIGNMENT_FIXES_SUMMARY.md
- docs/CRITICAL_DATABASE_MIGRATION_APPLIED.md
- docs/CRITICAL_OPTIMIZATIONS_COMPLETE.md
- docs/CYPRESS_CICD_IMPLEMENTATION_SUMMARY.md
- docs/CYPRESS_CLOUD_CICD_SETUP.md
- docs/CYPRESS_CLOUD_SETUP.md
- docs/CYPRESS_CLOUD_TROUBLESHOOTING.md
- docs/CYPRESS_TESTING_SETUP.md
- docs/CYPRESS_TROUBLESHOOTING.md
- docs/DASHBOARD_LOGOUT_FIX.md
- docs/DEBUG_ADMIN_DASHBOARD.md
- docs/DEPLOYMENT_AUTHORIZATION_FIX.md
- docs/DEVELOPER_PANEL_IMPLEMENTATION_COMPLETE.md
- docs/DEVELOPER_REGISTRATION_VALIDATION_REPORT.md
- docs/DOCUMENTACAO_COMPLETA.md
- docs/DOCUMENTACAO_TECNICA_CONVITES_FAMILIARES.md
- docs/EMAIL_CONFIRMATION_FIX.md
- docs/ENHANCED_PDF_PARSING.md
- docs/ENVIRONMENT_CONFIGURATION_COMPLETE.md
- docs/ENVIRONMENT_SETUP_GUIDE.md
- docs/EXCEL_IMPORT_GUIDE.md
- docs/EXECUTION_TASKS_TRACKER.md
- docs/FAMILY_INVITATIONS_BUG_FIX.md
- docs/FAMILY_INVITATIONS_FEATURE.md
- docs/FAMILY_INVITATIONS_IMPLEMENTATION.md
- docs/FAMILY_MANAGEMENT_BUG_FIX.md
- docs/FAMILY_MANAGEMENT_TESTING_GUIDE.md
- docs/FAMILY_MEMBER_INSERT_BUG_FIX.md
- docs/FAQ_DELIVERABLES_SUMMARY.md
- docs/FAQ_SECTION_IMPLEMENTATION.md
- docs/GITHUB_ACTIONS_SETUP.md
- docs/GITHUB_REPOSITORY_SETUP.md
- docs/GUIA_ADMINISTRADOR_SISTEMA_MINISTERIAL.md
- docs/GUIA_TESTES_CYPRESS.md
- docs/GUIA_TRADUCAO_COMPLETA.md
- docs/GUIA_USUARIO.md
- docs/guia-desenvolvedor-logout.md
- docs/HEADER_AUTHENTICATION_FIX.md
- docs/historico-problemas-logout.md
- docs/IMPLEMENTACAO_COMPLETA_FINAL.md
- docs/IMPLEMENTACAO_COMPLETA_SISTEMA_MINISTERIAL.md
- docs/IMPLEMENTACAO_REGRA_S38_OFICIAL.md
- docs/IMPLEMENTATION_PLAN.md
- docs/INFINITE_LOADING_FIX.md
- docs/INTEGRACAO_DASHBOARDS_UNIFICADA.md
- docs/INTERNATIONAL_PHONE_SUPPORT.md
- docs/MEETINGS_DATABASE_IMPLEMENTATION_COMPLETE.md
- docs/MELHORIAS_IMPORTACAO_PLANILHA.md
- docs/PACKAGE_MANAGER_LOCKFILE_RESOLUTION.md
- docs/PAGE_REFRESH_FIX.md
- docs/PAGE_REFRESH_LOADING_FIX.md
- docs/PAINEL_INSTRUTOR_INTERATIVO.md
- docs/PERFORMANCE_OPTIMIZATIONS_IMPLEMENTED.md
- docs/PLANO.md
- docs/PLANO_IMPLEMENTACAO_HISTORICO_FILA_JUSTA.md
- docs/PRD.md
- docs/problemas-logout-sistema-ministerial.md
- docs/PRODUCTION_DEPLOYMENT_FIX.md
- docs/PRODUCTION_URL_UPDATE.md
- docs/PROFILE_FETCH_FIX.md
- docs/PROFILE_FETCH_TIMEOUT_FIXES.md
- docs/PROGRAM_PREVIEW_SYSTEM_COMPLETE.md
- docs/PROGRAMA_HARMONIZACAO_AMANHA.md
- docs/PROGRAMAS_SETUP.md
- docs/PROXIMAS_TAREFAS.md
- docs/PULL_REQUEST_DESCRIPTION.md
- docs/QUESTIONARIO_PROJETO_SISTEMA_MINISTERIAL.md
- docs/QUICK_DEPLOYMENT_FIX.md
- docs/REACT_HOOKS_ISSUE_FIX.md
- docs/REACT_USEEFFECT_FIX.md
- docs/README.md
- docs/README_ESTUDANTES.md
- docs/RECORD_KEY_GENERATION_GUIDE.md
- docs/REGIONAL_CONNECTIVITY_FIXES.md
- docs/RESPOSTAS_QUESTIONARIO.md
- docs/ROUTE_AUDIT_AND_UX_REVISION.md
- docs/ROUTE_AUDIT_IMPLEMENTATION_COMPLETE.md
- docs/ROUTING_FIX_SUMMARY.md
- docs/SARAH_CYPRESS_TEST.md
- docs/SCHEMA_FIX_APPLICATION_GUIDE.md
- docs/SECURITY_FIX_REPORT.md
- docs/SIGNUP_ERROR_FIX.md
- docs/SISTEMA_BILINGUE.md
- docs/SISTEMA_DESIGNACOES_S38T.md
- docs/SISTEMA_TUTORIAIS_INTERATIVOS.md
- docs/SISTEMA-UNIFICADO.md
- docs/SOLUCAO_WEBSOCKET.md
- docs/STUDENT_LOGIN_DEBUG_GUIDE.md
- docs/STUDENT_LOGOUT_IMPLEMENTATION.md
- docs/STUDENT_PORTAL_IMPLEMENTATION.md
- docs/SUPABASE_AUTHENTICATION_FIXES_SUMMARY.md
- docs/SUPABASE_CLIENT_TIMEOUT_FIX.md
- docs/SUPABASE_EMAIL_TEMPLATE_CONFIG.md
- docs/SUPABASE_URL_CONFIG_COMPLETE.md
- docs/SUPABASE_URL_CONFIGURATION.md
- docs/SYSTEM_FLOW.md
- docs/SYSTEM_FLOW_DIAGRAM.md
- docs/SYSTEM_LOGIC_DOCUMENTATION.md
- docs/TABLET_RESPONSIVENESS_FIXES.md
- docs/TAILWIND_CONFIGURATION_UPDATE_SUMMARY.md
- docs/TASK_14_COMPLETION_SUMMARY.md
- docs/TESTE_SISTEMA_BILINGUE.md
- docs/TUTORIAL_IMPORT_ERROR_FIX_COMPLETE.md
- docs/UNIFICACAO_SCRIPTS.md
- docs/UNIFIED_DASHBOARD_INTEGRATION_SUMMARY.md
- docs/VERIFICACAO_CYPRESS_BUILD.md
- docs/VERIFICATION_SYSTEM_GUIDE.md
- docs/VERIFICATION_SYSTEM_IMPLEMENTATION_COMPLETE.md
- docs/ZOOM_RESPONSIVENESS_TESTING_GUIDE.md
- docs/ZOOM_RESPONSIVENESS_TESTING_IMPLEMENTATION_SUMMARY.md
- docs/ADMIN_DASHBOARD_INTEGRATION.md
- docs/ANALISE_COMPLETA_SISTEMA_MINISTERIAL.md
- docs/ANALISE_DASHBOARDS_INTEGRACAO.md
- docs/ANALISE_RESPOSTAS_QUESTIONARIO.md
- docs/APPLICATION_READINESS_ASSESSMENT.md
- docs/APPLY_DATABASE_MIGRATION_NOW.md
- docs/ASSIGNMENT_GENERATION_SYSTEM.md
- docs/ASSIGNMENT_SYSTEM_IMPLEMENTATION_COMPLETE.md
- docs/ASSIGNMENT_SYSTEM_REPAIR_GUIDE.md
- docs/ASSIGNMENT_WORKFLOW_GUIDE.md
- docs/AUDITORIA_E_IMPLANTACAO.md
- docs/AUTH_TIMEOUT_FIXES_COMPREHENSIVE.md
- docs/AUTH_TROUBLESHOOTING.md
- docs/AUTHENTICATION_STATUS_REPORT.md
- docs/BIRTH_DATE_FEATURE.md
- docs/BUILD_ERRORS_FIXED.md
- docs/CACHE_ASIDE_PATTERN_GUIDE.md
- docs/CHECKLIST_IMPLEMENTACAO.md
- docs/CI_CD_COMPLETION_GUIDE.md
- docs/CI_CD_INTEGRATION_SUMMARY.md
- docs/COMPREHENSIVE_TUTORIAL_SYSTEM_COMPLETE.md
- docs/COMPREHENSIVE_VALIDATION_ASSESSMENT_REPORT.md

```

Adicionei no `AGENTS.md` um índice com:
- Links HTTP para os materiais em `docs/Oficial` servidos pelo backend na rota `/materials` (com encoding para nomes com espaços/parênteses).
- Lista dos documentos internos em `docs/` citados.

Se quiser, posso transformar os itens da lista de documentos em links markdown relativos clicáveis (ex.: `[docs/PROGRAMAS_SETUP.md](docs/PROGRAMAS_SETUP.md)`).

---

**User**

no dashboard do admin tem que aparecer as programacoes

---

**Cursor**

Vou adicionar a listagem de programações no `AdminDashboard`: buscar os últimos programas do Supabase e exibi-los na aba “Visão Geral”. Vou implementar o carregamento (`loadPrograms`) e um Card com a lista.

```typescriptreact
import React, { useState, useEffect, useCallback, useMemo, lazy, Suspense } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { supabase } from '../integrations/supabase/client';
import { useJWorgIntegration } from '../hooks/useJWorgIntegration';
import { JWorgTest } from '../components/JWorgTest';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../components/ui/card';
import LazyLoader from '../components/LazyLoader';
import AuthErrorHandler from '../components/AuthErrorHandler';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '../components/ui/tabs';
import { Button } from '../components/ui/button';
import { Badge } from '../components/ui/badge';
import { Separator } from '../components/ui/separator';
import { 
  Download, 
  Upload, 
  Globe, 
  BarChart3, 
  Settings, 
  RefreshCw,
  CheckCircle,
  AlertCircle,
  Clock,
  FileText,
  Users,
  Package,
  Activity,
  Database
} from 'lucide-react';

// 🚀 Lazy loading para componentes pesados (comentado por enquanto)
// const JWorgTestLazy = lazy(() => import('../components/JWorgTest'));

interface SystemStats {
  total_congregations: number;
  active_congregations: number;
  total_users: number;
  total_estudantes: number;
  total_programas: number;
  last_sync: string;
}

export default function AdminDashboard() {
  const { user, profile, isAdmin } = useAuth();
  const jworg = useJWorgIntegration();
  const [activeTab, setActiveTab] = useState('overview');
  const [loading, setLoading] = useState(false);
  const [systemStats, setSystemStats] = useState<SystemStats | null>(null);
  const [lastCheck, setLastCheck] = useState<string>('');
  const [debugInfo, setDebugInfo] = useState<string>('');
  const [showJWorgTest, setShowJWorgTest] = useState(false);
  const [programs, setPrograms] = useState<any[]>([]);
  const [programsLoading, setProgramsLoading] = useState<boolean>(false);

  // 🚀 Memoização de dados estáticos para reduzir re-renders
  const staticStats = useMemo(() => ({
    total_congregations: systemStats?.total_congregations || 0,
    active_congregations: systemStats?.active_congregations || 0,
    total_users: systemStats?.total_users || 0,
    total_estudantes: systemStats?.total_estudantes || 0,
    total_programas: systemStats?.total_programas || 0,
    last_sync: systemStats?.last_sync || ''
  }), [systemStats]);

  // 🚀 Debounced function para reduzir chamadas desnecessárias
  const debouncedSetDebugInfo = useCallback((info: string) => {
    let timeoutId: NodeJS.Timeout;
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => setDebugInfo(info), 100);
  }, []);

  // DEBUG: Log component state (otimizado)
  useEffect(() => {
    const debugData = {
      user: !!user,
      userId: user?.id,
      userEmail: user?.email,
      profile: !!profile,
      profileRole: profile?.role,
      isAdmin,
      loading,
      userMetadata: user?.user_metadata
    };

    console.log('🔍 AdminDashboard Component Debug:', debugData);
    debouncedSetDebugInfo(JSON.stringify(debugData, null, 2));
  }, [user, profile, isAdmin, loading, debouncedSetDebugInfo]);

  useEffect(() => {
    console.log('🔄 AdminDashboard useEffect triggered:', { user, isAdmin });
    
    if (user && isAdmin) {
      console.log('✅ Admin user detected, loading system data...');
      loadSystemData();
    } else if (user && !isAdmin) {
      console.log('❌ User is not admin, role:', profile?.role);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ User is not admin, role: ' + profile?.role);
    } else if (!user) {
      console.log('❌ No user found');
      debouncedSetDebugInfo(debugInfo + '\n\n❌ No user found');
    }
  }, [user, isAdmin, debouncedSetDebugInfo]);

  const loadSystemData = useCallback(async () => {
    if (!user || !isAdmin) {
      console.log('🚫 loadSystemData: User not admin or not logged in');
      return;
    }
    
    console.log('🔄 Loading system data for admin...');
    setLoading(true);
    try {
      // Testar conexão com Supabase
      console.log('🔍 Testing Supabase connection...');
      const { count: profilesCount, error: testError } = await supabase
        .from('profiles')
        .select('*', { count: 'exact', head: true });
      
      if (testError) {
        console.error('❌ Supabase connection test failed:', testError);
        debouncedSetDebugInfo(debugInfo + '\n\n❌ Supabase Test Failed: ' + testError.message);
        return;
      }

        console.log('✅ Supabase connection test successful');
      debouncedSetDebugInfo(debugInfo + '\n\n✅ Supabase Test: Connected');

      // Carregar estatísticas do sistema
      await loadSystemStats();
      // Carregar programações publicadas
      await loadPrograms();

    } catch (error) {
      console.error('❌ Supabase test exception:', error);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ Supabase Test Exception: ' + error);
    } finally {
      setLoading(false);
    }
  }, [user, isAdmin, debouncedSetDebugInfo, debugInfo]);

  const loadSystemStats = useCallback(async () => {
    try {
      console.log('📊 Loading system statistics...');

      const [profilesRes, estudantesRes, programasRes, congregacoesRes] = await Promise.all([
        supabase.from('profiles').select('*', { count: 'exact', head: true }),
        supabase.from('estudantes').select('*', { count: 'exact', head: true }),
        supabase.from('programas').select('*', { count: 'exact', head: true }),
        supabase.from('congregacoes').select('*', { count: 'exact', head: true }),
      ]);

      const stats: SystemStats = {
        total_congregations: (congregacoesRes.count as number) || 0,
        active_congregations: (congregacoesRes.count as number) || 0,
        total_users: (profilesRes.count as number) || 0,
        total_estudantes: (estudantesRes.count as number) || 0,
        total_programas: (programasRes.count as number) || 0,
        last_sync: new Date().toISOString(),
      };

      setSystemStats(stats);
      setLastCheck(new Date().toISOString());

      console.log('✅ System stats loaded:', stats);
      debouncedSetDebugInfo(debugInfo + '\n\n✅ System Stats Loaded: ' + JSON.stringify(stats, null, 2));

    } catch (error) {
      console.error('❌ Error loading system stats:', error);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ System Stats Error: ' + error);
    }
  }, [debouncedSetDebugInfo, debugInfo]);

  const loadPrograms = useCallback(async () => {
    try {
      setProgramsLoading(true);
      const { data, error } = await supabase
        .from('programas')
        .select('id, semana_iso, idioma, status, versao, data_inicio, data_fim')
        .order('data_inicio', { ascending: false })
        .limit(12);
      if (error) throw error;
      setPrograms(data || []);
      console.log('✅ Programs loaded:', data?.length || 0);
    } catch (error: any) {
      console.error('❌ Error loading programs:', error);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ Programs Load Error: ' + (error?.message || error));
    } finally {
      setProgramsLoading(false);
    }
  }, [debouncedSetDebugInfo, debugInfo]);

  const checkForUpdates = useCallback(async () => {
    console.log('🔄 Checking for updates...');
    setLoading(true);
    
    try {
      await loadSystemStats();
      await loadPrograms();
      console.log('✅ Updates checked successfully');
    } catch (error) {
      console.error('❌ Error checking updates:', error);
    } finally {
      setLoading(false);
    }
  }, [loadSystemStats]);

  const testSupabaseConnection = useCallback(async () => {
    console.log('🔧 Testing Supabase connection...');
    
    try {
      const { count, error } = await supabase
        .from('profiles')
        .select('*', { count: 'exact', head: true });

      if (error) {
        console.error('❌ Supabase test error:', error);
        alert('Supabase test error: ' + error.message);
      } else {
        console.log('✅ Supabase test successful. Profiles count:', count);
        alert('Supabase test successful! Total profiles: ' + (count ?? 0));
      }
    } catch (error) {
      console.error('❌ Supabase test exception:', error);
      alert('Supabase test exception: ' + error);
    }
  }, []);

  // ========== HANDLERS DOS BOTÕES ==========
  
  const handleListUsers = useCallback(async () => {
    console.log('👥 Listando usuários...');
    try {
      const { data: users, error } = await supabase
        .from('profiles')
        .select('id, nome_completo, role, congregacao, cargo')
        .order('nome_completo');
      
      if (error) throw error;
      
      console.log('✅ Usuários carregados:', users);
      alert(`Encontrados ${users?.length || 0} usuários no sistema:\n\n${users?.map(u => `${u.nome_completo || u.id} - ${u.role} (${u.congregacao || 'N/A'})`).join('\n')}`);
    } catch (error) {
      console.error('❌ Erro ao listar usuários:', error);
      alert('Erro ao carregar usuários: ' + error.message);
    }
  }, []);

  const handleManagePermissions = useCallback(async () => {
    console.log('⚙️ Gerenciando permissões...');
    const newRole = prompt('Digite o novo role (admin, instrutor, estudante):');
    if (!newRole) return;
    
    // Validar role
    const validRoles = ['admin', 'instrutor', 'estudante', 'family_member', 'developer'];
    if (!validRoles.includes(newRole)) {
      alert('Role inválido. Use: admin, instrutor, estudante, family_member ou developer');
      return;
    }
    
    const userId = prompt('Digite o ID do usuário:');
    if (!userId) return;
    
    try {
      const { error } = await supabase
        .from('profiles')
        .update({ role: newRole as any })
        .eq('id', userId);
      
      if (error) throw error;
      
      console.log('✅ Permissão atualizada');
      alert('Permissão atualizada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao atualizar permissão:', error);
      alert('Erro ao atualizar permissão: ' + error.message);
    }
  }, []);

  const handleActivityReport = useCallback(async () => {
    console.log('📊 Gerando relatório de atividades...');
    try {
      // Simulação de relatório
      const report = {
        totalUsers: staticStats.total_users,
        totalCongregations: staticStats.total_congregations,
        lastUpdate: new Date().toLocaleString('pt-BR'),
        activeUsers: Math.floor(staticStats.total_users * 0.8)
      };
      
      alert(`📊 Relatório de Atividades:\n\n` +
            `• Total de usuários: ${report.totalUsers}\n` +
            `• Usuários ativos: ${report.activeUsers}\n` +
            `• Total de congregações: ${report.totalCongregations}\n` +
            `• Última atualização: ${report.lastUpdate}`);
    } catch (error) {
      console.error('❌ Erro ao gerar relatório:', error);
      alert('Erro ao gerar relatório: ' + error.message);
    }
  }, [staticStats]);

  const handleBackupData = useCallback(async () => {
    console.log('💾 Fazendo backup dos dados...');
    try {
      const { data: profiles, error: profilesError } = await supabase
        .from('profiles')
        .select('*');
      
      if (profilesError) throw profilesError;
      
      // Simular backup
      const backupData = {
        timestamp: new Date().toISOString(),
        profiles: profiles,
        stats: staticStats
      };
      
      const dataStr = JSON.stringify(backupData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `backup_sistema_ministerial_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      URL.revokeObjectURL(url);
      console.log('✅ Backup criado com sucesso');
      alert('Backup criado e baixado com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao fazer backup:', error);
      alert('Erro ao fazer backup: ' + error.message);
    }
  }, [staticStats]);

  // Congregações
  const handleManageCongregation = useCallback((congregationName: string) => {
    console.log('🏢 Gerenciando congregação:', congregationName);
    alert(`🏢 Gerenciando congregação: ${congregationName}\n\nEsta funcionalidade abrirá o painel de gerenciamento da congregação.`);
  }, []);

  const handleAddCongregation = useCallback(async () => {
    console.log('➕ Adicionando nova congregação...');
    const congregationName = prompt('Digite o nome da nova congregação:');
    if (!congregationName) return;
    
    try {
      // Simulação - em produção seria inserção no Supabase
      console.log('✅ Congregação adicionada:', congregationName);
      alert(`✅ Congregação "${congregationName}" adicionada com sucesso!\n\nEla agora receberá automaticamente a programação oficial.`);
    } catch (error) {
      console.error('❌ Erro ao adicionar congregação:', error);
      alert('Erro ao adicionar congregação: ' + error.message);
    }
  }, []);

  // JW.org & S-38
  const handleMWBAvailable = useCallback(async () => {
    console.log('📚 Disponibilizando MWB atual...');
    try {
      await jworg.fetchCurrentWeek();
      console.log('✅ MWB atualizada');
      alert('✅ Apostila MWB atual disponibilizada para todas as congregações!');
    } catch (error) {
      console.error('❌ Erro ao disponibilizar MWB:', error);
      alert('Erro ao disponibilizar MWB: ' + error.message);
    }
  }, [jworg]);

  const handleConfigureJWorgURLs = useCallback(() => {
    console.log('⚙️ Configurando URLs JW.org...');
    const ptUrl = prompt('URL JW.org PT:', 'https://www.jw.org/pt/biblioteca/jw-apostila-do-mes/');
    const enUrl = prompt('URL JW.org EN:', 'https://www.jw.org/en/library/jw-meeting-workbook/');
    
    if (ptUrl && enUrl) {
      console.log('✅ URLs configuradas:', { ptUrl, enUrl });
      alert('✅ URLs JW.org configuradas com sucesso!');
    }
  }, []);

  const handleSyncCongregations = useCallback(async () => {
    console.log('🔄 Sincronizando com congregações...');
    try {
      // Simulação de sincronização
      const congregationsCount = staticStats.total_congregations;
      console.log(`✅ Sincronizando com ${congregationsCount} congregações`);
      alert(`🔄 Sincronização iniciada!\n\nProgramação oficial sendo enviada para ${congregationsCount} congregações...\n\nTempo estimado: ${Math.ceil(congregationsCount / 100)} minutos`);
    } catch (error) {
      console.error('❌ Erro na sincronização:', error);
      alert('Erro na sincronização: ' + error.message);
    }
  }, [staticStats]);

  // Programação Oficial
  const handleViewFullProgram = useCallback(() => {
    console.log('📅 Visualizando programação completa (3 meses)...');
    alert(`📅 Programação Completa dos Próximos 3 Meses\n\n` +
          `• Semanas carregadas: 12\n` +
          `• Idiomas: PT e EN\n` +
          `• Última atualização: Hoje\n\n` +
          `Esta visualização mostrará todas as apostilas MWB dos próximos 3 meses.`);
  }, []);

  const handleUpdateProgramPT = useCallback(async () => {
    console.log('🇧🇷 Atualizando programação PT...');
    try {
      jworg.setLanguage('pt');
      await jworg.fetchNextWeeks();
      console.log('✅ Programação PT atualizada');
      alert('✅ Programação em Português atualizada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao atualizar programação PT:', error);
      alert('Erro ao atualizar programação PT: ' + error.message);
    }
  }, [jworg]);

  const handleUpdateProgramEN = useCallback(async () => {
    console.log('🇺🇸 Atualizando programação EN...');
    try {
      jworg.setLanguage('en');
      await jworg.fetchNextWeeks();
      console.log('✅ Programação EN atualizada');
      alert('✅ Programação em Inglês atualizada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao atualizar programação EN:', error);
      alert('Erro ao atualizar programação EN: ' + error.message);
    }
  }, [jworg]);

  const handleCheckNewWeeks = useCallback(async () => {
    console.log('🔍 Verificando novas semanas...');
    try {
      await jworg.fetchNextWeeks();
      const newWeeks = jworg.nextWeeks.length;
      console.log(`✅ Verificação concluída: ${newWeeks} semanas`);
      alert(`🔍 Verificação concluída!\n\nEncontradas ${newWeeks} semanas de programação.\n\nTodas estão sincronizadas com JW.org.`);
    } catch (error) {
      console.error('❌ Erro ao verificar semanas:', error);
      alert('Erro ao verificar novas semanas: ' + error.message);
    }
  }, [jworg]);

  const handleUpdateS38Structure = useCallback(() => {
    console.log('🏗️ Atualizando estrutura S-38 global...');
    alert(`🏗️ Estrutura S-38 Global\n\n` +
          `✅ Partes da reunião atualizadas:\n` +
          `• Chairman\n• Treasures\n• Gems\n• Reading\n` +
          `• Starting\n• Following\n• Making\n• Explaining\n` +
          `• Talk\n\n` +
          `Esta estrutura será aplicada mundialmente.`);
  }, []);

  // JW.org Integration
  const handleReloadCurrentWeek = useCallback(async () => {
    console.log('🔄 Recarregando semana atual...');
    try {
      await jworg.fetchCurrentWeek();
      console.log('✅ Semana atual recarregada');
      alert('✅ Semana atual recarregada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao recarregar semana:', error);
      alert('Erro ao recarregar semana: ' + error.message);
    }
  }, [jworg]);

  const handleReloadNextWeeks = useCallback(async () => {
    console.log('📅 Recarregando próximas semanas...');
    try {
      await jworg.fetchNextWeeks();
      console.log('✅ Próximas semanas recarregadas');
      alert('✅ Próximas semanas recarregadas com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao recarregar próximas semanas:', error);
      alert('Erro ao recarregar próximas semanas: ' + error.message);
    }
  }, [jworg]);

  const handleTestDownloadPT = useCallback(async () => {
    console.log('🧪 Testando download PT...');
    try {
      jworg.setLanguage('pt');
      await jworg.downloadWorkbook('pt', '07', '2025');
      console.log('✅ Download PT testado');
      alert('✅ Download PT testado com sucesso!');
    } catch (error) {
      console.error('❌ Erro no teste de download PT:', error);
      alert('Erro no teste de download PT: ' + error.message);
    }
  }, [jworg]);

  // Monitoramento
  const handleViewAllLogs = useCallback(async () => {
    console.log('📋 Visualizando todos os logs...');
    try {
      // Simulação de logs
      const logs = [
        { timestamp: new Date().toLocaleString(), event: 'Sistema iniciado', level: 'info' },
        { timestamp: new Date(Date.now() - 3600000).toLocaleString(), event: 'Backup automático executado', level: 'info' },
        { timestamp: new Date(Date.now() - 86400000).toLocaleString(), event: 'Novo usuário registrado', level: 'info' },
        { timestamp: new Date(Date.now() - 172800000).toLocaleString(), event: 'Manutenção programada', level: 'warning' }
      ];
      
      const logText = logs.map(log => `${log.timestamp} [${log.level.toUpperCase()}] ${log.event}`).join('\n');
      alert(`📋 Logs do Sistema\n\n${logText}`);
    } catch (error) {
      console.error('❌ Erro ao carregar logs:', error);
      alert('Erro ao carregar logs: ' + error.message);
    }
  }, []);

  const handleTestJWorgIntegration = useCallback(async () => {
    console.log('🧪 Testando integração JW.org...');
    try {
      await jworg.fetchCurrentWeek();
      console.log('✅ Integração JW.org testada com sucesso');
      alert('✅ Integração JW.org funcionando perfeitamente!');
    } catch (error) {
      console.error('❌ Erro na integração JW.org:', error);
      alert('❌ Erro na integração JW.org: ' + error.message);
    }
  }, [jworg]);

  const handleChangeLanguage = useCallback((newLang: 'pt' | 'en') => {
    jworg.setLanguage(newLang);
    console.log(`🌐 Idioma alterado para: ${newLang}`);
    alert(`🌐 Idioma alterado para: ${newLang === 'pt' ? 'Português' : 'English'}`);
  }, [jworg]);

  // Alterna o idioma atual entre PT/EN
  const toggleLanguage = useCallback(() => {
    const current = (jworg as any)?.currentLanguage ?? 'pt';
    const next = current === 'pt' ? 'en' : 'pt';
    jworg.setLanguage(next);
    console.log(`🌐 Idioma alternado: ${current} -> ${next}`);
    alert(`🌐 Idioma alternado para: ${next === 'pt' ? 'Português' : 'English'}`);
  }, [jworg]);

  // Atualiza materiais JW.org (semana atual + próximas semanas)
  const updateMaterials = useCallback(async () => {
    try {
      await jworg.fetchCurrentWeek();
      await jworg.fetchNextWeeks();
      console.log('✅ Materiais JW.org atualizados');
      alert('✅ Materiais JW.org atualizados com sucesso!');
    } catch (error: any) {
      console.error('❌ Erro ao atualizar materiais:', error);
      alert('❌ Erro ao atualizar materiais: ' + (error?.message || error));
    }
  }, [jworg]);

  // NOW CHECK CONDITIONS AND RENDER APPROPRIATELY
  // Se não for admin, mostrar mensagem de acesso negado
  if (user && !isAdmin) {
    return (
      <div className="container mx-auto px-4 py-8">
        <Card className="max-w-md mx-auto">
          <CardHeader>
            <CardTitle className="text-red-600">Acesso Negado</CardTitle>
            <CardDescription>
              Você não tem permissão para acessar o painel administrativo.
            </CardDescription>
          </CardHeader>
          <CardContent>
            <p className="text-sm text-muted-foreground mb-4">
              Seu perfil atual: <strong>{profile?.role}</strong>
            </p>
            <Button onClick={() => window.history.back()}>
              Voltar
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Se não houver usuário, mostrar loading
  if (!user) {
    return (
      <div className="container mx-auto px-4 py-8">
        <Card className="max-w-md mx-auto">
          <CardHeader>
            <CardTitle>Carregando...</CardTitle>
            <CardDescription>
              Verificando autenticação...
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="flex items-center justify-center">
              <RefreshCw className="h-6 w-6 animate-spin" />
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background">
      {/* Auth Error Handler */}
      <AuthErrorHandler />
      
      {/* Header */}
      <div className="border-b">
        <div className="container mx-auto px-4 py-6">
          <div className="flex flex-col space-y-4">
          <div className="flex items-center justify-between">
            <div>
                <h1 className="text-3xl font-bold tracking-tight">📊 Dashboard do Administrador Geral</h1>
                <p className="text-muted-foreground">
                  Programação oficial das reuniões ministeriais - Padronização mundial para todas as congregações
              </p>
            </div>
              <div className="flex items-center space-x-2">
              {/* Force Profile Load Button */}
              {import.meta.env.DEV && (
                <Button 
                  variant="outline" 
                  size="sm"
                    onClick={testSupabaseConnection}
                  >
                    🔧 Test Supabase
                </Button>
              )}
              
              <Button onClick={checkForUpdates} disabled={loading}>
                <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
                  Atualizar
              </Button>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Debug Info Panel */}
      {import.meta.env.DEV && (
        <div className="container mx-auto px-4 py-2">
          <Card className="bg-yellow-50 border-yellow-200">
            <CardHeader className="pb-2">
              <CardTitle className="text-sm text-yellow-800">🐛 Debug Info (Development Only)</CardTitle>
            </CardHeader>
            <CardContent>
              <pre className="text-xs text-yellow-700 overflow-auto max-h-40">
                {debugInfo}
              </pre>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Main Content */}
      <div className="container mx-auto px-4 py-6">
        <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-6">
          <TabsList className="grid w-full grid-cols-4">
            <TabsTrigger value="overview">Visão Geral</TabsTrigger>
            <TabsTrigger value="users">Usuários</TabsTrigger>
            <TabsTrigger value="congregations">Congregações</TabsTrigger>
            <TabsTrigger value="system">Sistema</TabsTrigger>
          </TabsList>

          {/* Visão Geral */}
          <TabsContent value="overview" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                🎯 Sistema Ministerial Global - Padronização Mundial
              </h3>
              <div className="text-center text-sm text-muted-foreground mt-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
                <strong>📊 Admin Geral:</strong> Disponibiliza programação oficial semanal (SEM nomes de estudantes) <br/>
                <strong>🎓 Instrutores:</strong> Recebem programação automaticamente + fazem designações locais reais
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Congregações Conectadas</CardTitle>
                  <Globe className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">{staticStats.total_congregations}</div>
                  <p className="text-xs text-muted-foreground">
                    Recebendo programação oficial
                  </p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Semanas Programadas</CardTitle>
                  <BarChart3 className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">12</div>
                  <p className="text-xs text-muted-foreground">
                    Próximas 3 meses
                  </p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Idiomas Disponíveis</CardTitle>
                  <Globe className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">2</div>
                  <p className="text-xs text-muted-foreground">
                    Português e Inglês
                  </p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Última Sincronização</CardTitle>
                  <RefreshCw className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">✅</div>
                  <p className="text-xs text-muted-foreground">
                    Hoje, {new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                  </p>
                </CardContent>
              </Card>
            </div>

            {/* Ações Rápidas */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Status do Sistema */}
              <Card>
                <CardHeader>
                  <CardTitle>Status do Sistema</CardTitle>
                  <CardDescription>
                    Informações sobre a última verificação e status geral
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Última Verificação:</span>
                    <span className="text-sm text-muted-foreground">
                      {lastCheck ? new Date(lastCheck).toLocaleString('pt-BR') : 'Nunca'}
                    </span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Status:</span>
                    <Badge variant="outline" className="text-green-600">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Operacional
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Supabase:</span>
                    <Badge variant="outline" className="text-green-600">
                      <Database className="h-3 w-3 mr-1" />
                      Conectado
                    </Badge>
                  </div>
                </CardContent>
              </Card>

              {/* JW.org Downloads */}
              <Card className="bg-green-50 border-green-200">
                <CardHeader>
                  <CardTitle className="text-green-800">📚 JW.org Downloads</CardTitle>
                  <CardDescription className="text-green-700">
                    Gerenciar materiais oficiais
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Apostila MWB Atual:</span>
                    <Badge variant="outline" className="text-green-600">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Disponível
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Última verificação:</span>
                    <span className="text-sm text-green-700">Hoje, 10:30</span>
                  </div>
                  <div className="flex space-x-2">
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleMWBAvailable}>
                      <RefreshCw className="h-3 w-3 mr-1" />
                      Disponibilizar MWB Atual
                    </Button>
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleConfigureJWorgURLs}>
                      <Settings className="h-3 w-3 mr-1" />
                      Configurar URLs JW.org
                    </Button>
                  </div>
                </CardContent>
              </Card>

              {/* Sistema S-38 - Designações */}
              <Card className="bg-purple-50 border-purple-200">
                <CardHeader>
                  <CardTitle className="text-purple-800">⚙️ Sistema S-38</CardTitle>
                  <CardDescription className="text-purple-700">
                    Estrutura das reuniões ministeriais
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="text-sm text-purple-700 space-y-2">
                    <p>📚 <strong>Função do Admin:</strong> Disponibilizar apostilas MWB</p>
                    <p>👥 <strong>Para Instrutores:</strong> Designar estudantes para partes</p>
                    <p>🎯 <strong>Partes da Reunião:</strong></p>
                    <div className="grid grid-cols-2 gap-1 text-xs ml-2">
                      <div>• Chairman</div>
                      <div>• Treasures</div>
                      <div>• Gems</div>
                      <div>• Reading</div>
                      <div>• Starting</div>
                      <div>• Following</div>
                      <div>• Making</div>
                      <div>• Explaining</div>
                      <div>• Talk</div>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Debug / Integração */}
              <Card className="bg-slate-50 border-slate-200">
                <CardHeader>
                  <CardTitle className="text-slate-800">🧪 Debug / Integração</CardTitle>
                  <CardDescription className="text-slate-700">
                    Ferramentas rápidas para validar integrações e idioma
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-3">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Idioma Atual:</span>
                    <Badge variant="outline" className="text-slate-700">
                      {(jworg as any)?.currentLanguage === 'en' ? '🇺🇸 English' : '🇧🇷 Português'}
                    </Badge>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    <Button size="sm" variant="outline" onClick={toggleLanguage}>
                      Alternar Idioma
                    </Button>
                    <Button size="sm" variant="outline" onClick={updateMaterials}>
                      Atualizar Materiais
                    </Button>
                    <Button size="sm" variant="outline" onClick={handleTestJWorgIntegration}>
                      Testar Integração JW.org
                    </Button>
                    <Button size="sm" variant="outline" onClick={checkForUpdates} disabled={loading}>
                      Atualizar Contagens
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          {/* Usuários */}
          <TabsContent value="users" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                👥 Gestão de Usuários para Acesso às Apostilas MWB
              </h3>
              <p className="text-center text-sm text-muted-foreground mt-2">
                🎯 Função Principal: Admin gerencia usuários → Instrutores acessam apostilas
              </p>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Estatísticas de Usuários */}
            <Card>
              <CardHeader>
                  <CardTitle>Estatísticas</CardTitle>
                  <CardDescription>Resumo dos usuários</CardDescription>
              </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Total de Usuários:</span>
                      <Badge variant="outline">{staticStats.total_users}</Badge>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Admins:</span>
                      <Badge variant="outline" className="bg-red-50 text-red-700">
                        {isAdmin ? 1 : 0}
                      </Badge>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Instrutores:</span>
                      <Badge variant="outline" className="bg-blue-50 text-blue-700">
                        {staticStats.total_users - (isAdmin ? 1 : 0)}
                      </Badge>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Usuários Registrados */}
              <Card className="lg:col-span-2">
                <CardHeader>
                  <CardTitle>Usuários Registrados</CardTitle>
                  <CardDescription>Últimos usuários cadastrados no sistema</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between p-3 border rounded-lg">
                      <div className="flex items-center space-x-3">
                        <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                          <Users className="h-5 w-5 text-blue-600" />
                        </div>
                        <div>
                          <p className="font-medium">{profile?.nome_completo || 'Roberto Araujo da Silva'}</p>
                          <p className="text-sm text-muted-foreground">Administrator</p>
                        </div>
                      </div>
                      <Badge variant="outline" className="bg-red-50 text-red-700">
                        Admin
                      </Badge>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Ações Administrativas */}
            <Card>
              <CardHeader>
                <CardTitle>Ações Administrativas</CardTitle>
                <CardDescription>
                  Gerenciar usuários e permissões
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <Button className="w-full justify-start" variant="outline" onClick={handleListUsers}>
                    <Users className="h-4 w-4 mr-2" />
                    Listar Todos os Usuários
                  </Button>
                  <Button className="w-full justify-start" variant="outline" onClick={handleManagePermissions}>
                    <Settings className="h-4 w-4 mr-2" />
                    Gerenciar Permissões
                  </Button>
                  <Button className="w-full justify-start" variant="outline" onClick={handleActivityReport}>
                    <Activity className="h-4 w-4 mr-2" />
                    Relatório de Atividades
                  </Button>
                  <Button className="w-full justify-start" variant="outline" onClick={handleBackupData}>
                    <Database className="h-4 w-4 mr-2" />
                    Backup de Dados
                  </Button>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Congregações */}
          <TabsContent value="congregations" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                🏢 Gestão de Congregações para Acesso às Apostilas MWB
              </h3>
              <p className="text-center text-sm text-muted-foreground mt-2">
                🎯 Função Principal: Admin gerencia congregações → Instrutores acessam apostilas
              </p>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Estatísticas de Congregações */}
            <Card>
              <CardHeader>
                  <CardTitle>Estatísticas</CardTitle>
                  <CardDescription>Resumo das congregações</CardDescription>
              </CardHeader>
              <CardContent>
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Total de Congregações:</span>
                      <Badge variant="outline">{staticStats.total_congregations}</Badge>
                  </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Congregações Ativas:</span>
                      <Badge variant="outline" className="bg-green-50 text-green-700">
                        {staticStats.active_congregations}
                      </Badge>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Total de Estudantes:</span>
                      <Badge variant="outline">{staticStats.total_estudantes}</Badge>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Lista de Congregações */}
              <Card className="lg:col-span-2">
                <CardHeader>
                  <CardTitle>Congregações Registradas</CardTitle>
                  <CardDescription>Lista das congregações no sistema</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between p-3 border rounded-lg">
                      <div className="flex items-center space-x-3">
                        <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                          <Package className="h-5 w-5 text-blue-600" />
                        </div>
                        <div>
                          <p className="font-medium">Sistema Ministerial Global</p>
                          <p className="text-sm text-muted-foreground">Congregação Principal</p>
                          </div>
                        </div>
                      <Badge variant="outline" className="bg-green-50 text-green-700">
                        Ativa
                        </Badge>
                      </div>
                  </div>
                  
                  <div className="mt-4">
                    <Button variant="outline" className="w-full" onClick={() => handleManageCongregation('Sistema Ministerial Global')}>
                      <Users className="h-4 w-4 mr-2" />
                      Gerenciar
                    </Button>
                  </div>
                  
                  <div className="mt-4">
                    <Button variant="outline" className="w-full" onClick={handleAddCongregation}>
                      <Users className="h-4 w-4 mr-2" />
                      Adicionar Nova Congregação
                    </Button>
                  </div>
                  
                  <div className="mt-4">
                    <Button variant="outline" className="w-full">
                      <Users className="h-4 w-4 mr-2" />
                      Expandir
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          {/* Sistema */}
          <TabsContent value="system" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                ⚙️ Monitoramento e Configurações do Sistema
              </h3>
              <p className="text-center text-sm text-muted-foreground mt-2">
                🎯 Função Principal: Admin monitora sistema → Instrutores recebem apostilas estáveis
              </p>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Downloads JW.org */}
              <Card className="bg-green-50 border-green-200">
              <CardHeader>
                  <CardTitle className="text-green-800">📚 JW.org Downloads</CardTitle>
                  <CardDescription className="text-green-700">
                    Gerenciar materiais oficiais
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Apostila MWB Atual:</span>
                    <Badge variant="outline" className="text-green-600">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Disponível
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Última verificação:</span>
                    <span className="text-sm text-green-700">Hoje, 10:30</span>
                  </div>
                  <div className="flex space-x-2">
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleSyncCongregations}>
                      <RefreshCw className="h-3 w-3 mr-1" />
                      Sincronizar com Congregações
                    </Button>
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleViewFullProgram}>
                      <Settings className="h-3 w-3 mr-1" />
                      Ver Programação Completa
                    </Button>
                </div>
              </CardContent>
            </Card>

              {/* Configurações Gerais */}
            <Card>
              <CardHeader>
                  <CardTitle>Configurações Gerais</CardTitle>
                <CardDescription>
                    Parâmetros do sistema
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                    <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Backup Automático:</span>
                    <Badge variant="outline" className="bg-green-50 text-green-700">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Diário às 02:00
                      </Badge>
                    </div>
                    <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Notificações:</span>
                    <Badge variant="outline" className="bg-blue-50 text-blue-700">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Email + Sistema
                    </Badge>
                    </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Manutenção:</span>
                    <span className="text-sm text-muted-foreground">Última: Ontem</span>
                  </div>
                  <div className="flex space-x-2">
                    <Button size="sm" variant="outline">
                      <Settings className="h-3 w-3 mr-1" />
                      Configurar
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Métricas do Sistema */}
            <Card>
              <CardHeader>
                <CardTitle>Métricas do Sistema</CardTitle>
                <CardDescription>
                  Monitoramento em tempo real
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-green-600">99.9%</p>
                    <p className="text-sm text-muted-foreground">Uptime</p>
                  </div>
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-blue-600">~120ms</p>
                    <p className="text-sm text-muted-foreground">Latência</p>
                  </div>
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-green-600">25%</p>
                    <p className="text-sm text-muted-foreground">CPU</p>
                  </div>
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-blue-600">33%</p>
                    <p className="text-sm text-muted-foreground">Memória</p>
                  </div>
                </div>

                <Separator />

                <div className="space-y-3">
                    <div className="flex items-center justify-between">
                    <span className="text-sm">CPU:</span>
                    <div className="flex items-center space-x-2">
                      <div className="w-24 h-2 bg-gray-200 rounded-full">
                        <div className="w-1/4 h-2 bg-green-500 rounded-full"></div>
                    </div>
                        <span className="text-sm">25%</span>
                  </div>
                    </div>
                    
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Memória:</span>
                      <div className="flex items-center space-x-2">
                        <div className="w-24 h-2 bg-gray-200 rounded-full">
                          <div className="w-1/3 h-2 bg-blue-500 rounded-full"></div>
                    </div>
                        <span className="text-sm">33%</span>
                      </div>
                    </div>
                    
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Banco:</span>
                      <div className="flex items-center space-x-2">
                        <CheckCircle className="h-4 w-4 text-green-500" />
                        <span className="text-sm">Conectado</span>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

              {/* Logs e Atividades */}
              <Card>
                <CardHeader>
                  <CardTitle>Logs Recentes</CardTitle>
                  <CardDescription>
                    Últimas atividades do sistema
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <CheckCircle className="h-4 w-4 text-green-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Sistema iniciado</p>
                        <p className="text-xs text-muted-foreground">Hoje, 08:00</p>
                      </div>
                    </div>

                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <Activity className="h-4 w-4 text-blue-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Backup automático executado</p>
                        <p className="text-xs text-muted-foreground">Hoje, 02:00</p>
                      </div>
                    </div>

                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <Users className="h-4 w-4 text-green-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Novo usuário registrado</p>
                        <p className="text-xs text-muted-foreground">Ontem, 16:30</p>
                      </div>
                    </div>

                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <AlertCircle className="h-4 w-4 text-yellow-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Manutenção programada</p>
                        <p className="text-xs text-muted-foreground">Ontem, 03:00</p>
                      </div>
                    </div>
                  </div>

                  <div className="mt-4">
                    <Button variant="outline" className="w-full" onClick={handleViewAllLogs}>
                      <FileText className="h-4 w-4 mr-2" />
                      Ver Todos os Logs
                    </Button>
                  </div>
                </CardContent>
              </Card>
          </TabsContent>
        </Tabs>
      </div>
    </div>
  );
}

```

```typescriptreact
*** Begin Patch
*** Update File: src/pages/AdminDashboard.tsx
@@
           {/* Ações Rápidas */}
           <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
@@
             </Card>
 
+            {/* Programações Publicadas */}
+            <Card>
+              <CardHeader>
+                <CardTitle>Programações Publicadas</CardTitle>
+                <CardDescription>
+                  Últimas semanas importadas/publicadas
+                </CardDescription>
+              </CardHeader>
+              <CardContent>
+                {programsLoading ? (
+                  <div className="text-sm text-muted-foreground">Carregando...</div>
+                ) : programs.length === 0 ? (
+                  <div className="text-sm text-muted-foreground">Nenhuma programação encontrada.</div>
+                ) : (
+                  <div className="space-y-2">
+                    {programs.map((p) => (
+                      <div key={p.id} className="flex items-center justify-between p-2 border rounded-md">
+                        <div className="text-sm">
+                          <div className="font-medium">Semana {p.semana_iso} • {p.idioma?.toUpperCase?.() || '—'}</div>
+                          <div className="text-xs text-muted-foreground">
+                            {p.data_inicio ? new Date(p.data_inicio).toLocaleDateString('pt-BR') : '—'}
+                            {p.data_fim ? ` — ${new Date(p.data_fim).toLocaleDateString('pt-BR')}` : ''}
+                          </div>
+                        </div>
+                        <Badge variant="outline" className={p.status === 'publicado' ? 'bg-green-50 text-green-700' : ''}>
+                          v{p.versao || 1} • {p.status || 'rascunho'}
+                        </Badge>
+                      </div>
+                    ))}
+                  </div>
+                )}
+              </CardContent>
+            </Card>
+
             {/* JW.org Downloads */}
             <Card className="bg-green-50 border-green-200">
*** End Patch
```

```typescriptreact
import React, { useState, useEffect, useCallback, useMemo, lazy, Suspense } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { supabase } from '../integrations/supabase/client';
import { useJWorgIntegration } from '../hooks/useJWorgIntegration';
import { JWorgTest } from '../components/JWorgTest';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../components/ui/card';
import LazyLoader from '../components/LazyLoader';
import AuthErrorHandler from '../components/AuthErrorHandler';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '../components/ui/tabs';
import { Button } from '../components/ui/button';
import { Badge } from '../components/ui/badge';
import { Separator } from '../components/ui/separator';
import { 
  Download, 
  Upload, 
  Globe, 
  BarChart3, 
  Settings, 
  RefreshCw,
  CheckCircle,
  AlertCircle,
  Clock,
  FileText,
  Users,
  Package,
  Activity,
  Database
} from 'lucide-react';

// 🚀 Lazy loading para componentes pesados (comentado por enquanto)
// const JWorgTestLazy = lazy(() => import('../components/JWorgTest'));

interface SystemStats {
  total_congregations: number;
  active_congregations: number;
  total_users: number;
  total_estudantes: number;
  total_programas: number;
  last_sync: string;
}

export default function AdminDashboard() {
  const { user, profile, isAdmin } = useAuth();
  const jworg = useJWorgIntegration();
  const [activeTab, setActiveTab] = useState('overview');
  const [loading, setLoading] = useState(false);
  const [systemStats, setSystemStats] = useState<SystemStats | null>(null);
  const [lastCheck, setLastCheck] = useState<string>('');
  const [debugInfo, setDebugInfo] = useState<string>('');
  const [showJWorgTest, setShowJWorgTest] = useState(false);
  const [programs, setPrograms] = useState<any[]>([]);
  const [programsLoading, setProgramsLoading] = useState<boolean>(false);

  // 🚀 Memoização de dados estáticos para reduzir re-renders
  const staticStats = useMemo(() => ({
    total_congregations: systemStats?.total_congregations || 0,
    active_congregations: systemStats?.active_congregations || 0,
    total_users: systemStats?.total_users || 0,
    total_estudantes: systemStats?.total_estudantes || 0,
    total_programas: systemStats?.total_programas || 0,
    last_sync: systemStats?.last_sync || ''
  }), [systemStats]);

  // 🚀 Debounced function para reduzir chamadas desnecessárias
  const debouncedSetDebugInfo = useCallback((info: string) => {
    let timeoutId: NodeJS.Timeout;
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => setDebugInfo(info), 100);
  }, []);

  // DEBUG: Log component state (otimizado)
  useEffect(() => {
    const debugData = {
      user: !!user,
      userId: user?.id,
      userEmail: user?.email,
      profile: !!profile,
      profileRole: profile?.role,
      isAdmin,
      loading,
      userMetadata: user?.user_metadata
    };

    console.log('🔍 AdminDashboard Component Debug:', debugData);
    debouncedSetDebugInfo(JSON.stringify(debugData, null, 2));
  }, [user, profile, isAdmin, loading, debouncedSetDebugInfo]);

  useEffect(() => {
    console.log('🔄 AdminDashboard useEffect triggered:', { user, isAdmin });
    
    if (user && isAdmin) {
      console.log('✅ Admin user detected, loading system data...');
      loadSystemData();
    } else if (user && !isAdmin) {
      console.log('❌ User is not admin, role:', profile?.role);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ User is not admin, role: ' + profile?.role);
    } else if (!user) {
      console.log('❌ No user found');
      debouncedSetDebugInfo(debugInfo + '\n\n❌ No user found');
    }
  }, [user, isAdmin, debouncedSetDebugInfo]);

  const loadSystemData = useCallback(async () => {
    if (!user || !isAdmin) {
      console.log('🚫 loadSystemData: User not admin or not logged in');
      return;
    }
    
    console.log('🔄 Loading system data for admin...');
    setLoading(true);
    try {
      // Testar conexão com Supabase
      console.log('🔍 Testing Supabase connection...');
      const { count: profilesCount, error: testError } = await supabase
        .from('profiles')
        .select('*', { count: 'exact', head: true });
      
      if (testError) {
        console.error('❌ Supabase connection test failed:', testError);
        debouncedSetDebugInfo(debugInfo + '\n\n❌ Supabase Test Failed: ' + testError.message);
        return;
      }

        console.log('✅ Supabase connection test successful');
      debouncedSetDebugInfo(debugInfo + '\n\n✅ Supabase Test: Connected');

      // Carregar estatísticas do sistema
      await loadSystemStats();
      // Carregar programações publicadas
      await loadPrograms();

    } catch (error) {
      console.error('❌ Supabase test exception:', error);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ Supabase Test Exception: ' + error);
    } finally {
      setLoading(false);
    }
  }, [user, isAdmin, debouncedSetDebugInfo, debugInfo]);

  const loadSystemStats = useCallback(async () => {
    try {
      console.log('📊 Loading system statistics...');

      const [profilesRes, estudantesRes, programasRes, congregacoesRes] = await Promise.all([
        supabase.from('profiles').select('*', { count: 'exact', head: true }),
        supabase.from('estudantes').select('*', { count: 'exact', head: true }),
        supabase.from('programas').select('*', { count: 'exact', head: true }),
        supabase.from('congregacoes').select('*', { count: 'exact', head: true }),
      ]);

      const stats: SystemStats = {
        total_congregations: (congregacoesRes.count as number) || 0,
        active_congregations: (congregacoesRes.count as number) || 0,
        total_users: (profilesRes.count as number) || 0,
        total_estudantes: (estudantesRes.count as number) || 0,
        total_programas: (programasRes.count as number) || 0,
        last_sync: new Date().toISOString(),
      };

      setSystemStats(stats);
      setLastCheck(new Date().toISOString());

      console.log('✅ System stats loaded:', stats);
      debouncedSetDebugInfo(debugInfo + '\n\n✅ System Stats Loaded: ' + JSON.stringify(stats, null, 2));

    } catch (error) {
      console.error('❌ Error loading system stats:', error);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ System Stats Error: ' + error);
    }
  }, [debouncedSetDebugInfo, debugInfo]);

  const loadPrograms = useCallback(async () => {
    try {
      setProgramsLoading(true);
      const { data, error } = await supabase
        .from('programas')
        .select('id, semana_iso, idioma, status, versao, data_inicio, data_fim')
        .order('data_inicio', { ascending: false })
        .limit(12);
      if (error) throw error;
      setPrograms(data || []);
      console.log('✅ Programs loaded:', data?.length || 0);
    } catch (error: any) {
      console.error('❌ Error loading programs:', error);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ Programs Load Error: ' + (error?.message || error));
    } finally {
      setProgramsLoading(false);
    }
  }, [debouncedSetDebugInfo, debugInfo]);

  const checkForUpdates = useCallback(async () => {
    console.log('🔄 Checking for updates...');
    setLoading(true);
    
    try {
      await loadSystemStats();
      await loadPrograms();
      console.log('✅ Updates checked successfully');
    } catch (error) {
      console.error('❌ Error checking updates:', error);
    } finally {
      setLoading(false);
    }
  }, [loadSystemStats]);

  const testSupabaseConnection = useCallback(async () => {
    console.log('🔧 Testing Supabase connection...');
    
    try {
      const { count, error } = await supabase
        .from('profiles')
        .select('*', { count: 'exact', head: true });

      if (error) {
        console.error('❌ Supabase test error:', error);
        alert('Supabase test error: ' + error.message);
      } else {
        console.log('✅ Supabase test successful. Profiles count:', count);
        alert('Supabase test successful! Total profiles: ' + (count ?? 0));
      }
    } catch (error) {
      console.error('❌ Supabase test exception:', error);
      alert('Supabase test exception: ' + error);
    }
  }, []);

  // ========== HANDLERS DOS BOTÕES ==========
  
  const handleListUsers = useCallback(async () => {
    console.log('👥 Listando usuários...');
    try {
      const { data: users, error } = await supabase
        .from('profiles')
        .select('id, nome_completo, role, congregacao, cargo')
        .order('nome_completo');
      
      if (error) throw error;
      
      console.log('✅ Usuários carregados:', users);
      alert(`Encontrados ${users?.length || 0} usuários no sistema:\n\n${users?.map(u => `${u.nome_completo || u.id} - ${u.role} (${u.congregacao || 'N/A'})`).join('\n')}`);
    } catch (error) {
      console.error('❌ Erro ao listar usuários:', error);
      alert('Erro ao carregar usuários: ' + error.message);
    }
  }, []);

  const handleManagePermissions = useCallback(async () => {
    console.log('⚙️ Gerenciando permissões...');
    const newRole = prompt('Digite o novo role (admin, instrutor, estudante):');
    if (!newRole) return;
    
    // Validar role
    const validRoles = ['admin', 'instrutor', 'estudante', 'family_member', 'developer'];
    if (!validRoles.includes(newRole)) {
      alert('Role inválido. Use: admin, instrutor, estudante, family_member ou developer');
      return;
    }
    
    const userId = prompt('Digite o ID do usuário:');
    if (!userId) return;
    
    try {
      const { error } = await supabase
        .from('profiles')
        .update({ role: newRole as any })
        .eq('id', userId);
      
      if (error) throw error;
      
      console.log('✅ Permissão atualizada');
      alert('Permissão atualizada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao atualizar permissão:', error);
      alert('Erro ao atualizar permissão: ' + error.message);
    }
  }, []);

  const handleActivityReport = useCallback(async () => {
    console.log('📊 Gerando relatório de atividades...');
    try {
      // Simulação de relatório
      const report = {
        totalUsers: staticStats.total_users,
        totalCongregations: staticStats.total_congregations,
        lastUpdate: new Date().toLocaleString('pt-BR'),
        activeUsers: Math.floor(staticStats.total_users * 0.8)
      };
      
      alert(`📊 Relatório de Atividades:\n\n` +
            `• Total de usuários: ${report.totalUsers}\n` +
            `• Usuários ativos: ${report.activeUsers}\n` +
            `• Total de congregações: ${report.totalCongregations}\n` +
            `• Última atualização: ${report.lastUpdate}`);
    } catch (error) {
      console.error('❌ Erro ao gerar relatório:', error);
      alert('Erro ao gerar relatório: ' + error.message);
    }
  }, [staticStats]);

  const handleBackupData = useCallback(async () => {
    console.log('💾 Fazendo backup dos dados...');
    try {
      const { data: profiles, error: profilesError } = await supabase
        .from('profiles')
        .select('*');
      
      if (profilesError) throw profilesError;
      
      // Simular backup
      const backupData = {
        timestamp: new Date().toISOString(),
        profiles: profiles,
        stats: staticStats
      };
      
      const dataStr = JSON.stringify(backupData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `backup_sistema_ministerial_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      URL.revokeObjectURL(url);
      console.log('✅ Backup criado com sucesso');
      alert('Backup criado e baixado com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao fazer backup:', error);
      alert('Erro ao fazer backup: ' + error.message);
    }
  }, [staticStats]);

  // Congregações
  const handleManageCongregation = useCallback((congregationName: string) => {
    console.log('🏢 Gerenciando congregação:', congregationName);
    alert(`🏢 Gerenciando congregação: ${congregationName}\n\nEsta funcionalidade abrirá o painel de gerenciamento da congregação.`);
  }, []);

  const handleAddCongregation = useCallback(async () => {
    console.log('➕ Adicionando nova congregação...');
    const congregationName = prompt('Digite o nome da nova congregação:');
    if (!congregationName) return;
    
    try {
      // Simulação - em produção seria inserção no Supabase
      console.log('✅ Congregação adicionada:', congregationName);
      alert(`✅ Congregação "${congregationName}" adicionada com sucesso!\n\nEla agora receberá automaticamente a programação oficial.`);
    } catch (error) {
      console.error('❌ Erro ao adicionar congregação:', error);
      alert('Erro ao adicionar congregação: ' + error.message);
    }
  }, []);

  // JW.org & S-38
  const handleMWBAvailable = useCallback(async () => {
    console.log('📚 Disponibilizando MWB atual...');
    try {
      await jworg.fetchCurrentWeek();
      console.log('✅ MWB atualizada');
      alert('✅ Apostila MWB atual disponibilizada para todas as congregações!');
    } catch (error) {
      console.error('❌ Erro ao disponibilizar MWB:', error);
      alert('Erro ao disponibilizar MWB: ' + error.message);
    }
  }, [jworg]);

  const handleConfigureJWorgURLs = useCallback(() => {
    console.log('⚙️ Configurando URLs JW.org...');
    const ptUrl = prompt('URL JW.org PT:', 'https://www.jw.org/pt/biblioteca/jw-apostila-do-mes/');
    const enUrl = prompt('URL JW.org EN:', 'https://www.jw.org/en/library/jw-meeting-workbook/');
    
    if (ptUrl && enUrl) {
      console.log('✅ URLs configuradas:', { ptUrl, enUrl });
      alert('✅ URLs JW.org configuradas com sucesso!');
    }
  }, []);

  const handleSyncCongregations = useCallback(async () => {
    console.log('🔄 Sincronizando com congregações...');
    try {
      // Simulação de sincronização
      const congregationsCount = staticStats.total_congregations;
      console.log(`✅ Sincronizando com ${congregationsCount} congregações`);
      alert(`🔄 Sincronização iniciada!\n\nProgramação oficial sendo enviada para ${congregationsCount} congregações...\n\nTempo estimado: ${Math.ceil(congregationsCount / 100)} minutos`);
    } catch (error) {
      console.error('❌ Erro na sincronização:', error);
      alert('Erro na sincronização: ' + error.message);
    }
  }, [staticStats]);

  // Programação Oficial
  const handleViewFullProgram = useCallback(() => {
    console.log('📅 Visualizando programação completa (3 meses)...');
    alert(`📅 Programação Completa dos Próximos 3 Meses\n\n` +
          `• Semanas carregadas: 12\n` +
          `• Idiomas: PT e EN\n` +
          `• Última atualização: Hoje\n\n` +
          `Esta visualização mostrará todas as apostilas MWB dos próximos 3 meses.`);
  }, []);

  const handleUpdateProgramPT = useCallback(async () => {
    console.log('🇧🇷 Atualizando programação PT...');
    try {
      jworg.setLanguage('pt');
      await jworg.fetchNextWeeks();
      console.log('✅ Programação PT atualizada');
      alert('✅ Programação em Português atualizada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao atualizar programação PT:', error);
      alert('Erro ao atualizar programação PT: ' + error.message);
    }
  }, [jworg]);

  const handleUpdateProgramEN = useCallback(async () => {
    console.log('🇺🇸 Atualizando programação EN...');
    try {
      jworg.setLanguage('en');
      await jworg.fetchNextWeeks();
      console.log('✅ Programação EN atualizada');
      alert('✅ Programação em Inglês atualizada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao atualizar programação EN:', error);
      alert('Erro ao atualizar programação EN: ' + error.message);
    }
  }, [jworg]);

  const handleCheckNewWeeks = useCallback(async () => {
    console.log('🔍 Verificando novas semanas...');
    try {
      await jworg.fetchNextWeeks();
      const newWeeks = jworg.nextWeeks.length;
      console.log(`✅ Verificação concluída: ${newWeeks} semanas`);
      alert(`🔍 Verificação concluída!\n\nEncontradas ${newWeeks} semanas de programação.\n\nTodas estão sincronizadas com JW.org.`);
    } catch (error) {
      console.error('❌ Erro ao verificar semanas:', error);
      alert('Erro ao verificar novas semanas: ' + error.message);
    }
  }, [jworg]);

  const handleUpdateS38Structure = useCallback(() => {
    console.log('🏗️ Atualizando estrutura S-38 global...');
    alert(`🏗️ Estrutura S-38 Global\n\n` +
          `✅ Partes da reunião atualizadas:\n` +
          `• Chairman\n• Treasures\n• Gems\n• Reading\n` +
          `• Starting\n• Following\n• Making\n• Explaining\n` +
          `• Talk\n\n` +
          `Esta estrutura será aplicada mundialmente.`);
  }, []);

  // JW.org Integration
  const handleReloadCurrentWeek = useCallback(async () => {
    console.log('🔄 Recarregando semana atual...');
    try {
      await jworg.fetchCurrentWeek();
      console.log('✅ Semana atual recarregada');
      alert('✅ Semana atual recarregada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao recarregar semana:', error);
      alert('Erro ao recarregar semana: ' + error.message);
    }
  }, [jworg]);

  const handleReloadNextWeeks = useCallback(async () => {
    console.log('📅 Recarregando próximas semanas...');
    try {
      await jworg.fetchNextWeeks();
      console.log('✅ Próximas semanas recarregadas');
      alert('✅ Próximas semanas recarregadas com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao recarregar próximas semanas:', error);
      alert('Erro ao recarregar próximas semanas: ' + error.message);
    }
  }, [jworg]);

  const handleTestDownloadPT = useCallback(async () => {
    console.log('🧪 Testando download PT...');
    try {
      jworg.setLanguage('pt');
      await jworg.downloadWorkbook('pt', '07', '2025');
      console.log('✅ Download PT testado');
      alert('✅ Download PT testado com sucesso!');
    } catch (error) {
      console.error('❌ Erro no teste de download PT:', error);
      alert('Erro no teste de download PT: ' + error.message);
    }
  }, [jworg]);

  // Monitoramento
  const handleViewAllLogs = useCallback(async () => {
    console.log('📋 Visualizando todos os logs...');
    try {
      // Simulação de logs
      const logs = [
        { timestamp: new Date().toLocaleString(), event: 'Sistema iniciado', level: 'info' },
        { timestamp: new Date(Date.now() - 3600000).toLocaleString(), event: 'Backup automático executado', level: 'info' },
        { timestamp: new Date(Date.now() - 86400000).toLocaleString(), event: 'Novo usuário registrado', level: 'info' },
        { timestamp: new Date(Date.now() - 172800000).toLocaleString(), event: 'Manutenção programada', level: 'warning' }
      ];
      
      const logText = logs.map(log => `${log.timestamp} [${log.level.toUpperCase()}] ${log.event}`).join('\n');
      alert(`📋 Logs do Sistema\n\n${logText}`);
    } catch (error) {
      console.error('❌ Erro ao carregar logs:', error);
      alert('Erro ao carregar logs: ' + error.message);
    }
  }, []);

  const handleTestJWorgIntegration = useCallback(async () => {
    console.log('🧪 Testando integração JW.org...');
    try {
      await jworg.fetchCurrentWeek();
      console.log('✅ Integração JW.org testada com sucesso');
      alert('✅ Integração JW.org funcionando perfeitamente!');
    } catch (error) {
      console.error('❌ Erro na integração JW.org:', error);
      alert('❌ Erro na integração JW.org: ' + error.message);
    }
  }, [jworg]);

  const handleChangeLanguage = useCallback((newLang: 'pt' | 'en') => {
    jworg.setLanguage(newLang);
    console.log(`🌐 Idioma alterado para: ${newLang}`);
    alert(`🌐 Idioma alterado para: ${newLang === 'pt' ? 'Português' : 'English'}`);
  }, [jworg]);

  // Alterna o idioma atual entre PT/EN
  const toggleLanguage = useCallback(() => {
    const current = (jworg as any)?.currentLanguage ?? 'pt';
    const next = current === 'pt' ? 'en' : 'pt';
    jworg.setLanguage(next);
    console.log(`🌐 Idioma alternado: ${current} -> ${next}`);
    alert(`🌐 Idioma alternado para: ${next === 'pt' ? 'Português' : 'English'}`);
  }, [jworg]);

  // Atualiza materiais JW.org (semana atual + próximas semanas)
  const updateMaterials = useCallback(async () => {
    try {
      await jworg.fetchCurrentWeek();
      await jworg.fetchNextWeeks();
      console.log('✅ Materiais JW.org atualizados');
      alert('✅ Materiais JW.org atualizados com sucesso!');
    } catch (error: any) {
      console.error('❌ Erro ao atualizar materiais:', error);
      alert('❌ Erro ao atualizar materiais: ' + (error?.message || error));
    }
  }, [jworg]);

  // NOW CHECK CONDITIONS AND RENDER APPROPRIATELY
  // Se não for admin, mostrar mensagem de acesso negado
  if (user && !isAdmin) {
    return (
      <div className="container mx-auto px-4 py-8">
        <Card className="max-w-md mx-auto">
          <CardHeader>
            <CardTitle className="text-red-600">Acesso Negado</CardTitle>
            <CardDescription>
              Você não tem permissão para acessar o painel administrativo.
            </CardDescription>
          </CardHeader>
          <CardContent>
            <p className="text-sm text-muted-foreground mb-4">
              Seu perfil atual: <strong>{profile?.role}</strong>
            </p>
            <Button onClick={() => window.history.back()}>
              Voltar
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Se não houver usuário, mostrar loading
  if (!user) {
    return (
      <div className="container mx-auto px-4 py-8">
        <Card className="max-w-md mx-auto">
          <CardHeader>
            <CardTitle>Carregando...</CardTitle>
            <CardDescription>
              Verificando autenticação...
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="flex items-center justify-center">
              <RefreshCw className="h-6 w-6 animate-spin" />
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background">
      {/* Auth Error Handler */}
      <AuthErrorHandler />
      
      {/* Header */}
      <div className="border-b">
        <div className="container mx-auto px-4 py-6">
          <div className="flex flex-col space-y-4">
          <div className="flex items-center justify-between">
            <div>
                <h1 className="text-3xl font-bold tracking-tight">📊 Dashboard do Administrador Geral</h1>
                <p className="text-muted-foreground">
                  Programação oficial das reuniões ministeriais - Padronização mundial para todas as congregações
              </p>
            </div>
              <div className="flex items-center space-x-2">
              {/* Force Profile Load Button */}
              {import.meta.env.DEV && (
                <Button 
                  variant="outline" 
                  size="sm"
                    onClick={testSupabaseConnection}
                  >
                    🔧 Test Supabase
                </Button>
              )}
              
              <Button onClick={checkForUpdates} disabled={loading}>
                <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
                  Atualizar
              </Button>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Debug Info Panel */}
      {import.meta.env.DEV && (
        <div className="container mx-auto px-4 py-2">
          <Card className="bg-yellow-50 border-yellow-200">
            <CardHeader className="pb-2">
              <CardTitle className="text-sm text-yellow-800">🐛 Debug Info (Development Only)</CardTitle>
            </CardHeader>
            <CardContent>
              <pre className="text-xs text-yellow-700 overflow-auto max-h-40">
                {debugInfo}
              </pre>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Main Content */}
      <div className="container mx-auto px-4 py-6">
        <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-6">
          <TabsList className="grid w-full grid-cols-4">
            <TabsTrigger value="overview">Visão Geral</TabsTrigger>
            <TabsTrigger value="users">Usuários</TabsTrigger>
            <TabsTrigger value="congregations">Congregações</TabsTrigger>
            <TabsTrigger value="system">Sistema</TabsTrigger>
          </TabsList>

          {/* Visão Geral */}
          <TabsContent value="overview" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                🎯 Sistema Ministerial Global - Padronização Mundial
              </h3>
              <div className="text-center text-sm text-muted-foreground mt-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
                <strong>📊 Admin Geral:</strong> Disponibiliza programação oficial semanal (SEM nomes de estudantes) <br/>
                <strong>🎓 Instrutores:</strong> Recebem programação automaticamente + fazem designações locais reais
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Congregações Conectadas</CardTitle>
                  <Globe className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">{staticStats.total_congregations}</div>
                  <p className="text-xs text-muted-foreground">
                    Recebendo programação oficial
                  </p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Semanas Programadas</CardTitle>
                  <BarChart3 className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">12</div>
                  <p className="text-xs text-muted-foreground">
                    Próximas 3 meses
                  </p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Idiomas Disponíveis</CardTitle>
                  <Globe className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">2</div>
                  <p className="text-xs text-muted-foreground">
                    Português e Inglês
                  </p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Última Sincronização</CardTitle>
                  <RefreshCw className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">✅</div>
                  <p className="text-xs text-muted-foreground">
                    Hoje, {new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                  </p>
                </CardContent>
              </Card>
            </div>

            {/* Ações Rápidas */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Status do Sistema */}
              <Card>
                <CardHeader>
                  <CardTitle>Status do Sistema</CardTitle>
                  <CardDescription>
                    Informações sobre a última verificação e status geral
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Última Verificação:</span>
                    <span className="text-sm text-muted-foreground">
                      {lastCheck ? new Date(lastCheck).toLocaleString('pt-BR') : 'Nunca'}
                    </span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Status:</span>
                    <Badge variant="outline" className="text-green-600">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Operacional
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Supabase:</span>
                    <Badge variant="outline" className="text-green-600">
                      <Database className="h-3 w-3 mr-1" />
                      Conectado
                    </Badge>
                  </div>
                </CardContent>
              </Card>

              {/* Programações Publicadas */}
              <Card>
                <CardHeader>
                  <CardTitle>Programações Publicadas</CardTitle>
                  <CardDescription>
                    Últimas semanas importadas/publicadas
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  {programsLoading ? (
                    <div className="text-sm text-muted-foreground">Carregando...</div>
                  ) : programs.length === 0 ? (
                    <div className="text-sm text-muted-foreground">Nenhuma programação encontrada.</div>
                  ) : (
                    <div className="space-y-2">
                      {programs.map((p) => (
                        <div key={p.id} className="flex items-center justify-between p-2 border rounded-md">
                          <div className="text-sm">
                            <div className="font-medium">Semana {p.semana_iso} • {p.idioma?.toUpperCase?.() || '—'}</div>
                            <div className="text-xs text-muted-foreground">
                              {p.data_inicio ? new Date(p.data_inicio).toLocaleDateString('pt-BR') : '—'}
                              {p.data_fim ? ` — ${new Date(p.data_fim).toLocaleDateString('pt-BR')}` : ''}
                            </div>
                          </div>
                          <Badge variant="outline" className={p.status === 'publicado' ? 'bg-green-50 text-green-700' : ''}>
                            v{p.versao || 1} • {p.status || 'rascunho'}
                          </Badge>
                        </div>
                      ))}
                    </div>
                  )}
                </CardContent>
              </Card>

              {/* JW.org Downloads */}
              <Card className="bg-green-50 border-green-200">
                <CardHeader>
                  <CardTitle className="text-green-800">📚 JW.org Downloads</CardTitle>
                  <CardDescription className="text-green-700">
                    Gerenciar materiais oficiais
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Apostila MWB Atual:</span>
                    <Badge variant="outline" className="text-green-600">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Disponível
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Última verificação:</span>
                    <span className="text-sm text-green-700">Hoje, 10:30</span>
                  </div>
                  <div className="flex space-x-2">
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleMWBAvailable}>
                      <RefreshCw className="h-3 w-3 mr-1" />
                      Disponibilizar MWB Atual
                    </Button>
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleConfigureJWorgURLs}>
                      <Settings className="h-3 w-3 mr-1" />
                      Configurar URLs JW.org
                    </Button>
                  </div>
                </CardContent>
              </Card>

              {/* Sistema S-38 - Designações */}
              <Card className="bg-purple-50 border-purple-200">
                <CardHeader>
                  <CardTitle className="text-purple-800">⚙️ Sistema S-38</CardTitle>
                  <CardDescription className="text-purple-700">
                    Estrutura das reuniões ministeriais
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="text-sm text-purple-700 space-y-2">
                    <p>📚 <strong>Função do Admin:</strong> Disponibilizar apostilas MWB</p>
                    <p>👥 <strong>Para Instrutores:</strong> Designar estudantes para partes</p>
                    <p>🎯 <strong>Partes da Reunião:</strong></p>
                    <div className="grid grid-cols-2 gap-1 text-xs ml-2">
                      <div>• Chairman</div>
                      <div>• Treasures</div>
                      <div>• Gems</div>
                      <div>• Reading</div>
                      <div>• Starting</div>
                      <div>• Following</div>
                      <div>• Making</div>
                      <div>• Explaining</div>
                      <div>• Talk</div>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Debug / Integração */}
              <Card className="bg-slate-50 border-slate-200">
                <CardHeader>
                  <CardTitle className="text-slate-800">🧪 Debug / Integração</CardTitle>
                  <CardDescription className="text-slate-700">
                    Ferramentas rápidas para validar integrações e idioma
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-3">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Idioma Atual:</span>
                    <Badge variant="outline" className="text-slate-700">
                      {(jworg as any)?.currentLanguage === 'en' ? '🇺🇸 English' : '🇧🇷 Português'}
                    </Badge>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    <Button size="sm" variant="outline" onClick={toggleLanguage}>
                      Alternar Idioma
                    </Button>
                    <Button size="sm" variant="outline" onClick={updateMaterials}>
                      Atualizar Materiais
                    </Button>
                    <Button size="sm" variant="outline" onClick={handleTestJWorgIntegration}>
                      Testar Integração JW.org
                    </Button>
                    <Button size="sm" variant="outline" onClick={checkForUpdates} disabled={loading}>
                      Atualizar Contagens
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          {/* Usuários */}
          <TabsContent value="users" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                👥 Gestão de Usuários para Acesso às Apostilas MWB
              </h3>
              <p className="text-center text-sm text-muted-foreground mt-2">
                🎯 Função Principal: Admin gerencia usuários → Instrutores acessam apostilas
              </p>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Estatísticas de Usuários */}
            <Card>
              <CardHeader>
                  <CardTitle>Estatísticas</CardTitle>
                  <CardDescription>Resumo dos usuários</CardDescription>
              </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Total de Usuários:</span>
                      <Badge variant="outline">{staticStats.total_users}</Badge>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Admins:</span>
                      <Badge variant="outline" className="bg-red-50 text-red-700">
                        {isAdmin ? 1 : 0}
                      </Badge>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Instrutores:</span>
                      <Badge variant="outline" className="bg-blue-50 text-blue-700">
                        {staticStats.total_users - (isAdmin ? 1 : 0)}
                      </Badge>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Usuários Registrados */}
              <Card className="lg:col-span-2">
                <CardHeader>
                  <CardTitle>Usuários Registrados</CardTitle>
                  <CardDescription>Últimos usuários cadastrados no sistema</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between p-3 border rounded-lg">
                      <div className="flex items-center space-x-3">
                        <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                          <Users className="h-5 w-5 text-blue-600" />
                        </div>
                        <div>
                          <p className="font-medium">{profile?.nome_completo || 'Roberto Araujo da Silva'}</p>
                          <p className="text-sm text-muted-foreground">Administrator</p>
                        </div>
                      </div>
                      <Badge variant="outline" className="bg-red-50 text-red-700">
                        Admin
                      </Badge>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Ações Administrativas */}
            <Card>
              <CardHeader>
                <CardTitle>Ações Administrativas</CardTitle>
                <CardDescription>
                  Gerenciar usuários e permissões
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <Button className="w-full justify-start" variant="outline" onClick={handleListUsers}>
                    <Users className="h-4 w-4 mr-2" />
                    Listar Todos os Usuários
                  </Button>
                  <Button className="w-full justify-start" variant="outline" onClick={handleManagePermissions}>
                    <Settings className="h-4 w-4 mr-2" />
                    Gerenciar Permissões
                  </Button>
                  <Button className="w-full justify-start" variant="outline" onClick={handleActivityReport}>
                    <Activity className="h-4 w-4 mr-2" />
                    Relatório de Atividades
                  </Button>
                  <Button className="w-full justify-start" variant="outline" onClick={handleBackupData}>
                    <Database className="h-4 w-4 mr-2" />
                    Backup de Dados
                  </Button>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Congregações */}
          <TabsContent value="congregations" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                🏢 Gestão de Congregações para Acesso às Apostilas MWB
              </h3>
              <p className="text-center text-sm text-muted-foreground mt-2">
                🎯 Função Principal: Admin gerencia congregações → Instrutores acessam apostilas
              </p>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Estatísticas de Congregações */}
            <Card>
              <CardHeader>
                  <CardTitle>Estatísticas</CardTitle>
                  <CardDescription>Resumo das congregações</CardDescription>
              </CardHeader>
              <CardContent>
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Total de Congregações:</span>
                      <Badge variant="outline">{staticStats.total_congregations}</Badge>
                  </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Congregações Ativas:</span>
                      <Badge variant="outline" className="bg-green-50 text-green-700">
                        {staticStats.active_congregations}
                      </Badge>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Total de Estudantes:</span>
                      <Badge variant="outline">{staticStats.total_estudantes}</Badge>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Lista de Congregações */}
              <Card className="lg:col-span-2">
                <CardHeader>
                  <CardTitle>Congregações Registradas</CardTitle>
                  <CardDescription>Lista das congregações no sistema</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between p-3 border rounded-lg">
                      <div className="flex items-center space-x-3">
                        <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                          <Package className="h-5 w-5 text-blue-600" />
                        </div>
                        <div>
                          <p className="font-medium">Sistema Ministerial Global</p>
                          <p className="text-sm text-muted-foreground">Congregação Principal</p>
                          </div>
                        </div>
                      <Badge variant="outline" className="bg-green-50 text-green-700">
                        Ativa
                        </Badge>
                      </div>
                  </div>
                  
                  <div className="mt-4">
                    <Button variant="outline" className="w-full" onClick={() => handleManageCongregation('Sistema Ministerial Global')}>
                      <Users className="h-4 w-4 mr-2" />
                      Gerenciar
                    </Button>
                  </div>
                  
                  <div className="mt-4">
                    <Button variant="outline" className="w-full" onClick={handleAddCongregation}>
                      <Users className="h-4 w-4 mr-2" />
                      Adicionar Nova Congregação
                    </Button>
                  </div>
                  
                  <div className="mt-4">
                    <Button variant="outline" className="w-full">
                      <Users className="h-4 w-4 mr-2" />
                      Expandir
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          {/* Sistema */}
          <TabsContent value="system" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                ⚙️ Monitoramento e Configurações do Sistema
              </h3>
              <p className="text-center text-sm text-muted-foreground mt-2">
                🎯 Função Principal: Admin monitora sistema → Instrutores recebem apostilas estáveis
              </p>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Downloads JW.org */}
              <Card className="bg-green-50 border-green-200">
              <CardHeader>
                  <CardTitle className="text-green-800">📚 JW.org Downloads</CardTitle>
                  <CardDescription className="text-green-700">
                    Gerenciar materiais oficiais
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Apostila MWB Atual:</span>
                    <Badge variant="outline" className="text-green-600">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Disponível
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Última verificação:</span>
                    <span className="text-sm text-green-700">Hoje, 10:30</span>
                  </div>
                  <div className="flex space-x-2">
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleSyncCongregations}>
                      <RefreshCw className="h-3 w-3 mr-1" />
                      Sincronizar com Congregações
                    </Button>
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleViewFullProgram}>
                      <Settings className="h-3 w-3 mr-1" />
                      Ver Programação Completa
                    </Button>
                </div>
              </CardContent>
            </Card>

              {/* Configurações Gerais */}
            <Card>
              <CardHeader>
                  <CardTitle>Configurações Gerais</CardTitle>
                <CardDescription>
                    Parâmetros do sistema
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                    <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Backup Automático:</span>
                    <Badge variant="outline" className="bg-green-50 text-green-700">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Diário às 02:00
                      </Badge>
                    </div>
                    <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Notificações:</span>
                    <Badge variant="outline" className="bg-blue-50 text-blue-700">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Email + Sistema
                    </Badge>
                    </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Manutenção:</span>
                    <span className="text-sm text-muted-foreground">Última: Ontem</span>
                  </div>
                  <div className="flex space-x-2">
                    <Button size="sm" variant="outline">
                      <Settings className="h-3 w-3 mr-1" />
                      Configurar
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Métricas do Sistema */}
            <Card>
              <CardHeader>
                <CardTitle>Métricas do Sistema</CardTitle>
                <CardDescription>
                  Monitoramento em tempo real
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-green-600">99.9%</p>
                    <p className="text-sm text-muted-foreground">Uptime</p>
                  </div>
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-blue-600">~120ms</p>
                    <p className="text-sm text-muted-foreground">Latência</p>
                  </div>
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-green-600">25%</p>
                    <p className="text-sm text-muted-foreground">CPU</p>
                  </div>
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-blue-600">33%</p>
                    <p className="text-sm text-muted-foreground">Memória</p>
                  </div>
                </div>

                <Separator />

                <div className="space-y-3">
                    <div className="flex items-center justify-between">
                    <span className="text-sm">CPU:</span>
                    <div className="flex items-center space-x-2">
                      <div className="w-24 h-2 bg-gray-200 rounded-full">
                        <div className="w-1/4 h-2 bg-green-500 rounded-full"></div>
                    </div>
                        <span className="text-sm">25%</span>
                  </div>
                    </div>
                    
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Memória:</span>
                      <div className="flex items-center space-x-2">
                        <div className="w-24 h-2 bg-gray-200 rounded-full">
                          <div className="w-1/3 h-2 bg-blue-500 rounded-full"></div>
                    </div>
                        <span className="text-sm">33%</span>
                      </div>
                    </div>
                    
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Banco:</span>
                      <div className="flex items-center space-x-2">
                        <CheckCircle className="h-4 w-4 text-green-500" />
                        <span className="text-sm">Conectado</span>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

              {/* Logs e Atividades */}
              <Card>
                <CardHeader>
                  <CardTitle>Logs Recentes</CardTitle>
                  <CardDescription>
                    Últimas atividades do sistema
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <CheckCircle className="h-4 w-4 text-green-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Sistema iniciado</p>
                        <p className="text-xs text-muted-foreground">Hoje, 08:00</p>
                      </div>
                    </div>

                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <Activity className="h-4 w-4 text-blue-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Backup automático executado</p>
                        <p className="text-xs text-muted-foreground">Hoje, 02:00</p>
                      </div>
                    </div>

                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <Users className="h-4 w-4 text-green-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Novo usuário registrado</p>
                        <p className="text-xs text-muted-foreground">Ontem, 16:30</p>
                      </div>
                    </div>

                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <AlertCircle className="h-4 w-4 text-yellow-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Manutenção programada</p>
                        <p className="text-xs text-muted-foreground">Ontem, 03:00</p>
                      </div>
                    </div>
                  </div>

                  <div className="mt-4">
                    <Button variant="outline" className="w-full" onClick={handleViewAllLogs}>
                      <FileText className="h-4 w-4 mr-2" />
                      Ver Todos os Logs
                    </Button>
                  </div>
                </CardContent>
              </Card>
          </TabsContent>
        </Tabs>
      </div>
    </div>
  );
}

```

Adicionei no `AdminDashboard`:
- Carregamento dos programas do Supabase (`loadPrograms`) e atualização em `checkForUpdates`.
- Novo Card “Programações Publicadas” na aba “Visão Geral” listando as últimas semanas (idioma, período, versão e status).

Se quiser, posso adicionar link para abrir os detalhes da semana ou filtrar por idioma/status.

---

**User**

para o dashboard do Instrutor vamos simular Our Christian Life and Ministry Meeting Schedule

Bible Chapters PROVERBS 29

	Chairman	Geoff Holt	7.00
5 min	Song 28 and prayer	Andy Holt	7.00-7.05
1 min	Opening Comments	Geoff Holt	7.05-7.06

10 min	Treasures From Gode Word
1. Reject Unscrlptural Beliefs and Customs	
Jason O'Brien	
7.06-7.16
10 min	2. Spiritual Gems	Mick Shepherd	7.16-7.26
4 min	3. Bible Reading Pr 29:1-18 (th study 5)	Patrick Keane	7.26-7.30
3 min	4. INFORMAL. Invite the person to the upcoming special talk	Alpa Parmar	7.30-7.33

4 min	Assistant	(tmd lesson 2 point 3)
5.  SE TOHSE. Use The WB/ebb No. 1 2025 to staA a conversation	Sharon De-Lima
Mary Salter	
7.34-7.38

5 min	Assistant	(Irnd lesson 3 point 3)
6. iNFORMAL Qfer 7heWb/chto+er No.1 2025 wla expresses comm of war	Karen Moore
Tim Beasley	
7.39-7.44
	Assistant	(/md lesson 3 point 4)	Andy Holt	
	Song 159		7.45-7.50
15 min	7. Local Needs GB UPDATE 5	Geoff Holt	7.50-8.05
30 min	8. Cong Bible Study //b intro to section 4 and lessons 14-15	John Ricketts	8.05-8.35
	Reader	Tom Bott	
3 min	Concluding Comments	Geoff Holt	8.35-8.38
5 min	Song 31 and Prayer	Jason O'Brien	8.45


Bible Chapters PROVERBS 30

	Chairman	David Newby	7.00
5 min	Song 136 and prayer	Jacob Ash	7.00-7.05
1 min	Opening Comments	David Newby	7.05-7.06

10 min	Treasures From Gods Word
1. "Give Me Neither Poverty NOF Riches”	
Jacob Ash	
7.06-7.16
10 min
4 min	2.	Spiritual Gems
3.	Bible Reading Pr 30:1-14 [th study 2)	John Ricketts
Frank DeLima	7.16-7.26
7.26-7.30

 
4 min	4. HSE TO HSE. Use roeWatchtowm No.1 2D25 to start a conversation Assistant	(/md lesson 1 point 3)
 
Aurelija Williams	7.30-7.34
Debra Kimberly-Frost
 
4 min	5. PUBLIC WITNESSING. (Imd lesson 9 point 3) Assistant
4 min	6. Talk. ij\vdq article 102—Theme: Is Gambling a Sin†
th study ')

Song 80
{jj jj j	7 oo got ge y/rygay jrnfzett sPeece/•-th/6/eeSoaz›an7
1	yj{}		@ gg) @gfig) flfifiOM@[]BhM8NM fOP @B@@M	F 3o min	9. Congregation Bible Study //b lessons 16-17
Reader
Concluding Comments 5 min	Song 128 and Prayer
 
Timea Kremer Jasmina Ash Kiel Juby



Terry Moore David Newby Joe Green Andy O'Brien David Newby Kiel Juby
 
7.35-7.39

7.40-7.44


7.45-7.50
7.50-7.55

8.05-8.35

8.35-8.38
8.45
 
 


Bible Chapters PROVERBS 31

	Chairman	Andy O'Bûen	7.00
5 min	Song 135 and prayer	Tim Beasley	7.00-7.05
1 min	Opening Comments	Andy O'Bûen	7.05-7.06
	Treasures From Gods Word		
10 min	1. Lessons From a MoQer's Loving lnstrucéons	Tim Beasley	7.06-7.16
10 min	2. Spiritual Gems	Stuart Frost	7.16-7.26
4 min	3. Bible Reading Pr 31:1&31 {Ill s&dy 10)	David Newby snr	7.26-7.30

 
3 milk	4.lNFORMALIn"‹tiate conversation after someone is kind someway	Jasmina Ash
Assistant	;/md lesson 5 point 3)	Jayne O'Brien
4 min	5.HSE TO HSE. Shae one of the Tru1hs We Love D Teach"	Tamara Green
Assistant	apperzlix A EaveUp/e brochure. [lmd lesson 1 point 4)	Alpa Parl+laf
5 min	6. HSE TO HSE lwite who accepted W’afchf‹xvwNo.1 2025 to specialialk	Stuart Frost
ASSiStant	(/md lesson 7 point 4)	Nathan Frost
 
7.30-7.33

7.34-7.38

7.39-7.44
 
Song 121	7.45-7.50
15 min	7. Help Your Chlldren D Use Electronlc Devlces Wisely	Tom Bott	7.50-8.05
30 min	8. Congregation Bible Study Ifb lessons 18-19	Mick Shepherd	8.05-8.35
Reader	Joe Green
 
3.min	Concluding Comments	Andy O'Brien
5.min	Song 2 and Prayer	Tom Bolt


Bible Chapters ECCLESIASTES 1-2
 
8.35-8.38
8.45
 

	Chairman	Joe Green	7.00
5 min	Song 103 and prayer	Kiel Juby	7.00-7.05
1 min	Opening Comments	Joe Green	7.05-7.06
	Treasures From Gods Word-
 		
10 min	1. Conflnue @ Train &e Next Generaflon	Kiel Juby	7.06-7.16
10 min	2. SpirituaC Gems	Terry Moore	7.16-7.2b
4 min	3. Bible Reading Ec 1:1-18 (th s&dy 11)	StuaÛ Frost	7.26-7.30
2 mÏ0	4. INFORMAL Flró what interests the person. Arrange to contact again	Geofi Holt	7.30-7.32
	Assistant	(/md lesson 3 point 5)	Tyler O'Brien	
Ü fTiÏ0	.PUBLIC Share alruths We Love to Teach' using method In appendix A	Serena Bott	7.33-7.35
	ASSÍStàFlt	Love Pecp/s brochure. (Imd lesson 2 point 3)	Michaela Juby	
2 lNIII	6. INFORMAL Answer question the person ralsed dunng previous conversation
Assistant	(iÆ lesson 9 point 5)	Agrita PauCe
Aurelija Williams	7.36-7.38
 
5 min	PUBLIC Demo a Bible study, make arrangements to œnônue..	Terry Larder
ÂSSÏStäOt	(/md lesson 10 point 3)	Mary Salter

Song 84
 
7.39-7.44


7.45-7.50
 
15 min	7. Three Important Lessons About Training
30 min	8. Congregation Bible Study f6 lesaons 021
Reader
 
Jason O'Brien	7.so-g.os
Andy O'Brien	8.05-8.35
Jacob Ash
 
3 mln	Concluding Comments 5 mln	 Song 148 and Prayer
 
Joe Green Terry Moore
 
8.35-8.38
8.45


---

**Cursor**

Perfeito. Vou preparar uma simulação pronta para o Dashboard do Instrutor usando um único objeto de “programação da semana” com as partes já mapeadas conforme o S‑38, usando seus exemplos (Provérbios 29, 30, 31 e início de Eclesiastes). Assim você pode visualizar imediatamente no front sem depender do parser.

Proponho este formato de dados (JSON) para fixture local:
- programa: identifica a semana, capítulo base e idioma
- partes: entrada por ordem, com tipo, seção, minutagem, elegibilidade, participantes e horário

Coloque este arquivo em public/templates/schedule-instructor-sample.json e eu ligo no painel do instrutor depois.

Exemplo de fixture (recorte com 1 semana completa e mais duas resumidas):
```json
{
  "programas": [
    {
      "id": "week-prov-29",
      "semana_iso": "2025-W35",
      "idioma": "en",
      "capitulo_biblico": "Proverbs 29",
      "data_inicio": "2025-08-25",
      "data_fim": "2025-08-31",
      "partes": [
        { "ordem": 0, "secao": "opening", "tipo": "chairman", "titulo": "Chairman", "tempo_min": 0, "elegibilidade": "elder_or_ms", "designado": "Geoff Holt", "horario": "19:00" },
        { "ordem": 1, "secao": "opening", "tipo": "song_prayer", "titulo": "Song 28 and prayer", "tempo_min": 5, "elegibilidade": "elder_or_ms", "designado": "Andy Holt", "horario": "19:00-19:05" },
        { "ordem": 2, "secao": "opening", "tipo": "comments", "titulo": "Opening Comments", "tempo_min": 1, "elegibilidade": "elder_or_ms", "designado": "Geoff Holt", "horario": "19:05-19:06" },

        { "ordem": 3, "secao": "treasures", "tipo": "talk", "titulo": "Reject Unscrip­tural Beliefs and Customs", "tempo_min": 10, "elegibilidade": "elder_or_ms", "designado": "Jason O'Brien", "horario": "19:06-19:16" },
        { "ordem": 4, "secao": "treasures", "tipo": "qna", "titulo": "Spiritual Gems", "tempo_min": 10, "elegibilidade": "elder_or_ms", "designado": "Mick Shepherd", "horario": "19:16-19:26" },
        { "ordem": 5, "secao": "treasures", "tipo": "reading", "titulo": "Bible Reading Pr 29:1-18 (th study 5)", "tempo_min": 4, "elegibilidade": "male_student", "designado": "Patrick Keane", "horario": "19:26-19:30" },

        { "ordem": 6, "secao": "apply", "tipo": "demo", "settings": "informal", "titulo": "Invite the person to the upcoming special talk", "tempo_min": 3, "elegibilidade": "male_or_female", "designado": "Alpa Parmar", "assistant": null, "horario": "19:30-19:33" },

        { "ordem": 7, "secao": "apply", "tipo": "demo", "settings": "house_to_house", "titulo": "Use The Watchtower/Workbook No.1 2025 to start a conversation", "tempo_min": 4, "elegibilidade": "same_gender_with_assistant_or_family", "designado": "Sharon De‑Lima", "assistant": "Mary Salter", "observacoes": "tmd lesson 2 point 3", "horario": "19:34-19:38" },

        { "ordem": 8, "secao": "apply", "tipo": "demo", "settings": "informal", "titulo": "Offer The Watchtower/Chapter No.1 2025 when the person expresses concern", "tempo_min": 5, "elegibilidade": "same_gender_with_assistant", "designado": "Karen Moore", "assistant": "Tim Beasley", "observacoes": "lmd lesson 3 point 3/4", "horario": "19:39-19:44" },

        { "ordem": 9, "secao": "transition", "tipo": "song", "titulo": "Song 159", "tempo_min": 5, "elegibilidade": "n/a", "designado": null, "horario": "19:45-19:50" },

        { "ordem": 10, "secao": "living", "tipo": "local_needs", "titulo": "Local Needs GB UPDATE 5", "tempo_min": 15, "elegibilidade": "elder", "designado": "Geoff Holt", "horario": "19:50-20:05" },
        { "ordem": 11, "secao": "cbs", "tipo": "study", "titulo": "Congregation Bible Study //b intro to section 4 and lessons 14-15", "tempo_min": 30, "elegibilidade": "qualified_elder", "designado": "John Ricketts", "reader": "Tom Bott", "horario": "20:05-20:35" },

        { "ordem": 12, "secao": "closing", "tipo": "comments", "titulo": "Concluding Comments", "tempo_min": 3, "elegibilidade": "elder_or_ms", "designado": "Geoff Holt", "horario": "20:35-20:38" },
        { "ordem": 13, "secao": "closing", "tipo": "song_prayer", "titulo": "Song 31 and Prayer", "tempo_min": 5, "elegibilidade": "elder_or_ms", "designado": "Jason O'Brien", "horario": "20:45" }
      ]
    },

    {
      "id": "week-prov-30",
      "semana_iso": "2025-W36",
      "idioma": "en",
      "capitulo_biblico": "Proverbs 30",
      "resumo": [
        { "secao": "opening", "items": ["Chairman David Newby", "Song 136 and prayer Jacob Ash", "Opening Comments"] },
        { "secao": "treasures", "items": ["Talk: Give Me Neither Poverty Nor Riches — Jacob Ash", "Spiritual Gems", "Bible Reading Pr 30:1-14 — Frank DeLima"] },
        { "secao": "apply", "items": ["HSE TO HSE start a conversation (assistant Debra K-Frost)", "PUBLIC WITNESSING (lesson 9 pt3)", "Talk: Is Gambling a Sin?"] },
        { "secao": "living", "items": ["Song 80", "Congregation Bible Study lessons 16-17", "Concluding Comments", "Song 128 and Prayer"] }
      ]
    },

    {
      "id": "week-prov-31",
      "semana_iso": "2025-W37",
      "idioma": "en",
      "capitulo_biblico": "Proverbs 31",
      "resumo": [
        { "secao": "opening", "items": ["Chairman Andy O'Brien", "Song 135 and prayer Tim Beasley", "Opening Comments"] },
        { "secao": "treasures", "items": ["Lessons From a Mother's Loving Instructions — Tim Beasley", "Spiritual Gems — Stuart Frost", "Bible Reading Pr 31:1-31 — David Newby sr"] },
        { "secao": "apply", "items": ["INFORMAL initiate conversation after kindness (assistant Jayne O'Brien)", "HSE TO HSE share Truths We Love", "HSE TO HSE invite to special talk (assistant Nathan Frost)"] },
        { "secao": "living", "items": ["Song 121", "Help Your Children Use Electronic Devices Wisely — Tom Bott", "CBS lessons 18-19", "Concluding Comments", "Song 2 and Prayer"] }
      ]
    }
  ]
}
```

Como usar no Dashboard do Instrutor
- Passo 1: salvar o JSON em public/templates/schedule-instructor-sample.json.
- Passo 2: no painel do Instrutor, criar um carregamento de “Programação de exemplo” quando não houver dados ou via botão “Importar exemplo”, que:
  - lê o JSON,
  - popula a lista de semanas,
  - abre a semana para exibir as partes com tempo, tipo, elegibilidade e designados.

Se preferir, eu já implemento:
- Botão “Carregar exemplo” no Dashboard do Instrutor.
- Lista das semanas (W35, W36, W37).
- Tela de detalhes da semana “Proverbs 29” com as partes em ordem, badges de seção, tempo e validações de elegibilidade (leitura bíblica masculino, etc.).

Quer que eu crie o arquivo JSON agora e ligue o botão “Carregar exemplo” no painel do Instrutor?

```json
{
  "programas": [
    {
      "id": "week-prov-29",
      "semana_iso": "2025-W35",
      "idioma": "en",
      "capitulo_biblico": "Proverbs 29",
      "data_inicio": "2025-08-25",
      "data_fim": "2025-08-31",
      "partes": [
        { "ordem": 0, "secao": "opening", "tipo": "chairman", "titulo": "Chairman", "tempo_min": 0, "elegibilidade": "elder_or_ms", "designado": "Geoff Holt", "horario": "19:00" },
        { "ordem": 1, "secao": "opening", "tipo": "song_prayer", "titulo": "Song 28 and prayer", "tempo_min": 5, "elegibilidade": "elder_or_ms", "designado": "Andy Holt", "horario": "19:00-19:05" },
        { "ordem": 2, "secao": "opening", "tipo": "comments", "titulo": "Opening Comments", "tempo_min": 1, "elegibilidade": "elder_or_ms", "designado": "Geoff Holt", "horario": "19:05-19:06" },

        { "ordem": 3, "secao": "treasures", "tipo": "talk", "titulo": "Reject Unscrip­tural Beliefs and Customs", "tempo_min": 10, "elegibilidade": "elder_or_ms", "designado": "Jason O'Brien", "horario": "19:06-19:16" },
        { "ordem": 4, "secao": "treasures", "tipo": "qna", "titulo": "Spiritual Gems", "tempo_min": 10, "elegibilidade": "elder_or_ms", "designado": "Mick Shepherd", "horario": "19:16-19:26" },
        { "ordem": 5, "secao": "treasures", "tipo": "reading", "titulo": "Bible Reading Pr 29:1-18 (th study 5)", "tempo_min": 4, "elegibilidade": "male_student", "designado": "Patrick Keane", "horario": "19:26-19:30" },

        { "ordem": 6, "secao": "apply", "tipo": "demo", "settings": "informal", "titulo": "Invite the person to the upcoming special talk", "tempo_min": 3, "elegibilidade": "male_or_female", "designado": "Alpa Parmar", "assistant": null, "horario": "19:30-19:33" },

        { "ordem": 7, "secao": "apply", "tipo": "demo", "settings": "house_to_house", "titulo": "Use The Watchtower/Workbook No.1 2025 to start a conversation", "tempo_min": 4, "elegibilidade": "same_gender_with_assistant_or_family", "designado": "Sharon De‑Lima", "assistant": "Mary Salter", "observacoes": "tmd lesson 2 point 3", "horario": "19:34-19:38" },

        { "ordem": 8, "secao": "apply", "tipo": "demo", "settings": "informal", "titulo": "Offer The Watchtower/Chapter No.1 2025 when the person expresses concern", "tempo_min": 5, "elegibilidade": "same_gender_with_assistant", "designado": "Karen Moore", "assistant": "Tim Beasley", "observacoes": "lmd lesson 3 point 3/4", "horario": "19:39-19:44" },

        { "ordem": 9, "secao": "transition", "tipo": "song", "titulo": "Song 159", "tempo_min": 5, "elegibilidade": "n/a", "designado": null, "horario": "19:45-19:50" },

        { "ordem": 10, "secao": "living", "tipo": "local_needs", "titulo": "Local Needs GB UPDATE 5", "tempo_min": 15, "elegibilidade": "elder", "designado": "Geoff Holt", "horario": "19:50-20:05" },
        { "ordem": 11, "secao": "cbs", "tipo": "study", "titulo": "Congregation Bible Study //b intro to section 4 and lessons 14-15", "tempo_min": 30, "elegibilidade": "qualified_elder", "designado": "John Ricketts", "reader": "Tom Bott", "horario": "20:05-20:35" },

        { "ordem": 12, "secao": "closing", "tipo": "comments", "titulo": "Concluding Comments", "tempo_min": 3, "elegibilidade": "elder_or_ms", "designado": "Geoff Holt", "horario": "20:35-20:38" },
        { "ordem": 13, "secao": "closing", "tipo": "song_prayer", "titulo": "Song 31 and Prayer", "tempo_min": 5, "elegibilidade": "elder_or_ms", "designado": "Jason O'Brien", "horario": "20:45" }
      ]
    },

    {
      "id": "week-prov-30",
      "semana_iso": "2025-W36",
      "idioma": "en",
      "capitulo_biblico": "Proverbs 30",
      "resumo": [
        { "secao": "opening", "items": ["Chairman David Newby", "Song 136 and prayer Jacob Ash", "Opening Comments"] },
        { "secao": "treasures", "items": ["Talk: Give Me Neither Poverty Nor Riches — Jacob Ash", "Spiritual Gems", "Bible Reading Pr 30:1-14 — Frank DeLima"] },
        { "secao": "apply", "items": ["HSE TO HSE start a conversation (assistant Debra K-Frost)", "PUBLIC WITNESSING (lesson 9 pt3)", "Talk: Is Gambling a Sin?"] },
        { "secao": "living", "items": ["Song 80", "Congregation Bible Study lessons 16-17", "Concluding Comments", "Song 128 and Prayer"] }
      ]
    },

    {
      "id": "week-prov-31",
      "semana_iso": "2025-W37",
      "idioma": "en",
      "capitulo_biblico": "Proverbs 31",
      "resumo": [
        { "secao": "opening", "items": ["Chairman Andy O'Brien", "Song 135 and prayer Tim Beasley", "Opening Comments"] },
        { "secao": "treasures", "items": ["Lessons From a Mother's Loving Instructions — Tim Beasley", "Spiritual Gems — Stuart Frost", "Bible Reading Pr 31:1-31 — David Newby sr"] },
        { "secao": "apply", "items": ["INFORMAL initiate conversation after kindness (assistant Jayne O'Brien)", "HSE TO HSE share Truths We Love", "HSE TO HSE invite to special talk (assistant Nathan Frost)"] },
        { "secao": "living", "items": ["Song 121", "Help Your Children Use Electronic Devices Wisely — Tom Bott", "CBS lessons 18-19", "Concluding Comments", "Song 2 and Prayer"] }
      ]
    }
  ]
}
```

---

**User**

PS C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte> npm run dev:all
npm warn config optional Use `--omit=optional` to exclude optional dependencies, or
npm warn config `--include=optional` to include them.
npm warn config
npm warn config       Default value does install optional deps unless otherwise omitted.
npm error code EJSONPARSE
npm error JSON.parse Invalid package.json: JSONParseError: Expected ',' or '}' after property value in JSON at position 5919 (line 80 column 5) while parsing near "...m run analyze\"\r\n    \"agents:log\": \"node ..."
npm error JSON.parse Failed to parse JSON data.
npm error JSON.parse Note: package.json must be actual JSON, not just JavaScript.
npm error A complete log of this run can be found in: C:\Users\frank.MONITORE-MAFRA\AppData\Local\npm-cache\_logs\2025-09-08T12_11_16_986Z-debug-0.log
PS C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte> 


---

**Cursor**

Vou abrir o package.json para corrigir o erro de JSON inválido e ajustar a seção de scripts.

Vou corrigir o JSON inválido adicionando a vírgula faltante entre os scripts em `package.json`. Em seguida, você pode rodar novamente `npm run dev:all`.

```json
{
  "name": "vite_react_shadcn_ts",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "dev:all": "concurrently \"npm run dev:backend\" \"npm run dev:frontend\"",
    "dev:backend": "cd backend && npm run dev",
    "dev:frontend": "vite",
    "dev:backend-only": "cd backend && npm run dev",
    "dev:frontend-only": "vite",
    "build": "vite build",
    "build:prod": "vite build --config vite.config.prod.ts",
    "build:analyze": "vite build --config vite.config.prod.ts && npm run analyze",
    "analyze": "npx vite-bundle-analyzer dist",
    "build:dev": "vite build --mode development",
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0",
    "typecheck": "tsc -p tsconfig.json",
    "preview": "vite preview",
    "start": "serve -s dist -l $PORT",
    "cypress:open": "cypress open",
    "cypress:run": "cypress run",
    "cypress:install": "cypress install",
    "cypress:verify": "cypress verify",
    "test:e2e": "cypress run --spec \"cypress/e2e/**/*.cy.ts\"",
    "test:e2e:open": "cypress open",
    "test:e2e:record": "cypress run --record",
    "test:franklin": "cypress run --spec \"cypress/e2e/franklin-login.cy.ts\"",
    "test:franklin:record": "cypress run --spec \"cypress/e2e/franklin-login.cy.ts\" --record",
    "test:sarah": "cypress run --spec \"cypress/e2e/sarah-student-registration.cy.ts\"",
    "test:sarah:record": "cypress run --spec \"cypress/e2e/sarah-student-registration.cy.ts\" --record",
    "test:birth-date": "cypress run --spec \"cypress/e2e/sarah-student-registration.cy.ts\"",
    "test:sarah:open": "cypress open --e2e --browser chrome",
    "test:audit": "cypress run --spec \"cypress/e2e/auditoria_sistema_ministerial.cy.ts\"",
    "test:audit:record": "cypress run --spec \"cypress/e2e/auditoria_sistema_ministerial.cy.ts\" --record",
    "test:auth": "cypress run --spec \"cypress/e2e/authentication-roles.cy.ts\"",
    "test:auth:record": "cypress run --spec \"cypress/e2e/authentication-roles.cy.ts\" --record",
    "test:pdf-upload": "cypress run --spec \"cypress/e2e/pdf-upload-functionality.cy.ts\"",
    "test:pdf-upload:record": "cypress run --spec \"cypress/e2e/pdf-upload-functionality.cy.ts\" --record",
    "env:validate": "node scripts/validate-env.js",
    "env:check": "node scripts/validate-env.js",
    "env:show": "node -e \"console.log('Environment Variables:'); Object.keys(process.env).filter(k => k.startsWith('VITE_') || ['NODE_ENV', 'DATABASE_URL'].includes(k)).forEach(k => console.log(k + '=' + (k.includes('SECRET') || k.includes('TOKEN') || k.includes('KEY') ? '[HIDDEN]' : process.env[k])))\"",
    "test:programs": "cypress run --spec \"cypress/e2e/programs-page-functionality.cy.ts\"",
    "test:programs:record": "cypress run --spec \"cypress/e2e/programs-page-functionality.cy.ts\" --record",
    "test:sistema-completo": "cypress run --spec \"cypress/e2e/sistema-ministerial-e2e.cy.ts\"",
    "test:sistema-completo:record": "cypress run --spec \"cypress/e2e/sistema-ministerial-e2e.cy.ts\" --record",
    "test:enhanced-parsing": "cypress run --spec \"cypress/e2e/enhanced-pdf-parsing.cy.ts\"",
    "test:enhanced-parsing:record": "cypress run --spec \"cypress/e2e/enhanced-pdf-parsing.cy.ts\" --record",
    "test:assignment-generation": "cypress run --spec \"cypress/e2e/assignment-generation.cy.ts\"",
    "test:assignment-generation:record": "cypress run --spec \"cypress/e2e/assignment-generation.cy.ts\" --record",
    "test:all-new": "cypress run --spec \"cypress/e2e/{pdf-upload-functionality,programs-page-functionality,sistema-ministerial-e2e,enhanced-pdf-parsing,assignment-generation}.cy.ts\"",
    "test:complete-workflow": "cypress run --spec \"cypress/e2e/{enhanced-pdf-parsing,assignment-generation}.cy.ts\"",
    "test:integration": "node src/verification/integration-test-cli.js",
    "test:integration:performance": "node -e \"import('./src/verification/tests/integration-test-runner.js').then(m => m.runIntegrationTestSuite())\"",
    "test:integration:services": "node -e \"console.log('🔗 Running service integration tests...'); import('./src/verification/tests/integration-test-runner.js').then(m => m.runIntegrationTestSuite())\"",
    "verify:integration": "node src/verification/test-integration-simple.js",
    "test:setup": "cypress install && cypress verify",
    "test:verification": "node src/verification/tests/test-runner.cjs",
    "test:verification:simple": "node src/verification/tests/test-runner.cjs --simple",
    "test:verification:basic": "node src/verification/tests/test-runner.cjs --basic",
    "audit:plan": "node ./scripts/audit-implementation.mjs",
    "verify:system": "node src/verification/cli.js --full",
    "verify:frontend": "node src/verification/cli.js --module=frontend",
    "verify:backend": "node src/verification/cli.js --module=backend",
    "verify:infrastructure": "node src/verification/cli.js --module=infrastructure",
    "verify:reports": "node src/verification/cli.js reports",
    "verify:reports:list": "node src/verification/cli.js reports list",
    "verify:reports:dashboard": "node src/verification/cli.js reports dashboard",
    "verify:reports:trends": "node src/verification/cli.js reports trends",
    "verify:reports:cleanup": "node src/verification/cli.js reports cleanup",
    "verify:reports:init": "node src/verification/cli.js reports init",
    "test:report-storage": "node src/verification/test-report-storage.js",
    "test:frontend-verifier": "node src/verification/test-frontend-verifier.js",
    "test": "cypress run",
    "test:open": "cypress open",
    "test:component": "cypress run --component",
    "test:performance": "lighthouse http://localhost:8080/admin --output html --output-path ./lighthouse-report.html",
    "optimize": "npm run build:prod && npm run analyze",
    "agents:log": "node scripts/agents-log.js"
  },
  "dependencies": {
    "@hello-pangea/dnd": "^18.0.1",
    "@hookform/resolvers": "^3.10.0",
    "@radix-ui/react-accordion": "^1.2.11",
    "@radix-ui/react-alert-dialog": "^1.1.14",
    "@radix-ui/react-aspect-ratio": "^1.1.7",
    "@radix-ui/react-avatar": "^1.1.10",
    "@radix-ui/react-checkbox": "^1.3.2",
    "@radix-ui/react-collapsible": "^1.1.11",
    "@radix-ui/react-context-menu": "^2.2.15",
    "@radix-ui/react-dialog": "^1.1.14",
    "@radix-ui/react-dropdown-menu": "^2.1.15",
    "@radix-ui/react-hover-card": "^1.1.14",
    "@radix-ui/react-label": "^2.1.7",
    "@radix-ui/react-menubar": "^1.1.15",
    "@radix-ui/react-navigation-menu": "^1.2.13",
    "@radix-ui/react-popover": "^1.1.14",
    "@radix-ui/react-progress": "^1.1.7",
    "@radix-ui/react-radio-group": "^1.3.7",
    "@radix-ui/react-scroll-area": "^1.2.9",
    "@radix-ui/react-select": "^2.2.5",
    "@radix-ui/react-separator": "^1.1.7",
    "@radix-ui/react-slider": "^1.3.5",
    "@radix-ui/react-slot": "^1.2.3",
    "@radix-ui/react-switch": "^1.2.5",
    "@radix-ui/react-tabs": "^1.1.12",
    "@radix-ui/react-toast": "^1.2.14",
    "@radix-ui/react-toggle": "^1.1.9",
    "@radix-ui/react-toggle-group": "^1.1.10",
    "@radix-ui/react-tooltip": "^1.2.7",
    "@supabase/mcp-server-supabase": "^0.4.5",
    "@supabase/supabase-js": "^2.54.0",
    "@tanstack/react-query": "^5.83.0",
    "ag-grid-community": "^34.1.1",
    "ag-grid-react": "^34.1.1",
    "cheerio": "^1.1.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cmdk": "^1.1.1",
    "date-fns": "^3.6.0",
    "dotenv": "^17.2.1",
    "embla-carousel-react": "^8.6.0",
    "fs-extra": "^11.3.1",
    "i18next": "^25.3.6",
    "i18next-browser-languagedetector": "^8.2.0",
    "input-otp": "^1.4.2",
    "jspdf": "^3.0.1",
    "lucide-react": "^0.462.0",
    "next-themes": "^0.3.0",
    "node-fetch": "^3.3.2",
    "pdf-parse": "^1.1.1",
    "qrcode.react": "^4.2.0",
    "react": "^18.3.1",
    "react-day-picker": "^8.10.1",
    "react-dom": "^18.3.1",
    "react-error-boundary": "^6.0.0",
    "react-hook-form": "^7.61.1",
    "react-i18next": "^15.6.1",
    "react-resizable-panels": "^2.1.9",
    "react-router-dom": "^6.30.1",
    "recharts": "^2.15.4",
    "serve": "^14.2.3",
    "sonner": "^1.7.4",
    "tailwind-merge": "^2.6.0",
    "tailwindcss-animate": "^1.0.7",
    "vaul": "^0.9.9",
    "xlsx": "^0.18.5",
    "zod": "^3.25.76"
  },
  "overrides": {
    "rollup": "^4.0.0"
  },
  "devDependencies": {
    "@eslint/js": "^9.32.0",
    "@tailwindcss/typography": "^0.5.16",
    "@types/babel__core": "^7.20.5",
    "@types/babel__generator": "^7.27.0",
    "@types/babel__template": "^7.4.4",
    "@types/node": "^22.17.1",
    "@types/react": "^18.3.23",
    "@types/react-dom": "^18.3.7",
    "@vitejs/plugin-react": "^4.3.1",
    "autoprefixer": "^10.4.21",
    "concurrently": "^9.2.0",
    "cssnano": "^7.1.0",
    "cypress": "^13.17.0",
    "eslint": "^9.32.0",
    "eslint-plugin-react-hooks": "^5.2.0",
    "eslint-plugin-react-refresh": "^0.4.20",
    "fast-glob": "^3.3.3",
    "globals": "^15.15.0",
    "lovable-tagger": "^1.1.9",
    "postcss": "^8.5.6",
    "rollup-plugin-visualizer": "^6.0.3",
    "tailwindcss": "^3.4.17",
    "terser": "^5.43.1",
    "typescript": "^5.8.3",
    "typescript-eslint": "^8.38.0",
    "vite": "^5.0.0",
    "vite-plugin-pwa": "^1.0.3"
  }
}

```

Corrigi o `package.json` (faltava a vírgula antes de `"agents:log"`). Tente novamente:
- npm run dev:all

Se der certo, seguimos para adicionar o “Carregar exemplo” no painel do Instrutor.

---

**User**

nwpuurgwnnuejqinkvrh.supabase.co/rest/v1/congregacoes?select=*:1  Failed to load resource: the server responded with a status of 404 ()
nwpuurgwnnuejqinkvrh.supabase.co/rest/v1/programas?select=id%2Csemana_iso%2Cidioma%2Cstatus%2Cversao%2Cdata_inicio%2Cdata_fim&order=data_inicio.desc&limit=12:1  Failed to load resource: the server responded with a status of 400 ()
AdminDashboard.tsx:184 ❌ Error loading programs: Object
(anônimo) @ AdminDashboard.tsx:184
nwpuurgwnnuejqinkvrh.supabase.co/rest/v1/congregacoes?select=*:1  Failed to load resource: the server responded with a status of 404 ()
nwpuurgwnnuejqinkvrh.supabase.co/rest/v1/programas?select=id%2Csemana_iso%2Cidioma%2Cstatus%2Cversao%2Cdata_inicio%2Cdata_fim&order=data_inicio.desc&limit=12:1  Failed to load resource: the server responded with a status of 400 ()
AdminDashboard.tsx:184 ❌ Error loading programs: Object
(anônimo) @ AdminDashboard.tsx:184
nwpuurgwnnuejqinkvrh.supabase.co/rest/v1/congregacoes?select=*:1  Failed to load resource: the server responded with a status of 404 ()
nwpuurgwnnuejqinkvrh.supabase.co/rest/v1/programas?select=id%2Csemana_iso%2Cidioma%2Cstatus%2Cversao%2Cdata_inicio%2Cdata_fim&order=data_inicio.desc&limit=12:1  Failed to load resource: the server responded with a status of 400 ()
AdminDashboard.tsx:184 ❌ Error loading programs: Object
(anônimo) @ AdminDashboard.tsx:184  em lugar algum eu vejo a programacao informada em "C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_E_202511.pdf"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_E_202507.pdf"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_E_202509.pdf"  no http://localhost:8080/admin


---

**Cursor**

```sql
create table if not exists programas (id uuid default gen_random_uuid() primary key, semana_iso text, idioma text, status text, versao int default 1, data_inicio date, data_fim date);
```

- Os 404/400 indicam que as tabelas `congregacoes` e/ou `programas` não existem (ou RLS/colunas não batem) no Supabase, então a listagem não aparece no Admin.
- Os PDFs em `docs/Oficial/*.pdf` não “viram” programas automaticamente; eles são apenas arquivos estáticos servidos em `http://localhost:3001/materials/...`. Para aparecer como “Programações Publicadas” no Admin, precisamos ter registros na tabela `programas`.

Como destravar agora (rápido):
- Verifique variáveis do frontend:
  - VITE_SUPABASE_URL e VITE_SUPABASE_ANON_KEY válidos.
- Crie tabelas mínimas no Supabase (DDL simplificada):
  - programas: id, semana_iso, idioma, status, versao, data_inicio, data_fim
  - congregacoes: id, nome, idioma
- Insira 1-2 linhas em `programas` para teste.

Exemplo SQL (execute no Supabase SQL editor):
```sql
create extension if not exists pgcrypto;

create table if not exists programas (
  id uuid primary key default gen_random_uuid(),
  semana_iso text,
  idioma text,
  status text default 'publicado',
  versao int default 1,
  data_inicio date,
  data_fim date,
  created_at timestamp with time zone default now()
);

create table if not exists congregacoes (
  id uuid primary key default gen_random_uuid(),
  nome text not null,
  idioma text,
  created_at timestamp with time zone default now()
);

insert into programas (semana_iso, idioma, status, versao, data_inicio, data_fim)
values
('2025-W31', 'pt', 'publicado', 1, '2025-07-28', '2025-08-03'),
('2025-W33', 'pt', 'publicado', 1, '2025-08-11', '2025-08-17');
```

Depois:
- Recarregue o Admin: a aba “Programações Publicadas” deve exibir as semanas.

Opcional (fallback visual imediato):
- Posso adicionar um card “Materiais disponíveis” no Admin que mostra links diretos para:
  - http://localhost:3001/materials/mwb_E_202507.pdf
  - http://localhost:3001/materials/mwb_E_202509.pdf
  - http://localhost:3001/materials/mwb_E_202511.pdf
Assim você já enxerga os PDFs enquanto estruturamos a tabela `programas`. Quer que eu implemente esse fallback agora?

```sql
create extension if not exists pgcrypto;

create table if not exists programas (
  id uuid primary key default gen_random_uuid(),
  semana_iso text,
  idioma text,
  status text default 'publicado',
  versao int default 1,
  data_inicio date,
  data_fim date,
  created_at timestamp with time zone default now()
);

create table if not exists congregacoes (
  id uuid primary key default gen_random_uuid(),
  nome text not null,
  idioma text,
  created_at timestamp with time zone default now()
);

insert into programas (semana_iso, idioma, status, versao, data_inicio, data_fim)
values
('2025-W31', 'pt', 'publicado', 1, '2025-07-28', '2025-08-03'),
('2025-W33', 'pt', 'publicado', 1, '2025-08-11', '2025-08-17');
```

---

**User**

use o mcp do supabase para resolver isso 

---

**Cursor**

Vou verificar as tabelas no seu projeto Supabase e, se necessário, criar `programas` e `congregacoes`, depois inserir registros de exemplo para o AdminDashboard listar.

```typescriptreact
import React, { useState, useEffect, useCallback, useMemo, lazy, Suspense } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { supabase } from '../integrations/supabase/client';
import { useJWorgIntegration } from '../hooks/useJWorgIntegration';
import { JWorgTest } from '../components/JWorgTest';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../components/ui/card';
import LazyLoader from '../components/LazyLoader';
import AuthErrorHandler from '../components/AuthErrorHandler';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '../components/ui/tabs';
import { Button } from '../components/ui/button';
import { Badge } from '../components/ui/badge';
import { Separator } from '../components/ui/separator';
import { 
  Download, 
  Upload, 
  Globe, 
  BarChart3, 
  Settings, 
  RefreshCw,
  CheckCircle,
  AlertCircle,
  Clock,
  FileText,
  Users,
  Package,
  Activity,
  Database
} from 'lucide-react';

// 🚀 Lazy loading para componentes pesados (comentado por enquanto)
// const JWorgTestLazy = lazy(() => import('../components/JWorgTest'));

interface SystemStats {
  total_congregations: number;
  active_congregations: number;
  total_users: number;
  total_estudantes: number;
  total_programas: number;
  last_sync: string;
}

export default function AdminDashboard() {
  const { user, profile, isAdmin } = useAuth();
  const jworg = useJWorgIntegration();
  const [activeTab, setActiveTab] = useState('overview');
  const [loading, setLoading] = useState(false);
  const [systemStats, setSystemStats] = useState<SystemStats | null>(null);
  const [lastCheck, setLastCheck] = useState<string>('');
  const [debugInfo, setDebugInfo] = useState<string>('');
  const [showJWorgTest, setShowJWorgTest] = useState(false);
  const [programs, setPrograms] = useState<any[]>([]);
  const [programsLoading, setProgramsLoading] = useState<boolean>(false);

  // 🚀 Memoização de dados estáticos para reduzir re-renders
  const staticStats = useMemo(() => ({
    total_congregations: systemStats?.total_congregations || 0,
    active_congregations: systemStats?.active_congregations || 0,
    total_users: systemStats?.total_users || 0,
    total_estudantes: systemStats?.total_estudantes || 0,
    total_programas: systemStats?.total_programas || 0,
    last_sync: systemStats?.last_sync || ''
  }), [systemStats]);

  // 🚀 Debounced function para reduzir chamadas desnecessárias
  const debouncedSetDebugInfo = useCallback((info: string) => {
    let timeoutId: NodeJS.Timeout;
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => setDebugInfo(info), 100);
  }, []);

  // DEBUG: Log component state (otimizado)
  useEffect(() => {
    const debugData = {
      user: !!user,
      userId: user?.id,
      userEmail: user?.email,
      profile: !!profile,
      profileRole: profile?.role,
      isAdmin,
      loading,
      userMetadata: user?.user_metadata
    };

    console.log('🔍 AdminDashboard Component Debug:', debugData);
    debouncedSetDebugInfo(JSON.stringify(debugData, null, 2));
  }, [user, profile, isAdmin, loading, debouncedSetDebugInfo]);

  useEffect(() => {
    console.log('🔄 AdminDashboard useEffect triggered:', { user, isAdmin });
    
    if (user && isAdmin) {
      console.log('✅ Admin user detected, loading system data...');
      loadSystemData();
    } else if (user && !isAdmin) {
      console.log('❌ User is not admin, role:', profile?.role);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ User is not admin, role: ' + profile?.role);
    } else if (!user) {
      console.log('❌ No user found');
      debouncedSetDebugInfo(debugInfo + '\n\n❌ No user found');
    }
  }, [user, isAdmin, debouncedSetDebugInfo]);

  const loadSystemData = useCallback(async () => {
    if (!user || !isAdmin) {
      console.log('🚫 loadSystemData: User not admin or not logged in');
      return;
    }
    
    console.log('🔄 Loading system data for admin...');
    setLoading(true);
    try {
      // Testar conexão com Supabase
      console.log('🔍 Testing Supabase connection...');
      const { count: profilesCount, error: testError } = await supabase
        .from('profiles')
        .select('*', { count: 'exact', head: true });
      
      if (testError) {
        console.error('❌ Supabase connection test failed:', testError);
        debouncedSetDebugInfo(debugInfo + '\n\n❌ Supabase Test Failed: ' + testError.message);
        return;
      }

        console.log('✅ Supabase connection test successful');
      debouncedSetDebugInfo(debugInfo + '\n\n✅ Supabase Test: Connected');

      // Carregar estatísticas do sistema
      await loadSystemStats();
      // Carregar programações publicadas
      await loadPrograms();

    } catch (error) {
      console.error('❌ Supabase test exception:', error);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ Supabase Test Exception: ' + error);
    } finally {
      setLoading(false);
    }
  }, [user, isAdmin, debouncedSetDebugInfo, debugInfo]);

  const loadSystemStats = useCallback(async () => {
    try {
      console.log('📊 Loading system statistics...');

      const [profilesRes, estudantesRes, programasRes] = await Promise.all([
        supabase.from('profiles').select('*', { count: 'exact', head: true }),
        supabase.from('estudantes').select('*', { count: 'exact', head: true }),
        supabase.from('programas').select('*', { count: 'exact', head: true }),
      ]);

      // congregacoes (opcional - pode não existir neste projeto)
      let congregacoesCount = 0;
      try {
        const { count: congCount, error: congError } = await supabase
          .from('congregacoes')
          .select('*', { count: 'exact', head: true });
        if (!congError && typeof congCount === 'number') {
          congregacoesCount = congCount;
        }
      } catch (_) {}

      const stats: SystemStats = {
        total_congregations: congregacoesCount,
        active_congregations: congregacoesCount,
        total_users: (profilesRes.count as number) || 0,
        total_estudantes: (estudantesRes.count as number) || 0,
        total_programas: (programasRes.count as number) || 0,
        last_sync: new Date().toISOString(),
      };

      setSystemStats(stats);
      setLastCheck(new Date().toISOString());

      console.log('✅ System stats loaded:', stats);
      debouncedSetDebugInfo(debugInfo + '\n\n✅ System Stats Loaded: ' + JSON.stringify(stats, null, 2));

    } catch (error) {
      console.error('❌ Error loading system stats:', error);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ System Stats Error: ' + error);
    }
  }, [debouncedSetDebugInfo, debugInfo, supabase]);

  const loadPrograms = useCallback(async () => {
    try {
      setProgramsLoading(true);
      const { data, error } = await supabase
        .from('programas')
        .select('id, semana, mes_apostila, status, data_inicio_semana, arquivo')
        .order('data_inicio_semana', { ascending: false })
        .limit(12);
      if (error) throw error;
      setPrograms(data || []);
      console.log('✅ Programs loaded:', data?.length || 0);
    } catch (error: any) {
      console.error('❌ Error loading programs:', error);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ Programs Load Error: ' + (error?.message || error));
    } finally {
      setProgramsLoading(false);
    }
  }, [debouncedSetDebugInfo, debugInfo]);

  const checkForUpdates = useCallback(async () => {
    console.log('🔄 Checking for updates...');
    setLoading(true);
    
    try {
      await loadSystemStats();
      await loadPrograms();
      console.log('✅ Updates checked successfully');
    } catch (error) {
      console.error('❌ Error checking updates:', error);
    } finally {
      setLoading(false);
    }
  }, [loadSystemStats]);

  const testSupabaseConnection = useCallback(async () => {
    console.log('🔧 Testing Supabase connection...');
    
    try {
      const { count, error } = await supabase
        .from('profiles')
        .select('*', { count: 'exact', head: true });

      if (error) {
        console.error('❌ Supabase test error:', error);
        alert('Supabase test error: ' + error.message);
      } else {
        console.log('✅ Supabase test successful. Profiles count:', count);
        alert('Supabase test successful! Total profiles: ' + (count ?? 0));
      }
    } catch (error) {
      console.error('❌ Supabase test exception:', error);
      alert('Supabase test exception: ' + error);
    }
  }, []);

  // ========== HANDLERS DOS BOTÕES ==========
  
  const handleListUsers = useCallback(async () => {
    console.log('👥 Listando usuários...');
    try {
      const { data: users, error } = await supabase
        .from('profiles')
        .select('id, nome_completo, role, congregacao, cargo')
        .order('nome_completo');
      
      if (error) throw error;
      
      console.log('✅ Usuários carregados:', users);
      alert(`Encontrados ${users?.length || 0} usuários no sistema:\n\n${users?.map(u => `${u.nome_completo || u.id} - ${u.role} (${u.congregacao || 'N/A'})`).join('\n')}`);
    } catch (error) {
      console.error('❌ Erro ao listar usuários:', error);
      alert('Erro ao carregar usuários: ' + error.message);
    }
  }, []);

  const handleManagePermissions = useCallback(async () => {
    console.log('⚙️ Gerenciando permissões...');
    const newRole = prompt('Digite o novo role (admin, instrutor, estudante):');
    if (!newRole) return;
    
    // Validar role
    const validRoles = ['admin', 'instrutor', 'estudante', 'family_member', 'developer'];
    if (!validRoles.includes(newRole)) {
      alert('Role inválido. Use: admin, instrutor, estudante, family_member ou developer');
      return;
    }
    
    const userId = prompt('Digite o ID do usuário:');
    if (!userId) return;
    
    try {
      const { error } = await supabase
        .from('profiles')
        .update({ role: newRole as any })
        .eq('id', userId);
      
      if (error) throw error;
      
      console.log('✅ Permissão atualizada');
      alert('Permissão atualizada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao atualizar permissão:', error);
      alert('Erro ao atualizar permissão: ' + error.message);
    }
  }, []);

  const handleActivityReport = useCallback(async () => {
    console.log('📊 Gerando relatório de atividades...');
    try {
      // Simulação de relatório
      const report = {
        totalUsers: staticStats.total_users,
        totalCongregations: staticStats.total_congregations,
        lastUpdate: new Date().toLocaleString('pt-BR'),
        activeUsers: Math.floor(staticStats.total_users * 0.8)
      };
      
      alert(`📊 Relatório de Atividades:\n\n` +
            `• Total de usuários: ${report.totalUsers}\n` +
            `• Usuários ativos: ${report.activeUsers}\n` +
            `• Total de congregações: ${report.totalCongregations}\n` +
            `• Última atualização: ${report.lastUpdate}`);
    } catch (error) {
      console.error('❌ Erro ao gerar relatório:', error);
      alert('Erro ao gerar relatório: ' + error.message);
    }
  }, [staticStats]);

  const handleBackupData = useCallback(async () => {
    console.log('💾 Fazendo backup dos dados...');
    try {
      const { data: profiles, error: profilesError } = await supabase
        .from('profiles')
        .select('*');
      
      if (profilesError) throw profilesError;
      
      // Simular backup
      const backupData = {
        timestamp: new Date().toISOString(),
        profiles: profiles,
        stats: staticStats
      };
      
      const dataStr = JSON.stringify(backupData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `backup_sistema_ministerial_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      URL.revokeObjectURL(url);
      console.log('✅ Backup criado com sucesso');
      alert('Backup criado e baixado com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao fazer backup:', error);
      alert('Erro ao fazer backup: ' + error.message);
    }
  }, [staticStats]);

  // Congregações
  const handleManageCongregation = useCallback((congregationName: string) => {
    console.log('🏢 Gerenciando congregação:', congregationName);
    alert(`🏢 Gerenciando congregação: ${congregationName}\n\nEsta funcionalidade abrirá o painel de gerenciamento da congregação.`);
  }, []);

  const handleAddCongregation = useCallback(async () => {
    console.log('➕ Adicionando nova congregação...');
    const congregationName = prompt('Digite o nome da nova congregação:');
    if (!congregationName) return;
    
    try {
      // Simulação - em produção seria inserção no Supabase
      console.log('✅ Congregação adicionada:', congregationName);
      alert(`✅ Congregação "${congregationName}" adicionada com sucesso!\n\nEla agora receberá automaticamente a programação oficial.`);
    } catch (error) {
      console.error('❌ Erro ao adicionar congregação:', error);
      alert('Erro ao adicionar congregação: ' + error.message);
    }
  }, []);

  // JW.org & S-38
  const handleMWBAvailable = useCallback(async () => {
    console.log('📚 Disponibilizando MWB atual...');
    try {
      await jworg.fetchCurrentWeek();
      console.log('✅ MWB atualizada');
      alert('✅ Apostila MWB atual disponibilizada para todas as congregações!');
    } catch (error) {
      console.error('❌ Erro ao disponibilizar MWB:', error);
      alert('Erro ao disponibilizar MWB: ' + error.message);
    }
  }, [jworg]);

  const handleConfigureJWorgURLs = useCallback(() => {
    console.log('⚙️ Configurando URLs JW.org...');
    const ptUrl = prompt('URL JW.org PT:', 'https://www.jw.org/pt/biblioteca/jw-apostila-do-mes/');
    const enUrl = prompt('URL JW.org EN:', 'https://www.jw.org/en/library/jw-meeting-workbook/');
    
    if (ptUrl && enUrl) {
      console.log('✅ URLs configuradas:', { ptUrl, enUrl });
      alert('✅ URLs JW.org configuradas com sucesso!');
    }
  }, []);

  const handleSyncCongregations = useCallback(async () => {
    console.log('🔄 Sincronizando com congregações...');
    try {
      // Simulação de sincronização
      const congregationsCount = staticStats.total_congregations;
      console.log(`✅ Sincronizando com ${congregationsCount} congregações`);
      alert(`🔄 Sincronização iniciada!\n\nProgramação oficial sendo enviada para ${congregationsCount} congregações...\n\nTempo estimado: ${Math.ceil(congregationsCount / 100)} minutos`);
    } catch (error) {
      console.error('❌ Erro na sincronização:', error);
      alert('Erro na sincronização: ' + error.message);
    }
  }, [staticStats]);

  // Programação Oficial
  const handleViewFullProgram = useCallback(() => {
    console.log('📅 Visualizando programação completa (3 meses)...');
    alert(`📅 Programação Completa dos Próximos 3 Meses\n\n` +
          `• Semanas carregadas: 12\n` +
          `• Idiomas: PT e EN\n` +
          `• Última atualização: Hoje\n\n` +
          `Esta visualização mostrará todas as apostilas MWB dos próximos 3 meses.`);
  }, []);

  const handleUpdateProgramPT = useCallback(async () => {
    console.log('🇧🇷 Atualizando programação PT...');
    try {
      jworg.setLanguage('pt');
      await jworg.fetchNextWeeks();
      console.log('✅ Programação PT atualizada');
      alert('✅ Programação em Português atualizada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao atualizar programação PT:', error);
      alert('Erro ao atualizar programação PT: ' + error.message);
    }
  }, [jworg]);

  const handleUpdateProgramEN = useCallback(async () => {
    console.log('🇺🇸 Atualizando programação EN...');
    try {
      jworg.setLanguage('en');
      await jworg.fetchNextWeeks();
      console.log('✅ Programação EN atualizada');
      alert('✅ Programação em Inglês atualizada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao atualizar programação EN:', error);
      alert('Erro ao atualizar programação EN: ' + error.message);
    }
  }, [jworg]);

  const handleCheckNewWeeks = useCallback(async () => {
    console.log('🔍 Verificando novas semanas...');
    try {
      await jworg.fetchNextWeeks();
      const newWeeks = jworg.nextWeeks.length;
      console.log(`✅ Verificação concluída: ${newWeeks} semanas`);
      alert(`🔍 Verificação concluída!\n\nEncontradas ${newWeeks} semanas de programação.\n\nTodas estão sincronizadas com JW.org.`);
    } catch (error) {
      console.error('❌ Erro ao verificar semanas:', error);
      alert('Erro ao verificar novas semanas: ' + error.message);
    }
  }, [jworg]);

  const handleUpdateS38Structure = useCallback(() => {
    console.log('🏗️ Atualizando estrutura S-38 global...');
    alert(`🏗️ Estrutura S-38 Global\n\n` +
          `✅ Partes da reunião atualizadas:\n` +
          `• Chairman\n• Treasures\n• Gems\n• Reading\n` +
          `• Starting\n• Following\n• Making\n• Explaining\n` +
          `• Talk\n\n` +
          `Esta estrutura será aplicada mundialmente.`);
  }, []);

  // JW.org Integration
  const handleReloadCurrentWeek = useCallback(async () => {
    console.log('🔄 Recarregando semana atual...');
    try {
      await jworg.fetchCurrentWeek();
      console.log('✅ Semana atual recarregada');
      alert('✅ Semana atual recarregada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao recarregar semana:', error);
      alert('Erro ao recarregar semana: ' + error.message);
    }
  }, [jworg]);

  const handleReloadNextWeeks = useCallback(async () => {
    console.log('📅 Recarregando próximas semanas...');
    try {
      await jworg.fetchNextWeeks();
      console.log('✅ Próximas semanas recarregadas');
      alert('✅ Próximas semanas recarregadas com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao recarregar próximas semanas:', error);
      alert('Erro ao recarregar próximas semanas: ' + error.message);
    }
  }, [jworg]);

  const handleTestDownloadPT = useCallback(async () => {
    console.log('🧪 Testando download PT...');
    try {
      jworg.setLanguage('pt');
      await jworg.downloadWorkbook('pt', '07', '2025');
      console.log('✅ Download PT testado');
      alert('✅ Download PT testado com sucesso!');
    } catch (error) {
      console.error('❌ Erro no teste de download PT:', error);
      alert('Erro no teste de download PT: ' + error.message);
    }
  }, [jworg]);

  // Monitoramento
  const handleViewAllLogs = useCallback(async () => {
    console.log('📋 Visualizando todos os logs...');
    try {
      // Simulação de logs
      const logs = [
        { timestamp: new Date().toLocaleString(), event: 'Sistema iniciado', level: 'info' },
        { timestamp: new Date(Date.now() - 3600000).toLocaleString(), event: 'Backup automático executado', level: 'info' },
        { timestamp: new Date(Date.now() - 86400000).toLocaleString(), event: 'Novo usuário registrado', level: 'info' },
        { timestamp: new Date(Date.now() - 172800000).toLocaleString(), event: 'Manutenção programada', level: 'warning' }
      ];
      
      const logText = logs.map(log => `${log.timestamp} [${log.level.toUpperCase()}] ${log.event}`).join('\n');
      alert(`📋 Logs do Sistema\n\n${logText}`);
    } catch (error) {
      console.error('❌ Erro ao carregar logs:', error);
      alert('Erro ao carregar logs: ' + error.message);
    }
  }, []);

  const handleTestJWorgIntegration = useCallback(async () => {
    console.log('🧪 Testando integração JW.org...');
    try {
      await jworg.fetchCurrentWeek();
      console.log('✅ Integração JW.org testada com sucesso');
      alert('✅ Integração JW.org funcionando perfeitamente!');
    } catch (error) {
      console.error('❌ Erro na integração JW.org:', error);
      alert('❌ Erro na integração JW.org: ' + error.message);
    }
  }, [jworg]);

  const handleChangeLanguage = useCallback((newLang: 'pt' | 'en') => {
    jworg.setLanguage(newLang);
    console.log(`🌐 Idioma alterado para: ${newLang}`);
    alert(`🌐 Idioma alterado para: ${newLang === 'pt' ? 'Português' : 'English'}`);
  }, [jworg]);

  // Alterna o idioma atual entre PT/EN
  const toggleLanguage = useCallback(() => {
    const current = (jworg as any)?.currentLanguage ?? 'pt';
    const next = current === 'pt' ? 'en' : 'pt';
    jworg.setLanguage(next);
    console.log(`🌐 Idioma alternado: ${current} -> ${next}`);
    alert(`🌐 Idioma alternado para: ${next === 'pt' ? 'Português' : 'English'}`);
  }, [jworg]);

  // Atualiza materiais JW.org (semana atual + próximas semanas)
  const updateMaterials = useCallback(async () => {
    try {
      await jworg.fetchCurrentWeek();
      await jworg.fetchNextWeeks();
      console.log('✅ Materiais JW.org atualizados');
      alert('✅ Materiais JW.org atualizados com sucesso!');
    } catch (error: any) {
      console.error('❌ Erro ao atualizar materiais:', error);
      alert('❌ Erro ao atualizar materiais: ' + (error?.message || error));
    }
  }, [jworg]);

  // NOW CHECK CONDITIONS AND RENDER APPROPRIATELY
  // Se não for admin, mostrar mensagem de acesso negado
  if (user && !isAdmin) {
    return (
      <div className="container mx-auto px-4 py-8">
        <Card className="max-w-md mx-auto">
          <CardHeader>
            <CardTitle className="text-red-600">Acesso Negado</CardTitle>
            <CardDescription>
              Você não tem permissão para acessar o painel administrativo.
            </CardDescription>
          </CardHeader>
          <CardContent>
            <p className="text-sm text-muted-foreground mb-4">
              Seu perfil atual: <strong>{profile?.role}</strong>
            </p>
            <Button onClick={() => window.history.back()}>
              Voltar
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Se não houver usuário, mostrar loading
  if (!user) {
    return (
      <div className="container mx-auto px-4 py-8">
        <Card className="max-w-md mx-auto">
          <CardHeader>
            <CardTitle>Carregando...</CardTitle>
            <CardDescription>
              Verificando autenticação...
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="flex items-center justify-center">
              <RefreshCw className="h-6 w-6 animate-spin" />
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background">
      {/* Auth Error Handler */}
      <AuthErrorHandler />
      
      {/* Header */}
      <div className="border-b">
        <div className="container mx-auto px-4 py-6">
          <div className="flex flex-col space-y-4">
          <div className="flex items-center justify-between">
            <div>
                <h1 className="text-3xl font-bold tracking-tight">📊 Dashboard do Administrador Geral</h1>
                <p className="text-muted-foreground">
                  Programação oficial das reuniões ministeriais - Padronização mundial para todas as congregações
              </p>
            </div>
              <div className="flex items-center space-x-2">
              {/* Force Profile Load Button */}
              {import.meta.env.DEV && (
                <Button 
                  variant="outline" 
                  size="sm"
                    onClick={testSupabaseConnection}
                  >
                    🔧 Test Supabase
                </Button>
              )}
              
              <Button onClick={checkForUpdates} disabled={loading}>
                <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
                  Atualizar
              </Button>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Debug Info Panel */}
      {import.meta.env.DEV && (
        <div className="container mx-auto px-4 py-2">
          <Card className="bg-yellow-50 border-yellow-200">
            <CardHeader className="pb-2">
              <CardTitle className="text-sm text-yellow-800">🐛 Debug Info (Development Only)</CardTitle>
            </CardHeader>
            <CardContent>
              <pre className="text-xs text-yellow-700 overflow-auto max-h-40">
                {debugInfo}
              </pre>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Main Content */}
      <div className="container mx-auto px-4 py-6">
        <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-6">
          <TabsList className="grid w-full grid-cols-4">
            <TabsTrigger value="overview">Visão Geral</TabsTrigger>
            <TabsTrigger value="users">Usuários</TabsTrigger>
            <TabsTrigger value="congregations">Congregações</TabsTrigger>
            <TabsTrigger value="system">Sistema</TabsTrigger>
          </TabsList>

          {/* Visão Geral */}
          <TabsContent value="overview" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                🎯 Sistema Ministerial Global - Padronização Mundial
              </h3>
              <div className="text-center text-sm text-muted-foreground mt-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
                <strong>📊 Admin Geral:</strong> Disponibiliza programação oficial semanal (SEM nomes de estudantes) <br/>
                <strong>🎓 Instrutores:</strong> Recebem programação automaticamente + fazem designações locais reais
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Congregações Conectadas</CardTitle>
                  <Globe className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">{staticStats.total_congregations}</div>
                  <p className="text-xs text-muted-foreground">
                    Recebendo programação oficial
                  </p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Semanas Programadas</CardTitle>
                  <BarChart3 className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">12</div>
                  <p className="text-xs text-muted-foreground">
                    Próximas 3 meses
                  </p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Idiomas Disponíveis</CardTitle>
                  <Globe className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">2</div>
                  <p className="text-xs text-muted-foreground">
                    Português e Inglês
                  </p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Última Sincronização</CardTitle>
                  <RefreshCw className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">✅</div>
                  <p className="text-xs text-muted-foreground">
                    Hoje, {new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                  </p>
                </CardContent>
              </Card>
            </div>

            {/* Ações Rápidas */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Status do Sistema */}
              <Card>
                <CardHeader>
                  <CardTitle>Status do Sistema</CardTitle>
                  <CardDescription>
                    Informações sobre a última verificação e status geral
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Última Verificação:</span>
                    <span className="text-sm text-muted-foreground">
                      {lastCheck ? new Date(lastCheck).toLocaleString('pt-BR') : 'Nunca'}
                    </span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Status:</span>
                    <Badge variant="outline" className="text-green-600">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Operacional
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Supabase:</span>
                    <Badge variant="outline" className="text-green-600">
                      <Database className="h-3 w-3 mr-1" />
                      Conectado
                    </Badge>
                  </div>
                </CardContent>
              </Card>

              {/* Programações Publicadas */}
              <Card>
                <CardHeader>
                  <CardTitle>Programações Publicadas</CardTitle>
                  <CardDescription>
                    Últimas semanas importadas/publicadas
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  {programsLoading ? (
                    <div className="text-sm text-muted-foreground">Carregando...</div>
                  ) : programs.length === 0 ? (
                    <div className="text-sm text-muted-foreground">Nenhuma programação encontrada.</div>
                  ) : (
                    <div className="space-y-2">
                      {programs.map((p) => (
                        <div key={p.id} className="flex items-center justify-between p-2 border rounded-md">
                          <div className="text-sm">
                            <div className="font-medium">Semana {p.semana_iso} • {p.idioma?.toUpperCase?.() || '—'}</div>
                            <div className="text-xs text-muted-foreground">
                              {p.data_inicio ? new Date(p.data_inicio).toLocaleDateString('pt-BR') : '—'}
                              {p.data_fim ? ` — ${new Date(p.data_fim).toLocaleDateString('pt-BR')}` : ''}
                            </div>
                          </div>
                          <Badge variant="outline" className={p.status === 'publicado' ? 'bg-green-50 text-green-700' : ''}>
                            v{p.versao || 1} • {p.status || 'rascunho'}
                          </Badge>
                        </div>
                      ))}
                    </div>
                  )}
                </CardContent>
              </Card>

              {/* JW.org Downloads */}
              <Card className="bg-green-50 border-green-200">
                <CardHeader>
                  <CardTitle className="text-green-800">📚 JW.org Downloads</CardTitle>
                  <CardDescription className="text-green-700">
                    Gerenciar materiais oficiais
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Apostila MWB Atual:</span>
                    <Badge variant="outline" className="text-green-600">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Disponível
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Última verificação:</span>
                    <span className="text-sm text-green-700">Hoje, 10:30</span>
                  </div>
                  <div className="flex space-x-2">
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleMWBAvailable}>
                      <RefreshCw className="h-3 w-3 mr-1" />
                      Disponibilizar MWB Atual
                    </Button>
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleConfigureJWorgURLs}>
                      <Settings className="h-3 w-3 mr-1" />
                      Configurar URLs JW.org
                    </Button>
                  </div>
                </CardContent>
              </Card>

              {/* Sistema S-38 - Designações */}
              <Card className="bg-purple-50 border-purple-200">
                <CardHeader>
                  <CardTitle className="text-purple-800">⚙️ Sistema S-38</CardTitle>
                  <CardDescription className="text-purple-700">
                    Estrutura das reuniões ministeriais
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="text-sm text-purple-700 space-y-2">
                    <p>📚 <strong>Função do Admin:</strong> Disponibilizar apostilas MWB</p>
                    <p>👥 <strong>Para Instrutores:</strong> Designar estudantes para partes</p>
                    <p>🎯 <strong>Partes da Reunião:</strong></p>
                    <div className="grid grid-cols-2 gap-1 text-xs ml-2">
                      <div>• Chairman</div>
                      <div>• Treasures</div>
                      <div>• Gems</div>
                      <div>• Reading</div>
                      <div>• Starting</div>
                      <div>• Following</div>
                      <div>• Making</div>
                      <div>• Explaining</div>
                      <div>• Talk</div>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Debug / Integração */}
              <Card className="bg-slate-50 border-slate-200">
                <CardHeader>
                  <CardTitle className="text-slate-800">🧪 Debug / Integração</CardTitle>
                  <CardDescription className="text-slate-700">
                    Ferramentas rápidas para validar integrações e idioma
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-3">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Idioma Atual:</span>
                    <Badge variant="outline" className="text-slate-700">
                      {(jworg as any)?.currentLanguage === 'en' ? '🇺🇸 English' : '🇧🇷 Português'}
                    </Badge>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    <Button size="sm" variant="outline" onClick={toggleLanguage}>
                      Alternar Idioma
                    </Button>
                    <Button size="sm" variant="outline" onClick={updateMaterials}>
                      Atualizar Materiais
                    </Button>
                    <Button size="sm" variant="outline" onClick={handleTestJWorgIntegration}>
                      Testar Integração JW.org
                    </Button>
                    <Button size="sm" variant="outline" onClick={checkForUpdates} disabled={loading}>
                      Atualizar Contagens
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          {/* Usuários */}
          <TabsContent value="users" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                👥 Gestão de Usuários para Acesso às Apostilas MWB
              </h3>
              <p className="text-center text-sm text-muted-foreground mt-2">
                🎯 Função Principal: Admin gerencia usuários → Instrutores acessam apostilas
              </p>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Estatísticas de Usuários */}
            <Card>
              <CardHeader>
                  <CardTitle>Estatísticas</CardTitle>
                  <CardDescription>Resumo dos usuários</CardDescription>
              </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Total de Usuários:</span>
                      <Badge variant="outline">{staticStats.total_users}</Badge>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Admins:</span>
                      <Badge variant="outline" className="bg-red-50 text-red-700">
                        {isAdmin ? 1 : 0}
                      </Badge>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Instrutores:</span>
                      <Badge variant="outline" className="bg-blue-50 text-blue-700">
                        {staticStats.total_users - (isAdmin ? 1 : 0)}
                      </Badge>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Usuários Registrados */}
              <Card className="lg:col-span-2">
                <CardHeader>
                  <CardTitle>Usuários Registrados</CardTitle>
                  <CardDescription>Últimos usuários cadastrados no sistema</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between p-3 border rounded-lg">
                      <div className="flex items-center space-x-3">
                        <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                          <Users className="h-5 w-5 text-blue-600" />
                        </div>
                        <div>
                          <p className="font-medium">{profile?.nome_completo || 'Roberto Araujo da Silva'}</p>
                          <p className="text-sm text-muted-foreground">Administrator</p>
                        </div>
                      </div>
                      <Badge variant="outline" className="bg-red-50 text-red-700">
                        Admin
                      </Badge>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Ações Administrativas */}
            <Card>
              <CardHeader>
                <CardTitle>Ações Administrativas</CardTitle>
                <CardDescription>
                  Gerenciar usuários e permissões
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <Button className="w-full justify-start" variant="outline" onClick={handleListUsers}>
                    <Users className="h-4 w-4 mr-2" />
                    Listar Todos os Usuários
                  </Button>
                  <Button className="w-full justify-start" variant="outline" onClick={handleManagePermissions}>
                    <Settings className="h-4 w-4 mr-2" />
                    Gerenciar Permissões
                  </Button>
                  <Button className="w-full justify-start" variant="outline" onClick={handleActivityReport}>
                    <Activity className="h-4 w-4 mr-2" />
                    Relatório de Atividades
                  </Button>
                  <Button className="w-full justify-start" variant="outline" onClick={handleBackupData}>
                    <Database className="h-4 w-4 mr-2" />
                    Backup de Dados
                  </Button>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Congregações */}
          <TabsContent value="congregations" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                🏢 Gestão de Congregações para Acesso às Apostilas MWB
              </h3>
              <p className="text-center text-sm text-muted-foreground mt-2">
                🎯 Função Principal: Admin gerencia congregações → Instrutores acessam apostilas
              </p>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Estatísticas de Congregações */}
            <Card>
              <CardHeader>
                  <CardTitle>Estatísticas</CardTitle>
                  <CardDescription>Resumo das congregações</CardDescription>
              </CardHeader>
              <CardContent>
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Total de Congregações:</span>
                      <Badge variant="outline">{staticStats.total_congregations}</Badge>
                  </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Congregações Ativas:</span>
                      <Badge variant="outline" className="bg-green-50 text-green-700">
                        {staticStats.active_congregations}
                      </Badge>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Total de Estudantes:</span>
                      <Badge variant="outline">{staticStats.total_estudantes}</Badge>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Lista de Congregações */}
              <Card className="lg:col-span-2">
                <CardHeader>
                  <CardTitle>Congregações Registradas</CardTitle>
                  <CardDescription>Lista das congregações no sistema</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between p-3 border rounded-lg">
                      <div className="flex items-center space-x-3">
                        <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                          <Package className="h-5 w-5 text-blue-600" />
                        </div>
                        <div>
                          <p className="font-medium">Sistema Ministerial Global</p>
                          <p className="text-sm text-muted-foreground">Congregação Principal</p>
                          </div>
                        </div>
                      <Badge variant="outline" className="bg-green-50 text-green-700">
                        Ativa
                        </Badge>
                      </div>
                  </div>
                  
                  <div className="mt-4">
                    <Button variant="outline" className="w-full" onClick={() => handleManageCongregation('Sistema Ministerial Global')}>
                      <Users className="h-4 w-4 mr-2" />
                      Gerenciar
                    </Button>
                  </div>
                  
                  <div className="mt-4">
                    <Button variant="outline" className="w-full" onClick={handleAddCongregation}>
                      <Users className="h-4 w-4 mr-2" />
                      Adicionar Nova Congregação
                    </Button>
                  </div>
                  
                  <div className="mt-4">
                    <Button variant="outline" className="w-full">
                      <Users className="h-4 w-4 mr-2" />
                      Expandir
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          {/* Sistema */}
          <TabsContent value="system" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                ⚙️ Monitoramento e Configurações do Sistema
              </h3>
              <p className="text-center text-sm text-muted-foreground mt-2">
                🎯 Função Principal: Admin monitora sistema → Instrutores recebem apostilas estáveis
              </p>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Downloads JW.org */}
              <Card className="bg-green-50 border-green-200">
              <CardHeader>
                  <CardTitle className="text-green-800">📚 JW.org Downloads</CardTitle>
                  <CardDescription className="text-green-700">
                    Gerenciar materiais oficiais
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Apostila MWB Atual:</span>
                    <Badge variant="outline" className="text-green-600">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Disponível
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Última verificação:</span>
                    <span className="text-sm text-green-700">Hoje, 10:30</span>
                  </div>
                  <div className="flex space-x-2">
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleSyncCongregations}>
                      <RefreshCw className="h-3 w-3 mr-1" />
                      Sincronizar com Congregações
                    </Button>
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleViewFullProgram}>
                      <Settings className="h-3 w-3 mr-1" />
                      Ver Programação Completa
                    </Button>
                </div>
              </CardContent>
            </Card>

              {/* Configurações Gerais */}
            <Card>
              <CardHeader>
                  <CardTitle>Configurações Gerais</CardTitle>
                <CardDescription>
                    Parâmetros do sistema
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                    <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Backup Automático:</span>
                    <Badge variant="outline" className="bg-green-50 text-green-700">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Diário às 02:00
                      </Badge>
                    </div>
                    <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Notificações:</span>
                    <Badge variant="outline" className="bg-blue-50 text-blue-700">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Email + Sistema
                    </Badge>
                    </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Manutenção:</span>
                    <span className="text-sm text-muted-foreground">Última: Ontem</span>
                  </div>
                  <div className="flex space-x-2">
                    <Button size="sm" variant="outline">
                      <Settings className="h-3 w-3 mr-1" />
                      Configurar
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Métricas do Sistema */}
            <Card>
              <CardHeader>
                <CardTitle>Métricas do Sistema</CardTitle>
                <CardDescription>
                  Monitoramento em tempo real
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-green-600">99.9%</p>
                    <p className="text-sm text-muted-foreground">Uptime</p>
                  </div>
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-blue-600">~120ms</p>
                    <p className="text-sm text-muted-foreground">Latência</p>
                  </div>
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-green-600">25%</p>
                    <p className="text-sm text-muted-foreground">CPU</p>
                  </div>
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-blue-600">33%</p>
                    <p className="text-sm text-muted-foreground">Memória</p>
                  </div>
                </div>

                <Separator />

                <div className="space-y-3">
                    <div className="flex items-center justify-between">
                    <span className="text-sm">CPU:</span>
                    <div className="flex items-center space-x-2">
                      <div className="w-24 h-2 bg-gray-200 rounded-full">
                        <div className="w-1/4 h-2 bg-green-500 rounded-full"></div>
                    </div>
                        <span className="text-sm">25%</span>
                  </div>
                    </div>
                    
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Memória:</span>
                      <div className="flex items-center space-x-2">
                        <div className="w-24 h-2 bg-gray-200 rounded-full">
                          <div className="w-1/3 h-2 bg-blue-500 rounded-full"></div>
                    </div>
                        <span className="text-sm">33%</span>
                      </div>
                    </div>
                    
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Banco:</span>
                      <div className="flex items-center space-x-2">
                        <CheckCircle className="h-4 w-4 text-green-500" />
                        <span className="text-sm">Conectado</span>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

              {/* Logs e Atividades */}
              <Card>
                <CardHeader>
                  <CardTitle>Logs Recentes</CardTitle>
                  <CardDescription>
                    Últimas atividades do sistema
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <CheckCircle className="h-4 w-4 text-green-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Sistema iniciado</p>
                        <p className="text-xs text-muted-foreground">Hoje, 08:00</p>
                      </div>
                    </div>

                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <Activity className="h-4 w-4 text-blue-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Backup automático executado</p>
                        <p className="text-xs text-muted-foreground">Hoje, 02:00</p>
                      </div>
                    </div>

                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <Users className="h-4 w-4 text-green-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Novo usuário registrado</p>
                        <p className="text-xs text-muted-foreground">Ontem, 16:30</p>
                      </div>
                    </div>

                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <AlertCircle className="h-4 w-4 text-yellow-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Manutenção programada</p>
                        <p className="text-xs text-muted-foreground">Ontem, 03:00</p>
                      </div>
                    </div>
                  </div>

                  <div className="mt-4">
                    <Button variant="outline" className="w-full" onClick={handleViewAllLogs}>
                      <FileText className="h-4 w-4 mr-2" />
                      Ver Todos os Logs
                    </Button>
                  </div>
                </CardContent>
              </Card>
          </TabsContent>
        </Tabs>
      </div>
    </div>
  );
}

```

Usei o MCP do Supabase para inspecionar seu schema. Ajustes feitos:

- Seu `programas` já existe, mas com colunas diferentes das que eu consultei no front. Atualizei o `AdminDashboard` para buscar: `id, semana, mes_apostila, status, data_inicio_semana, arquivo` e ordenação por `data_inicio_semana`. Também tratei a ausência de `congregacoes`.

Próximo passo para ver algo no Admin:
- Insira pelo menos 1 registro em `public.programas` com essas colunas. Exemplo (rode no Supabase SQL editor):
```sql
insert into public.programas (semana, mes_apostila, status, data_inicio_semana, arquivo)
values ('2025-W31','2025-08','ativo','2025-07-28','mwb_E_202507.pdf');
```

Sobre os PDFs:
- Eles são servidos em `http://localhost:3001/materials/<arquivo>`. Para relacionar com a UI, use a coluna `arquivo` com o nome do PDF existente (ex.: `mwb_E_202509.pdf`). Posso mostrar um link direto no card “Programações Publicadas”. Quer que eu adicione o link agora?

```sql
insert into public.programas (semana, mes_apostila, status, data_inicio_semana, arquivo)
values ('2025-W31','2025-08','ativo','2025-07-28','mwb_E_202507.pdf');
```

---

**User**

sim

---

**Cursor**

```typescriptreact
import React, { useState, useEffect, useCallback, useMemo, lazy, Suspense } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { supabase } from '../integrations/supabase/client';
import { useJWorgIntegration } from '../hooks/useJWorgIntegration';
import { JWorgTest } from '../components/JWorgTest';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../components/ui/card';
import LazyLoader from '../components/LazyLoader';
import AuthErrorHandler from '../components/AuthErrorHandler';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '../components/ui/tabs';
import { Button } from '../components/ui/button';
import { Badge } from '../components/ui/badge';
import { Separator } from '../components/ui/separator';
import { 
  Download, 
  Upload, 
  Globe, 
  BarChart3, 
  Settings, 
  RefreshCw,
  CheckCircle,
  AlertCircle,
  Clock,
  FileText,
  Users,
  Package,
  Activity,
  Database
} from 'lucide-react';

// 🚀 Lazy loading para componentes pesados (comentado por enquanto)
// const JWorgTestLazy = lazy(() => import('../components/JWorgTest'));

interface SystemStats {
  total_congregations: number;
  active_congregations: number;
  total_users: number;
  total_estudantes: number;
  total_programas: number;
  last_sync: string;
}

export default function AdminDashboard() {
  const { user, profile, isAdmin } = useAuth();
  const jworg = useJWorgIntegration();
  const [activeTab, setActiveTab] = useState('overview');
  const [loading, setLoading] = useState(false);
  const [systemStats, setSystemStats] = useState<SystemStats | null>(null);
  const [lastCheck, setLastCheck] = useState<string>('');
  const [debugInfo, setDebugInfo] = useState<string>('');
  const [showJWorgTest, setShowJWorgTest] = useState(false);
  const [programs, setPrograms] = useState<any[]>([]);
  const [programsLoading, setProgramsLoading] = useState<boolean>(false);

  // 🚀 Memoização de dados estáticos para reduzir re-renders
  const staticStats = useMemo(() => ({
    total_congregations: systemStats?.total_congregations || 0,
    active_congregations: systemStats?.active_congregations || 0,
    total_users: systemStats?.total_users || 0,
    total_estudantes: systemStats?.total_estudantes || 0,
    total_programas: systemStats?.total_programas || 0,
    last_sync: systemStats?.last_sync || ''
  }), [systemStats]);

  // 🚀 Debounced function para reduzir chamadas desnecessárias
  const debouncedSetDebugInfo = useCallback((info: string) => {
    let timeoutId: NodeJS.Timeout;
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => setDebugInfo(info), 100);
  }, []);

  // DEBUG: Log component state (otimizado)
  useEffect(() => {
    const debugData = {
      user: !!user,
      userId: user?.id,
      userEmail: user?.email,
      profile: !!profile,
      profileRole: profile?.role,
      isAdmin,
      loading,
      userMetadata: user?.user_metadata
    };

    console.log('🔍 AdminDashboard Component Debug:', debugData);
    debouncedSetDebugInfo(JSON.stringify(debugData, null, 2));
  }, [user, profile, isAdmin, loading, debouncedSetDebugInfo]);

  useEffect(() => {
    console.log('🔄 AdminDashboard useEffect triggered:', { user, isAdmin });
    
    if (user && isAdmin) {
      console.log('✅ Admin user detected, loading system data...');
      loadSystemData();
    } else if (user && !isAdmin) {
      console.log('❌ User is not admin, role:', profile?.role);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ User is not admin, role: ' + profile?.role);
    } else if (!user) {
      console.log('❌ No user found');
      debouncedSetDebugInfo(debugInfo + '\n\n❌ No user found');
    }
  }, [user, isAdmin, debouncedSetDebugInfo]);

  const loadSystemData = useCallback(async () => {
    if (!user || !isAdmin) {
      console.log('🚫 loadSystemData: User not admin or not logged in');
      return;
    }
    
    console.log('🔄 Loading system data for admin...');
    setLoading(true);
    try {
      // Testar conexão com Supabase
      console.log('🔍 Testing Supabase connection...');
      const { count: profilesCount, error: testError } = await supabase
        .from('profiles')
        .select('*', { count: 'exact', head: true });
      
      if (testError) {
        console.error('❌ Supabase connection test failed:', testError);
        debouncedSetDebugInfo(debugInfo + '\n\n❌ Supabase Test Failed: ' + testError.message);
        return;
      }

        console.log('✅ Supabase connection test successful');
      debouncedSetDebugInfo(debugInfo + '\n\n✅ Supabase Test: Connected');

      // Carregar estatísticas do sistema
      await loadSystemStats();
      // Carregar programações publicadas
      await loadPrograms();

    } catch (error) {
      console.error('❌ Supabase test exception:', error);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ Supabase Test Exception: ' + error);
    } finally {
      setLoading(false);
    }
  }, [user, isAdmin, debouncedSetDebugInfo, debugInfo]);

  const loadSystemStats = useCallback(async () => {
    try {
      console.log('📊 Loading system statistics...');

      const [profilesRes, estudantesRes, programasRes] = await Promise.all([
        supabase.from('profiles').select('*', { count: 'exact', head: true }),
        supabase.from('estudantes').select('*', { count: 'exact', head: true }),
        supabase.from('programas').select('*', { count: 'exact', head: true }),
      ]);

      // congregacoes (opcional - pode não existir neste projeto)
      let congregacoesCount = 0;
      try {
        const { count: congCount, error: congError } = await supabase
          .from('congregacoes')
          .select('*', { count: 'exact', head: true });
        if (!congError && typeof congCount === 'number') {
          congregacoesCount = congCount;
        }
      } catch (_) {}

      const stats: SystemStats = {
        total_congregations: congregacoesCount,
        active_congregations: congregacoesCount,
        total_users: (profilesRes.count as number) || 0,
        total_estudantes: (estudantesRes.count as number) || 0,
        total_programas: (programasRes.count as number) || 0,
        last_sync: new Date().toISOString(),
      };

      setSystemStats(stats);
      setLastCheck(new Date().toISOString());

      console.log('✅ System stats loaded:', stats);
      debouncedSetDebugInfo(debugInfo + '\n\n✅ System Stats Loaded: ' + JSON.stringify(stats, null, 2));

    } catch (error) {
      console.error('❌ Error loading system stats:', error);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ System Stats Error: ' + error);
    }
  }, [debouncedSetDebugInfo, debugInfo, supabase]);

  const loadPrograms = useCallback(async () => {
    try {
      setProgramsLoading(true);
      const { data, error } = await supabase
        .from('programas')
        .select('id, semana, mes_apostila, status, data_inicio_semana, arquivo')
        .order('data_inicio_semana', { ascending: false })
        .limit(12);
      if (error) throw error;
      setPrograms(data || []);
      console.log('✅ Programs loaded:', data?.length || 0);
    } catch (error: any) {
      console.error('❌ Error loading programs:', error);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ Programs Load Error: ' + (error?.message || error));
    } finally {
      setProgramsLoading(false);
    }
  }, [debouncedSetDebugInfo, debugInfo]);

  const checkForUpdates = useCallback(async () => {
    console.log('🔄 Checking for updates...');
    setLoading(true);
    
    try {
      await loadSystemStats();
      await loadPrograms();
      console.log('✅ Updates checked successfully');
    } catch (error) {
      console.error('❌ Error checking updates:', error);
    } finally {
      setLoading(false);
    }
  }, [loadSystemStats]);

  const testSupabaseConnection = useCallback(async () => {
    console.log('🔧 Testing Supabase connection...');
    
    try {
      const { count, error } = await supabase
        .from('profiles')
        .select('*', { count: 'exact', head: true });

      if (error) {
        console.error('❌ Supabase test error:', error);
        alert('Supabase test error: ' + error.message);
      } else {
        console.log('✅ Supabase test successful. Profiles count:', count);
        alert('Supabase test successful! Total profiles: ' + (count ?? 0));
      }
    } catch (error) {
      console.error('❌ Supabase test exception:', error);
      alert('Supabase test exception: ' + error);
    }
  }, []);

  // ========== HANDLERS DOS BOTÕES ==========
  
  const handleListUsers = useCallback(async () => {
    console.log('👥 Listando usuários...');
    try {
      const { data: users, error } = await supabase
        .from('profiles')
        .select('id, nome_completo, role, congregacao, cargo')
        .order('nome_completo');
      
      if (error) throw error;
      
      console.log('✅ Usuários carregados:', users);
      alert(`Encontrados ${users?.length || 0} usuários no sistema:\n\n${users?.map(u => `${u.nome_completo || u.id} - ${u.role} (${u.congregacao || 'N/A'})`).join('\n')}`);
    } catch (error) {
      console.error('❌ Erro ao listar usuários:', error);
      alert('Erro ao carregar usuários: ' + error.message);
    }
  }, []);

  const handleManagePermissions = useCallback(async () => {
    console.log('⚙️ Gerenciando permissões...');
    const newRole = prompt('Digite o novo role (admin, instrutor, estudante):');
    if (!newRole) return;
    
    // Validar role
    const validRoles = ['admin', 'instrutor', 'estudante', 'family_member', 'developer'];
    if (!validRoles.includes(newRole)) {
      alert('Role inválido. Use: admin, instrutor, estudante, family_member ou developer');
      return;
    }
    
    const userId = prompt('Digite o ID do usuário:');
    if (!userId) return;
    
    try {
      const { error } = await supabase
        .from('profiles')
        .update({ role: newRole as any })
        .eq('id', userId);
      
      if (error) throw error;
      
      console.log('✅ Permissão atualizada');
      alert('Permissão atualizada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao atualizar permissão:', error);
      alert('Erro ao atualizar permissão: ' + error.message);
    }
  }, []);

  const handleActivityReport = useCallback(async () => {
    console.log('📊 Gerando relatório de atividades...');
    try {
      // Simulação de relatório
      const report = {
        totalUsers: staticStats.total_users,
        totalCongregations: staticStats.total_congregations,
        lastUpdate: new Date().toLocaleString('pt-BR'),
        activeUsers: Math.floor(staticStats.total_users * 0.8)
      };
      
      alert(`📊 Relatório de Atividades:\n\n` +
            `• Total de usuários: ${report.totalUsers}\n` +
            `• Usuários ativos: ${report.activeUsers}\n` +
            `• Total de congregações: ${report.totalCongregations}\n` +
            `• Última atualização: ${report.lastUpdate}`);
    } catch (error) {
      console.error('❌ Erro ao gerar relatório:', error);
      alert('Erro ao gerar relatório: ' + error.message);
    }
  }, [staticStats]);

  const handleBackupData = useCallback(async () => {
    console.log('💾 Fazendo backup dos dados...');
    try {
      const { data: profiles, error: profilesError } = await supabase
        .from('profiles')
        .select('*');
      
      if (profilesError) throw profilesError;
      
      // Simular backup
      const backupData = {
        timestamp: new Date().toISOString(),
        profiles: profiles,
        stats: staticStats
      };
      
      const dataStr = JSON.stringify(backupData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `backup_sistema_ministerial_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      URL.revokeObjectURL(url);
      console.log('✅ Backup criado com sucesso');
      alert('Backup criado e baixado com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao fazer backup:', error);
      alert('Erro ao fazer backup: ' + error.message);
    }
  }, [staticStats]);

  // Congregações
  const handleManageCongregation = useCallback((congregationName: string) => {
    console.log('🏢 Gerenciando congregação:', congregationName);
    alert(`🏢 Gerenciando congregação: ${congregationName}\n\nEsta funcionalidade abrirá o painel de gerenciamento da congregação.`);
  }, []);

  const handleAddCongregation = useCallback(async () => {
    console.log('➕ Adicionando nova congregação...');
    const congregationName = prompt('Digite o nome da nova congregação:');
    if (!congregationName) return;
    
    try {
      // Simulação - em produção seria inserção no Supabase
      console.log('✅ Congregação adicionada:', congregationName);
      alert(`✅ Congregação "${congregationName}" adicionada com sucesso!\n\nEla agora receberá automaticamente a programação oficial.`);
    } catch (error) {
      console.error('❌ Erro ao adicionar congregação:', error);
      alert('Erro ao adicionar congregação: ' + error.message);
    }
  }, []);

  // JW.org & S-38
  const handleMWBAvailable = useCallback(async () => {
    console.log('📚 Disponibilizando MWB atual...');
    try {
      await jworg.fetchCurrentWeek();
      console.log('✅ MWB atualizada');
      alert('✅ Apostila MWB atual disponibilizada para todas as congregações!');
    } catch (error) {
      console.error('❌ Erro ao disponibilizar MWB:', error);
      alert('Erro ao disponibilizar MWB: ' + error.message);
    }
  }, [jworg]);

  const handleConfigureJWorgURLs = useCallback(() => {
    console.log('⚙️ Configurando URLs JW.org...');
    const ptUrl = prompt('URL JW.org PT:', 'https://www.jw.org/pt/biblioteca/jw-apostila-do-mes/');
    const enUrl = prompt('URL JW.org EN:', 'https://www.jw.org/en/library/jw-meeting-workbook/');
    
    if (ptUrl && enUrl) {
      console.log('✅ URLs configuradas:', { ptUrl, enUrl });
      alert('✅ URLs JW.org configuradas com sucesso!');
    }
  }, []);

  const handleSyncCongregations = useCallback(async () => {
    console.log('🔄 Sincronizando com congregações...');
    try {
      // Simulação de sincronização
      const congregationsCount = staticStats.total_congregations;
      console.log(`✅ Sincronizando com ${congregationsCount} congregações`);
      alert(`🔄 Sincronização iniciada!\n\nProgramação oficial sendo enviada para ${congregationsCount} congregações...\n\nTempo estimado: ${Math.ceil(congregationsCount / 100)} minutos`);
    } catch (error) {
      console.error('❌ Erro na sincronização:', error);
      alert('Erro na sincronização: ' + error.message);
    }
  }, [staticStats]);

  // Programação Oficial
  const handleViewFullProgram = useCallback(() => {
    console.log('📅 Visualizando programação completa (3 meses)...');
    alert(`📅 Programação Completa dos Próximos 3 Meses\n\n` +
          `• Semanas carregadas: 12\n` +
          `• Idiomas: PT e EN\n` +
          `• Última atualização: Hoje\n\n` +
          `Esta visualização mostrará todas as apostilas MWB dos próximos 3 meses.`);
  }, []);

  const handleUpdateProgramPT = useCallback(async () => {
    console.log('🇧🇷 Atualizando programação PT...');
    try {
      jworg.setLanguage('pt');
      await jworg.fetchNextWeeks();
      console.log('✅ Programação PT atualizada');
      alert('✅ Programação em Português atualizada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao atualizar programação PT:', error);
      alert('Erro ao atualizar programação PT: ' + error.message);
    }
  }, [jworg]);

  const handleUpdateProgramEN = useCallback(async () => {
    console.log('🇺🇸 Atualizando programação EN...');
    try {
      jworg.setLanguage('en');
      await jworg.fetchNextWeeks();
      console.log('✅ Programação EN atualizada');
      alert('✅ Programação em Inglês atualizada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao atualizar programação EN:', error);
      alert('Erro ao atualizar programação EN: ' + error.message);
    }
  }, [jworg]);

  const handleCheckNewWeeks = useCallback(async () => {
    console.log('🔍 Verificando novas semanas...');
    try {
      await jworg.fetchNextWeeks();
      const newWeeks = jworg.nextWeeks.length;
      console.log(`✅ Verificação concluída: ${newWeeks} semanas`);
      alert(`🔍 Verificação concluída!\n\nEncontradas ${newWeeks} semanas de programação.\n\nTodas estão sincronizadas com JW.org.`);
    } catch (error) {
      console.error('❌ Erro ao verificar semanas:', error);
      alert('Erro ao verificar novas semanas: ' + error.message);
    }
  }, [jworg]);

  const handleUpdateS38Structure = useCallback(() => {
    console.log('🏗️ Atualizando estrutura S-38 global...');
    alert(`🏗️ Estrutura S-38 Global\n\n` +
          `✅ Partes da reunião atualizadas:\n` +
          `• Chairman\n• Treasures\n• Gems\n• Reading\n` +
          `• Starting\n• Following\n• Making\n• Explaining\n` +
          `• Talk\n\n` +
          `Esta estrutura será aplicada mundialmente.`);
  }, []);

  // JW.org Integration
  const handleReloadCurrentWeek = useCallback(async () => {
    console.log('🔄 Recarregando semana atual...');
    try {
      await jworg.fetchCurrentWeek();
      console.log('✅ Semana atual recarregada');
      alert('✅ Semana atual recarregada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao recarregar semana:', error);
      alert('Erro ao recarregar semana: ' + error.message);
    }
  }, [jworg]);

  const handleReloadNextWeeks = useCallback(async () => {
    console.log('📅 Recarregando próximas semanas...');
    try {
      await jworg.fetchNextWeeks();
      console.log('✅ Próximas semanas recarregadas');
      alert('✅ Próximas semanas recarregadas com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao recarregar próximas semanas:', error);
      alert('Erro ao recarregar próximas semanas: ' + error.message);
    }
  }, [jworg]);

  const handleTestDownloadPT = useCallback(async () => {
    console.log('🧪 Testando download PT...');
    try {
      jworg.setLanguage('pt');
      await jworg.downloadWorkbook('pt', '07', '2025');
      console.log('✅ Download PT testado');
      alert('✅ Download PT testado com sucesso!');
    } catch (error) {
      console.error('❌ Erro no teste de download PT:', error);
      alert('Erro no teste de download PT: ' + error.message);
    }
  }, [jworg]);

  // Monitoramento
  const handleViewAllLogs = useCallback(async () => {
    console.log('📋 Visualizando todos os logs...');
    try {
      // Simulação de logs
      const logs = [
        { timestamp: new Date().toLocaleString(), event: 'Sistema iniciado', level: 'info' },
        { timestamp: new Date(Date.now() - 3600000).toLocaleString(), event: 'Backup automático executado', level: 'info' },
        { timestamp: new Date(Date.now() - 86400000).toLocaleString(), event: 'Novo usuário registrado', level: 'info' },
        { timestamp: new Date(Date.now() - 172800000).toLocaleString(), event: 'Manutenção programada', level: 'warning' }
      ];
      
      const logText = logs.map(log => `${log.timestamp} [${log.level.toUpperCase()}] ${log.event}`).join('\n');
      alert(`📋 Logs do Sistema\n\n${logText}`);
    } catch (error) {
      console.error('❌ Erro ao carregar logs:', error);
      alert('Erro ao carregar logs: ' + error.message);
    }
  }, []);

  const handleTestJWorgIntegration = useCallback(async () => {
    console.log('🧪 Testando integração JW.org...');
    try {
      await jworg.fetchCurrentWeek();
      console.log('✅ Integração JW.org testada com sucesso');
      alert('✅ Integração JW.org funcionando perfeitamente!');
    } catch (error) {
      console.error('❌ Erro na integração JW.org:', error);
      alert('❌ Erro na integração JW.org: ' + error.message);
    }
  }, [jworg]);

  const handleChangeLanguage = useCallback((newLang: 'pt' | 'en') => {
    jworg.setLanguage(newLang);
    console.log(`🌐 Idioma alterado para: ${newLang}`);
    alert(`🌐 Idioma alterado para: ${newLang === 'pt' ? 'Português' : 'English'}`);
  }, [jworg]);

  // Alterna o idioma atual entre PT/EN
  const toggleLanguage = useCallback(() => {
    const current = (jworg as any)?.currentLanguage ?? 'pt';
    const next = current === 'pt' ? 'en' : 'pt';
    jworg.setLanguage(next);
    console.log(`🌐 Idioma alternado: ${current} -> ${next}`);
    alert(`🌐 Idioma alternado para: ${next === 'pt' ? 'Português' : 'English'}`);
  }, [jworg]);

  // Atualiza materiais JW.org (semana atual + próximas semanas)
  const updateMaterials = useCallback(async () => {
    try {
      await jworg.fetchCurrentWeek();
      await jworg.fetchNextWeeks();
      console.log('✅ Materiais JW.org atualizados');
      alert('✅ Materiais JW.org atualizados com sucesso!');
    } catch (error: any) {
      console.error('❌ Erro ao atualizar materiais:', error);
      alert('❌ Erro ao atualizar materiais: ' + (error?.message || error));
    }
  }, [jworg]);

  // NOW CHECK CONDITIONS AND RENDER APPROPRIATELY
  // Se não for admin, mostrar mensagem de acesso negado
  if (user && !isAdmin) {
    return (
      <div className="container mx-auto px-4 py-8">
        <Card className="max-w-md mx-auto">
          <CardHeader>
            <CardTitle className="text-red-600">Acesso Negado</CardTitle>
            <CardDescription>
              Você não tem permissão para acessar o painel administrativo.
            </CardDescription>
          </CardHeader>
          <CardContent>
            <p className="text-sm text-muted-foreground mb-4">
              Seu perfil atual: <strong>{profile?.role}</strong>
            </p>
            <Button onClick={() => window.history.back()}>
              Voltar
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Se não houver usuário, mostrar loading
  if (!user) {
    return (
      <div className="container mx-auto px-4 py-8">
        <Card className="max-w-md mx-auto">
          <CardHeader>
            <CardTitle>Carregando...</CardTitle>
            <CardDescription>
              Verificando autenticação...
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="flex items-center justify-center">
              <RefreshCw className="h-6 w-6 animate-spin" />
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background">
      {/* Auth Error Handler */}
      <AuthErrorHandler />
      
      {/* Header */}
      <div className="border-b">
        <div className="container mx-auto px-4 py-6">
          <div className="flex flex-col space-y-4">
          <div className="flex items-center justify-between">
            <div>
                <h1 className="text-3xl font-bold tracking-tight">📊 Dashboard do Administrador Geral</h1>
                <p className="text-muted-foreground">
                  Programação oficial das reuniões ministeriais - Padronização mundial para todas as congregações
              </p>
            </div>
              <div className="flex items-center space-x-2">
              {/* Force Profile Load Button */}
              {import.meta.env.DEV && (
                <Button 
                  variant="outline" 
                  size="sm"
                    onClick={testSupabaseConnection}
                  >
                    🔧 Test Supabase
                </Button>
              )}
              
              <Button onClick={checkForUpdates} disabled={loading}>
                <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
                  Atualizar
              </Button>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Debug Info Panel */}
      {import.meta.env.DEV && (
        <div className="container mx-auto px-4 py-2">
          <Card className="bg-yellow-50 border-yellow-200">
            <CardHeader className="pb-2">
              <CardTitle className="text-sm text-yellow-800">🐛 Debug Info (Development Only)</CardTitle>
            </CardHeader>
            <CardContent>
              <pre className="text-xs text-yellow-700 overflow-auto max-h-40">
                {debugInfo}
              </pre>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Main Content */}
      <div className="container mx-auto px-4 py-6">
        <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-6">
          <TabsList className="grid w-full grid-cols-4">
            <TabsTrigger value="overview">Visão Geral</TabsTrigger>
            <TabsTrigger value="users">Usuários</TabsTrigger>
            <TabsTrigger value="congregations">Congregações</TabsTrigger>
            <TabsTrigger value="system">Sistema</TabsTrigger>
          </TabsList>

          {/* Visão Geral */}
          <TabsContent value="overview" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                🎯 Sistema Ministerial Global - Padronização Mundial
              </h3>
              <div className="text-center text-sm text-muted-foreground mt-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
                <strong>📊 Admin Geral:</strong> Disponibiliza programação oficial semanal (SEM nomes de estudantes) <br/>
                <strong>🎓 Instrutores:</strong> Recebem programação automaticamente + fazem designações locais reais
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Congregações Conectadas</CardTitle>
                  <Globe className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">{staticStats.total_congregations}</div>
                  <p className="text-xs text-muted-foreground">
                    Recebendo programação oficial
                  </p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Semanas Programadas</CardTitle>
                  <BarChart3 className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">12</div>
                  <p className="text-xs text-muted-foreground">
                    Próximas 3 meses
                  </p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Idiomas Disponíveis</CardTitle>
                  <Globe className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">2</div>
                  <p className="text-xs text-muted-foreground">
                    Português e Inglês
                  </p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Última Sincronização</CardTitle>
                  <RefreshCw className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">✅</div>
                  <p className="text-xs text-muted-foreground">
                    Hoje, {new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                  </p>
                </CardContent>
              </Card>
            </div>

            {/* Ações Rápidas */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Status do Sistema */}
              <Card>
                <CardHeader>
                  <CardTitle>Status do Sistema</CardTitle>
                  <CardDescription>
                    Informações sobre a última verificação e status geral
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Última Verificação:</span>
                    <span className="text-sm text-muted-foreground">
                      {lastCheck ? new Date(lastCheck).toLocaleString('pt-BR') : 'Nunca'}
                    </span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Status:</span>
                    <Badge variant="outline" className="text-green-600">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Operacional
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Supabase:</span>
                    <Badge variant="outline" className="text-green-600">
                      <Database className="h-3 w-3 mr-1" />
                      Conectado
                    </Badge>
                  </div>
                </CardContent>
              </Card>

              {/* Programações Publicadas */}
              <Card>
                <CardHeader>
                  <CardTitle>Programações Publicadas</CardTitle>
                  <CardDescription>
                    Últimas semanas importadas/publicadas
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  {programsLoading ? (
                    <div className="text-sm text-muted-foreground">Carregando...</div>
                  ) : programs.length === 0 ? (
                    <div className="text-sm text-muted-foreground">Nenhuma programação encontrada.</div>
                  ) : (
                    <div className="space-y-2">
                      {programs.map((p) => (
                        <div key={p.id} className="p-2 border rounded-md">
                          <div className="flex items-center justify-between">
                            <div className="text-sm">
                              <div className="font-medium">Semana {p.semana || '—'} • {p.mes_apostila || '—'}</div>
                              <div className="text-xs text-muted-foreground">
                                {p.data_inicio_semana ? new Date(p.data_inicio_semana).toLocaleDateString('pt-BR') : '—'}
                              </div>
                            </div>
                            <Badge variant="outline" className={p.status === 'ativo' || p.status === 'publicado' ? 'bg-green-50 text-green-700' : ''}>
                              {p.status || '—'}
                            </Badge>
                          </div>
                          {p.arquivo && (
                            <div className="mt-2">
                              <a
                                href={`http://localhost:3001/materials/${encodeURIComponent(p.arquivo)}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="text-blue-600 text-xs underline"
                              >
                                Abrir material ({p.arquivo})
                              </a>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </CardContent>
              </Card>

              {/* JW.org Downloads */}
              <Card className="bg-green-50 border-green-200">
                <CardHeader>
                  <CardTitle className="text-green-800">📚 JW.org Downloads</CardTitle>
                  <CardDescription className="text-green-700">
                    Gerenciar materiais oficiais
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Apostila MWB Atual:</span>
                    <Badge variant="outline" className="text-green-600">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Disponível
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Última verificação:</span>
                    <span className="text-sm text-green-700">Hoje, 10:30</span>
                  </div>
                  <div className="flex space-x-2">
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleMWBAvailable}>
                      <RefreshCw className="h-3 w-3 mr-1" />
                      Disponibilizar MWB Atual
                    </Button>
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleConfigureJWorgURLs}>
                      <Settings className="h-3 w-3 mr-1" />
                      Configurar URLs JW.org
                    </Button>
                  </div>
                </CardContent>
              </Card>

              {/* Sistema S-38 - Designações */}
              <Card className="bg-purple-50 border-purple-200">
                <CardHeader>
                  <CardTitle className="text-purple-800">⚙️ Sistema S-38</CardTitle>
                  <CardDescription className="text-purple-700">
                    Estrutura das reuniões ministeriais
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="text-sm text-purple-700 space-y-2">
                    <p>📚 <strong>Função do Admin:</strong> Disponibilizar apostilas MWB</p>
                    <p>👥 <strong>Para Instrutores:</strong> Designar estudantes para partes</p>
                    <p>🎯 <strong>Partes da Reunião:</strong></p>
                    <div className="grid grid-cols-2 gap-1 text-xs ml-2">
                      <div>• Chairman</div>
                      <div>• Treasures</div>
                      <div>• Gems</div>
                      <div>• Reading</div>
                      <div>• Starting</div>
                      <div>• Following</div>
                      <div>• Making</div>
                      <div>• Explaining</div>
                      <div>• Talk</div>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Debug / Integração */}
              <Card className="bg-slate-50 border-slate-200">
                <CardHeader>
                  <CardTitle className="text-slate-800">🧪 Debug / Integração</CardTitle>
                  <CardDescription className="text-slate-700">
                    Ferramentas rápidas para validar integrações e idioma
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-3">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Idioma Atual:</span>
                    <Badge variant="outline" className="text-slate-700">
                      {(jworg as any)?.currentLanguage === 'en' ? '🇺🇸 English' : '🇧🇷 Português'}
                    </Badge>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    <Button size="sm" variant="outline" onClick={toggleLanguage}>
                      Alternar Idioma
                    </Button>
                    <Button size="sm" variant="outline" onClick={updateMaterials}>
                      Atualizar Materiais
                    </Button>
                    <Button size="sm" variant="outline" onClick={handleTestJWorgIntegration}>
                      Testar Integração JW.org
                    </Button>
                    <Button size="sm" variant="outline" onClick={checkForUpdates} disabled={loading}>
                      Atualizar Contagens
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          {/* Usuários */}
          <TabsContent value="users" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                👥 Gestão de Usuários para Acesso às Apostilas MWB
              </h3>
              <p className="text-center text-sm text-muted-foreground mt-2">
                🎯 Função Principal: Admin gerencia usuários → Instrutores acessam apostilas
              </p>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Estatísticas de Usuários */}
            <Card>
              <CardHeader>
                  <CardTitle>Estatísticas</CardTitle>
                  <CardDescription>Resumo dos usuários</CardDescription>
              </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Total de Usuários:</span>
                      <Badge variant="outline">{staticStats.total_users}</Badge>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Admins:</span>
                      <Badge variant="outline" className="bg-red-50 text-red-700">
                        {isAdmin ? 1 : 0}
                      </Badge>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Instrutores:</span>
                      <Badge variant="outline" className="bg-blue-50 text-blue-700">
                        {staticStats.total_users - (isAdmin ? 1 : 0)}
                      </Badge>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Usuários Registrados */}
              <Card className="lg:col-span-2">
                <CardHeader>
                  <CardTitle>Usuários Registrados</CardTitle>
                  <CardDescription>Últimos usuários cadastrados no sistema</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between p-3 border rounded-lg">
                      <div className="flex items-center space-x-3">
                        <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                          <Users className="h-5 w-5 text-blue-600" />
                        </div>
                        <div>
                          <p className="font-medium">{profile?.nome_completo || 'Roberto Araujo da Silva'}</p>
                          <p className="text-sm text-muted-foreground">Administrator</p>
                        </div>
                      </div>
                      <Badge variant="outline" className="bg-red-50 text-red-700">
                        Admin
                      </Badge>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Ações Administrativas */}
            <Card>
              <CardHeader>
                <CardTitle>Ações Administrativas</CardTitle>
                <CardDescription>
                  Gerenciar usuários e permissões
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <Button className="w-full justify-start" variant="outline" onClick={handleListUsers}>
                    <Users className="h-4 w-4 mr-2" />
                    Listar Todos os Usuários
                  </Button>
                  <Button className="w-full justify-start" variant="outline" onClick={handleManagePermissions}>
                    <Settings className="h-4 w-4 mr-2" />
                    Gerenciar Permissões
                  </Button>
                  <Button className="w-full justify-start" variant="outline" onClick={handleActivityReport}>
                    <Activity className="h-4 w-4 mr-2" />
                    Relatório de Atividades
                  </Button>
                  <Button className="w-full justify-start" variant="outline" onClick={handleBackupData}>
                    <Database className="h-4 w-4 mr-2" />
                    Backup de Dados
                  </Button>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Congregações */}
          <TabsContent value="congregations" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                🏢 Gestão de Congregações para Acesso às Apostilas MWB
              </h3>
              <p className="text-center text-sm text-muted-foreground mt-2">
                🎯 Função Principal: Admin gerencia congregações → Instrutores acessam apostilas
              </p>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Estatísticas de Congregações */}
            <Card>
              <CardHeader>
                  <CardTitle>Estatísticas</CardTitle>
                  <CardDescription>Resumo das congregações</CardDescription>
              </CardHeader>
              <CardContent>
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Total de Congregações:</span>
                      <Badge variant="outline">{staticStats.total_congregations}</Badge>
                  </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Congregações Ativas:</span>
                      <Badge variant="outline" className="bg-green-50 text-green-700">
                        {staticStats.active_congregations}
                      </Badge>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Total de Estudantes:</span>
                      <Badge variant="outline">{staticStats.total_estudantes}</Badge>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Lista de Congregações */}
              <Card className="lg:col-span-2">
                <CardHeader>
                  <CardTitle>Congregações Registradas</CardTitle>
                  <CardDescription>Lista das congregações no sistema</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between p-3 border rounded-lg">
                      <div className="flex items-center space-x-3">
                        <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                          <Package className="h-5 w-5 text-blue-600" />
                        </div>
                        <div>
                          <p className="font-medium">Sistema Ministerial Global</p>
                          <p className="text-sm text-muted-foreground">Congregação Principal</p>
                          </div>
                        </div>
                      <Badge variant="outline" className="bg-green-50 text-green-700">
                        Ativa
                        </Badge>
                      </div>
                  </div>
                  
                  <div className="mt-4">
                    <Button variant="outline" className="w-full" onClick={() => handleManageCongregation('Sistema Ministerial Global')}>
                      <Users className="h-4 w-4 mr-2" />
                      Gerenciar
                    </Button>
                  </div>
                  
                  <div className="mt-4">
                    <Button variant="outline" className="w-full" onClick={handleAddCongregation}>
                      <Users className="h-4 w-4 mr-2" />
                      Adicionar Nova Congregação
                    </Button>
                  </div>
                  
                  <div className="mt-4">
                    <Button variant="outline" className="w-full">
                      <Users className="h-4 w-4 mr-2" />
                      Expandir
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          {/* Sistema */}
          <TabsContent value="system" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                ⚙️ Monitoramento e Configurações do Sistema
              </h3>
              <p className="text-center text-sm text-muted-foreground mt-2">
                🎯 Função Principal: Admin monitora sistema → Instrutores recebem apostilas estáveis
              </p>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Downloads JW.org */}
              <Card className="bg-green-50 border-green-200">
              <CardHeader>
                  <CardTitle className="text-green-800">📚 JW.org Downloads</CardTitle>
                  <CardDescription className="text-green-700">
                    Gerenciar materiais oficiais
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Apostila MWB Atual:</span>
                    <Badge variant="outline" className="text-green-600">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Disponível
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Última verificação:</span>
                    <span className="text-sm text-green-700">Hoje, 10:30</span>
                  </div>
                  <div className="flex space-x-2">
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleSyncCongregations}>
                      <RefreshCw className="h-3 w-3 mr-1" />
                      Sincronizar com Congregações
                    </Button>
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleViewFullProgram}>
                      <Settings className="h-3 w-3 mr-1" />
                      Ver Programação Completa
                    </Button>
                </div>
              </CardContent>
            </Card>

              {/* Configurações Gerais */}
            <Card>
              <CardHeader>
                  <CardTitle>Configurações Gerais</CardTitle>
                <CardDescription>
                    Parâmetros do sistema
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                    <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Backup Automático:</span>
                    <Badge variant="outline" className="bg-green-50 text-green-700">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Diário às 02:00
                      </Badge>
                    </div>
                    <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Notificações:</span>
                    <Badge variant="outline" className="bg-blue-50 text-blue-700">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Email + Sistema
                    </Badge>
                    </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Manutenção:</span>
                    <span className="text-sm text-muted-foreground">Última: Ontem</span>
                  </div>
                  <div className="flex space-x-2">
                    <Button size="sm" variant="outline">
                      <Settings className="h-3 w-3 mr-1" />
                      Configurar
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Métricas do Sistema */}
            <Card>
              <CardHeader>
                <CardTitle>Métricas do Sistema</CardTitle>
                <CardDescription>
                  Monitoramento em tempo real
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-green-600">99.9%</p>
                    <p className="text-sm text-muted-foreground">Uptime</p>
                  </div>
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-blue-600">~120ms</p>
                    <p className="text-sm text-muted-foreground">Latência</p>
                  </div>
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-green-600">25%</p>
                    <p className="text-sm text-muted-foreground">CPU</p>
                  </div>
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-blue-600">33%</p>
                    <p className="text-sm text-muted-foreground">Memória</p>
                  </div>
                </div>

                <Separator />

                <div className="space-y-3">
                    <div className="flex items-center justify-between">
                    <span className="text-sm">CPU:</span>
                    <div className="flex items-center space-x-2">
                      <div className="w-24 h-2 bg-gray-200 rounded-full">
                        <div className="w-1/4 h-2 bg-green-500 rounded-full"></div>
                    </div>
                        <span className="text-sm">25%</span>
                  </div>
                    </div>
                    
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Memória:</span>
                      <div className="flex items-center space-x-2">
                        <div className="w-24 h-2 bg-gray-200 rounded-full">
                          <div className="w-1/3 h-2 bg-blue-500 rounded-full"></div>
                    </div>
                        <span className="text-sm">33%</span>
                      </div>
                    </div>
                    
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Banco:</span>
                      <div className="flex items-center space-x-2">
                        <CheckCircle className="h-4 w-4 text-green-500" />
                        <span className="text-sm">Conectado</span>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

              {/* Logs e Atividades */}
              <Card>
                <CardHeader>
                  <CardTitle>Logs Recentes</CardTitle>
                  <CardDescription>
                    Últimas atividades do sistema
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <CheckCircle className="h-4 w-4 text-green-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Sistema iniciado</p>
                        <p className="text-xs text-muted-foreground">Hoje, 08:00</p>
                      </div>
                    </div>

                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <Activity className="h-4 w-4 text-blue-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Backup automático executado</p>
                        <p className="text-xs text-muted-foreground">Hoje, 02:00</p>
                      </div>
                    </div>

                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <Users className="h-4 w-4 text-green-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Novo usuário registrado</p>
                        <p className="text-xs text-muted-foreground">Ontem, 16:30</p>
                      </div>
                    </div>

                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <AlertCircle className="h-4 w-4 text-yellow-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Manutenção programada</p>
                        <p className="text-xs text-muted-foreground">Ontem, 03:00</p>
                      </div>
                    </div>
                  </div>

                  <div className="mt-4">
                    <Button variant="outline" className="w-full" onClick={handleViewAllLogs}>
                      <FileText className="h-4 w-4 mr-2" />
                      Ver Todos os Logs
                    </Button>
                  </div>
                </CardContent>
              </Card>
          </TabsContent>
        </Tabs>
      </div>
    </div>
  );
}

```

Adicionei no card “Programações Publicadas” um link “Abrir material (arquivo)” para `http://localhost:3001/materials/<arquivo>`, usando `encodeURIComponent` para nomes com espaços/parênteses. 

Para testar agora:
- Insira um registro em `public.programas` com `arquivo = 'mwb_E_202509.pdf'` (ou outro dos seus PDFs).
- Recarregue o Admin em http://localhost:8080/admin e clique em “Abrir material”.

Se quiser, adiciono um botão “Sincronizar materiais” que cria automaticamente linhas em `programas` a partir dos PDFs existentes em `docs/Oficial`.

---

**User**

client.ts:76  HEAD https://nwpuurgwnnuejqinkvrh.supabase.co/rest/v1/congregacoes?select=* 404 (Not Found)
fetch @ client.ts:76
(anônimo) @ @supabase_supabase-js.js?v=a0d85490:4230
(anônimo) @ @supabase_supabase-js.js?v=a0d85490:4251
fulfilled @ @supabase_supabase-js.js?v=a0d85490:4203
Promise.then
step @ @supabase_supabase-js.js?v=a0d85490:4216
(anônimo) @ @supabase_supabase-js.js?v=a0d85490:4218
__awaiter6 @ @supabase_supabase-js.js?v=a0d85490:4200
(anônimo) @ @supabase_supabase-js.js?v=a0d85490:4241
then @ @supabase_supabase-js.js?v=a0d85490:90


---

**Cursor**

```typescriptreact
import React, { useState, useEffect, useCallback, useMemo, lazy, Suspense } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { supabase } from '../integrations/supabase/client';
import { useJWorgIntegration } from '../hooks/useJWorgIntegration';
import { JWorgTest } from '../components/JWorgTest';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../components/ui/card';
import LazyLoader from '../components/LazyLoader';
import AuthErrorHandler from '../components/AuthErrorHandler';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '../components/ui/tabs';
import { Button } from '../components/ui/button';
import { Badge } from '../components/ui/badge';
import { Separator } from '../components/ui/separator';
import { 
  Download, 
  Upload, 
  Globe, 
  BarChart3, 
  Settings, 
  RefreshCw,
  CheckCircle,
  AlertCircle,
  Clock,
  FileText,
  Users,
  Package,
  Activity,
  Database
} from 'lucide-react';

// 🚀 Lazy loading para componentes pesados (comentado por enquanto)
// const JWorgTestLazy = lazy(() => import('../components/JWorgTest'));

interface SystemStats {
  total_congregations: number;
  active_congregations: number;
  total_users: number;
  total_estudantes: number;
  total_programas: number;
  last_sync: string;
}

export default function AdminDashboard() {
  const { user, profile, isAdmin } = useAuth();
  const jworg = useJWorgIntegration();
  const [activeTab, setActiveTab] = useState('overview');
  const [loading, setLoading] = useState(false);
  const [systemStats, setSystemStats] = useState<SystemStats | null>(null);
  const [lastCheck, setLastCheck] = useState<string>('');
  const [debugInfo, setDebugInfo] = useState<string>('');
  const [showJWorgTest, setShowJWorgTest] = useState(false);
  const [programs, setPrograms] = useState<any[]>([]);
  const [programsLoading, setProgramsLoading] = useState<boolean>(false);

  // 🚀 Memoização de dados estáticos para reduzir re-renders
  const staticStats = useMemo(() => ({
    total_congregations: systemStats?.total_congregations || 0,
    active_congregations: systemStats?.active_congregations || 0,
    total_users: systemStats?.total_users || 0,
    total_estudantes: systemStats?.total_estudantes || 0,
    total_programas: systemStats?.total_programas || 0,
    last_sync: systemStats?.last_sync || ''
  }), [systemStats]);

  // 🚀 Debounced function para reduzir chamadas desnecessárias
  const debouncedSetDebugInfo = useCallback((info: string) => {
    let timeoutId: NodeJS.Timeout;
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => setDebugInfo(info), 100);
  }, []);

  // DEBUG: Log component state (otimizado)
  useEffect(() => {
    const debugData = {
      user: !!user,
      userId: user?.id,
      userEmail: user?.email,
      profile: !!profile,
      profileRole: profile?.role,
      isAdmin,
      loading,
      userMetadata: user?.user_metadata
    };

    console.log('🔍 AdminDashboard Component Debug:', debugData);
    debouncedSetDebugInfo(JSON.stringify(debugData, null, 2));
  }, [user, profile, isAdmin, loading, debouncedSetDebugInfo]);

  useEffect(() => {
    console.log('🔄 AdminDashboard useEffect triggered:', { user, isAdmin });
    
    if (user && isAdmin) {
      console.log('✅ Admin user detected, loading system data...');
      loadSystemData();
    } else if (user && !isAdmin) {
      console.log('❌ User is not admin, role:', profile?.role);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ User is not admin, role: ' + profile?.role);
    } else if (!user) {
      console.log('❌ No user found');
      debouncedSetDebugInfo(debugInfo + '\n\n❌ No user found');
    }
  }, [user, isAdmin, debouncedSetDebugInfo]);

  const loadSystemData = useCallback(async () => {
    if (!user || !isAdmin) {
      console.log('🚫 loadSystemData: User not admin or not logged in');
      return;
    }
    
    console.log('🔄 Loading system data for admin...');
    setLoading(true);
    try {
      // Testar conexão com Supabase
      console.log('🔍 Testing Supabase connection...');
      const { count: profilesCount, error: testError } = await supabase
        .from('profiles')
        .select('*', { count: 'exact', head: true });
      
      if (testError) {
        console.error('❌ Supabase connection test failed:', testError);
        debouncedSetDebugInfo(debugInfo + '\n\n❌ Supabase Test Failed: ' + testError.message);
        return;
      }

        console.log('✅ Supabase connection test successful');
      debouncedSetDebugInfo(debugInfo + '\n\n✅ Supabase Test: Connected');

      // Carregar estatísticas do sistema
      await loadSystemStats();
      // Carregar programações publicadas
      await loadPrograms();

    } catch (error) {
      console.error('❌ Supabase test exception:', error);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ Supabase Test Exception: ' + error);
    } finally {
      setLoading(false);
    }
  }, [user, isAdmin, debouncedSetDebugInfo, debugInfo]);

  const loadSystemStats = useCallback(async () => {
    try {
      console.log('📊 Loading system statistics...');

      const [profilesRes, estudantesRes, programasRes] = await Promise.all([
        supabase.from('profiles').select('*', { count: 'exact', head: true }),
        supabase.from('estudantes').select('*', { count: 'exact', head: true }),
        supabase.from('programas').select('*', { count: 'exact', head: true }),
      ]);

      // congregacoes (removido: tabela pode não existir neste projeto)
      const congregacoesCount = 0;

      const stats: SystemStats = {
        total_congregations: congregacoesCount,
        active_congregations: congregacoesCount,
        total_users: (profilesRes.count as number) || 0,
        total_estudantes: (estudantesRes.count as number) || 0,
        total_programas: (programasRes.count as number) || 0,
        last_sync: new Date().toISOString(),
      };

      setSystemStats(stats);
      setLastCheck(new Date().toISOString());

      console.log('✅ System stats loaded:', stats);
      debouncedSetDebugInfo(debugInfo + '\n\n✅ System Stats Loaded: ' + JSON.stringify(stats, null, 2));

    } catch (error) {
      console.error('❌ Error loading system stats:', error);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ System Stats Error: ' + error);
    }
  }, [debouncedSetDebugInfo, debugInfo, supabase]);

  const loadPrograms = useCallback(async () => {
    try {
      setProgramsLoading(true);
      const { data, error } = await supabase
        .from('programas')
        .select('id, semana, mes_apostila, status, data_inicio_semana, arquivo')
        .order('data_inicio_semana', { ascending: false })
        .limit(12);
      if (error) throw error;
      setPrograms(data || []);
      console.log('✅ Programs loaded:', data?.length || 0);
    } catch (error: any) {
      console.error('❌ Error loading programs:', error);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ Programs Load Error: ' + (error?.message || error));
    } finally {
      setProgramsLoading(false);
    }
  }, [debouncedSetDebugInfo, debugInfo]);

  const checkForUpdates = useCallback(async () => {
    console.log('🔄 Checking for updates...');
    setLoading(true);
    
    try {
      await loadSystemStats();
      await loadPrograms();
      console.log('✅ Updates checked successfully');
    } catch (error) {
      console.error('❌ Error checking updates:', error);
    } finally {
      setLoading(false);
    }
  }, [loadSystemStats]);

  const testSupabaseConnection = useCallback(async () => {
    console.log('🔧 Testing Supabase connection...');
    
    try {
      const { count, error } = await supabase
        .from('profiles')
        .select('*', { count: 'exact', head: true });

      if (error) {
        console.error('❌ Supabase test error:', error);
        alert('Supabase test error: ' + error.message);
      } else {
        console.log('✅ Supabase test successful. Profiles count:', count);
        alert('Supabase test successful! Total profiles: ' + (count ?? 0));
      }
    } catch (error) {
      console.error('❌ Supabase test exception:', error);
      alert('Supabase test exception: ' + error);
    }
  }, []);

  // ========== HANDLERS DOS BOTÕES ==========
  
  const handleListUsers = useCallback(async () => {
    console.log('👥 Listando usuários...');
    try {
      const { data: users, error } = await supabase
        .from('profiles')
        .select('id, nome_completo, role, congregacao, cargo')
        .order('nome_completo');
      
      if (error) throw error;
      
      console.log('✅ Usuários carregados:', users);
      alert(`Encontrados ${users?.length || 0} usuários no sistema:\n\n${users?.map(u => `${u.nome_completo || u.id} - ${u.role} (${u.congregacao || 'N/A'})`).join('\n')}`);
    } catch (error) {
      console.error('❌ Erro ao listar usuários:', error);
      alert('Erro ao carregar usuários: ' + error.message);
    }
  }, []);

  const handleManagePermissions = useCallback(async () => {
    console.log('⚙️ Gerenciando permissões...');
    const newRole = prompt('Digite o novo role (admin, instrutor, estudante):');
    if (!newRole) return;
    
    // Validar role
    const validRoles = ['admin', 'instrutor', 'estudante', 'family_member', 'developer'];
    if (!validRoles.includes(newRole)) {
      alert('Role inválido. Use: admin, instrutor, estudante, family_member ou developer');
      return;
    }
    
    const userId = prompt('Digite o ID do usuário:');
    if (!userId) return;
    
    try {
      const { error } = await supabase
        .from('profiles')
        .update({ role: newRole as any })
        .eq('id', userId);
      
      if (error) throw error;
      
      console.log('✅ Permissão atualizada');
      alert('Permissão atualizada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao atualizar permissão:', error);
      alert('Erro ao atualizar permissão: ' + error.message);
    }
  }, []);

  const handleActivityReport = useCallback(async () => {
    console.log('📊 Gerando relatório de atividades...');
    try {
      // Simulação de relatório
      const report = {
        totalUsers: staticStats.total_users,
        totalCongregations: staticStats.total_congregations,
        lastUpdate: new Date().toLocaleString('pt-BR'),
        activeUsers: Math.floor(staticStats.total_users * 0.8)
      };
      
      alert(`📊 Relatório de Atividades:\n\n` +
            `• Total de usuários: ${report.totalUsers}\n` +
            `• Usuários ativos: ${report.activeUsers}\n` +
            `• Total de congregações: ${report.totalCongregations}\n` +
            `• Última atualização: ${report.lastUpdate}`);
    } catch (error) {
      console.error('❌ Erro ao gerar relatório:', error);
      alert('Erro ao gerar relatório: ' + error.message);
    }
  }, [staticStats]);

  const handleBackupData = useCallback(async () => {
    console.log('💾 Fazendo backup dos dados...');
    try {
      const { data: profiles, error: profilesError } = await supabase
        .from('profiles')
        .select('*');
      
      if (profilesError) throw profilesError;
      
      // Simular backup
      const backupData = {
        timestamp: new Date().toISOString(),
        profiles: profiles,
        stats: staticStats
      };
      
      const dataStr = JSON.stringify(backupData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `backup_sistema_ministerial_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      URL.revokeObjectURL(url);
      console.log('✅ Backup criado com sucesso');
      alert('Backup criado e baixado com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao fazer backup:', error);
      alert('Erro ao fazer backup: ' + error.message);
    }
  }, [staticStats]);

  // Congregações
  const handleManageCongregation = useCallback((congregationName: string) => {
    console.log('🏢 Gerenciando congregação:', congregationName);
    alert(`🏢 Gerenciando congregação: ${congregationName}\n\nEsta funcionalidade abrirá o painel de gerenciamento da congregação.`);
  }, []);

  const handleAddCongregation = useCallback(async () => {
    console.log('➕ Adicionando nova congregação...');
    const congregationName = prompt('Digite o nome da nova congregação:');
    if (!congregationName) return;
    
    try {
      // Simulação - em produção seria inserção no Supabase
      console.log('✅ Congregação adicionada:', congregationName);
      alert(`✅ Congregação "${congregationName}" adicionada com sucesso!\n\nEla agora receberá automaticamente a programação oficial.`);
    } catch (error) {
      console.error('❌ Erro ao adicionar congregação:', error);
      alert('Erro ao adicionar congregação: ' + error.message);
    }
  }, []);

  // JW.org & S-38
  const handleMWBAvailable = useCallback(async () => {
    console.log('📚 Disponibilizando MWB atual...');
    try {
      await jworg.fetchCurrentWeek();
      console.log('✅ MWB atualizada');
      alert('✅ Apostila MWB atual disponibilizada para todas as congregações!');
    } catch (error) {
      console.error('❌ Erro ao disponibilizar MWB:', error);
      alert('Erro ao disponibilizar MWB: ' + error.message);
    }
  }, [jworg]);

  const handleConfigureJWorgURLs = useCallback(() => {
    console.log('⚙️ Configurando URLs JW.org...');
    const ptUrl = prompt('URL JW.org PT:', 'https://www.jw.org/pt/biblioteca/jw-apostila-do-mes/');
    const enUrl = prompt('URL JW.org EN:', 'https://www.jw.org/en/library/jw-meeting-workbook/');
    
    if (ptUrl && enUrl) {
      console.log('✅ URLs configuradas:', { ptUrl, enUrl });
      alert('✅ URLs JW.org configuradas com sucesso!');
    }
  }, []);

  const handleSyncCongregations = useCallback(async () => {
    console.log('🔄 Sincronizando com congregações...');
    try {
      // Simulação de sincronização
      const congregationsCount = staticStats.total_congregations;
      console.log(`✅ Sincronizando com ${congregationsCount} congregações`);
      alert(`🔄 Sincronização iniciada!\n\nProgramação oficial sendo enviada para ${congregationsCount} congregações...\n\nTempo estimado: ${Math.ceil(congregationsCount / 100)} minutos`);
    } catch (error) {
      console.error('❌ Erro na sincronização:', error);
      alert('Erro na sincronização: ' + error.message);
    }
  }, [staticStats]);

  // Programação Oficial
  const handleViewFullProgram = useCallback(() => {
    console.log('📅 Visualizando programação completa (3 meses)...');
    alert(`📅 Programação Completa dos Próximos 3 Meses\n\n` +
          `• Semanas carregadas: 12\n` +
          `• Idiomas: PT e EN\n` +
          `• Última atualização: Hoje\n\n` +
          `Esta visualização mostrará todas as apostilas MWB dos próximos 3 meses.`);
  }, []);

  const handleUpdateProgramPT = useCallback(async () => {
    console.log('🇧🇷 Atualizando programação PT...');
    try {
      jworg.setLanguage('pt');
      await jworg.fetchNextWeeks();
      console.log('✅ Programação PT atualizada');
      alert('✅ Programação em Português atualizada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao atualizar programação PT:', error);
      alert('Erro ao atualizar programação PT: ' + error.message);
    }
  }, [jworg]);

  const handleUpdateProgramEN = useCallback(async () => {
    console.log('🇺🇸 Atualizando programação EN...');
    try {
      jworg.setLanguage('en');
      await jworg.fetchNextWeeks();
      console.log('✅ Programação EN atualizada');
      alert('✅ Programação em Inglês atualizada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao atualizar programação EN:', error);
      alert('Erro ao atualizar programação EN: ' + error.message);
    }
  }, [jworg]);

  const handleCheckNewWeeks = useCallback(async () => {
    console.log('🔍 Verificando novas semanas...');
    try {
      await jworg.fetchNextWeeks();
      const newWeeks = jworg.nextWeeks.length;
      console.log(`✅ Verificação concluída: ${newWeeks} semanas`);
      alert(`🔍 Verificação concluída!\n\nEncontradas ${newWeeks} semanas de programação.\n\nTodas estão sincronizadas com JW.org.`);
    } catch (error) {
      console.error('❌ Erro ao verificar semanas:', error);
      alert('Erro ao verificar novas semanas: ' + error.message);
    }
  }, [jworg]);

  const handleUpdateS38Structure = useCallback(() => {
    console.log('🏗️ Atualizando estrutura S-38 global...');
    alert(`🏗️ Estrutura S-38 Global\n\n` +
          `✅ Partes da reunião atualizadas:\n` +
          `• Chairman\n• Treasures\n• Gems\n• Reading\n` +
          `• Starting\n• Following\n• Making\n• Explaining\n` +
          `• Talk\n\n` +
          `Esta estrutura será aplicada mundialmente.`);
  }, []);

  // JW.org Integration
  const handleReloadCurrentWeek = useCallback(async () => {
    console.log('🔄 Recarregando semana atual...');
    try {
      await jworg.fetchCurrentWeek();
      console.log('✅ Semana atual recarregada');
      alert('✅ Semana atual recarregada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao recarregar semana:', error);
      alert('Erro ao recarregar semana: ' + error.message);
    }
  }, [jworg]);

  const handleReloadNextWeeks = useCallback(async () => {
    console.log('📅 Recarregando próximas semanas...');
    try {
      await jworg.fetchNextWeeks();
      console.log('✅ Próximas semanas recarregadas');
      alert('✅ Próximas semanas recarregadas com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao recarregar próximas semanas:', error);
      alert('Erro ao recarregar próximas semanas: ' + error.message);
    }
  }, [jworg]);

  const handleTestDownloadPT = useCallback(async () => {
    console.log('🧪 Testando download PT...');
    try {
      jworg.setLanguage('pt');
      await jworg.downloadWorkbook('pt', '07', '2025');
      console.log('✅ Download PT testado');
      alert('✅ Download PT testado com sucesso!');
    } catch (error) {
      console.error('❌ Erro no teste de download PT:', error);
      alert('Erro no teste de download PT: ' + error.message);
    }
  }, [jworg]);

  // Monitoramento
  const handleViewAllLogs = useCallback(async () => {
    console.log('📋 Visualizando todos os logs...');
    try {
      // Simulação de logs
      const logs = [
        { timestamp: new Date().toLocaleString(), event: 'Sistema iniciado', level: 'info' },
        { timestamp: new Date(Date.now() - 3600000).toLocaleString(), event: 'Backup automático executado', level: 'info' },
        { timestamp: new Date(Date.now() - 86400000).toLocaleString(), event: 'Novo usuário registrado', level: 'info' },
        { timestamp: new Date(Date.now() - 172800000).toLocaleString(), event: 'Manutenção programada', level: 'warning' }
      ];
      
      const logText = logs.map(log => `${log.timestamp} [${log.level.toUpperCase()}] ${log.event}`).join('\n');
      alert(`📋 Logs do Sistema\n\n${logText}`);
    } catch (error) {
      console.error('❌ Erro ao carregar logs:', error);
      alert('Erro ao carregar logs: ' + error.message);
    }
  }, []);

  const handleTestJWorgIntegration = useCallback(async () => {
    console.log('🧪 Testando integração JW.org...');
    try {
      await jworg.fetchCurrentWeek();
      console.log('✅ Integração JW.org testada com sucesso');
      alert('✅ Integração JW.org funcionando perfeitamente!');
    } catch (error) {
      console.error('❌ Erro na integração JW.org:', error);
      alert('❌ Erro na integração JW.org: ' + error.message);
    }
  }, [jworg]);

  const handleChangeLanguage = useCallback((newLang: 'pt' | 'en') => {
    jworg.setLanguage(newLang);
    console.log(`🌐 Idioma alterado para: ${newLang}`);
    alert(`🌐 Idioma alterado para: ${newLang === 'pt' ? 'Português' : 'English'}`);
  }, [jworg]);

  // Alterna o idioma atual entre PT/EN
  const toggleLanguage = useCallback(() => {
    const current = (jworg as any)?.currentLanguage ?? 'pt';
    const next = current === 'pt' ? 'en' : 'pt';
    jworg.setLanguage(next);
    console.log(`🌐 Idioma alternado: ${current} -> ${next}`);
    alert(`🌐 Idioma alternado para: ${next === 'pt' ? 'Português' : 'English'}`);
  }, [jworg]);

  // Atualiza materiais JW.org (semana atual + próximas semanas)
  const updateMaterials = useCallback(async () => {
    try {
      await jworg.fetchCurrentWeek();
      await jworg.fetchNextWeeks();
      console.log('✅ Materiais JW.org atualizados');
      alert('✅ Materiais JW.org atualizados com sucesso!');
    } catch (error: any) {
      console.error('❌ Erro ao atualizar materiais:', error);
      alert('❌ Erro ao atualizar materiais: ' + (error?.message || error));
    }
  }, [jworg]);

  // NOW CHECK CONDITIONS AND RENDER APPROPRIATELY
  // Se não for admin, mostrar mensagem de acesso negado
  if (user && !isAdmin) {
    return (
      <div className="container mx-auto px-4 py-8">
        <Card className="max-w-md mx-auto">
          <CardHeader>
            <CardTitle className="text-red-600">Acesso Negado</CardTitle>
            <CardDescription>
              Você não tem permissão para acessar o painel administrativo.
            </CardDescription>
          </CardHeader>
          <CardContent>
            <p className="text-sm text-muted-foreground mb-4">
              Seu perfil atual: <strong>{profile?.role}</strong>
            </p>
            <Button onClick={() => window.history.back()}>
              Voltar
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Se não houver usuário, mostrar loading
  if (!user) {
    return (
      <div className="container mx-auto px-4 py-8">
        <Card className="max-w-md mx-auto">
          <CardHeader>
            <CardTitle>Carregando...</CardTitle>
            <CardDescription>
              Verificando autenticação...
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="flex items-center justify-center">
              <RefreshCw className="h-6 w-6 animate-spin" />
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background">
      {/* Auth Error Handler */}
      <AuthErrorHandler />
      
      {/* Header */}
      <div className="border-b">
        <div className="container mx-auto px-4 py-6">
          <div className="flex flex-col space-y-4">
          <div className="flex items-center justify-between">
            <div>
                <h1 className="text-3xl font-bold tracking-tight">📊 Dashboard do Administrador Geral</h1>
                <p className="text-muted-foreground">
                  Programação oficial das reuniões ministeriais - Padronização mundial para todas as congregações
              </p>
            </div>
              <div className="flex items-center space-x-2">
              {/* Force Profile Load Button */}
              {import.meta.env.DEV && (
                <Button 
                  variant="outline" 
                  size="sm"
                    onClick={testSupabaseConnection}
                  >
                    🔧 Test Supabase
                </Button>
              )}
              
              <Button onClick={checkForUpdates} disabled={loading}>
                <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
                  Atualizar
              </Button>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Debug Info Panel */}
      {import.meta.env.DEV && (
        <div className="container mx-auto px-4 py-2">
          <Card className="bg-yellow-50 border-yellow-200">
            <CardHeader className="pb-2">
              <CardTitle className="text-sm text-yellow-800">🐛 Debug Info (Development Only)</CardTitle>
            </CardHeader>
            <CardContent>
              <pre className="text-xs text-yellow-700 overflow-auto max-h-40">
                {debugInfo}
              </pre>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Main Content */}
      <div className="container mx-auto px-4 py-6">
        <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-6">
          <TabsList className="grid w-full grid-cols-4">
            <TabsTrigger value="overview">Visão Geral</TabsTrigger>
            <TabsTrigger value="users">Usuários</TabsTrigger>
            <TabsTrigger value="congregations">Congregações</TabsTrigger>
            <TabsTrigger value="system">Sistema</TabsTrigger>
          </TabsList>

          {/* Visão Geral */}
          <TabsContent value="overview" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                🎯 Sistema Ministerial Global - Padronização Mundial
              </h3>
              <div className="text-center text-sm text-muted-foreground mt-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
                <strong>📊 Admin Geral:</strong> Disponibiliza programação oficial semanal (SEM nomes de estudantes) <br/>
                <strong>🎓 Instrutores:</strong> Recebem programação automaticamente + fazem designações locais reais
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Congregações Conectadas</CardTitle>
                  <Globe className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">{staticStats.total_congregations}</div>
                  <p className="text-xs text-muted-foreground">
                    Recebendo programação oficial
                  </p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Semanas Programadas</CardTitle>
                  <BarChart3 className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">12</div>
                  <p className="text-xs text-muted-foreground">
                    Próximas 3 meses
                  </p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Idiomas Disponíveis</CardTitle>
                  <Globe className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">2</div>
                  <p className="text-xs text-muted-foreground">
                    Português e Inglês
                  </p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Última Sincronização</CardTitle>
                  <RefreshCw className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">✅</div>
                  <p className="text-xs text-muted-foreground">
                    Hoje, {new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                  </p>
                </CardContent>
              </Card>
            </div>

            {/* Ações Rápidas */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Status do Sistema */}
              <Card>
                <CardHeader>
                  <CardTitle>Status do Sistema</CardTitle>
                  <CardDescription>
                    Informações sobre a última verificação e status geral
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Última Verificação:</span>
                    <span className="text-sm text-muted-foreground">
                      {lastCheck ? new Date(lastCheck).toLocaleString('pt-BR') : 'Nunca'}
                    </span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Status:</span>
                    <Badge variant="outline" className="text-green-600">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Operacional
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Supabase:</span>
                    <Badge variant="outline" className="text-green-600">
                      <Database className="h-3 w-3 mr-1" />
                      Conectado
                    </Badge>
                  </div>
                </CardContent>
              </Card>

              {/* Programações Publicadas */}
              <Card>
                <CardHeader>
                  <CardTitle>Programações Publicadas</CardTitle>
                  <CardDescription>
                    Últimas semanas importadas/publicadas
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  {programsLoading ? (
                    <div className="text-sm text-muted-foreground">Carregando...</div>
                  ) : programs.length === 0 ? (
                    <div className="text-sm text-muted-foreground">Nenhuma programação encontrada.</div>
                  ) : (
                    <div className="space-y-2">
                      {programs.map((p) => (
                        <div key={p.id} className="p-2 border rounded-md">
                          <div className="flex items-center justify-between">
                            <div className="text-sm">
                              <div className="font-medium">Semana {p.semana || '—'} • {p.mes_apostila || '—'}</div>
                              <div className="text-xs text-muted-foreground">
                                {p.data_inicio_semana ? new Date(p.data_inicio_semana).toLocaleDateString('pt-BR') : '—'}
                              </div>
                            </div>
                            <Badge variant="outline" className={p.status === 'ativo' || p.status === 'publicado' ? 'bg-green-50 text-green-700' : ''}>
                              {p.status || '—'}
                            </Badge>
                          </div>
                          {p.arquivo && (
                            <div className="mt-2">
                              <a
                                href={`http://localhost:3001/materials/${encodeURIComponent(p.arquivo)}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="text-blue-600 text-xs underline"
                              >
                                Abrir material ({p.arquivo})
                              </a>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </CardContent>
              </Card>

              {/* JW.org Downloads */}
              <Card className="bg-green-50 border-green-200">
                <CardHeader>
                  <CardTitle className="text-green-800">📚 JW.org Downloads</CardTitle>
                  <CardDescription className="text-green-700">
                    Gerenciar materiais oficiais
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Apostila MWB Atual:</span>
                    <Badge variant="outline" className="text-green-600">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Disponível
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Última verificação:</span>
                    <span className="text-sm text-green-700">Hoje, 10:30</span>
                  </div>
                  <div className="flex space-x-2">
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleMWBAvailable}>
                      <RefreshCw className="h-3 w-3 mr-1" />
                      Disponibilizar MWB Atual
                    </Button>
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleConfigureJWorgURLs}>
                      <Settings className="h-3 w-3 mr-1" />
                      Configurar URLs JW.org
                    </Button>
                  </div>
                </CardContent>
              </Card>

              {/* Sistema S-38 - Designações */}
              <Card className="bg-purple-50 border-purple-200">
                <CardHeader>
                  <CardTitle className="text-purple-800">⚙️ Sistema S-38</CardTitle>
                  <CardDescription className="text-purple-700">
                    Estrutura das reuniões ministeriais
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="text-sm text-purple-700 space-y-2">
                    <p>📚 <strong>Função do Admin:</strong> Disponibilizar apostilas MWB</p>
                    <p>👥 <strong>Para Instrutores:</strong> Designar estudantes para partes</p>
                    <p>🎯 <strong>Partes da Reunião:</strong></p>
                    <div className="grid grid-cols-2 gap-1 text-xs ml-2">
                      <div>• Chairman</div>
                      <div>• Treasures</div>
                      <div>• Gems</div>
                      <div>• Reading</div>
                      <div>• Starting</div>
                      <div>• Following</div>
                      <div>• Making</div>
                      <div>• Explaining</div>
                      <div>• Talk</div>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Debug / Integração */}
              <Card className="bg-slate-50 border-slate-200">
                <CardHeader>
                  <CardTitle className="text-slate-800">🧪 Debug / Integração</CardTitle>
                  <CardDescription className="text-slate-700">
                    Ferramentas rápidas para validar integrações e idioma
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-3">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Idioma Atual:</span>
                    <Badge variant="outline" className="text-slate-700">
                      {(jworg as any)?.currentLanguage === 'en' ? '🇺🇸 English' : '🇧🇷 Português'}
                    </Badge>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    <Button size="sm" variant="outline" onClick={toggleLanguage}>
                      Alternar Idioma
                    </Button>
                    <Button size="sm" variant="outline" onClick={updateMaterials}>
                      Atualizar Materiais
                    </Button>
                    <Button size="sm" variant="outline" onClick={handleTestJWorgIntegration}>
                      Testar Integração JW.org
                    </Button>
                    <Button size="sm" variant="outline" onClick={checkForUpdates} disabled={loading}>
                      Atualizar Contagens
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          {/* Usuários */}
          <TabsContent value="users" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                👥 Gestão de Usuários para Acesso às Apostilas MWB
              </h3>
              <p className="text-center text-sm text-muted-foreground mt-2">
                🎯 Função Principal: Admin gerencia usuários → Instrutores acessam apostilas
              </p>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Estatísticas de Usuários */}
            <Card>
              <CardHeader>
                  <CardTitle>Estatísticas</CardTitle>
                  <CardDescription>Resumo dos usuários</CardDescription>
              </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Total de Usuários:</span>
                      <Badge variant="outline">{staticStats.total_users}</Badge>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Admins:</span>
                      <Badge variant="outline" className="bg-red-50 text-red-700">
                        {isAdmin ? 1 : 0}
                      </Badge>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Instrutores:</span>
                      <Badge variant="outline" className="bg-blue-50 text-blue-700">
                        {staticStats.total_users - (isAdmin ? 1 : 0)}
                      </Badge>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Usuários Registrados */}
              <Card className="lg:col-span-2">
                <CardHeader>
                  <CardTitle>Usuários Registrados</CardTitle>
                  <CardDescription>Últimos usuários cadastrados no sistema</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between p-3 border rounded-lg">
                      <div className="flex items-center space-x-3">
                        <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                          <Users className="h-5 w-5 text-blue-600" />
                        </div>
                        <div>
                          <p className="font-medium">{profile?.nome_completo || 'Roberto Araujo da Silva'}</p>
                          <p className="text-sm text-muted-foreground">Administrator</p>
                        </div>
                      </div>
                      <Badge variant="outline" className="bg-red-50 text-red-700">
                        Admin
                      </Badge>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Ações Administrativas */}
            <Card>
              <CardHeader>
                <CardTitle>Ações Administrativas</CardTitle>
                <CardDescription>
                  Gerenciar usuários e permissões
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <Button className="w-full justify-start" variant="outline" onClick={handleListUsers}>
                    <Users className="h-4 w-4 mr-2" />
                    Listar Todos os Usuários
                  </Button>
                  <Button className="w-full justify-start" variant="outline" onClick={handleManagePermissions}>
                    <Settings className="h-4 w-4 mr-2" />
                    Gerenciar Permissões
                  </Button>
                  <Button className="w-full justify-start" variant="outline" onClick={handleActivityReport}>
                    <Activity className="h-4 w-4 mr-2" />
                    Relatório de Atividades
                  </Button>
                  <Button className="w-full justify-start" variant="outline" onClick={handleBackupData}>
                    <Database className="h-4 w-4 mr-2" />
                    Backup de Dados
                  </Button>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Congregações */}
          <TabsContent value="congregations" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                🏢 Gestão de Congregações para Acesso às Apostilas MWB
              </h3>
              <p className="text-center text-sm text-muted-foreground mt-2">
                🎯 Função Principal: Admin gerencia congregações → Instrutores acessam apostilas
              </p>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Estatísticas de Congregações */}
            <Card>
              <CardHeader>
                  <CardTitle>Estatísticas</CardTitle>
                  <CardDescription>Resumo das congregações</CardDescription>
              </CardHeader>
              <CardContent>
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Total de Congregações:</span>
                      <Badge variant="outline">{staticStats.total_congregations}</Badge>
                  </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Congregações Ativas:</span>
                      <Badge variant="outline" className="bg-green-50 text-green-700">
                        {staticStats.active_congregations}
                      </Badge>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Total de Estudantes:</span>
                      <Badge variant="outline">{staticStats.total_estudantes}</Badge>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Lista de Congregações */}
              <Card className="lg:col-span-2">
                <CardHeader>
                  <CardTitle>Congregações Registradas</CardTitle>
                  <CardDescription>Lista das congregações no sistema</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between p-3 border rounded-lg">
                      <div className="flex items-center space-x-3">
                        <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                          <Package className="h-5 w-5 text-blue-600" />
                        </div>
                        <div>
                          <p className="font-medium">Sistema Ministerial Global</p>
                          <p className="text-sm text-muted-foreground">Congregação Principal</p>
                          </div>
                        </div>
                      <Badge variant="outline" className="bg-green-50 text-green-700">
                        Ativa
                        </Badge>
                      </div>
                  </div>
                  
                  <div className="mt-4">
                    <Button variant="outline" className="w-full" onClick={() => handleManageCongregation('Sistema Ministerial Global')}>
                      <Users className="h-4 w-4 mr-2" />
                      Gerenciar
                    </Button>
                  </div>
                  
                  <div className="mt-4">
                    <Button variant="outline" className="w-full" onClick={handleAddCongregation}>
                      <Users className="h-4 w-4 mr-2" />
                      Adicionar Nova Congregação
                    </Button>
                  </div>
                  
                  <div className="mt-4">
                    <Button variant="outline" className="w-full">
                      <Users className="h-4 w-4 mr-2" />
                      Expandir
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          {/* Sistema */}
          <TabsContent value="system" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                ⚙️ Monitoramento e Configurações do Sistema
              </h3>
              <p className="text-center text-sm text-muted-foreground mt-2">
                🎯 Função Principal: Admin monitora sistema → Instrutores recebem apostilas estáveis
              </p>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Downloads JW.org */}
              <Card className="bg-green-50 border-green-200">
              <CardHeader>
                  <CardTitle className="text-green-800">📚 JW.org Downloads</CardTitle>
                  <CardDescription className="text-green-700">
                    Gerenciar materiais oficiais
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Apostila MWB Atual:</span>
                    <Badge variant="outline" className="text-green-600">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Disponível
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Última verificação:</span>
                    <span className="text-sm text-green-700">Hoje, 10:30</span>
                  </div>
                  <div className="flex space-x-2">
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleSyncCongregations}>
                      <RefreshCw className="h-3 w-3 mr-1" />
                      Sincronizar com Congregações
                    </Button>
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleViewFullProgram}>
                      <Settings className="h-3 w-3 mr-1" />
                      Ver Programação Completa
                    </Button>
                </div>
              </CardContent>
            </Card>

              {/* Configurações Gerais */}
            <Card>
              <CardHeader>
                  <CardTitle>Configurações Gerais</CardTitle>
                <CardDescription>
                    Parâmetros do sistema
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                    <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Backup Automático:</span>
                    <Badge variant="outline" className="bg-green-50 text-green-700">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Diário às 02:00
                      </Badge>
                    </div>
                    <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Notificações:</span>
                    <Badge variant="outline" className="bg-blue-50 text-blue-700">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Email + Sistema
                    </Badge>
                    </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Manutenção:</span>
                    <span className="text-sm text-muted-foreground">Última: Ontem</span>
                  </div>
                  <div className="flex space-x-2">
                    <Button size="sm" variant="outline">
                      <Settings className="h-3 w-3 mr-1" />
                      Configurar
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Métricas do Sistema */}
            <Card>
              <CardHeader>
                <CardTitle>Métricas do Sistema</CardTitle>
                <CardDescription>
                  Monitoramento em tempo real
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-green-600">99.9%</p>
                    <p className="text-sm text-muted-foreground">Uptime</p>
                  </div>
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-blue-600">~120ms</p>
                    <p className="text-sm text-muted-foreground">Latência</p>
                  </div>
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-green-600">25%</p>
                    <p className="text-sm text-muted-foreground">CPU</p>
                  </div>
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-blue-600">33%</p>
                    <p className="text-sm text-muted-foreground">Memória</p>
                  </div>
                </div>

                <Separator />

                <div className="space-y-3">
                    <div className="flex items-center justify-between">
                    <span className="text-sm">CPU:</span>
                    <div className="flex items-center space-x-2">
                      <div className="w-24 h-2 bg-gray-200 rounded-full">
                        <div className="w-1/4 h-2 bg-green-500 rounded-full"></div>
                    </div>
                        <span className="text-sm">25%</span>
                  </div>
                    </div>
                    
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Memória:</span>
                      <div className="flex items-center space-x-2">
                        <div className="w-24 h-2 bg-gray-200 rounded-full">
                          <div className="w-1/3 h-2 bg-blue-500 rounded-full"></div>
                    </div>
                        <span className="text-sm">33%</span>
                      </div>
                    </div>
                    
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Banco:</span>
                      <div className="flex items-center space-x-2">
                        <CheckCircle className="h-4 w-4 text-green-500" />
                        <span className="text-sm">Conectado</span>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

              {/* Logs e Atividades */}
              <Card>
                <CardHeader>
                  <CardTitle>Logs Recentes</CardTitle>
                  <CardDescription>
                    Últimas atividades do sistema
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <CheckCircle className="h-4 w-4 text-green-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Sistema iniciado</p>
                        <p className="text-xs text-muted-foreground">Hoje, 08:00</p>
                      </div>
                    </div>

                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <Activity className="h-4 w-4 text-blue-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Backup automático executado</p>
                        <p className="text-xs text-muted-foreground">Hoje, 02:00</p>
                      </div>
                    </div>

                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <Users className="h-4 w-4 text-green-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Novo usuário registrado</p>
                        <p className="text-xs text-muted-foreground">Ontem, 16:30</p>
                      </div>
                    </div>

                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <AlertCircle className="h-4 w-4 text-yellow-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Manutenção programada</p>
                        <p className="text-xs text-muted-foreground">Ontem, 03:00</p>
                      </div>
                    </div>
                  </div>

                  <div className="mt-4">
                    <Button variant="outline" className="w-full" onClick={handleViewAllLogs}>
                      <FileText className="h-4 w-4 mr-2" />
                      Ver Todos os Logs
                    </Button>
                  </div>
                </CardContent>
              </Card>
          </TabsContent>
        </Tabs>
      </div>
    </div>
  );
}

```

Removi a consulta à tabela `congregacoes` no `AdminDashboard` para evitar o 404 (a tabela não existe no seu projeto). Agora só contamos `profiles`, `estudantes` e `programas`. Recarregue o Admin e o erro 404 do HEAD deve desaparecer.

---

**User**

toda vez que eu aperto f5 no teclado o aplicativo fica em branco e nao volta a nao ser que eu remova os dados no site no console. isso eh muito desagradavel. 
Carregando Sistema Ministerial
Inicializando autenticação e permissões...

Debug
🌐 Language Debug
Hook Language: pt
Context Language: pt
Test PT: Bem-vindo
Test EN: Início
Toggle Language  em http://localhost:8080/admin 

---

**Cursor**

Provável causa: estado/auth persistido corrompido (localStorage/IndexedDB) ou SW em cache após F5, que trava a hidratação e deixa a tela em branco até você limpar os dados.

Correções recomendadas (rápidas e seguras):
- Desabilitar SW no dev
  - Em `sw-register.ts`, não registre o SW em `import.meta.env.DEV` (ou retorne cedo). Rebuild e F5.
- Inicialização de auth com guarda
  - No `AuthContext`, antes de renderizar a árvore:
    - Faça `await supabase.auth.getSession()`, escute `onAuthStateChange`.
    - Mantenha `ready=false` e só renderize `<children/>` quando `ready=true`.
- Sanitizar persistência
  - Ao ler `localStorage`/`sessionStorage`, envolva em `try/catch`. Se `JSON.parse` falhar, remova a key.
  - Zere qualquer cache de idioma/chaves antigas que seu app usa (ex.: `i18nextLng`, chaves de contexto).
- Fallback de erro
  - Garanta um ErrorBoundary global (ex.: `react-error-boundary`) e, em erro, mostre botão “Resetar cache local” que limpa `localStorage` e `IndexedDB` (apenas no dev) e recarrega.

Se quiser, eu aplico agora:
- Guardas no `AuthContext` (ready gate + try/catch de storage).
- Skip do SW em dev.
- ErrorBoundary com botão “Limpar cache e recarregar”.

---

**User**

resolva

---

**Cursor**

Vou aplicar três correções: desativar o Service Worker em desenvolvimento, adicionar um “ready gate” no `AuthContext` para evitar tela branca ao hidratar, e colocar um ErrorBoundary global com botão para limpar cache local e recarregar. Vou abrir os arquivos relevantes para fazer os edits.

```typescript
// Service Worker registration with robust error handling and cache cleanup

interface SWRegister {
  register(): void;
  handleChunkError(event: ErrorEvent): Promise<void>;
  clearCaches(): Promise<void>;
  unregister(): Promise<void>;
}

const swRegister: SWRegister = {
  register() {
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        // Limpar caches antigos antes de registrar
        this.clearCaches().then(() => {
          navigator.serviceWorker.register('/sw.js', {
            updateViaCache: 'none' // Sempre buscar nova versão
          })
            .then((registration) => {
              console.log('✅ Service Worker registered successfully:', registration);
              
              // Verificar se há atualizações
              registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                if (newWorker) {
                  newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                      console.log('🔄 New Service Worker available');
                      // Opcional: mostrar notificação para o usuário atualizar
                    }
                  });
                }
              });
            })
            .catch((registrationError) => {
              console.warn('⚠️ Service Worker registration failed:', registrationError);
              // Tentar limpar caches e tentar novamente
              this.clearCaches().then(() => {
                console.log('🔄 Retrying Service Worker registration...');
                setTimeout(() => this.register(), 1000);
              });
            });
        });
      });
    }
  },

  async handleChunkError(event: ErrorEvent) {
    const msg = String(event?.message || '');
    if (/ChunkLoadError|Loading chunk \d+ failed/i.test(msg)) {
      console.log('🚨 Chunk loading error detected, clearing caches and reloading...');
      await this.clearCaches();
      location.reload();
    }
  },

  async clearCaches() {
    if ('caches' in window) {
      try {
        const cacheNames = await caches.keys();
        await Promise.all(
          cacheNames.map(cacheName => {
            console.log('🗑️ Deleting cache:', cacheName);
            return caches.delete(cacheName);
          })
        );
        console.log('✅ All caches cleared successfully');
      } catch (error) {
        console.error('❌ Error clearing caches:', error);
      }
    }
  },

  async unregister() {
    if ('serviceWorker' in navigator) {
      try {
        const registration = await navigator.serviceWorker.getRegistration();
        if (registration) {
          await registration.unregister();
          console.log('✅ Service Worker unregistered');
        }
      } catch (error) {
        console.error('❌ Error unregistering Service Worker:', error);
      }
    }
  }
};

// Registrar service worker somente em produção (desabilitado em dev)
if (import.meta.env.PROD) {
  swRegister.register();
}

// Listener para erros de chunk
window.addEventListener('error', (event) => {
  swRegister.handleChunkError(event);
});

// Listener para erros não capturados
window.addEventListener('unhandledrejection', (event) => {
  console.warn('⚠️ Unhandled promise rejection:', event.reason);
  
  // Se for erro de cache, limpar caches
  if (event.reason && event.reason.message && 
      event.reason.message.includes('Cache')) {
    console.log('🗑️ Cache error detected, clearing caches...');
    swRegister.clearCaches();
  }
});

// Expor funções para debug
(window as any).swRegister = swRegister;

export default swRegister;
```

```typescriptreact
import { createContext, useContext, useEffect, useState, useCallback } from 'react';
import { User, Session } from '@supabase/supabase-js';
import { supabase } from '@/integrations/supabase/client';
import { Database } from '@/integrations/supabase/types';
import { smartLogout } from '@/utils/forceLogout';
import { withRefreshTokenErrorHandling, recoverSessionWithErrorHandling } from '@/utils/refreshTokenHandler';

// Types
type UserRole = Database['public']['Enums']['user_role'];

interface UserProfile {
  id: string;
  nome_completo: string | null;
  congregacao: string | null;
  cargo: string | null;
  role: UserRole;
  date_of_birth: string | null;
  email: string;
  created_at: string | null;
  updated_at: string | null;
}

interface SignUpData {
  email: string;
  password: string;
  nome_completo: string;
  congregacao: string;
  cargo?: string;
  role: UserRole;
  date_of_birth?: string;
}

interface AuthContextType {
  user: User | null;
  session: Session | null;
  profile: UserProfile | null;
  loading: boolean;
  signUp: (data: SignUpData) => Promise<{ error: Error | null }>;
  signIn: (email: string, password: string) => Promise<{ error: Error | null }>;
  signOut: () => Promise<{ error: Error | null }>;
  updateProfile: (updates: Partial<UserProfile>) => Promise<{ data: UserProfile | null; error: Error | null }>;
  isInstrutor: boolean;
  isEstudante: boolean;
  isAdmin: boolean;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [session, setSession] = useState<Session | null>(null);
  const [profile, setProfile] = useState<UserProfile | null>(null);
  const [loading, setLoading] = useState(true);
  const [ready, setReady] = useState(false);



  // Fetch user profile from database with simplified logic
  const fetchProfile = useCallback(async (userId: string): Promise<UserProfile | null> => {
    console.log('🔍 Fetching profile for user ID:', userId);

    try {
      // Step 1: Check current session
      console.log('🔐 Checking current session...');
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();

      if (sessionError) {
        console.error('❌ Session error:', sessionError);
        return await createProfileFromAuth(userId);
      }

      if (!session) {
        console.log('❌ No active session, using metadata fallback');
        return await createProfileFromAuth(userId);
      }

      if (session.user.id !== userId) {
        console.error('❌ Session user ID mismatch:', {
          sessionUserId: session.user.id,
          requestedUserId: userId
        });
        return null;
      }

      // Step 2: Fetch profile from database
      console.log('🔍 Fetching from profiles table...');
        const { data: profileData, error: profileError } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', userId as any)
          .single();

      if (profileError) {
        if (profileError.code === 'PGRST116') {
          console.log('📝 Profile not found in database, creating from auth metadata');
        } else {
          console.log('❌ Profile fetch error, using metadata fallback:', profileError);
        }
        return await createProfileFromAuth(userId);
      }

      if (profileData) {
        // Get email from session
        const email = session.user.email || '';
        const profileWithEmail = {
          ...(profileData as any),
          email
        };

        console.log('✅ Profile fetched successfully:', {
          id: profileWithEmail.id,
          nome_completo: profileWithEmail.nome_completo,
          role: profileWithEmail.role,
          email: profileWithEmail.email
        });

        return profileWithEmail;
      }

      console.log('❌ No profile data found, using metadata fallback');
      return await createProfileFromAuth(userId);

    } catch (error) {
      console.error('❌ Error in fetchProfile:', error);
      return await createProfileFromAuth(userId);
    }
  }, []);

  // Create profile from auth metadata with simplified logic
  const createProfileFromAuth = useCallback(async (userId: string) => {
    try {
      console.log('📝 Creating profile from auth metadata for user:', userId);

      // Get current user
      const { data: { user }, error: userError } = await supabase.auth.getUser();

      if (userError) {
        console.error('❌ Error getting user:', userError);
        return null;
      }

      if (!user) {
        console.error('❌ No user found');
        return null;
      }

      if (user.id !== userId) {
        console.error('❌ User ID mismatch in createProfileFromAuth');
        return null;
      }

      const metadata = user.user_metadata || {};
      console.log('📋 User metadata:', {
        hasMetadata: Object.keys(metadata).length > 0,
        role: metadata.role
      });

      // Try to insert profile in database
      const { data, error } = await supabase
        .from('profiles')
        .insert({
          id: userId,
          nome_completo: metadata.nome_completo || '',
          congregacao: metadata.congregacao || '',
          cargo: metadata.cargo || '',
          role: (metadata.role as UserRole) || 'instrutor'
        } as any)
        .select()
        .single();

      if (error) {
        console.error('❌ Error creating profile in database:', error);
        // Return profile from metadata even if DB insert fails
        const email = user.email || '';
        const fallbackProfile = {
          id: userId,
          nome_completo: metadata.nome_completo || '',
          congregacao: metadata.congregacao || '',
          cargo: metadata.cargo || '',
          role: (metadata.role as UserRole) || 'instrutor',
          date_of_birth: metadata.date_of_birth || null,
          email,
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        };
        console.log('🔄 Using fallback profile from metadata');
        return fallbackProfile as UserProfile;
      }

      // Return the profile with email from auth
      return {
        ...(data as any),
        email: user.email || ''
      } as UserProfile;
    } catch (error: unknown) {
      const errorMessage = error instanceof Error ? error.message : 'Unknown error';
      console.error('Error creating profile from auth:', errorMessage);
      return null;
    }
  }, []); // Empty dependency array since createProfileFromAuth doesn't depend on any props or state

  // Force profile loading for admin users
  const forceLoadProfile = useCallback(async () => {
    if (!user) return;
    
    console.log('🔧 Force loading profile for user:', user.id);
    
    try {
      // Direct database query to bypass potential RLS issues
      const { data: profileData, error: profileError } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', user.id as any)
        .single();

      if (profileError) {
        console.error('❌ Force profile load error:', profileError);
        return;
      }

      if (profileData) {
        console.log('✅ Force profile load successful:', profileData);
        setProfile({
          ...(profileData as any),
          email: user.email || ''
        });
      }
    } catch (error) {
      console.error('❌ Force profile load exception:', error);
    }
  }, [user]);

  // Force load profile when user is authenticated but profile is missing
  useEffect(() => {
    if (user && !profile && !loading) {
      console.log('🔧 User authenticated but profile missing, forcing load...');
      
      // Immediate profile load attempt
      forceLoadProfile();
      
      // Fallback timeout for faster UX
      const timeout = setTimeout(() => {
        if (!profile) {
          console.log('⏰ Profile load timeout, using metadata fallback');
          // Profile will be handled by ProtectedRoute timeout
        }
      }, 500); // Reduced to 500ms for faster fallback
      
      return () => clearTimeout(timeout);
    }
  }, [user, profile, loading, forceLoadProfile]);

  // Global function for direct login (available in console)
  useEffect(() => {
    if (typeof window !== 'undefined') {
      (window as any).forceAdminLogin = async () => {
        console.log('🔧 Force admin login initiated...');
        
        try {
          // Force login with admin credentials
          const { data, error } = await supabase.auth.signInWithPassword({
            email: 'amazonwebber007@gmail.com',
            password: 'admin123'
          });

          if (error) {
            console.error('❌ Force login error:', error);
            return;
          }

          if (data.user) {
            console.log('✅ Force login successful:', data.user);
            
            // Force load profile
            await forceLoadProfile();
          }
        } catch (error) {
          console.error('❌ Force login exception:', error);
        }
      };

      console.log('🔧 Force admin login function available: window.forceAdminLogin()');
    }
  }, [supabase.auth, forceLoadProfile]);

  useEffect(() => {
    // Get initial session with refresh token error handling
    const getInitialSession = async () => {
      try {
        console.log('🔄 Getting initial session...');

        const { session, error, recovered } = await recoverSessionWithErrorHandling();

        if (!recovered) {
          console.log('❌ Session recovery failed, user will need to log in again');
          setLoading(false);
          return;
        }

        if (error) {
          console.error('❌ Error getting initial session:', error);
          setLoading(false);
          return;
        }

        if (!session) {
          console.log('ℹ️ No session found');
          setLoading(false);
          return;
        }

        if (session?.user) {
          console.log('✅ Initial session found');
          setSession(session);
          setUser(session.user);

          // Fetch profile
          fetchProfile(session.user.id)
            .then(userProfile => {
              console.log('✅ Initial profile loaded successfully');
              setProfile(userProfile);
            })
            .catch((error: unknown) => {
              const errorMessage = error instanceof Error ? error.message : 'Unknown error';
              console.error('❌ Initial profile fetch failed:', errorMessage);
            });
        } else {
          console.log('ℹ️ No initial session found');
        }
      } catch (error: unknown) {
        const errorMessage = error instanceof Error ? error.message : 'Unknown error';
        console.error('Error in getInitialSession:', errorMessage);
      } finally {
        setLoading(false);
      }
    };

    getInitialSession();

    // Listen for auth changes with refresh token error handling
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      async (event, session) => {
        console.log('🔄 Auth state changed:', event, session?.user?.email);

        try {
          if (session?.user) {
            console.log('👤 Setting user and session...');
            setSession(session);
            setUser(session.user);

            // Fetch profile with error handling
            await withRefreshTokenErrorHandling(async () => {
              const userProfile = await fetchProfile(session.user.id);
              console.log('📋 Profile loaded:', userProfile);
              setProfile(userProfile);
            });
          } else {
            console.log('🚪 User signed out, clearing data...');
            setSession(null);
            setUser(null);
            setProfile(null);
          }
        } catch (error: unknown) {
          const errorMessage = error instanceof Error ? error.message : 'Unknown error';
          console.error('❌ Auth state change error:', errorMessage);
          
          // If it's a refresh token error, the global handler will take care of it
          if (errorMessage.includes('Authentication session expired')) {
            return; // Don't set loading to false, let the logout process handle it
          }
        }

        setLoading(false);
      }
    );

    return () => subscription.unsubscribe();
  }, [fetchProfile]);

  // Mark app ready after initial auth check completes
  useEffect(() => {
    if (!loading) {
      setReady(true);
    }
  }, [loading]);

  const signUp = async (data: SignUpData) => {
    try {
      const { error } = await supabase.auth.signUp({
        email: data.email,
        password: data.password,
        options: {
          data: {
            nome_completo: data.nome_completo,
            congregacao: data.congregacao,
            cargo: data.cargo || '',
            role: data.role,
            date_of_birth: data.date_of_birth || null,
          },
        },
      });

      if (error) {
        console.error('SignUp error:', error);
      }

      return { error };
    } catch (error) {
      console.error('SignUp exception:', error);
      return { error };
    }
  };

  const signIn = async (email: string, password: string) => {
    try {
      const { error } = await withRefreshTokenErrorHandling(async () => {
        const result = await supabase.auth.signInWithPassword({
          email,
          password,
        });
        return result;
      });

      if (error) {
        console.error('SignIn error:', error);
      }

      return { error };
    } catch (error) {
      console.error('SignIn exception:', error);
      return { error };
    }
  };

  const signOut = async () => {
    console.log('🔄 AuthContext signOut called');
    console.log('🔄 Current user:', user?.email, user?.id);
    console.log('🔄 Current session exists:', !!session);

    // Immediate local cleanup function
    const clearLocalState = () => {
      console.log('🧹 Clearing local auth state...');
      setUser(null);
      setSession(null);
      setProfile(null);

      // Clear any stored tokens/data
      localStorage.removeItem('supabase.auth.token');
      sessionStorage.clear();
    };

    try {
      console.log('🔄 Using smartLogout for robust logout...');
      
      // Use smartLogout which handles timeouts and fallbacks
      await smartLogout(async () => {
        console.log('🔄 Attempting Supabase signOut...');
        return await supabase.auth.signOut();
      });
      
      // If we reach here, logout was successful
      console.log('✅ Smart logout completed successfully');
      clearLocalState();
      return { error: null };
      
    } catch (error) {
      console.error('❌ SignOut exception:', error);
      
      // Always clear local state on any error
      clearLocalState();
      
      // Return success to UI since local cleanup is what matters for UX
      return { error: null };
    }
  };

  const updateProfile = async (updates: Partial<UserProfile>) => {
    if (!user) {
      return { data: null, error: new Error('No user logged in') };
    }

    try {
      const { data, error } = await supabase
        .from('profiles')
        .update(updates as any)
        .eq('id', user.id as any)
        .select()
        .single();

      if (error) {
        return { data: null, error: new Error(error.message) };
      }

      // Refresh and return the fully-typed profile (including email)
      const updatedProfile = await fetchProfile(user.id);
      setProfile(updatedProfile);
      return { data: updatedProfile, error: null };
    } catch (err: unknown) {
      const e = err instanceof Error ? err : new Error('UpdateProfile exception');
      console.error('UpdateProfile exception:', e);
      return { data: null, error: e };
    }
  };

  // Computed properties for role checking
  const isInstrutor = profile?.role === 'instrutor';
  const isEstudante = profile?.role === 'estudante';
  const isAdmin = profile?.role === 'admin';

  const value = {
    user,
    session,
    profile,
    loading,
    signUp,
    signIn,
    signOut,
    updateProfile,
    isInstrutor,
    isEstudante,
    isAdmin,
  };

  return (
    <AuthContext.Provider value={value}>
      {ready ? children : (
        <div className="min-h-screen flex items-center justify-center">
          <div className="text-sm text-muted-foreground">
            Carregando Sistema Ministerial<br/>
            Inicializando autenticação e permissões...
          </div>
        </div>
      )}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
}
```

Apliquei correções para eliminar a tela branca após F5:

- Service Worker: garantido que não registra em desenvolvimento (somente em produção). Arquivo: `src/sw-register.ts`.
- Auth “ready gate”: o app só renderiza após a checagem inicial de sessão, evitando render parcial/corrompida. Arquivo: `src/contexts/AuthContext.tsx`.

Teste:
- Pare e reinicie o dev server.
- Abra http://localhost:8080/admin, faça login.
- Pressione F5: a tela deve mostrar o estado “Carregando…” por instantes e voltar normalmente, sem precisar limpar storage.

Se o problema persistir, adiciono um ErrorBoundary global com botão “Limpar cache e recarregar” para reset local (apenas em dev).

---

**User**

ficou pior agora , ficou tudo em branco Auth.tsx:17 Uncaught SyntaxError: The requested module '/src/lib/supabase.ts?t=1757334270841' does not provide an export named 'handleAuthError' (at Auth.tsx:17:10)
  

---

**Cursor**

```typescriptreact
import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { toast } from '@/hooks/use-toast';
import { useAuth } from '@/contexts/AuthContext';
import { useTranslation } from '@/hooks/useTranslation';
import { Eye, EyeOff, LogIn, UserPlus, Shield, BookOpen } from 'lucide-react';
import { Database } from '@/integrations/supabase/types';
import { CARGO_LABELS } from '@/types/estudantes';
import { LoginFeedback, TestCredentials } from '@/components/auth/SimpleLoginFeedback';
import { handleAuthError, validateLoginForm } from '@/utils/auth';

type UserRole = Database['public']['Enums']['user_role'];

const Auth = () => {
  const { t } = useTranslation();
  const [activeTab, setActiveTab] = useState('signin');
  const [showPassword, setShowPassword] = useState(false);
  const [loading, setLoading] = useState(false);

  // Sign In Form
  const [signInEmail, setSignInEmail] = useState('');
  const [signInPassword, setSignInPassword] = useState('');

  // Login feedback states
  const [loginError, setLoginError] = useState<string | null>(null);
  const [loginErrorType, setLoginErrorType] = useState<'error' | 'warning' | 'info' | null>(null);
  const [loginSuccess, setLoginSuccess] = useState<string | null>(null);

  // Sign Up Form
  const [signUpEmail, setSignUpEmail] = useState('');
  const [signUpPassword, setSignUpPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [nomeCompleto, setNomeCompleto] = useState('');
  const [dateOfBirth, setDateOfBirth] = useState('');
  const [congregacao, setCongregacao] = useState('');
  const [cargo, setCargo] = useState('');
  const [role, setRole] = useState<UserRole>('instrutor');

  const { signUp, signIn, user, profile, isInstrutor, isEstudante } = useAuth();
  const navigate = useNavigate();

  // Age validation function
  const validateAge = (birthDate: string): { isValid: boolean; age: number; message?: string } => {
    if (!birthDate) {
      return { isValid: false, age: 0, message: t('auth.validation.birthDateRequired') };
    }

    const today = new Date();
    const birth = new Date(birthDate);

    if (birth > today) {
      return { isValid: false, age: 0, message: t('auth.validation.birthDateFuture') };
    }

    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();

    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
      age--;
    }

    if (age < 6) {
      return { isValid: false, age, message: t('auth.validation.ageMinimum') };
    }

    if (age > 100) {
      return { isValid: false, age, message: t('auth.validation.ageMaximum') };
    }

    return { isValid: true, age };
  };

  // Redirect if already authenticated
  useEffect(() => {
    console.log('🔀 Auth redirect check:', {
      hasUser: !!user,
      hasProfile: !!profile,
      profileRole: profile?.role,
      userMetadataRole: user?.user_metadata?.role,
      isInstrutor,
      isEstudante,
      userId: user?.id
    });

    if (user) {
      // Primary redirect: Use profile data if available
      if (profile) {
        console.log('✅ Both user and profile exist, checking role...');
        if (isInstrutor) {
          console.log('👨‍🏫 Redirecting instructor to dashboard');
          navigate('/dashboard');
          return;
        } else if (isEstudante) {
          console.log('👨‍🎓 Redirecting student to portal:', `/estudante/${user.id}`);
          navigate(`/estudante/${user.id}`);
          return;
        } else if (profile.role === 'admin') {
          console.log('👑 Redirecting admin to admin dashboard');
          navigate('/admin');
          return;
        } else {
          console.log('⚠️ User has unknown role:', profile.role);
        }
      } else {
        // Fallback redirect: Use user metadata if profile is not loaded
        console.log('⚠️ Profile not loaded, checking user metadata for role...');
        const metadataRole = user.user_metadata?.role;

        if (metadataRole === 'instrutor') {
          console.log('👨‍🏫 Redirecting instructor to dashboard (via metadata)');
          navigate('/dashboard');
          return;
        } else if (metadataRole === 'estudante') {
          console.log('👨‍🎓 Redirecting student to portal (via metadata):', `/estudante/${user.id}`);
          navigate(`/estudante/${user.id}`);
          return;
        } else if (metadataRole === 'admin') {
          console.log('👑 Redirecting admin to admin dashboard (via metadata)');
          navigate('/admin');
          return;
        } else {
          console.log('⏳ Waiting for profile data to load... (metadata role:', metadataRole, ')');
        }
      }
    } else {
      console.log('⏳ Waiting for user authentication...');
    }
  }, [user, profile, isInstrutor, isEstudante, navigate]);

  const handleSignIn = async (e: React.FormEvent) => {
    e.preventDefault();

    // Limpar estados anteriores
    setLoginError(null);
    setLoginErrorType(null);
    setLoginSuccess(null);

    // Validação do formulário
    const validationErrors = validateLoginForm(signInEmail, signInPassword);
    if (validationErrors.length > 0) {
      setLoginError(validationErrors.join('. '));
      setLoginErrorType('error');
      return;
    }

    setLoading(true);

    try {
      const { error } = await signIn(signInEmail, signInPassword);

      if (error) {
        const { message, type } = handleAuthError(error);
        setLoginError(message);
        setLoginErrorType(type);
      } else {
        setLoginSuccess(t('auth.loginSuccess'));
        // O redirecionamento será feito pelo useEffect que monitora o user
      }
    } catch (error) {
      const { message, type } = handleAuthError(error);
      setLoginError(message);
      setLoginErrorType(type);
    } finally {
      setLoading(false);
    }
  };

  // Função para preencher credenciais de teste
  const handleFillTestCredentials = (type: 'instructor' | 'student' | 'simple') => {
    const credentials = {
      instructor: {
        email: 'frankwebber33@hotmail.com',
        password: 'senha123'
      },
      student: {
        email: 'franklinmarceloferreiradelima@gmail.com',
        password: 'senha123'
      },
      simple: {
        email: 'teste@sistema.com',
        password: '123456'
      }
    };

    const cred = credentials[type];
    setSignInEmail(cred.email);
    setSignInPassword(cred.password);

    // Limpar erros quando preencher credenciais
    setLoginError(null);
    setLoginErrorType(null);

    const typeTranslation = type === 'instructor' ? 'instrutor' : type === 'student' ? 'estudante' : 'teste';
    toast({
      title: t('auth.messages.credentialsFilled'),
      description: t('auth.messages.credentialsFilledDesc', { type: typeTranslation }),
    });
  };

  const handleSignUp = async (e: React.FormEvent) => {
    e.preventDefault();

    // Validation
    if (!signUpEmail || !signUpPassword || !nomeCompleto || !dateOfBirth || !congregacao) {
      toast({
        title: t('forms.error'),
        description: t('auth.validation.allFieldsRequired'),
        variant: "destructive"
      });
      return;
    }

    // Validate birth date and age
    const ageValidation = validateAge(dateOfBirth);
    if (!ageValidation.isValid) {
      toast({
        title: t('forms.error'),
        description: ageValidation.message,
        variant: "destructive"
      });
      return;
    }

    // Validate cargo for students
    if (role === 'estudante' && !cargo) {
      toast({
        title: t('forms.error'),
        description: t('auth.validation.roleRequired'),
        variant: "destructive"
      });
      return;
    }

    if (signUpPassword !== confirmPassword) {
      toast({
        title: t('forms.error'),
        description: t('auth.validation.passwordMismatch'),
        variant: "destructive"
      });
      return;
    }

    if (signUpPassword.length < 6) {
      toast({
        title: t('forms.error'),
        description: t('auth.validation.passwordMinLength'),
        variant: "destructive"
      });
      return;
    }

    setLoading(true);

    try {
      const { error } = await signUp({
        email: signUpEmail,
        password: signUpPassword,
        nome_completo: nomeCompleto,
        congregacao: congregacao,
        cargo: cargo,
        role: role,
        date_of_birth: dateOfBirth,
      });

      if (error) {
        let errorMessage = t('auth.validation.unexpectedError');

        if (error.message === 'User already registered') {
          errorMessage = t('auth.validation.emailAlreadyExists');
        } else if (error.message.includes('already registered')) {
          errorMessage = t('auth.validation.emailAlreadyExists');
        } else {
          errorMessage = error.message;
        }

        toast({
          title: t('auth.messages.signupError'),
          description: errorMessage,
          variant: "destructive"
        });
      } else {
        toast({
          title: t('auth.messages.accountCreated'),
          description: t('auth.messages.accountCreatedDesc'),
        });
        setActiveTab('signin');
        // Clear form
        setSignUpEmail('');
        setSignUpPassword('');
        setConfirmPassword('');
        setNomeCompleto('');
        setCongregacao('');
        setCargo('');
        setRole('instrutor');
      }
    } catch (error) {
      toast({
        title: t('forms.error'),
        description: t('auth.validation.unexpectedError'),
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  };

  const getRoleInfo = (role: UserRole) => {
    if (role === 'instrutor') {
      return {
        icon: Shield,
        title: t('auth.roles.instrutor.title'),
        description: t('auth.roles.instrutor.description'),
        features: [t('dashboard.manageStudents'), t('programs.importProgram'), t('assignments.generateNew'), t('reports.title')]
      };
    } else {
      return {
        icon: BookOpen,
        title: t('auth.roles.estudante.title'),
        description: t('auth.roles.estudante.description'),
        features: [t('portal.myAssignments'), t('portal.confirmParticipation'), t('portal.myProgress'), t('benefits.sustainability.title')]
      };
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-jw-navy via-jw-navy to-jw-blue flex items-center justify-center p-4">
      <Card className="w-full max-w-lg">
      <CardHeader className="text-center">
      <div className="flex items-center justify-center mb-4">
      <div className="w-12 h-12 bg-jw-blue rounded-lg flex items-center justify-center">
      <span className="text-white font-bold text-lg">SM</span>
      </div>
      </div>
      <CardTitle className="text-2xl text-jw-navy">
      {t('common.appName')}
      </CardTitle>
      <CardDescription>
      {t('terms.theocraticMinistrySchool')}
      </CardDescription>
      </CardHeader>

        <CardContent>
          <Tabs value={activeTab} onValueChange={setActiveTab} className="w-full">
            <TabsList className="grid w-full grid-cols-2">
              <TabsTrigger value="signin" className="flex items-center gap-2">
                <LogIn className="w-4 h-4" />
                {t('auth.login')}
              </TabsTrigger>
              <TabsTrigger value="signup" className="flex items-center gap-2">
                <UserPlus className="w-4 h-4" />
                {t('auth.signUp')}
              </TabsTrigger>
            </TabsList>

            {/* Sign In Tab */}
            <TabsContent value="signin" className="space-y-4">
              <form onSubmit={handleSignIn} className="space-y-4">
                <div className="space-y-2">
                  <Label htmlFor="signin-email">{t('auth.email')}</Label>
                  <Input
                    id="signin-email"
                    type="email"
                    value={signInEmail}
                    onChange={(e) => setSignInEmail(e.target.value)}
                    placeholder="your@email.com"
                    required
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="signin-password">{t('auth.password')}</Label>
                  <div className="relative">
                    <Input
                      id="signin-password"
                      type={showPassword ? "text" : "password"}
                      value={signInPassword}
                      onChange={(e) => setSignInPassword(e.target.value)}
                      placeholder="••••••••"
                      required
                      minLength={6}
                      autoComplete="current-password"
                    />
                    <Button
                      type="button"
                      variant="ghost"
                      size="sm"
                      className="absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent"
                      onClick={() => setShowPassword(!showPassword)}
                    >
                      {showPassword ? (
                        <EyeOff className="h-4 w-4" />
                      ) : (
                        <Eye className="h-4 w-4" />
                      )}
                    </Button>
                  </div>
                </div>

                <Button
                  type="submit"
                  className="w-full"
                  variant="hero"
                  disabled={loading}
                >
                  {loading ? t('auth.loggingIn') : t('auth.signIn')}
                </Button>
              </form>

              {/* Feedback de login */}
              <LoginFeedback
                loading={loading}
                error={loginError}
                errorType={loginErrorType}
                success={loginSuccess}
              />

              {/* Credenciais de teste para desenvolvimento */}
              <TestCredentials onFillCredentials={handleFillTestCredentials} />
            </TabsContent>
            {/* Sign Up Tab */}
            <TabsContent value="signup" className="space-y-4">
              <form onSubmit={handleSignUp} className="space-y-4">
                {/* Role Selection */}
                <div className="space-y-3">
                  <Label>{t('auth.accountType')} *</Label>
                  <div className="grid grid-cols-1 gap-3">
                    {(['instrutor', 'estudante'] as UserRole[]).map((roleOption) => {
                      const roleInfo = getRoleInfo(roleOption);
                      const IconComponent = roleInfo.icon;
                      return (
                        <div
                          key={roleOption}
                          className={`border rounded-lg p-4 cursor-pointer transition-all ${role === roleOption
                              ? 'border-jw-blue bg-jw-blue/5'
                              : 'border-gray-200 hover:border-gray-300'
                            }`}
                          onClick={() => setRole(roleOption)}
                        >
                          <div className="flex items-start gap-3">
                            <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${role === roleOption ? 'bg-jw-blue text-white' : 'bg-gray-100 text-gray-600'
                              }`}>
                              <IconComponent className="w-5 h-5" />
                            </div>
                            <div className="flex-1">
                              <div className="flex items-center gap-2">
                                <h3 className="font-medium">{t(`auth.roles.${roleOption}.title`)}</h3>
                                {role === roleOption && (
                                  <Badge variant="default" className="text-xs">{t('auth.selected')}</Badge>
                                )}
                              </div>
                              <p className="text-sm text-gray-600 mt-1">{t(`auth.roles.${roleOption}.description`)}</p>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>

                {/* Personal Information */}
                <div className="grid grid-cols-1 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="signup-nome">{t('auth.fullName')} *</Label>
                    <Input
                      id="signup-nome"
                      type="text"
                      value={nomeCompleto}
                      onChange={(e) => setNomeCompleto(e.target.value)}
                      placeholder={t('auth.fullNamePlaceholder')}
                      required
                    />
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="signup-birth-date">{t('auth.birthDate')} *</Label>
                    <Input
                      id="signup-birth-date"
                      type="date"
                      value={dateOfBirth}
                      onChange={(e) => setDateOfBirth(e.target.value)}
                      required
                      max={new Date().toISOString().split('T')[0]} // Prevent future dates
                      min={new Date(new Date().getFullYear() - 100, 0, 1).toISOString().split('T')[0]} // 100 years ago
                    />
                    {dateOfBirth && (() => {
                      const ageValidation = validateAge(dateOfBirth);
                      return (
                        <p className={`text-sm ${ageValidation.isValid ? 'text-green-600' : 'text-red-600'}`}>
                          {ageValidation.isValid
                            ? `${t('auth.age')}: ${ageValidation.age} ${t('auth.years')}`
                            : t(ageValidation.message)
                          }
                        </p>
                      );
                    })()}
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="signup-congregacao">{t('terms.congregation')} *</Label>
                    <Input
                      id="signup-congregacao"
                      type="text"
                      value={congregacao}
                      onChange={(e) => setCongregacao(e.target.value)}
                      placeholder={t('auth.congregationPlaceholder')}
                      required
                    />
                  </div>

                  {role === 'instrutor' && (
                    <div className="space-y-2">
                      <Label htmlFor="signup-cargo">{t('auth.roleOptional')}</Label>
                      <Select value={cargo} onValueChange={setCargo}>
                        <SelectTrigger>
                          <SelectValue placeholder={t('auth.selectRole')} />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="superintendente_escola">{t('auth.roles.superintendent')}</SelectItem>
                          <SelectItem value="conselheiro_assistente">{t('auth.roles.assistantCounselor')}</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
                  )}

                  {role === 'estudante' && (
                    <div className="space-y-2">
                      <Label htmlFor="signup-cargo-estudante">{t('auth.congregationRole')} *</Label>
                      <Select value={cargo} onValueChange={setCargo}>
                        <SelectTrigger>
                          <SelectValue placeholder={t('auth.selectRole')} />
                        </SelectTrigger>
                        <SelectContent>
                          {Object.entries(CARGO_LABELS).map(([value, label]) => (
                            <SelectItem key={value} value={value}>
                              {t(`terms.${value}`)}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    </div>
                  )}
                </div>

                {/* Account Information */}
                <div className="grid grid-cols-1 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="signup-email">{t('auth.email')} *</Label>
                    <Input
                      id="signup-email"
                      type="email"
                      value={signUpEmail}
                      onChange={(e) => setSignUpEmail(e.target.value)}
                      placeholder="your@email.com"
                      required
                    />
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="signup-password">{t('auth.password')} *</Label>
                    <div className="relative">
                      <Input
                        id="signup-password"
                        type={showPassword ? "text" : "password"}
                        value={signUpPassword}
                        onChange={(e) => setSignUpPassword(e.target.value)}
                        placeholder="••••••••"
                        required
                        minLength={6}
                      />
                      <Button
                        type="button"
                        variant="ghost"
                        size="sm"
                        className="absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent"
                        onClick={() => setShowPassword(!showPassword)}
                      >
                        {showPassword ? (
                          <EyeOff className="h-4 w-4" />
                        ) : (
                          <Eye className="h-4 w-4" />
                        )}
                      </Button>
                    </div>
                    <p className="text-xs text-gray-500">{t('auth.passwordMinLength')}</p>
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="confirm-password">{t('auth.confirmPassword')} *</Label>
                    <Input
                      id="confirm-password"
                      type={showPassword ? "text" : "password"}
                      value={confirmPassword}
                      onChange={(e) => setConfirmPassword(e.target.value)}
                      placeholder="••••••••"
                      required
                      minLength={6}
                    />
                  </div>
                </div>

                <Button
                  type="submit"
                  className="w-full"
                  variant="hero"
                  disabled={loading}
                >
                  {loading ? t('auth.creatingAccount') : t('auth.createAccount')}
                </Button>
              </form>
            </TabsContent>
          </Tabs>
        </CardContent>
      </Card>
    </div>
  );
};

export default Auth;
```

Corrigi a causa da tela branca:

- O erro vinha de Auth.tsx importando `handleAuthError` e `validateLoginForm` de `src/lib/supabase.ts`, que não exporta essas funções. Alterei para importar de `src/utils/auth.ts`, onde elas existem de fato.

Já feito:
- Desabilitado SW em dev.
- Gate de “ready” no `AuthContext`.
- Ajuste de import em `Auth.tsx`.

Por favor, salve e recarregue:
- Pare e rode `npm run dev:all` novamente (para garantir rebuild limpo).
- Acesse http://localhost:8080/admin e teste F5.

---

**User**

sim , mas omde aparece a programacao em http://localhost:8080/admin que esta em "C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_E_202507.pdf"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_E_202509.pdf"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_E_202511.pdf"

---

**Cursor**

Hoje, o Admin mostra “Programações Publicadas” apenas se houver linhas em `public.programas`. Os PDFs em `docs/Oficial` são servidos em `/materials`, mas não viram “programação” sozinhos. Para aparecer no card com link “Abrir material”, insira as linhas apontando para cada PDF:

Execute no Supabase (SQL editor):
```sql
insert into public.programas (semana, mes_apostila, status, data_inicio_semana, arquivo)
values
('2025-W31','2025-07','ativo','2025-07-01','mwb_E_202507.pdf'),
('2025-W37','2025-09','ativo','2025-09-01','mwb_E_202509.pdf'),
('2025-W45','2025-11','ativo','2025-11-01','mwb_E_202511.pdf');
```

Depois, recarregue http://localhost:8080/admin:
- O card “Programações Publicadas” listará as semanas.
- Cada item terá “Abrir material”, que abre:
  - http://localhost:3001/materials/mwb_E_202507.pdf
  - http://localhost:3001/materials/mwb_E_202509.pdf
  - http://localhost:3001/materials/mwb_E_202511.pdf

Quer que eu adicione um botão “Sincronizar materiais” no Admin para varrer `docs/Oficial` e criar/atualizar essas linhas automaticamente?

```sql
insert into public.programas (semana, mes_apostila, status, data_inicio_semana, arquivo)
values
('2025-W31','2025-07','ativo','2025-07-01','mwb_E_202507.pdf'),
('2025-W37','2025-09','ativo','2025-09-01','mwb_E_202509.pdf'),
('2025-W45','2025-11','ativo','2025-11-01','mwb_E_202511.pdf');
```

---

**User**

sim

---

**Cursor**

```typescriptreact
import React, { useState, useEffect, useCallback, useMemo, lazy, Suspense } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { supabase } from '../integrations/supabase/client';
import { useJWorgIntegration } from '../hooks/useJWorgIntegration';
import { JWorgTest } from '../components/JWorgTest';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../components/ui/card';
import LazyLoader from '../components/LazyLoader';
import AuthErrorHandler from '../components/AuthErrorHandler';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '../components/ui/tabs';
import { Button } from '../components/ui/button';
import { Badge } from '../components/ui/badge';
import { Separator } from '../components/ui/separator';
import { 
  Download, 
  Upload, 
  Globe, 
  BarChart3, 
  Settings, 
  RefreshCw,
  CheckCircle,
  AlertCircle,
  Clock,
  FileText,
  Users,
  Package,
  Activity,
  Database
} from 'lucide-react';

// 🚀 Lazy loading para componentes pesados (comentado por enquanto)
// const JWorgTestLazy = lazy(() => import('../components/JWorgTest'));

interface SystemStats {
  total_congregations: number;
  active_congregations: number;
  total_users: number;
  total_estudantes: number;
  total_programas: number;
  last_sync: string;
}

export default function AdminDashboard() {
  const { user, profile, isAdmin } = useAuth();
  const jworg = useJWorgIntegration();
  const [activeTab, setActiveTab] = useState('overview');
  const [loading, setLoading] = useState(false);
  const [systemStats, setSystemStats] = useState<SystemStats | null>(null);
  const [lastCheck, setLastCheck] = useState<string>('');
  const [debugInfo, setDebugInfo] = useState<string>('');
  const [showJWorgTest, setShowJWorgTest] = useState(false);
  const [programs, setPrograms] = useState<any[]>([]);
  const [programsLoading, setProgramsLoading] = useState<boolean>(false);

  // 🚀 Memoização de dados estáticos para reduzir re-renders
  const staticStats = useMemo(() => ({
    total_congregations: systemStats?.total_congregations || 0,
    active_congregations: systemStats?.active_congregations || 0,
    total_users: systemStats?.total_users || 0,
    total_estudantes: systemStats?.total_estudantes || 0,
    total_programas: systemStats?.total_programas || 0,
    last_sync: systemStats?.last_sync || ''
  }), [systemStats]);

  // 🚀 Debounced function para reduzir chamadas desnecessárias
  const debouncedSetDebugInfo = useCallback((info: string) => {
    let timeoutId: NodeJS.Timeout;
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => setDebugInfo(info), 100);
  }, []);

  // DEBUG: Log component state (otimizado)
  useEffect(() => {
    const debugData = {
      user: !!user,
      userId: user?.id,
      userEmail: user?.email,
      profile: !!profile,
      profileRole: profile?.role,
      isAdmin,
      loading,
      userMetadata: user?.user_metadata
    };

    console.log('🔍 AdminDashboard Component Debug:', debugData);
    debouncedSetDebugInfo(JSON.stringify(debugData, null, 2));
  }, [user, profile, isAdmin, loading, debouncedSetDebugInfo]);

  useEffect(() => {
    console.log('🔄 AdminDashboard useEffect triggered:', { user, isAdmin });
    
    if (user && isAdmin) {
      console.log('✅ Admin user detected, loading system data...');
      loadSystemData();
    } else if (user && !isAdmin) {
      console.log('❌ User is not admin, role:', profile?.role);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ User is not admin, role: ' + profile?.role);
    } else if (!user) {
      console.log('❌ No user found');
      debouncedSetDebugInfo(debugInfo + '\n\n❌ No user found');
    }
  }, [user, isAdmin, debouncedSetDebugInfo]);

  const loadSystemData = useCallback(async () => {
    if (!user || !isAdmin) {
      console.log('🚫 loadSystemData: User not admin or not logged in');
      return;
    }
    
    console.log('🔄 Loading system data for admin...');
    setLoading(true);
    try {
      // Testar conexão com Supabase
      console.log('🔍 Testing Supabase connection...');
      const { count: profilesCount, error: testError } = await supabase
        .from('profiles')
        .select('*', { count: 'exact', head: true });
      
      if (testError) {
        console.error('❌ Supabase connection test failed:', testError);
        debouncedSetDebugInfo(debugInfo + '\n\n❌ Supabase Test Failed: ' + testError.message);
        return;
      }

        console.log('✅ Supabase connection test successful');
      debouncedSetDebugInfo(debugInfo + '\n\n✅ Supabase Test: Connected');

      // Carregar estatísticas do sistema
      await loadSystemStats();
      // Carregar programações publicadas
      await loadPrograms();

    } catch (error) {
      console.error('❌ Supabase test exception:', error);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ Supabase Test Exception: ' + error);
    } finally {
      setLoading(false);
    }
  }, [user, isAdmin, debouncedSetDebugInfo, debugInfo]);

  const loadSystemStats = useCallback(async () => {
    try {
      console.log('📊 Loading system statistics...');

      const [profilesRes, estudantesRes, programasRes] = await Promise.all([
        supabase.from('profiles').select('*', { count: 'exact', head: true }),
        supabase.from('estudantes').select('*', { count: 'exact', head: true }),
        supabase.from('programas').select('*', { count: 'exact', head: true }),
      ]);

      // congregacoes (removido: tabela pode não existir neste projeto)
      const congregacoesCount = 0;

      const stats: SystemStats = {
        total_congregations: congregacoesCount,
        active_congregations: congregacoesCount,
        total_users: (profilesRes.count as number) || 0,
        total_estudantes: (estudantesRes.count as number) || 0,
        total_programas: (programasRes.count as number) || 0,
        last_sync: new Date().toISOString(),
      };

      setSystemStats(stats);
      setLastCheck(new Date().toISOString());

      console.log('✅ System stats loaded:', stats);
      debouncedSetDebugInfo(debugInfo + '\n\n✅ System Stats Loaded: ' + JSON.stringify(stats, null, 2));

    } catch (error) {
      console.error('❌ Error loading system stats:', error);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ System Stats Error: ' + error);
    }
  }, [debouncedSetDebugInfo, debugInfo, supabase]);

  const loadPrograms = useCallback(async () => {
    try {
      setProgramsLoading(true);
      const { data, error } = await supabase
        .from('programas')
        .select('id, semana, mes_apostila, status, data_inicio_semana, arquivo')
        .order('data_inicio_semana', { ascending: false })
        .limit(12);
      if (error) throw error;
      setPrograms(data || []);
      console.log('✅ Programs loaded:', data?.length || 0);
    } catch (error: any) {
      console.error('❌ Error loading programs:', error);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ Programs Load Error: ' + (error?.message || error));
    } finally {
      setProgramsLoading(false);
    }
  }, [debouncedSetDebugInfo, debugInfo]);

  const checkForUpdates = useCallback(async () => {
    console.log('🔄 Checking for updates...');
    setLoading(true);
    
    try {
      await loadSystemStats();
      await loadPrograms();
      console.log('✅ Updates checked successfully');
    } catch (error) {
      console.error('❌ Error checking updates:', error);
    } finally {
      setLoading(false);
    }
  }, [loadSystemStats]);

  const testSupabaseConnection = useCallback(async () => {
    console.log('🔧 Testing Supabase connection...');
    
    try {
      const { count, error } = await supabase
        .from('profiles')
        .select('*', { count: 'exact', head: true });

      if (error) {
        console.error('❌ Supabase test error:', error);
        alert('Supabase test error: ' + error.message);
      } else {
        console.log('✅ Supabase test successful. Profiles count:', count);
        alert('Supabase test successful! Total profiles: ' + (count ?? 0));
      }
    } catch (error) {
      console.error('❌ Supabase test exception:', error);
      alert('Supabase test exception: ' + error);
    }
  }, []);

  // ========== HANDLERS DOS BOTÕES ==========
  
  const handleListUsers = useCallback(async () => {
    console.log('👥 Listando usuários...');
    try {
      const { data: users, error } = await supabase
        .from('profiles')
        .select('id, nome_completo, role, congregacao, cargo')
        .order('nome_completo');
      
      if (error) throw error;
      
      console.log('✅ Usuários carregados:', users);
      alert(`Encontrados ${users?.length || 0} usuários no sistema:\n\n${users?.map(u => `${u.nome_completo || u.id} - ${u.role} (${u.congregacao || 'N/A'})`).join('\n')}`);
    } catch (error) {
      console.error('❌ Erro ao listar usuários:', error);
      alert('Erro ao carregar usuários: ' + error.message);
    }
  }, []);

  const handleManagePermissions = useCallback(async () => {
    console.log('⚙️ Gerenciando permissões...');
    const newRole = prompt('Digite o novo role (admin, instrutor, estudante):');
    if (!newRole) return;
    
    // Validar role
    const validRoles = ['admin', 'instrutor', 'estudante', 'family_member', 'developer'];
    if (!validRoles.includes(newRole)) {
      alert('Role inválido. Use: admin, instrutor, estudante, family_member ou developer');
      return;
    }
    
    const userId = prompt('Digite o ID do usuário:');
    if (!userId) return;
    
    try {
      const { error } = await supabase
        .from('profiles')
        .update({ role: newRole as any })
        .eq('id', userId);
      
      if (error) throw error;
      
      console.log('✅ Permissão atualizada');
      alert('Permissão atualizada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao atualizar permissão:', error);
      alert('Erro ao atualizar permissão: ' + error.message);
    }
  }, []);

  const handleActivityReport = useCallback(async () => {
    console.log('📊 Gerando relatório de atividades...');
    try {
      // Simulação de relatório
      const report = {
        totalUsers: staticStats.total_users,
        totalCongregations: staticStats.total_congregations,
        lastUpdate: new Date().toLocaleString('pt-BR'),
        activeUsers: Math.floor(staticStats.total_users * 0.8)
      };
      
      alert(`📊 Relatório de Atividades:\n\n` +
            `• Total de usuários: ${report.totalUsers}\n` +
            `• Usuários ativos: ${report.activeUsers}\n` +
            `• Total de congregações: ${report.totalCongregations}\n` +
            `• Última atualização: ${report.lastUpdate}`);
    } catch (error) {
      console.error('❌ Erro ao gerar relatório:', error);
      alert('Erro ao gerar relatório: ' + error.message);
    }
  }, [staticStats]);

  const handleBackupData = useCallback(async () => {
    console.log('💾 Fazendo backup dos dados...');
    try {
      const { data: profiles, error: profilesError } = await supabase
        .from('profiles')
        .select('*');
      
      if (profilesError) throw profilesError;
      
      // Simular backup
      const backupData = {
        timestamp: new Date().toISOString(),
        profiles: profiles,
        stats: staticStats
      };
      
      const dataStr = JSON.stringify(backupData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `backup_sistema_ministerial_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      URL.revokeObjectURL(url);
      console.log('✅ Backup criado com sucesso');
      alert('Backup criado e baixado com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao fazer backup:', error);
      alert('Erro ao fazer backup: ' + error.message);
    }
  }, [staticStats]);

  // Congregações
  const handleManageCongregation = useCallback((congregationName: string) => {
    console.log('🏢 Gerenciando congregação:', congregationName);
    alert(`🏢 Gerenciando congregação: ${congregationName}\n\nEsta funcionalidade abrirá o painel de gerenciamento da congregação.`);
  }, []);

  const handleAddCongregation = useCallback(async () => {
    console.log('➕ Adicionando nova congregação...');
    const congregationName = prompt('Digite o nome da nova congregação:');
    if (!congregationName) return;
    
    try {
      // Simulação - em produção seria inserção no Supabase
      console.log('✅ Congregação adicionada:', congregationName);
      alert(`✅ Congregação "${congregationName}" adicionada com sucesso!\n\nEla agora receberá automaticamente a programação oficial.`);
    } catch (error) {
      console.error('❌ Erro ao adicionar congregação:', error);
      alert('Erro ao adicionar congregação: ' + error.message);
    }
  }, []);

  // JW.org & S-38
  const handleMWBAvailable = useCallback(async () => {
    console.log('📚 Disponibilizando MWB atual...');
    try {
      await jworg.fetchCurrentWeek();
      console.log('✅ MWB atualizada');
      alert('✅ Apostila MWB atual disponibilizada para todas as congregações!');
    } catch (error) {
      console.error('❌ Erro ao disponibilizar MWB:', error);
      alert('Erro ao disponibilizar MWB: ' + error.message);
    }
  }, [jworg]);

  const handleConfigureJWorgURLs = useCallback(() => {
    console.log('⚙️ Configurando URLs JW.org...');
    const ptUrl = prompt('URL JW.org PT:', 'https://www.jw.org/pt/biblioteca/jw-apostila-do-mes/');
    const enUrl = prompt('URL JW.org EN:', 'https://www.jw.org/en/library/jw-meeting-workbook/');
    
    if (ptUrl && enUrl) {
      console.log('✅ URLs configuradas:', { ptUrl, enUrl });
      alert('✅ URLs JW.org configuradas com sucesso!');
    }
  }, []);

  const handleSyncCongregations = useCallback(async () => {
    console.log('🔄 Sincronizando com congregações...');
    try {
      // Simulação de sincronização
      const congregationsCount = staticStats.total_congregations;
      console.log(`✅ Sincronizando com ${congregationsCount} congregações`);
      alert(`🔄 Sincronização iniciada!\n\nProgramação oficial sendo enviada para ${congregationsCount} congregações...\n\nTempo estimado: ${Math.ceil(congregationsCount / 100)} minutos`);
    } catch (error) {
      console.error('❌ Erro na sincronização:', error);
      alert('Erro na sincronização: ' + error.message);
    }
  }, [staticStats]);

  // Programação Oficial
  const handleViewFullProgram = useCallback(() => {
    console.log('📅 Visualizando programação completa (3 meses)...');
    alert(`📅 Programação Completa dos Próximos 3 Meses\n\n` +
          `• Semanas carregadas: 12\n` +
          `• Idiomas: PT e EN\n` +
          `• Última atualização: Hoje\n\n` +
          `Esta visualização mostrará todas as apostilas MWB dos próximos 3 meses.`);
  }, []);

  const handleUpdateProgramPT = useCallback(async () => {
    console.log('🇧🇷 Atualizando programação PT...');
    try {
      jworg.setLanguage('pt');
      await jworg.fetchNextWeeks();
      console.log('✅ Programação PT atualizada');
      alert('✅ Programação em Português atualizada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao atualizar programação PT:', error);
      alert('Erro ao atualizar programação PT: ' + error.message);
    }
  }, [jworg]);

  const handleUpdateProgramEN = useCallback(async () => {
    console.log('🇺🇸 Atualizando programação EN...');
    try {
      jworg.setLanguage('en');
      await jworg.fetchNextWeeks();
      console.log('✅ Programação EN atualizada');
      alert('✅ Programação em Inglês atualizada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao atualizar programação EN:', error);
      alert('Erro ao atualizar programação EN: ' + error.message);
    }
  }, [jworg]);

  const handleCheckNewWeeks = useCallback(async () => {
    console.log('🔍 Verificando novas semanas...');
    try {
      await jworg.fetchNextWeeks();
      const newWeeks = jworg.nextWeeks.length;
      console.log(`✅ Verificação concluída: ${newWeeks} semanas`);
      alert(`🔍 Verificação concluída!\n\nEncontradas ${newWeeks} semanas de programação.\n\nTodas estão sincronizadas com JW.org.`);
    } catch (error) {
      console.error('❌ Erro ao verificar semanas:', error);
      alert('Erro ao verificar novas semanas: ' + error.message);
    }
  }, [jworg]);

  const handleUpdateS38Structure = useCallback(() => {
    console.log('🏗️ Atualizando estrutura S-38 global...');
    alert(`🏗️ Estrutura S-38 Global\n\n` +
          `✅ Partes da reunião atualizadas:\n` +
          `• Chairman\n• Treasures\n• Gems\n• Reading\n` +
          `• Starting\n• Following\n• Making\n• Explaining\n` +
          `• Talk\n\n` +
          `Esta estrutura será aplicada mundialmente.`);
  }, []);

  // JW.org Integration
  const handleReloadCurrentWeek = useCallback(async () => {
    console.log('🔄 Recarregando semana atual...');
    try {
      await jworg.fetchCurrentWeek();
      console.log('✅ Semana atual recarregada');
      alert('✅ Semana atual recarregada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao recarregar semana:', error);
      alert('Erro ao recarregar semana: ' + error.message);
    }
  }, [jworg]);

  const handleReloadNextWeeks = useCallback(async () => {
    console.log('📅 Recarregando próximas semanas...');
    try {
      await jworg.fetchNextWeeks();
      console.log('✅ Próximas semanas recarregadas');
      alert('✅ Próximas semanas recarregadas com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao recarregar próximas semanas:', error);
      alert('Erro ao recarregar próximas semanas: ' + error.message);
    }
  }, [jworg]);

  const handleTestDownloadPT = useCallback(async () => {
    console.log('🧪 Testando download PT...');
    try {
      jworg.setLanguage('pt');
      await jworg.downloadWorkbook('pt', '07', '2025');
      console.log('✅ Download PT testado');
      alert('✅ Download PT testado com sucesso!');
    } catch (error) {
      console.error('❌ Erro no teste de download PT:', error);
      alert('Erro no teste de download PT: ' + error.message);
    }
  }, [jworg]);

  // Monitoramento
  const handleViewAllLogs = useCallback(async () => {
    console.log('📋 Visualizando todos os logs...');
    try {
      // Simulação de logs
      const logs = [
        { timestamp: new Date().toLocaleString(), event: 'Sistema iniciado', level: 'info' },
        { timestamp: new Date(Date.now() - 3600000).toLocaleString(), event: 'Backup automático executado', level: 'info' },
        { timestamp: new Date(Date.now() - 86400000).toLocaleString(), event: 'Novo usuário registrado', level: 'info' },
        { timestamp: new Date(Date.now() - 172800000).toLocaleString(), event: 'Manutenção programada', level: 'warning' }
      ];
      
      const logText = logs.map(log => `${log.timestamp} [${log.level.toUpperCase()}] ${log.event}`).join('\n');
      alert(`📋 Logs do Sistema\n\n${logText}`);
    } catch (error) {
      console.error('❌ Erro ao carregar logs:', error);
      alert('Erro ao carregar logs: ' + error.message);
    }
  }, []);

  const handleTestJWorgIntegration = useCallback(async () => {
    console.log('🧪 Testando integração JW.org...');
    try {
      await jworg.fetchCurrentWeek();
      console.log('✅ Integração JW.org testada com sucesso');
      alert('✅ Integração JW.org funcionando perfeitamente!');
    } catch (error) {
      console.error('❌ Erro na integração JW.org:', error);
      alert('❌ Erro na integração JW.org: ' + error.message);
    }
  }, [jworg]);

  const handleChangeLanguage = useCallback((newLang: 'pt' | 'en') => {
    jworg.setLanguage(newLang);
    console.log(`🌐 Idioma alterado para: ${newLang}`);
    alert(`🌐 Idioma alterado para: ${newLang === 'pt' ? 'Português' : 'English'}`);
  }, [jworg]);

  // Alterna o idioma atual entre PT/EN
  const toggleLanguage = useCallback(() => {
    const current = (jworg as any)?.currentLanguage ?? 'pt';
    const next = current === 'pt' ? 'en' : 'pt';
    jworg.setLanguage(next);
    console.log(`🌐 Idioma alternado: ${current} -> ${next}`);
    alert(`🌐 Idioma alternado para: ${next === 'pt' ? 'Português' : 'English'}`);
  }, [jworg]);

  // Atualiza materiais JW.org (semana atual + próximas semanas)
  const updateMaterials = useCallback(async () => {
    try {
      await jworg.fetchCurrentWeek();
      await jworg.fetchNextWeeks();
      console.log('✅ Materiais JW.org atualizados');
      alert('✅ Materiais JW.org atualizados com sucesso!');
    } catch (error: any) {
      console.error('❌ Erro ao atualizar materiais:', error);
      alert('❌ Erro ao atualizar materiais: ' + (error?.message || error));
    }
  }, [jworg]);

  // Sincronizar materiais da pasta docs/Oficial -> tabela public.programas
  const syncMaterialsToPrograms = useCallback(async () => {
    try {
      setLoading(true);

      // Obter token do usuário atual para autenticar no backend
      const { data: sessionData } = await supabase.auth.getSession();
      const accessToken = sessionData.session?.access_token;
      if (!accessToken) {
        alert('Sessão inválida. Faça login novamente.');
        return;
      }

      // Buscar lista de materiais no backend (requer Authorization)
      const res = await fetch('http://localhost:3001/api/materials', {
        headers: { Authorization: `Bearer ${accessToken}` },
      });
      if (!res.ok) {
        alert('Falha ao listar materiais no backend.');
        return;
      }
      const payload = await res.json();
      const materials: Array<{ filename: string }> = payload.materials || [];

      // Filtrar arquivos relevantes e preparar upserts
      const rows: any[] = materials
        .map((m) => m.filename)
        .filter((name) => /^(mwb_|S-38_|mwb_T_)/i.test(name))
        .map((arquivo) => {
          // Extrair ano/mês do padrão mwb_E_YYYYMM.pdf
          let ano = '';
          let mes = '';
          const match = arquivo.match(/mwb_[A-Z]_([0-9]{6})/i);
          if (match) {
            ano = match[1].slice(0, 4);
            mes = match[1].slice(4, 6);
          }
          const mes_apostila = ano && mes ? `${ano}-${mes}` : null;
          const data_inicio_semana = mes_apostila ? `${ano}-${mes}-01` : null;
          return {
            semana: null,
            mes_apostila,
            status: 'ativo',
            data_inicio_semana,
            arquivo,
          };
        });

      // Inserir somente os que ainda não existem por arquivo
      for (const row of rows) {
        const { data: exists, error: selErr } = await supabase
          .from('programas')
          .select('id')
          .eq('arquivo', row.arquivo)
          .maybeSingle();
        if (selErr) {
          console.warn('Select error (ignorado):', selErr.message);
        }
        if (!exists) {
          const { error: insErr } = await supabase.from('programas').insert(row as any);
          if (insErr) {
            console.warn('Insert error para', row.arquivo, insErr.message);
          }
        }
      }

      await loadPrograms();
      alert('Sincronização concluída.');
    } catch (error: any) {
      console.error('❌ Erro ao sincronizar materiais:', error);
      alert('Erro ao sincronizar materiais: ' + (error?.message || error));
    } finally {
      setLoading(false);
    }
  }, [supabase, loadPrograms]);

  // NOW CHECK CONDITIONS AND RENDER APPROPRIATELY
  // Se não for admin, mostrar mensagem de acesso negado
  if (user && !isAdmin) {
    return (
      <div className="container mx-auto px-4 py-8">
        <Card className="max-w-md mx-auto">
          <CardHeader>
            <CardTitle className="text-red-600">Acesso Negado</CardTitle>
            <CardDescription>
              Você não tem permissão para acessar o painel administrativo.
            </CardDescription>
          </CardHeader>
          <CardContent>
            <p className="text-sm text-muted-foreground mb-4">
              Seu perfil atual: <strong>{profile?.role}</strong>
            </p>
            <Button onClick={() => window.history.back()}>
              Voltar
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Se não houver usuário, mostrar loading
  if (!user) {
    return (
      <div className="container mx-auto px-4 py-8">
        <Card className="max-w-md mx-auto">
          <CardHeader>
            <CardTitle>Carregando...</CardTitle>
            <CardDescription>
              Verificando autenticação...
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="flex items-center justify-center">
              <RefreshCw className="h-6 w-6 animate-spin" />
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background">
      {/* Auth Error Handler */}
      <AuthErrorHandler />
      
      {/* Header */}
      <div className="border-b">
        <div className="container mx-auto px-4 py-6">
          <div className="flex flex-col space-y-4">
          <div className="flex items-center justify-between">
            <div>
                <h1 className="text-3xl font-bold tracking-tight">📊 Dashboard do Administrador Geral</h1>
                <p className="text-muted-foreground">
                  Programação oficial das reuniões ministeriais - Padronização mundial para todas as congregações
              </p>
            </div>
              <div className="flex items-center space-x-2">
              {/* Force Profile Load Button */}
              {import.meta.env.DEV && (
                <Button 
                  variant="outline" 
                  size="sm"
                    onClick={testSupabaseConnection}
                  >
                    🔧 Test Supabase
                </Button>
              )}
              
              <Button onClick={checkForUpdates} disabled={loading}>
                <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
                  Atualizar
              </Button>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Debug Info Panel */}
      {import.meta.env.DEV && (
        <div className="container mx-auto px-4 py-2">
          <Card className="bg-yellow-50 border-yellow-200">
            <CardHeader className="pb-2">
              <CardTitle className="text-sm text-yellow-800">🐛 Debug Info (Development Only)</CardTitle>
            </CardHeader>
            <CardContent>
              <pre className="text-xs text-yellow-700 overflow-auto max-h-40">
                {debugInfo}
              </pre>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Main Content */}
      <div className="container mx-auto px-4 py-6">
        <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-6">
          <TabsList className="grid w-full grid-cols-4">
            <TabsTrigger value="overview">Visão Geral</TabsTrigger>
            <TabsTrigger value="users">Usuários</TabsTrigger>
            <TabsTrigger value="congregations">Congregações</TabsTrigger>
            <TabsTrigger value="system">Sistema</TabsTrigger>
          </TabsList>

          {/* Visão Geral */}
          <TabsContent value="overview" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                🎯 Sistema Ministerial Global - Padronização Mundial
              </h3>
              <div className="text-center text-sm text-muted-foreground mt-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
                <strong>📊 Admin Geral:</strong> Disponibiliza programação oficial semanal (SEM nomes de estudantes) <br/>
                <strong>🎓 Instrutores:</strong> Recebem programação automaticamente + fazem designações locais reais
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Congregações Conectadas</CardTitle>
                  <Globe className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">{staticStats.total_congregations}</div>
                  <p className="text-xs text-muted-foreground">
                    Recebendo programação oficial
                  </p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Semanas Programadas</CardTitle>
                  <BarChart3 className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">12</div>
                  <p className="text-xs text-muted-foreground">
                    Próximas 3 meses
                  </p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Idiomas Disponíveis</CardTitle>
                  <Globe className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">2</div>
                  <p className="text-xs text-muted-foreground">
                    Português e Inglês
                  </p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Última Sincronização</CardTitle>
                  <RefreshCw className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">✅</div>
                  <p className="text-xs text-muted-foreground">
                    Hoje, {new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                  </p>
                </CardContent>
              </Card>
            </div>

            {/* Ações Rápidas */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Status do Sistema */}
              <Card>
                <CardHeader>
                  <CardTitle>Status do Sistema</CardTitle>
                  <CardDescription>
                    Informações sobre a última verificação e status geral
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Última Verificação:</span>
                    <span className="text-sm text-muted-foreground">
                      {lastCheck ? new Date(lastCheck).toLocaleString('pt-BR') : 'Nunca'}
                    </span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Status:</span>
                    <Badge variant="outline" className="text-green-600">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Operacional
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Supabase:</span>
                    <Badge variant="outline" className="text-green-600">
                      <Database className="h-3 w-3 mr-1" />
                      Conectado
                    </Badge>
                  </div>
                </CardContent>
              </Card>

              {/* Programações Publicadas */}
              <Card>
                <CardHeader>
                  <CardTitle>Programações Publicadas</CardTitle>
                  <CardDescription>
                    Últimas semanas importadas/publicadas
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  {programsLoading ? (
                    <div className="text-sm text-muted-foreground">Carregando...</div>
                  ) : programs.length === 0 ? (
                    <div className="text-sm text-muted-foreground">Nenhuma programação encontrada.</div>
                  ) : (
                    <div className="space-y-2">
                      {programs.map((p) => (
                        <div key={p.id} className="p-2 border rounded-md">
                          <div className="flex items-center justify-between">
                            <div className="text-sm">
                              <div className="font-medium">Semana {p.semana || '—'} • {p.mes_apostila || '—'}</div>
                              <div className="text-xs text-muted-foreground">
                                {p.data_inicio_semana ? new Date(p.data_inicio_semana).toLocaleDateString('pt-BR') : '—'}
                              </div>
                            </div>
                            <Badge variant="outline" className={p.status === 'ativo' || p.status === 'publicado' ? 'bg-green-50 text-green-700' : ''}>
                              {p.status || '—'}
                            </Badge>
                          </div>
                          {p.arquivo && (
                            <div className="mt-2">
                              <a
                                href={`http://localhost:3001/materials/${encodeURIComponent(p.arquivo)}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="text-blue-600 text-xs underline"
                              >
                                Abrir material ({p.arquivo})
                              </a>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </CardContent>
              </Card>

              {/* JW.org Downloads */}
              <Card className="bg-green-50 border-green-200">
                <CardHeader>
                  <CardTitle className="text-green-800">📚 JW.org Downloads</CardTitle>
                  <CardDescription className="text-green-700">
                    Gerenciar materiais oficiais
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Apostila MWB Atual:</span>
                    <Badge variant="outline" className="text-green-600">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Disponível
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Última verificação:</span>
                    <span className="text-sm text-green-700">Hoje, 10:30</span>
                  </div>
                  <div className="flex space-x-2">
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleMWBAvailable}>
                      <RefreshCw className="h-3 w-3 mr-1" />
                      Disponibilizar MWB Atual
                    </Button>
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleConfigureJWorgURLs}>
                      <Settings className="h-3 w-3 mr-1" />
                      Configurar URLs JW.org
                    </Button>
                  </div>
                </CardContent>
              </Card>

              {/* Sistema S-38 - Designações */}
              <Card className="bg-purple-50 border-purple-200">
                <CardHeader>
                  <CardTitle className="text-purple-800">⚙️ Sistema S-38</CardTitle>
                  <CardDescription className="text-purple-700">
                    Estrutura das reuniões ministeriais
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="text-sm text-purple-700 space-y-2">
                    <p>📚 <strong>Função do Admin:</strong> Disponibilizar apostilas MWB</p>
                    <p>👥 <strong>Para Instrutores:</strong> Designar estudantes para partes</p>
                    <p>🎯 <strong>Partes da Reunião:</strong></p>
                    <div className="grid grid-cols-2 gap-1 text-xs ml-2">
                      <div>• Chairman</div>
                      <div>• Treasures</div>
                      <div>• Gems</div>
                      <div>• Reading</div>
                      <div>• Starting</div>
                      <div>• Following</div>
                      <div>• Making</div>
                      <div>• Explaining</div>
                      <div>• Talk</div>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Debug / Integração */}
              <Card className="bg-slate-50 border-slate-200">
                <CardHeader>
                  <CardTitle className="text-slate-800">🧪 Debug / Integração</CardTitle>
                  <CardDescription className="text-slate-700">
                    Ferramentas rápidas para validar integrações e idioma
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-3">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Idioma Atual:</span>
                    <Badge variant="outline" className="text-slate-700">
                      {(jworg as any)?.currentLanguage === 'en' ? '🇺🇸 English' : '🇧🇷 Português'}
                    </Badge>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    <Button size="sm" variant="outline" onClick={toggleLanguage}>
                      Alternar Idioma
                    </Button>
                    <Button size="sm" variant="outline" onClick={updateMaterials}>
                      Atualizar Materiais
                    </Button>
                    <Button size="sm" variant="outline" onClick={handleTestJWorgIntegration}>
                      Testar Integração JW.org
                    </Button>
                    <Button size="sm" variant="outline" onClick={checkForUpdates} disabled={loading}>
                      Atualizar Contagens
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          {/* Usuários */}
          <TabsContent value="users" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                👥 Gestão de Usuários para Acesso às Apostilas MWB
              </h3>
              <p className="text-center text-sm text-muted-foreground mt-2">
                🎯 Função Principal: Admin gerencia usuários → Instrutores acessam apostilas
              </p>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Estatísticas de Usuários */}
            <Card>
              <CardHeader>
                  <CardTitle>Estatísticas</CardTitle>
                  <CardDescription>Resumo dos usuários</CardDescription>
              </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Total de Usuários:</span>
                      <Badge variant="outline">{staticStats.total_users}</Badge>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Admins:</span>
                      <Badge variant="outline" className="bg-red-50 text-red-700">
                        {isAdmin ? 1 : 0}
                      </Badge>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Instrutores:</span>
                      <Badge variant="outline" className="bg-blue-50 text-blue-700">
                        {staticStats.total_users - (isAdmin ? 1 : 0)}
                      </Badge>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Usuários Registrados */}
              <Card className="lg:col-span-2">
                <CardHeader>
                  <CardTitle>Usuários Registrados</CardTitle>
                  <CardDescription>Últimos usuários cadastrados no sistema</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between p-3 border rounded-lg">
                      <div className="flex items-center space-x-3">
                        <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                          <Users className="h-5 w-5 text-blue-600" />
                        </div>
                        <div>
                          <p className="font-medium">{profile?.nome_completo || 'Roberto Araujo da Silva'}</p>
                          <p className="text-sm text-muted-foreground">Administrator</p>
                        </div>
                      </div>
                      <Badge variant="outline" className="bg-red-50 text-red-700">
                        Admin
                      </Badge>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Ações Administrativas */}
            <Card>
              <CardHeader>
                <CardTitle>Ações Administrativas</CardTitle>
                <CardDescription>
                  Gerenciar usuários e permissões
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <Button className="w-full justify-start" variant="outline" onClick={handleListUsers}>
                    <Users className="h-4 w-4 mr-2" />
                    Listar Todos os Usuários
                  </Button>
                  <Button className="w-full justify-start" variant="outline" onClick={handleManagePermissions}>
                    <Settings className="h-4 w-4 mr-2" />
                    Gerenciar Permissões
                  </Button>
                  <Button className="w-full justify-start" variant="outline" onClick={handleActivityReport}>
                    <Activity className="h-4 w-4 mr-2" />
                    Relatório de Atividades
                  </Button>
                  <Button className="w-full justify-start" variant="outline" onClick={handleBackupData}>
                    <Database className="h-4 w-4 mr-2" />
                    Backup de Dados
                  </Button>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Congregações */}
          <TabsContent value="congregations" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                🏢 Gestão de Congregações para Acesso às Apostilas MWB
              </h3>
              <p className="text-center text-sm text-muted-foreground mt-2">
                🎯 Função Principal: Admin gerencia congregações → Instrutores acessam apostilas
              </p>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Estatísticas de Congregações */}
            <Card>
              <CardHeader>
                  <CardTitle>Estatísticas</CardTitle>
                  <CardDescription>Resumo das congregações</CardDescription>
              </CardHeader>
              <CardContent>
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Total de Congregações:</span>
                      <Badge variant="outline">{staticStats.total_congregations}</Badge>
                  </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Congregações Ativas:</span>
                      <Badge variant="outline" className="bg-green-50 text-green-700">
                        {staticStats.active_congregations}
                      </Badge>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Total de Estudantes:</span>
                      <Badge variant="outline">{staticStats.total_estudantes}</Badge>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Lista de Congregações */}
              <Card className="lg:col-span-2">
                <CardHeader>
                  <CardTitle>Congregações Registradas</CardTitle>
                  <CardDescription>Lista das congregações no sistema</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between p-3 border rounded-lg">
                      <div className="flex items-center space-x-3">
                        <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                          <Package className="h-5 w-5 text-blue-600" />
                        </div>
                        <div>
                          <p className="font-medium">Sistema Ministerial Global</p>
                          <p className="text-sm text-muted-foreground">Congregação Principal</p>
                          </div>
                        </div>
                      <Badge variant="outline" className="bg-green-50 text-green-700">
                        Ativa
                        </Badge>
                      </div>
                  </div>
                  
                  <div className="mt-4">
                    <Button variant="outline" className="w-full" onClick={() => handleManageCongregation('Sistema Ministerial Global')}>
                      <Users className="h-4 w-4 mr-2" />
                      Gerenciar
                    </Button>
                  </div>
                  
                  <div className="mt-4">
                    <Button variant="outline" className="w-full" onClick={handleAddCongregation}>
                      <Users className="h-4 w-4 mr-2" />
                      Adicionar Nova Congregação
                    </Button>
                  </div>
                  
                  <div className="mt-4">
                    <Button variant="outline" className="w-full">
                      <Users className="h-4 w-4 mr-2" />
                      Expandir
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          {/* Sistema */}
          <TabsContent value="system" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                ⚙️ Monitoramento e Configurações do Sistema
              </h3>
              <p className="text-center text-sm text-muted-foreground mt-2">
                🎯 Função Principal: Admin monitora sistema → Instrutores recebem apostilas estáveis
              </p>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Downloads JW.org */}
              <Card className="bg-green-50 border-green-200">
              <CardHeader>
                  <CardTitle className="text-green-800">📚 JW.org Downloads</CardTitle>
                  <CardDescription className="text-green-700">
                    Gerenciar materiais oficiais
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Apostila MWB Atual:</span>
                    <Badge variant="outline" className="text-green-600">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Disponível
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Última verificação:</span>
                    <span className="text-sm text-green-700">Hoje, 10:30</span>
                  </div>
                  <div className="flex space-x-2">
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleSyncCongregations}>
                      <RefreshCw className="h-3 w-3 mr-1" />
                      Sincronizar com Congregações
                    </Button>
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleViewFullProgram}>
                      <Settings className="h-3 w-3 mr-1" />
                      Ver Programação Completa
                    </Button>
                </div>
              </CardContent>
            </Card>

              {/* Configurações Gerais */}
            <Card>
              <CardHeader>
                  <CardTitle>Configurações Gerais</CardTitle>
                <CardDescription>
                    Parâmetros do sistema
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                    <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Backup Automático:</span>
                    <Badge variant="outline" className="bg-green-50 text-green-700">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Diário às 02:00
                      </Badge>
                    </div>
                    <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Notificações:</span>
                    <Badge variant="outline" className="bg-blue-50 text-blue-700">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Email + Sistema
                    </Badge>
                    </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Manutenção:</span>
                    <span className="text-sm text-muted-foreground">Última: Ontem</span>
                  </div>
                  <div className="flex space-x-2">
                    <Button size="sm" variant="outline">
                      <Settings className="h-3 w-3 mr-1" />
                      Configurar
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Métricas do Sistema */}
            <Card>
              <CardHeader>
                <CardTitle>Métricas do Sistema</CardTitle>
                <CardDescription>
                  Monitoramento em tempo real
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-green-600">99.9%</p>
                    <p className="text-sm text-muted-foreground">Uptime</p>
                  </div>
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-blue-600">~120ms</p>
                    <p className="text-sm text-muted-foreground">Latência</p>
                  </div>
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-green-600">25%</p>
                    <p className="text-sm text-muted-foreground">CPU</p>
                  </div>
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-blue-600">33%</p>
                    <p className="text-sm text-muted-foreground">Memória</p>
                  </div>
                </div>

                <Separator />

                <div className="space-y-3">
                    <div className="flex items-center justify-between">
                    <span className="text-sm">CPU:</span>
                    <div className="flex items-center space-x-2">
                      <div className="w-24 h-2 bg-gray-200 rounded-full">
                        <div className="w-1/4 h-2 bg-green-500 rounded-full"></div>
                    </div>
                        <span className="text-sm">25%</span>
                  </div>
                    </div>
                    
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Memória:</span>
                      <div className="flex items-center space-x-2">
                        <div className="w-24 h-2 bg-gray-200 rounded-full">
                          <div className="w-1/3 h-2 bg-blue-500 rounded-full"></div>
                    </div>
                        <span className="text-sm">33%</span>
                      </div>
                    </div>
                    
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Banco:</span>
                      <div className="flex items-center space-x-2">
                        <CheckCircle className="h-4 w-4 text-green-500" />
                        <span className="text-sm">Conectado</span>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

              {/* Logs e Atividades */}
              <Card>
                <CardHeader>
                  <CardTitle>Logs Recentes</CardTitle>
                  <CardDescription>
                    Últimas atividades do sistema
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <CheckCircle className="h-4 w-4 text-green-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Sistema iniciado</p>
                        <p className="text-xs text-muted-foreground">Hoje, 08:00</p>
                      </div>
                    </div>

                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <Activity className="h-4 w-4 text-blue-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Backup automático executado</p>
                        <p className="text-xs text-muted-foreground">Hoje, 02:00</p>
                      </div>
                    </div>

                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <Users className="h-4 w-4 text-green-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Novo usuário registrado</p>
                        <p className="text-xs text-muted-foreground">Ontem, 16:30</p>
                      </div>
                    </div>

                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <AlertCircle className="h-4 w-4 text-yellow-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Manutenção programada</p>
                        <p className="text-xs text-muted-foreground">Ontem, 03:00</p>
                      </div>
                    </div>
                  </div>

                  <div className="mt-4">
                    <Button variant="outline" className="w-full" onClick={handleViewAllLogs}>
                      <FileText className="h-4 w-4 mr-2" />
                      Ver Todos os Logs
                    </Button>
                  </div>
                </CardContent>
              </Card>
          </TabsContent>
        </Tabs>
      </div>
    </div>
  );
}

```

```typescriptreact
import React, { useState, useEffect, useCallback, useMemo, lazy, Suspense } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { supabase } from '../integrations/supabase/client';
import { useJWorgIntegration } from '../hooks/useJWorgIntegration';
import { JWorgTest } from '../components/JWorgTest';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../components/ui/card';
import LazyLoader from '../components/LazyLoader';
import AuthErrorHandler from '../components/AuthErrorHandler';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '../components/ui/tabs';
import { Button } from '../components/ui/button';
import { Badge } from '../components/ui/badge';
import { Separator } from '../components/ui/separator';
import { 
  Download, 
  Upload, 
  Globe, 
  BarChart3, 
  Settings, 
  RefreshCw,
  CheckCircle,
  AlertCircle,
  Clock,
  FileText,
  Users,
  Package,
  Activity,
  Database
} from 'lucide-react';

// 🚀 Lazy loading para componentes pesados (comentado por enquanto)
// const JWorgTestLazy = lazy(() => import('../components/JWorgTest'));

interface SystemStats {
  total_congregations: number;
  active_congregations: number;
  total_users: number;
  total_estudantes: number;
  total_programas: number;
  last_sync: string;
}

export default function AdminDashboard() {
  const { user, profile, isAdmin } = useAuth();
  const jworg = useJWorgIntegration();
  const [activeTab, setActiveTab] = useState('overview');
  const [loading, setLoading] = useState(false);
  const [systemStats, setSystemStats] = useState<SystemStats | null>(null);
  const [lastCheck, setLastCheck] = useState<string>('');
  const [debugInfo, setDebugInfo] = useState<string>('');
  const [showJWorgTest, setShowJWorgTest] = useState(false);
  const [programs, setPrograms] = useState<any[]>([]);
  const [programsLoading, setProgramsLoading] = useState<boolean>(false);

  // 🚀 Memoização de dados estáticos para reduzir re-renders
  const staticStats = useMemo(() => ({
    total_congregations: systemStats?.total_congregations || 0,
    active_congregations: systemStats?.active_congregations || 0,
    total_users: systemStats?.total_users || 0,
    total_estudantes: systemStats?.total_estudantes || 0,
    total_programas: systemStats?.total_programas || 0,
    last_sync: systemStats?.last_sync || ''
  }), [systemStats]);

  // 🚀 Debounced function para reduzir chamadas desnecessárias
  const debouncedSetDebugInfo = useCallback((info: string) => {
    let timeoutId: NodeJS.Timeout;
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => setDebugInfo(info), 100);
  }, []);

  // DEBUG: Log component state (otimizado)
  useEffect(() => {
    const debugData = {
      user: !!user,
      userId: user?.id,
      userEmail: user?.email,
      profile: !!profile,
      profileRole: profile?.role,
      isAdmin,
      loading,
      userMetadata: user?.user_metadata
    };

    console.log('🔍 AdminDashboard Component Debug:', debugData);
    debouncedSetDebugInfo(JSON.stringify(debugData, null, 2));
  }, [user, profile, isAdmin, loading, debouncedSetDebugInfo]);

  useEffect(() => {
    console.log('🔄 AdminDashboard useEffect triggered:', { user, isAdmin });
    
    if (user && isAdmin) {
      console.log('✅ Admin user detected, loading system data...');
      loadSystemData();
    } else if (user && !isAdmin) {
      console.log('❌ User is not admin, role:', profile?.role);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ User is not admin, role: ' + profile?.role);
    } else if (!user) {
      console.log('❌ No user found');
      debouncedSetDebugInfo(debugInfo + '\n\n❌ No user found');
    }
  }, [user, isAdmin, debouncedSetDebugInfo]);

  const loadSystemData = useCallback(async () => {
    if (!user || !isAdmin) {
      console.log('🚫 loadSystemData: User not admin or not logged in');
      return;
    }
    
    console.log('🔄 Loading system data for admin...');
    setLoading(true);
    try {
      // Testar conexão com Supabase
      console.log('🔍 Testing Supabase connection...');
      const { count: profilesCount, error: testError } = await supabase
        .from('profiles')
        .select('*', { count: 'exact', head: true });
      
      if (testError) {
        console.error('❌ Supabase connection test failed:', testError);
        debouncedSetDebugInfo(debugInfo + '\n\n❌ Supabase Test Failed: ' + testError.message);
        return;
      }

        console.log('✅ Supabase connection test successful');
      debouncedSetDebugInfo(debugInfo + '\n\n✅ Supabase Test: Connected');

      // Carregar estatísticas do sistema
      await loadSystemStats();
      // Carregar programações publicadas
      await loadPrograms();

    } catch (error) {
      console.error('❌ Supabase test exception:', error);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ Supabase Test Exception: ' + error);
    } finally {
      setLoading(false);
    }
  }, [user, isAdmin, debouncedSetDebugInfo, debugInfo]);

  const loadSystemStats = useCallback(async () => {
    try {
      console.log('📊 Loading system statistics...');

      const [profilesRes, estudantesRes, programasRes] = await Promise.all([
        supabase.from('profiles').select('*', { count: 'exact', head: true }),
        supabase.from('estudantes').select('*', { count: 'exact', head: true }),
        supabase.from('programas').select('*', { count: 'exact', head: true }),
      ]);

      // congregacoes (removido: tabela pode não existir neste projeto)
      const congregacoesCount = 0;

      const stats: SystemStats = {
        total_congregations: congregacoesCount,
        active_congregations: congregacoesCount,
        total_users: (profilesRes.count as number) || 0,
        total_estudantes: (estudantesRes.count as number) || 0,
        total_programas: (programasRes.count as number) || 0,
        last_sync: new Date().toISOString(),
      };

      setSystemStats(stats);
      setLastCheck(new Date().toISOString());

      console.log('✅ System stats loaded:', stats);
      debouncedSetDebugInfo(debugInfo + '\n\n✅ System Stats Loaded: ' + JSON.stringify(stats, null, 2));

    } catch (error) {
      console.error('❌ Error loading system stats:', error);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ System Stats Error: ' + error);
    }
  }, [debouncedSetDebugInfo, debugInfo, supabase]);

  const loadPrograms = useCallback(async () => {
    try {
      setProgramsLoading(true);
      const { data, error } = await supabase
        .from('programas')
        .select('id, semana, mes_apostila, status, data_inicio_semana, arquivo')
        .order('data_inicio_semana', { ascending: false })
        .limit(12);
      if (error) throw error;
      setPrograms(data || []);
      console.log('✅ Programs loaded:', data?.length || 0);
    } catch (error: any) {
      console.error('❌ Error loading programs:', error);
      debouncedSetDebugInfo(debugInfo + '\n\n❌ Programs Load Error: ' + (error?.message || error));
    } finally {
      setProgramsLoading(false);
    }
  }, [debouncedSetDebugInfo, debugInfo]);

  const checkForUpdates = useCallback(async () => {
    console.log('🔄 Checking for updates...');
    setLoading(true);
    
    try {
      await loadSystemStats();
      await loadPrograms();
      console.log('✅ Updates checked successfully');
    } catch (error) {
      console.error('❌ Error checking updates:', error);
    } finally {
      setLoading(false);
    }
  }, [loadSystemStats]);

  const testSupabaseConnection = useCallback(async () => {
    console.log('🔧 Testing Supabase connection...');
    
    try {
      const { count, error } = await supabase
        .from('profiles')
        .select('*', { count: 'exact', head: true });

      if (error) {
        console.error('❌ Supabase test error:', error);
        alert('Supabase test error: ' + error.message);
      } else {
        console.log('✅ Supabase test successful. Profiles count:', count);
        alert('Supabase test successful! Total profiles: ' + (count ?? 0));
      }
    } catch (error) {
      console.error('❌ Supabase test exception:', error);
      alert('Supabase test exception: ' + error);
    }
  }, []);

  // ========== HANDLERS DOS BOTÕES ==========
  
  const handleListUsers = useCallback(async () => {
    console.log('👥 Listando usuários...');
    try {
      const { data: users, error } = await supabase
        .from('profiles')
        .select('id, nome_completo, role, congregacao, cargo')
        .order('nome_completo');
      
      if (error) throw error;
      
      console.log('✅ Usuários carregados:', users);
      alert(`Encontrados ${users?.length || 0} usuários no sistema:\n\n${users?.map(u => `${u.nome_completo || u.id} - ${u.role} (${u.congregacao || 'N/A'})`).join('\n')}`);
    } catch (error) {
      console.error('❌ Erro ao listar usuários:', error);
      alert('Erro ao carregar usuários: ' + error.message);
    }
  }, []);

  const handleManagePermissions = useCallback(async () => {
    console.log('⚙️ Gerenciando permissões...');
    const newRole = prompt('Digite o novo role (admin, instrutor, estudante):');
    if (!newRole) return;
    
    // Validar role
    const validRoles = ['admin', 'instrutor', 'estudante', 'family_member', 'developer'];
    if (!validRoles.includes(newRole)) {
      alert('Role inválido. Use: admin, instrutor, estudante, family_member ou developer');
      return;
    }
    
    const userId = prompt('Digite o ID do usuário:');
    if (!userId) return;
    
    try {
      const { error } = await supabase
        .from('profiles')
        .update({ role: newRole as any })
        .eq('id', userId);
      
      if (error) throw error;
      
      console.log('✅ Permissão atualizada');
      alert('Permissão atualizada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao atualizar permissão:', error);
      alert('Erro ao atualizar permissão: ' + error.message);
    }
  }, []);

  const handleActivityReport = useCallback(async () => {
    console.log('📊 Gerando relatório de atividades...');
    try {
      // Simulação de relatório
      const report = {
        totalUsers: staticStats.total_users,
        totalCongregations: staticStats.total_congregations,
        lastUpdate: new Date().toLocaleString('pt-BR'),
        activeUsers: Math.floor(staticStats.total_users * 0.8)
      };
      
      alert(`📊 Relatório de Atividades:\n\n` +
            `• Total de usuários: ${report.totalUsers}\n` +
            `• Usuários ativos: ${report.activeUsers}\n` +
            `• Total de congregações: ${report.totalCongregations}\n` +
            `• Última atualização: ${report.lastUpdate}`);
    } catch (error) {
      console.error('❌ Erro ao gerar relatório:', error);
      alert('Erro ao gerar relatório: ' + error.message);
    }
  }, [staticStats]);

  const handleBackupData = useCallback(async () => {
    console.log('💾 Fazendo backup dos dados...');
    try {
      const { data: profiles, error: profilesError } = await supabase
        .from('profiles')
        .select('*');
      
      if (profilesError) throw profilesError;
      
      // Simular backup
      const backupData = {
        timestamp: new Date().toISOString(),
        profiles: profiles,
        stats: staticStats
      };
      
      const dataStr = JSON.stringify(backupData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `backup_sistema_ministerial_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      URL.revokeObjectURL(url);
      console.log('✅ Backup criado com sucesso');
      alert('Backup criado e baixado com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao fazer backup:', error);
      alert('Erro ao fazer backup: ' + error.message);
    }
  }, [staticStats]);

  // Congregações
  const handleManageCongregation = useCallback((congregationName: string) => {
    console.log('🏢 Gerenciando congregação:', congregationName);
    alert(`🏢 Gerenciando congregação: ${congregationName}\n\nEsta funcionalidade abrirá o painel de gerenciamento da congregação.`);
  }, []);

  const handleAddCongregation = useCallback(async () => {
    console.log('➕ Adicionando nova congregação...');
    const congregationName = prompt('Digite o nome da nova congregação:');
    if (!congregationName) return;
    
    try {
      // Simulação - em produção seria inserção no Supabase
      console.log('✅ Congregação adicionada:', congregationName);
      alert(`✅ Congregação "${congregationName}" adicionada com sucesso!\n\nEla agora receberá automaticamente a programação oficial.`);
    } catch (error) {
      console.error('❌ Erro ao adicionar congregação:', error);
      alert('Erro ao adicionar congregação: ' + error.message);
    }
  }, []);

  // JW.org & S-38
  const handleMWBAvailable = useCallback(async () => {
    console.log('📚 Disponibilizando MWB atual...');
    try {
      await jworg.fetchCurrentWeek();
      console.log('✅ MWB atualizada');
      alert('✅ Apostila MWB atual disponibilizada para todas as congregações!');
    } catch (error) {
      console.error('❌ Erro ao disponibilizar MWB:', error);
      alert('Erro ao disponibilizar MWB: ' + error.message);
    }
  }, [jworg]);

  const handleConfigureJWorgURLs = useCallback(() => {
    console.log('⚙️ Configurando URLs JW.org...');
    const ptUrl = prompt('URL JW.org PT:', 'https://www.jw.org/pt/biblioteca/jw-apostila-do-mes/');
    const enUrl = prompt('URL JW.org EN:', 'https://www.jw.org/en/library/jw-meeting-workbook/');
    
    if (ptUrl && enUrl) {
      console.log('✅ URLs configuradas:', { ptUrl, enUrl });
      alert('✅ URLs JW.org configuradas com sucesso!');
    }
  }, []);

  const handleSyncCongregations = useCallback(async () => {
    console.log('🔄 Sincronizando com congregações...');
    try {
      // Simulação de sincronização
      const congregationsCount = staticStats.total_congregations;
      console.log(`✅ Sincronizando com ${congregationsCount} congregações`);
      alert(`🔄 Sincronização iniciada!\n\nProgramação oficial sendo enviada para ${congregationsCount} congregações...\n\nTempo estimado: ${Math.ceil(congregationsCount / 100)} minutos`);
    } catch (error) {
      console.error('❌ Erro na sincronização:', error);
      alert('Erro na sincronização: ' + error.message);
    }
  }, [staticStats]);

  // Programação Oficial
  const handleViewFullProgram = useCallback(() => {
    console.log('📅 Visualizando programação completa (3 meses)...');
    alert(`📅 Programação Completa dos Próximos 3 Meses\n\n` +
          `• Semanas carregadas: 12\n` +
          `• Idiomas: PT e EN\n` +
          `• Última atualização: Hoje\n\n` +
          `Esta visualização mostrará todas as apostilas MWB dos próximos 3 meses.`);
  }, []);

  const handleUpdateProgramPT = useCallback(async () => {
    console.log('🇧🇷 Atualizando programação PT...');
    try {
      jworg.setLanguage('pt');
      await jworg.fetchNextWeeks();
      console.log('✅ Programação PT atualizada');
      alert('✅ Programação em Português atualizada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao atualizar programação PT:', error);
      alert('Erro ao atualizar programação PT: ' + error.message);
    }
  }, [jworg]);

  const handleUpdateProgramEN = useCallback(async () => {
    console.log('🇺🇸 Atualizando programação EN...');
    try {
      jworg.setLanguage('en');
      await jworg.fetchNextWeeks();
      console.log('✅ Programação EN atualizada');
      alert('✅ Programação em Inglês atualizada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao atualizar programação EN:', error);
      alert('Erro ao atualizar programação EN: ' + error.message);
    }
  }, [jworg]);

  const handleCheckNewWeeks = useCallback(async () => {
    console.log('🔍 Verificando novas semanas...');
    try {
      await jworg.fetchNextWeeks();
      const newWeeks = jworg.nextWeeks.length;
      console.log(`✅ Verificação concluída: ${newWeeks} semanas`);
      alert(`🔍 Verificação concluída!\n\nEncontradas ${newWeeks} semanas de programação.\n\nTodas estão sincronizadas com JW.org.`);
    } catch (error) {
      console.error('❌ Erro ao verificar semanas:', error);
      alert('Erro ao verificar novas semanas: ' + error.message);
    }
  }, [jworg]);

  const handleUpdateS38Structure = useCallback(() => {
    console.log('🏗️ Atualizando estrutura S-38 global...');
    alert(`🏗️ Estrutura S-38 Global\n\n` +
          `✅ Partes da reunião atualizadas:\n` +
          `• Chairman\n• Treasures\n• Gems\n• Reading\n` +
          `• Starting\n• Following\n• Making\n• Explaining\n` +
          `• Talk\n\n` +
          `Esta estrutura será aplicada mundialmente.`);
  }, []);

  // JW.org Integration
  const handleReloadCurrentWeek = useCallback(async () => {
    console.log('🔄 Recarregando semana atual...');
    try {
      await jworg.fetchCurrentWeek();
      console.log('✅ Semana atual recarregada');
      alert('✅ Semana atual recarregada com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao recarregar semana:', error);
      alert('Erro ao recarregar semana: ' + error.message);
    }
  }, [jworg]);

  const handleReloadNextWeeks = useCallback(async () => {
    console.log('📅 Recarregando próximas semanas...');
    try {
      await jworg.fetchNextWeeks();
      console.log('✅ Próximas semanas recarregadas');
      alert('✅ Próximas semanas recarregadas com sucesso!');
    } catch (error) {
      console.error('❌ Erro ao recarregar próximas semanas:', error);
      alert('Erro ao recarregar próximas semanas: ' + error.message);
    }
  }, [jworg]);

  const handleTestDownloadPT = useCallback(async () => {
    console.log('🧪 Testando download PT...');
    try {
      jworg.setLanguage('pt');
      await jworg.downloadWorkbook('pt', '07', '2025');
      console.log('✅ Download PT testado');
      alert('✅ Download PT testado com sucesso!');
    } catch (error) {
      console.error('❌ Erro no teste de download PT:', error);
      alert('Erro no teste de download PT: ' + error.message);
    }
  }, [jworg]);

  // Monitoramento
  const handleViewAllLogs = useCallback(async () => {
    console.log('📋 Visualizando todos os logs...');
    try {
      // Simulação de logs
      const logs = [
        { timestamp: new Date().toLocaleString(), event: 'Sistema iniciado', level: 'info' },
        { timestamp: new Date(Date.now() - 3600000).toLocaleString(), event: 'Backup automático executado', level: 'info' },
        { timestamp: new Date(Date.now() - 86400000).toLocaleString(), event: 'Novo usuário registrado', level: 'info' },
        { timestamp: new Date(Date.now() - 172800000).toLocaleString(), event: 'Manutenção programada', level: 'warning' }
      ];
      
      const logText = logs.map(log => `${log.timestamp} [${log.level.toUpperCase()}] ${log.event}`).join('\n');
      alert(`📋 Logs do Sistema\n\n${logText}`);
    } catch (error) {
      console.error('❌ Erro ao carregar logs:', error);
      alert('Erro ao carregar logs: ' + error.message);
    }
  }, []);

  const handleTestJWorgIntegration = useCallback(async () => {
    console.log('🧪 Testando integração JW.org...');
    try {
      await jworg.fetchCurrentWeek();
      console.log('✅ Integração JW.org testada com sucesso');
      alert('✅ Integração JW.org funcionando perfeitamente!');
    } catch (error) {
      console.error('❌ Erro na integração JW.org:', error);
      alert('❌ Erro na integração JW.org: ' + error.message);
    }
  }, [jworg]);

  const handleChangeLanguage = useCallback((newLang: 'pt' | 'en') => {
    jworg.setLanguage(newLang);
    console.log(`🌐 Idioma alterado para: ${newLang}`);
    alert(`🌐 Idioma alterado para: ${newLang === 'pt' ? 'Português' : 'English'}`);
  }, [jworg]);

  // Alterna o idioma atual entre PT/EN
  const toggleLanguage = useCallback(() => {
    const current = (jworg as any)?.currentLanguage ?? 'pt';
    const next = current === 'pt' ? 'en' : 'pt';
    jworg.setLanguage(next);
    console.log(`🌐 Idioma alternado: ${current} -> ${next}`);
    alert(`🌐 Idioma alternado para: ${next === 'pt' ? 'Português' : 'English'}`);
  }, [jworg]);

  // Atualiza materiais JW.org (semana atual + próximas semanas)
  const updateMaterials = useCallback(async () => {
    try {
      await jworg.fetchCurrentWeek();
      await jworg.fetchNextWeeks();
      console.log('✅ Materiais JW.org atualizados');
      alert('✅ Materiais JW.org atualizados com sucesso!');
    } catch (error: any) {
      console.error('❌ Erro ao atualizar materiais:', error);
      alert('❌ Erro ao atualizar materiais: ' + (error?.message || error));
    }
  }, [jworg]);

  // Sincronizar materiais da pasta docs/Oficial -> tabela public.programas
  const syncMaterialsToPrograms = useCallback(async () => {
    try {
      setLoading(true);

      // Obter token do usuário atual para autenticar no backend
      const { data: sessionData } = await supabase.auth.getSession();
      const accessToken = sessionData.session?.access_token;
      if (!accessToken) {
        alert('Sessão inválida. Faça login novamente.');
        return;
      }

      // Buscar lista de materiais no backend (requer Authorization)
      const res = await fetch('http://localhost:3001/api/materials', {
        headers: { Authorization: `Bearer ${accessToken}` },
      });
      if (!res.ok) {
        alert('Falha ao listar materiais no backend.');
        return;
      }
      const payload = await res.json();
      const materials: Array<{ filename: string }> = payload.materials || [];

      // Filtrar arquivos relevantes e preparar upserts
      const rows: any[] = materials
        .map((m) => m.filename)
        .filter((name) => /^(mwb_|S-38_|mwb_T_)/i.test(name))
        .map((arquivo) => {
          // Extrair ano/mês do padrão mwb_E_YYYYMM.pdf
          let ano = '';
          let mes = '';
          const match = arquivo.match(/mwb_[A-Z]_([0-9]{6})/i);
          if (match) {
            ano = match[1].slice(0, 4);
            mes = match[1].slice(4, 6);
          }
          const mes_apostila = ano && mes ? `${ano}-${mes}` : null;
          const data_inicio_semana = mes_apostila ? `${ano}-${mes}-01` : null;
          return {
            semana: null,
            mes_apostila,
            status: 'ativo',
            data_inicio_semana,
            arquivo,
          };
        });

      // Inserir somente os que ainda não existem por arquivo
      for (const row of rows) {
        const { data: exists, error: selErr } = await supabase
          .from('programas')
          .select('id')
          .eq('arquivo', row.arquivo)
          .maybeSingle();
        if (selErr) {
          console.warn('Select error (ignorado):', selErr.message);
        }
        if (!exists) {
          const { error: insErr } = await supabase.from('programas').insert(row as any);
          if (insErr) {
            console.warn('Insert error para', row.arquivo, insErr.message);
          }
        }
      }

      await loadPrograms();
      alert('Sincronização concluída.');
    } catch (error: any) {
      console.error('❌ Erro ao sincronizar materiais:', error);
      alert('Erro ao sincronizar materiais: ' + (error?.message || error));
    } finally {
      setLoading(false);
    }
  }, [supabase, loadPrograms]);

  // NOW CHECK CONDITIONS AND RENDER APPROPRIATELY
  // Se não for admin, mostrar mensagem de acesso negado
  if (user && !isAdmin) {
    return (
      <div className="container mx-auto px-4 py-8">
        <Card className="max-w-md mx-auto">
          <CardHeader>
            <CardTitle className="text-red-600">Acesso Negado</CardTitle>
            <CardDescription>
              Você não tem permissão para acessar o painel administrativo.
            </CardDescription>
          </CardHeader>
          <CardContent>
            <p className="text-sm text-muted-foreground mb-4">
              Seu perfil atual: <strong>{profile?.role}</strong>
            </p>
            <Button onClick={() => window.history.back()}>
              Voltar
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Se não houver usuário, mostrar loading
  if (!user) {
    return (
      <div className="container mx-auto px-4 py-8">
        <Card className="max-w-md mx-auto">
          <CardHeader>
            <CardTitle>Carregando...</CardTitle>
            <CardDescription>
              Verificando autenticação...
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="flex items-center justify-center">
              <RefreshCw className="h-6 w-6 animate-spin" />
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background">
      {/* Auth Error Handler */}
      <AuthErrorHandler />
      
      {/* Header */}
      <div className="border-b">
        <div className="container mx-auto px-4 py-6">
          <div className="flex flex-col space-y-4">
          <div className="flex items-center justify-between">
            <div>
                <h1 className="text-3xl font-bold tracking-tight">📊 Dashboard do Administrador Geral</h1>
                <p className="text-muted-foreground">
                  Programação oficial das reuniões ministeriais - Padronização mundial para todas as congregações
              </p>
            </div>
              <div className="flex items-center space-x-2">
              {/* Force Profile Load Button */}
              {import.meta.env.DEV && (
                <Button 
                  variant="outline" 
                  size="sm"
                    onClick={testSupabaseConnection}
                  >
                    🔧 Test Supabase
                </Button>
              )}
              
              <Button onClick={checkForUpdates} disabled={loading}>
                <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
                  Atualizar
              </Button>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Debug Info Panel */}
      {import.meta.env.DEV && (
        <div className="container mx-auto px-4 py-2">
          <Card className="bg-yellow-50 border-yellow-200">
            <CardHeader className="pb-2">
              <CardTitle className="text-sm text-yellow-800">🐛 Debug Info (Development Only)</CardTitle>
            </CardHeader>
            <CardContent>
              <pre className="text-xs text-yellow-700 overflow-auto max-h-40">
                {debugInfo}
              </pre>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Main Content */}
      <div className="container mx-auto px-4 py-6">
        <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-6">
          <TabsList className="grid w-full grid-cols-4">
            <TabsTrigger value="overview">Visão Geral</TabsTrigger>
            <TabsTrigger value="users">Usuários</TabsTrigger>
            <TabsTrigger value="congregations">Congregações</TabsTrigger>
            <TabsTrigger value="system">Sistema</TabsTrigger>
          </TabsList>

          {/* Visão Geral */}
          <TabsContent value="overview" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                🎯 Sistema Ministerial Global - Padronização Mundial
              </h3>
              <div className="text-center text-sm text-muted-foreground mt-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
                <strong>📊 Admin Geral:</strong> Disponibiliza programação oficial semanal (SEM nomes de estudantes) <br/>
                <strong>🎓 Instrutores:</strong> Recebem programação automaticamente + fazem designações locais reais
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Congregações Conectadas</CardTitle>
                  <Globe className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">{staticStats.total_congregations}</div>
                  <p className="text-xs text-muted-foreground">
                    Recebendo programação oficial
                  </p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Semanas Programadas</CardTitle>
                  <BarChart3 className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">12</div>
                  <p className="text-xs text-muted-foreground">
                    Próximas 3 meses
                  </p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Idiomas Disponíveis</CardTitle>
                  <Globe className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">2</div>
                  <p className="text-xs text-muted-foreground">
                    Português e Inglês
                  </p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Última Sincronização</CardTitle>
                  <RefreshCw className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">✅</div>
                  <p className="text-xs text-muted-foreground">
                    Hoje, {new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                  </p>
                </CardContent>
              </Card>
            </div>

            {/* Ações Rápidas */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Status do Sistema */}
              <Card>
                <CardHeader>
                  <CardTitle>Status do Sistema</CardTitle>
                  <CardDescription>
                    Informações sobre a última verificação e status geral
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Última Verificação:</span>
                    <span className="text-sm text-muted-foreground">
                      {lastCheck ? new Date(lastCheck).toLocaleString('pt-BR') : 'Nunca'}
                    </span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Status:</span>
                    <Badge variant="outline" className="text-green-600">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Operacional
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Supabase:</span>
                    <Badge variant="outline" className="text-green-600">
                      <Database className="h-3 w-3 mr-1" />
                      Conectado
                    </Badge>
                  </div>
                </CardContent>
              </Card>

              {/* Programações Publicadas */}
              <Card>
                <CardHeader>
                  <CardTitle>Programações Publicadas</CardTitle>
                  <CardDescription>
                    Últimas semanas importadas/publicadas
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  {programsLoading ? (
                    <div className="text-sm text-muted-foreground">Carregando...</div>
                  ) : programs.length === 0 ? (
                    <div className="text-sm text-muted-foreground">Nenhuma programação encontrada.</div>
                  ) : (
                    <div className="space-y-2">
                      {programs.map((p) => (
                        <div key={p.id} className="p-2 border rounded-md">
                          <div className="flex items-center justify-between">
                            <div className="text-sm">
                              <div className="font-medium">Semana {p.semana || '—'} • {p.mes_apostila || '—'}</div>
                              <div className="text-xs text-muted-foreground">
                                {p.data_inicio_semana ? new Date(p.data_inicio_semana).toLocaleDateString('pt-BR') : '—'}
                              </div>
                            </div>
                            <Badge variant="outline" className={p.status === 'ativo' || p.status === 'publicado' ? 'bg-green-50 text-green-700' : ''}>
                              {p.status || '—'}
                            </Badge>
                          </div>
                          {p.arquivo && (
                            <div className="mt-2">
                              <a
                                href={`http://localhost:3001/materials/${encodeURIComponent(p.arquivo)}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="text-blue-600 text-xs underline"
                              >
                                Abrir material ({p.arquivo})
                              </a>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </CardContent>
              </Card>

              {/* JW.org Downloads */}
              <Card className="bg-green-50 border-green-200">
                <CardHeader>
                  <CardTitle className="text-green-800">📚 JW.org Downloads</CardTitle>
                  <CardDescription className="text-green-700">
                    Gerenciar materiais oficiais
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Apostila MWB Atual:</span>
                    <Badge variant="outline" className="text-green-600">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Disponível
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Última verificação:</span>
                    <span className="text-sm text-green-700">Hoje, 10:30</span>
                  </div>
                  <div className="flex space-x-2">
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleMWBAvailable}>
                      <RefreshCw className="h-3 w-3 mr-1" />
                      Disponibilizar MWB Atual
                    </Button>
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleConfigureJWorgURLs}>
                      <Settings className="h-3 w-3 mr-1" />
                      Configurar URLs JW.org
                    </Button>
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={syncMaterialsToPrograms} disabled={loading}>
                      <RefreshCw className={`h-3 w-3 mr-1 ${loading ? 'animate-spin' : ''}`} />
                      Sincronizar materiais → programas
                    </Button>
                  </div>
                </CardContent>
              </Card>

              {/* Sistema S-38 - Designações */}
              <Card className="bg-purple-50 border-purple-200">
                <CardHeader>
                  <CardTitle className="text-purple-800">⚙️ Sistema S-38</CardTitle>
                  <CardDescription className="text-purple-700">
                    Estrutura das reuniões ministeriais
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="text-sm text-purple-700 space-y-2">
                    <p>📚 <strong>Função do Admin:</strong> Disponibilizar apostilas MWB</p>
                    <p>👥 <strong>Para Instrutores:</strong> Designar estudantes para partes</p>
                    <p>🎯 <strong>Partes da Reunião:</strong></p>
                    <div className="grid grid-cols-2 gap-1 text-xs ml-2">
                      <div>• Chairman</div>
                      <div>• Treasures</div>
                      <div>• Gems</div>
                      <div>• Reading</div>
                      <div>• Starting</div>
                      <div>• Following</div>
                      <div>• Making</div>
                      <div>• Explaining</div>
                      <div>• Talk</div>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Debug / Integração */}
              <Card className="bg-slate-50 border-slate-200">
                <CardHeader>
                  <CardTitle className="text-slate-800">🧪 Debug / Integração</CardTitle>
                  <CardDescription className="text-slate-700">
                    Ferramentas rápidas para validar integrações e idioma
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-3">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Idioma Atual:</span>
                    <Badge variant="outline" className="text-slate-700">
                      {(jworg as any)?.currentLanguage === 'en' ? '🇺🇸 English' : '🇧🇷 Português'}
                    </Badge>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    <Button size="sm" variant="outline" onClick={toggleLanguage}>
                      Alternar Idioma
                    </Button>
                    <Button size="sm" variant="outline" onClick={updateMaterials}>
                      Atualizar Materiais
                    </Button>
                    <Button size="sm" variant="outline" onClick={handleTestJWorgIntegration}>
                      Testar Integração JW.org
                    </Button>
                    <Button size="sm" variant="outline" onClick={checkForUpdates} disabled={loading}>
                      Atualizar Contagens
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          {/* Usuários */}
          <TabsContent value="users" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                👥 Gestão de Usuários para Acesso às Apostilas MWB
              </h3>
              <p className="text-center text-sm text-muted-foreground mt-2">
                🎯 Função Principal: Admin gerencia usuários → Instrutores acessam apostilas
              </p>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Estatísticas de Usuários */}
            <Card>
              <CardHeader>
                  <CardTitle>Estatísticas</CardTitle>
                  <CardDescription>Resumo dos usuários</CardDescription>
              </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Total de Usuários:</span>
                      <Badge variant="outline">{staticStats.total_users}</Badge>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Admins:</span>
                      <Badge variant="outline" className="bg-red-50 text-red-700">
                        {isAdmin ? 1 : 0}
                      </Badge>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Instrutores:</span>
                      <Badge variant="outline" className="bg-blue-50 text-blue-700">
                        {staticStats.total_users - (isAdmin ? 1 : 0)}
                      </Badge>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Usuários Registrados */}
              <Card className="lg:col-span-2">
                <CardHeader>
                  <CardTitle>Usuários Registrados</CardTitle>
                  <CardDescription>Últimos usuários cadastrados no sistema</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between p-3 border rounded-lg">
                      <div className="flex items-center space-x-3">
                        <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                          <Users className="h-5 w-5 text-blue-600" />
                        </div>
                        <div>
                          <p className="font-medium">{profile?.nome_completo || 'Roberto Araujo da Silva'}</p>
                          <p className="text-sm text-muted-foreground">Administrator</p>
                        </div>
                      </div>
                      <Badge variant="outline" className="bg-red-50 text-red-700">
                        Admin
                      </Badge>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Ações Administrativas */}
            <Card>
              <CardHeader>
                <CardTitle>Ações Administrativas</CardTitle>
                <CardDescription>
                  Gerenciar usuários e permissões
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <Button className="w-full justify-start" variant="outline" onClick={handleListUsers}>
                    <Users className="h-4 w-4 mr-2" />
                    Listar Todos os Usuários
                  </Button>
                  <Button className="w-full justify-start" variant="outline" onClick={handleManagePermissions}>
                    <Settings className="h-4 w-4 mr-2" />
                    Gerenciar Permissões
                  </Button>
                  <Button className="w-full justify-start" variant="outline" onClick={handleActivityReport}>
                    <Activity className="h-4 w-4 mr-2" />
                    Relatório de Atividades
                  </Button>
                  <Button className="w-full justify-start" variant="outline" onClick={handleBackupData}>
                    <Database className="h-4 w-4 mr-2" />
                    Backup de Dados
                  </Button>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Congregações */}
          <TabsContent value="congregations" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                🏢 Gestão de Congregações para Acesso às Apostilas MWB
              </h3>
              <p className="text-center text-sm text-muted-foreground mt-2">
                🎯 Função Principal: Admin gerencia congregações → Instrutores acessam apostilas
              </p>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Estatísticas de Congregações */}
            <Card>
              <CardHeader>
                  <CardTitle>Estatísticas</CardTitle>
                  <CardDescription>Resumo das congregações</CardDescription>
              </CardHeader>
              <CardContent>
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Total de Congregações:</span>
                      <Badge variant="outline">{staticStats.total_congregations}</Badge>
                  </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Congregações Ativas:</span>
                      <Badge variant="outline" className="bg-green-50 text-green-700">
                        {staticStats.active_congregations}
                      </Badge>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Total de Estudantes:</span>
                      <Badge variant="outline">{staticStats.total_estudantes}</Badge>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Lista de Congregações */}
              <Card className="lg:col-span-2">
                <CardHeader>
                  <CardTitle>Congregações Registradas</CardTitle>
                  <CardDescription>Lista das congregações no sistema</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between p-3 border rounded-lg">
                      <div className="flex items-center space-x-3">
                        <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                          <Package className="h-5 w-5 text-blue-600" />
                        </div>
                        <div>
                          <p className="font-medium">Sistema Ministerial Global</p>
                          <p className="text-sm text-muted-foreground">Congregação Principal</p>
                          </div>
                        </div>
                      <Badge variant="outline" className="bg-green-50 text-green-700">
                        Ativa
                        </Badge>
                      </div>
                  </div>
                  
                  <div className="mt-4">
                    <Button variant="outline" className="w-full" onClick={() => handleManageCongregation('Sistema Ministerial Global')}>
                      <Users className="h-4 w-4 mr-2" />
                      Gerenciar
                    </Button>
                  </div>
                  
                  <div className="mt-4">
                    <Button variant="outline" className="w-full" onClick={handleAddCongregation}>
                      <Users className="h-4 w-4 mr-2" />
                      Adicionar Nova Congregação
                    </Button>
                  </div>
                  
                  <div className="mt-4">
                    <Button variant="outline" className="w-full">
                      <Users className="h-4 w-4 mr-2" />
                      Expandir
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          {/* Sistema */}
          <TabsContent value="system" className="space-y-6">
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-center text-muted-foreground">
                ⚙️ Monitoramento e Configurações do Sistema
              </h3>
              <p className="text-center text-sm text-muted-foreground mt-2">
                🎯 Função Principal: Admin monitora sistema → Instrutores recebem apostilas estáveis
              </p>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Downloads JW.org */}
              <Card className="bg-green-50 border-green-200">
              <CardHeader>
                  <CardTitle className="text-green-800">📚 JW.org Downloads</CardTitle>
                  <CardDescription className="text-green-700">
                    Gerenciar materiais oficiais
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Apostila MWB Atual:</span>
                    <Badge variant="outline" className="text-green-600">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Disponível
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Última verificação:</span>
                    <span className="text-sm text-green-700">Hoje, 10:30</span>
                  </div>
                  <div className="flex space-x-2">
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleSyncCongregations}>
                      <RefreshCw className="h-3 w-3 mr-1" />
                      Sincronizar com Congregações
                    </Button>
                    <Button size="sm" variant="outline" className="border-green-300 text-green-700" onClick={handleViewFullProgram}>
                      <Settings className="h-3 w-3 mr-1" />
                      Ver Programação Completa
                    </Button>
                </div>
              </CardContent>
            </Card>

              {/* Configurações Gerais */}
            <Card>
              <CardHeader>
                  <CardTitle>Configurações Gerais</CardTitle>
                <CardDescription>
                    Parâmetros do sistema
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                    <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Backup Automático:</span>
                    <Badge variant="outline" className="bg-green-50 text-green-700">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Diário às 02:00
                      </Badge>
                    </div>
                    <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Notificações:</span>
                    <Badge variant="outline" className="bg-blue-50 text-blue-700">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      Email + Sistema
                    </Badge>
                    </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Manutenção:</span>
                    <span className="text-sm text-muted-foreground">Última: Ontem</span>
                  </div>
                  <div className="flex space-x-2">
                    <Button size="sm" variant="outline">
                      <Settings className="h-3 w-3 mr-1" />
                      Configurar
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Métricas do Sistema */}
            <Card>
              <CardHeader>
                <CardTitle>Métricas do Sistema</CardTitle>
                <CardDescription>
                  Monitoramento em tempo real
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-green-600">99.9%</p>
                    <p className="text-sm text-muted-foreground">Uptime</p>
                  </div>
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-blue-600">~120ms</p>
                    <p className="text-sm text-muted-foreground">Latência</p>
                  </div>
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-green-600">25%</p>
                    <p className="text-sm text-muted-foreground">CPU</p>
                  </div>
                  <div className="p-3 border rounded-lg text-center">
                    <p className="text-2xl font-bold text-blue-600">33%</p>
                    <p className="text-sm text-muted-foreground">Memória</p>
                  </div>
                </div>

                <Separator />

                <div className="space-y-3">
                    <div className="flex items-center justify-between">
                    <span className="text-sm">CPU:</span>
                    <div className="flex items-center space-x-2">
                      <div className="w-24 h-2 bg-gray-200 rounded-full">
                        <div className="w-1/4 h-2 bg-green-500 rounded-full"></div>
                    </div>
                        <span className="text-sm">25%</span>
                  </div>
                    </div>
                    
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Memória:</span>
                      <div className="flex items-center space-x-2">
                        <div className="w-24 h-2 bg-gray-200 rounded-full">
                          <div className="w-1/3 h-2 bg-blue-500 rounded-full"></div>
                    </div>
                        <span className="text-sm">33%</span>
                      </div>
                    </div>
                    
                    <div className="flex items-center justify-between">
                      <span className="text-sm">Banco:</span>
                      <div className="flex items-center space-x-2">
                        <CheckCircle className="h-4 w-4 text-green-500" />
                        <span className="text-sm">Conectado</span>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

              {/* Logs e Atividades */}
              <Card>
                <CardHeader>
                  <CardTitle>Logs Recentes</CardTitle>
                  <CardDescription>
                    Últimas atividades do sistema
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <CheckCircle className="h-4 w-4 text-green-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Sistema iniciado</p>
                        <p className="text-xs text-muted-foreground">Hoje, 08:00</p>
                      </div>
                    </div>

                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <Activity className="h-4 w-4 text-blue-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Backup automático executado</p>
                        <p className="text-xs text-muted-foreground">Hoje, 02:00</p>
                      </div>
                    </div>

                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <Users className="h-4 w-4 text-green-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Novo usuário registrado</p>
                        <p className="text-xs text-muted-foreground">Ontem, 16:30</p>
                      </div>
                    </div>

                    <div className="flex items-start space-x-3 p-2 border rounded-lg">
                      <AlertCircle className="h-4 w-4 text-yellow-500 mt-0.5" />
                      <div className="flex-1">
                        <p className="text-sm font-medium">Manutenção programada</p>
                        <p className="text-xs text-muted-foreground">Ontem, 03:00</p>
                      </div>
                    </div>
                  </div>

                  <div className="mt-4">
                    <Button variant="outline" className="w-full" onClick={handleViewAllLogs}>
                      <FileText className="h-4 w-4 mr-2" />
                      Ver Todos os Logs
                    </Button>
                  </div>
                </CardContent>
              </Card>
          </TabsContent>
        </Tabs>
      </div>
    </div>
  );
}

```

Adicionei um botão “Sincronizar materiais → programas” no Admin (em JW.org Downloads) que:

- Lê a sessão atual (token) e chama o backend `GET http://localhost:3001/api/materials` com Authorization.
- Mapeia os arquivos em `docs/Oficial` (mwb_*, S-38_*, mwb_T_*) para linhas de `public.programas` usando:
  - `arquivo` = nome do arquivo, ex.: mwb_E_202509.pdf
  - `mes_apostila` = AAAA-MM (derivado do nome do arquivo quando aplicável)
  - `data_inicio_semana` = AAAA-MM-01 (quando possível)
  - `status` = 'ativo'
- Insere apenas os que ainda não existem por `arquivo`.
- Atualiza o card “Programações Publicadas” e mostra alerta “Sincronização concluída”.

Como usar:
- Entre no Admin → JW.org Downloads → clique em “Sincronizar materiais → programas”.
- Em seguida, o card “Programações Publicadas” mostrará as entradas com link “Abrir material” para:
  - http://localhost:3001/materials/mwb_E_202507.pdf
  - http://localhost:3001/materials/mwb_E_202509.pdf
  - http://localhost:3001/materials/mwb_E_202511.pdf

Pré-requisitos:
- Backend rodando em 3001.
- Autenticação ativa (o botão usa o token atual).
- RLS/Permissões do Supabase permitindo `insert/select` em `public.programas` para seu usuário atual.

---

**User**

qual formato eh melhor para eu baixar e fazer aparecer no http://localhost:8080/admin  ? "C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_T_202507.daisy.zip"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_T_202509.daisy.zip"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_T_202509.jwpub"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_T_202511.jwpub"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\S-38_E.rtf"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\WhatsApp Image 2025-08-14 at 19.44.07 (1).jpeg"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\WhatsApp Image 2025-08-14 at 19.44.07.jpeg"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\estudantes_ficticios.xlsx"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\estudantes_rows.sql"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_E_202507.pdf"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_E_202509.pdf"
"C:\Users\frank.MONITORE-MAFRA\Documents\GitHub\sua-parte\docs\Oficial\mwb_E_202511.pdf" 

---

**Cursor**

- Melhor para aparecer no Admin agora: mwb_E_YYYYMM.pdf
  - Ex.: mwb_E_202507.pdf, mwb_E_202509.pdf, mwb_E_202511.pdf.
  - O botão “Sincronizar materiais → programas” reconhece esse padrão e preenche mês/data automaticamente, com link “Abrir material”.

- Também aceita (aparecem com link, mas sem mês/data automática):
  - .jwpub (mwb_T_YYYYMM.jwpub)
  - .daisy.zip (mwb_T_YYYYMM.daisy.zip)

- Não entram como “programação” (podem aparecer em outras seções, mas não no card atual):
  - S-38_E.rtf, imagens (.jpeg), planilhas (.xlsx), SQL (.sql)

Resumo: baixe/priorize mwb_E_YYYYMM.pdf para o card “Programações Publicadas”. Os .jwpub/.daisy também são listados, porém sem metadados de mês/data.

---

**User**

client:495 [vite] connecting...
client:618 [vite] connected.
chunk-NFC5BX5N.js?v=91091763:21551 Download the React DevTools for a better development experience: https://reactjs.org/link/react-devtools
client.ts:10 🔍 Supabase Environment Debug: Object
client.ts:38 ✅ Supabase Client Configuration: Object
@supabase_supabase-js.js?v=91091763:5551 GoTrueClient@0 (2.71.1) 2025-09-08T12:33:03.867Z #_acquireLock begin -1
@supabase_supabase-js.js?v=91091763:5551 GoTrueClient@0 (2.71.1) 2025-09-08T12:33:03.867Z #onAuthStateChange() registered callback with id db262ed7-3b5b-4d6e-a53b-f40353b4b7d8
debugLogger.ts:62 ℹ️ [INFO] Debug Logger Initialized Object
supabaseHealthCheck.ts:153 🔧 Supabase health check tools available:
supabaseHealthCheck.ts:154   window.supabaseHealth.check() - Full health check
supabaseHealthCheck.ts:155   window.supabaseHealth.testAuth() - Test auth operations
supabaseHealthCheck.ts:156   window.supabaseHealth.quickCheck() - Quick status check
logoutDiagnostics.ts:233 🔧 Logout diagnostics tools available:
logoutDiagnostics.ts:234   window.logoutDiagnostics.run() - Full diagnostic
logoutDiagnostics.ts:235   window.logoutDiagnostics.quickTest() - Quick test
offlineLocalDB.ts:642 🔧 Offline DB tools available: window.offlineDB.download(), window.offlineDB.downloadIncremental(), window.offlineDB.list('estudantes'), window.offlineDB.sync()
offlineLocalDB.ts:643 🔧 Outbox tools: window.offlineDB.createLocal(), window.offlineDB.getOutboxStatus(), window.offlineDB.getPendingOps()
offlineLocalDB.ts:644 🔧 Cursor tools: window.offlineDB.getCursors()
App.tsx:55 🔧 Loading debug tools for development environment...
i18next.js?v=91091763:208 i18next: languageChanged pt
i18next.js?v=91091763:208 i18next: initialized Object
@supabase_supabase-js.js?v=91091763:5551 GoTrueClient@0 (2.71.1) 2025-09-08T12:33:03.908Z #onAuthStateChange() registered callback with id 6741fe4e-a1a4-4f65-9452-8ee349af5c52
AuthContext.tsx:282 🔧 Force admin login function available: window.forceAdminLogin()
AuthContext.tsx:290 🔄 Getting initial session...
@supabase_supabase-js.js?v=91091763:5551 GoTrueClient@0 (2.71.1) 2025-09-08T12:33:03.914Z #onAuthStateChange() registered callback with id 759866b3-4f6d-4dce-9c04-a2bdabd9a6c1
LanguageContext.tsx:32 🌐 LanguageContext: Current language is pt
LanguageContext.tsx:33 🌐 LanguageContext: Available resources: Array(2)
emergencyLogout.ts:120 🚨 Emergency logout tools available:
emergencyLogout.ts:121   window.emergencyLogout() - Full emergency logout
emergencyLogout.ts:122   window.immediateLogout() - Instant logout, no delays
emergencyLogout.ts:123   window.smartLogout(signOutFn) - Try Supabase first, fallback to emergency
@supabase_supabase-js.js?v=91091763:5551 GoTrueClient@0 (2.71.1) 2025-09-08T12:33:03.919Z #_acquireLock lock acquired for storage key sb-nwpuurgwnnuejqinkvrh-auth-token
@supabase_supabase-js.js?v=91091763:5551 GoTrueClient@0 (2.71.1) 2025-09-08T12:33:03.919Z #_recoverAndRefresh() begin
@supabase_supabase-js.js?v=91091763:5551 GoTrueClient@0 (2.71.1) 2025-09-08T12:33:03.919Z #_recoverAndRefresh() session from storage Object
@supabase_supabase-js.js?v=91091763:5551 GoTrueClient@0 (2.71.1) 2025-09-08T12:33:03.919Z #_recoverAndRefresh() session has not expired with margin of 90000s
@supabase_supabase-js.js?v=91091763:5551 GoTrueClient@0 (2.71.1) 2025-09-08T12:33:03.920Z #_notifyAllSubscribers(SIGNED_IN) begin Object broadcast = true
AuthContext.tsx:343 🔄 Auth state changed: SIGNED_IN amazonwebber007@gmail.com
AuthContext.tsx:347 👤 Setting user and session...
AuthContext.tsx:60 🔍 Fetching profile for user ID: e8efcdcb-dc1a-4930-b77b-33bd5cd89a55
AuthContext.tsx:64 🔐 Checking current session...
AuthContext.tsx:282 🔧 Force admin login function available: window.forceAdminLogin()
familyMemberDebug.ts:350 🔧 Family Member Debug Tools Available:
familyMemberDebug.ts:351    window.debugFamilyMember.authState()
familyMemberDebug.ts:352    window.debugFamilyMember.insert(studentId)
familyMemberDebug.ts:353    window.debugFamilyMember.rls(studentId)
familyMemberDebug.ts:354    window.debugFamilyMember.comprehensive(studentId)
familyMemberDebug.ts:355    window.debugFamilyMember.invitationFlow(studentId)
familyMemberDebug.ts:356 
familyMemberDebug.ts:357 🎯 Quick Test Command:
familyMemberDebug.ts:358    window.debugFamilyMember.invitationFlow("77c99e53-500b-4140-b7fc-a69f96b216e1")
reviewDatabase.ts:134 🔧 Database review tool available: window.reviewDatabase()
executeMigration.ts:83 🔧 Migration tool available: window.executeMigration()
syncStudentsToInstructors.ts:79 🔧 Sync tool available: window.syncStudentsToInstructors()
quickSync.ts:72 🔧 Quick sync available: window.quickSync()
App.tsx:69 ✅ Debug tools loaded successfully
testDensityToggle.ts:6 🧪 Testing Density Toggle Functionality
testDensityToggle.ts:11 ✅ Current density mode: comfortable
testDensityToggle.ts:18 ✅ CSS Variables:
testDensityToggle.ts:19   --row-h: 44px
testDensityToggle.ts:20   --cell-px: 12px
testDensityToggle.ts:24 ✅ Saved density in localStorage: comfortable
testDensityToggle.ts:38 ✅ Value verification:
testDensityToggle.ts:39   Row height matches expected: true (44px vs 44px)
testDensityToggle.ts:40   Cell padding matches expected: true (12px vs 12px)
testDensityToggle.ts:44 ✅ Found density tables: 0
testDensityToggle.ts:53 ✅ Found responsive table containers: 0
testDensityToggle.ts:62 🎉 All density tests passed!


---

**Cursor**

- Clique em “Sincronizar materiais → programas” no bloco “📚 JW.org Downloads” do Admin.
- Pré‑requisitos:
  - Backend rodando em 3001.
  - Logado (o botão usa seu token).
  - Os PDFs mwb_E_YYYYMM.pdf estão em docs/Oficial (ex.: mwb_E_202507.pdf, 202509, 202511).

Após sincronizar:
- O card “Programações Publicadas” deve listar as entradas e mostrar “Abrir material” para cada PDF.
- Se nada aparecer, me diga o alerta exibido; como plano B, insira manualmente uma linha em public.programas com arquivo='mwb_E_202509.pdf' e recarregue.

---

**User**

resuma tudo que conversamos hoje

